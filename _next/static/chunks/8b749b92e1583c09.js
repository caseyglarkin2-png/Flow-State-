(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,72015,32913,e=>{"use strict";let t,i,r;var n=e.i(71645);let s=e=>{let t,i=new Set,r=(e,r)=>{let n="function"==typeof e?e(t):e;if(!Object.is(n,t)){let e=t;t=(null!=r?r:"object"!=typeof n||null===n)?n:Object.assign({},t,n),i.forEach(i=>i(t,e))}},n=()=>t,s={setState:r,getState:n,getInitialState:()=>o,subscribe:e=>(i.add(e),()=>i.delete(e))},o=t=e(r,n,s);return s},o=e=>{let t=e?s(e):s,i=e=>(function(e,t=e=>e){let i=n.default.useSyncExternalStore(e.subscribe,n.default.useCallback(()=>t(e.getState()),[e,t]),n.default.useCallback(()=>t(e.getInitialState()),[e,t]));return n.default.useDebugValue(i),i})(t,e);return Object.assign(i,t),i};function a(e,t){let i;try{i=e()}catch(e){return}return{getItem:e=>{var r;let n=e=>null===e?null:JSON.parse(e,null==t?void 0:t.reviver),s=null!=(r=i.getItem(e))?r:null;return s instanceof Promise?s.then(n):n(s)},setItem:(e,r)=>i.setItem(e,JSON.stringify(r,null==t?void 0:t.replacer)),removeItem:e=>i.removeItem(e)}}let l=e=>t=>{try{let i=e(t);if(i instanceof Promise)return i;return{then:e=>l(e)(i),catch(e){return this}}}catch(e){return{then(e){return this},catch:t=>l(t)(e)}}},u={id:"event-horizon",name:"Event Horizon",colors:{background:"#050505",surface:"#0F0F0F",primary:"#00B4FF",alert:"#FF2A00",text:"#FFFFFF",textSecondary:"#888888"},typography:{bodyFont:"Inter",monoFont:"JetBrains Mono",sizeBase:14,sizeSmall:12,sizeLarge:18,sizeXLarge:24},icons:{variant:"flow-v1"},logos:{variant:"horizontal"}},c={longitude:-98.5795,latitude:39.8283,zoom:4,pitch:0,bearing:0},h={Northeast:["CT","ME","MA","NH","NJ","NY","PA","RI","VT"],Southeast:["AL","FL","GA","KY","MS","NC","SC","TN","VA","WV"],Midwest:["IL","IN","IA","KS","MI","MN","MO","NE","ND","OH","SD","WI"],Southwest:["AZ","NM","OK","TX"],West:["AK","CA","CO","HI","ID","MT","NV","OR","UT","WA","WY"]};function d(e){for(let[t,i]of Object.entries(h))if(i.includes(e))return t;return"Other"}function f(e){let t=[];return e.id?t.push({field:"id",status:"valid"}):t.push({field:"id",status:"missing",message:"Facility ID is required"}),e.name?t.push({field:"name",status:"valid"}):t.push({field:"name",status:"missing",message:"Facility name is required"}),void 0===e.lat||null===e.lat||isNaN(e.lat)?t.push({field:"lat",status:"invalid",message:"Valid latitude is required"}):e.lat<-90||e.lat>90?t.push({field:"lat",status:"invalid",message:"Latitude must be between -90 and 90"}):t.push({field:"lat",status:"valid"}),void 0===e.lon||null===e.lon||isNaN(e.lon)?t.push({field:"lon",status:"invalid",message:"Valid longitude is required"}):e.lon<-180||e.lon>180?t.push({field:"lon",status:"invalid",message:"Longitude must be between -180 and 180"}):t.push({field:"lon",status:"valid"}),e.city?t.push({field:"city",status:"valid"}):t.push({field:"city",status:"missing",message:"City is required"}),e.state?t.push({field:"state",status:"valid"}):t.push({field:"state",status:"missing",message:"State is required"}),e.brand?t.push({field:"brand",status:"valid"}):t.push({field:"brand",status:"missing",message:"Brand is not specified"}),e.facilityType?t.push({field:"facilityType",status:"valid"}):t.push({field:"facilityType",status:"missing",message:"Facility type is not specified"}),e.status?t.push({field:"status",status:"valid"}):t.push({field:"status",status:"missing",message:"Status is not specified"}),e.counts?t.push({field:"counts",status:"valid"}):t.push({field:"counts",status:"missing",message:"Count data is missing"}),t}function p(e,t){let i={totalFacilities:e.length,totalTrucks:0,totalTrailers:0,totalGuardShacks:0,totalGates:0,totalTrailerYards:0,totalDropDocks:0,totalInboundLanes:0,totalOutboundLanes:0,networkVelocity:0};for(let t of e)i.totalTrucks+=t.counts.trucks,i.totalTrailers+=t.counts.trailers,i.totalGuardShacks+=t.counts.guardShacks,i.totalGates+=t.counts.gates,i.totalTrailerYards+=t.counts.trailerYards,i.totalDropDocks+=t.counts.dropDocks,i.totalInboundLanes+=t.counts.inboundLanes,i.totalOutboundLanes+=t.counts.outboundLanes;let r=t.reduce((e,t)=>e+t.volume,0),n=t.filter(e=>"Flow"===e.status).length,s=t.filter(e=>"Activating"===e.status).length;return i.networkVelocity=Math.round(r*(t.length>0?(n+.5*s)/t.length:0)/100),i}function g(e){switch(e?.toLowerCase().trim()){case"plant":case"manufacturing":return"Plant";case"dc":case"distribution":case"distribution center":return"DC";case"crossdock":case"cross-dock":case"cross dock":return"CrossDock";case"yard":case"trailer yard":return"Yard";case"terminal":return"Terminal";default:return"Other"}}function m(e){switch(e?.toLowerCase().trim()){case"flow":case"online":case"active":default:return"Flow";case"activating":case"pending":case"starting":return"Activating";case"chaos":case"offline":case"error":case"issue":return"Chaos"}}e.s(["FACILITY_TYPE_LABELS",0,{Plant:"Manufacturing Plant",DC:"Distribution Center",CrossDock:"Cross-Dock Facility",Yard:"Trailer Yard",Terminal:"Terminal",Other:"Other Facility"},"STATUS_COLORS",0,{Flow:"#00B4FF",Activating:"#FFB800",Chaos:"#FF2A00"},"calculateKPIs",()=>p,"defaultMapViewState",0,c,"defaultTheme",0,u,"getRegionByState",()=>d,"parseFacilityType",()=>g,"parseStatus",()=>m,"validateFacility",()=>f],32913);var y=e.i(51975),_=e.i(27131);let v=e=>{let t=e.facilities;if(e.filters.search){let i=e.filters.search.toLowerCase();t=t.filter(e=>e.name.toLowerCase().includes(i)||e.city.toLowerCase().includes(i)||e.state.toLowerCase().includes(i)||e.brand.toLowerCase().includes(i))}return e.filters.brands.length>0&&(t=t.filter(t=>e.filters.brands.includes(t.brand))),e.filters.facilityTypes.length>0&&(t=t.filter(t=>e.filters.facilityTypes.includes(t.facilityType))),e.filters.statuses.length>0&&(t=t.filter(t=>e.filters.statuses.includes(t.status))),e.filters.regions.length>0&&(t=t.filter(t=>e.filters.regions.includes(d(t.state)))),t},b=e=>{let t=new Set(v(e).map(e=>e.id));return e.lanes.filter(e=>t.has(e.fromFacilityId)&&t.has(e.toFacilityId))},x={search:"",brands:[],facilityTypes:[],statuses:[],regions:[]},w={showLanes:!0,showLabels:!0,showClusters:!0,animationEnabled:!0},k=(t?o(t):o)((i=(e,t)=>({facilities:y.default,lanes:_.default,filters:x,toggles:w,selectedFacilityId:null,isDrawerOpen:!1,isControlPanelOpen:!0,isThemeStudioOpen:!1,isCSVImportOpen:!1,mapViewState:c,theme:u,setFacilities:t=>e({facilities:t}),setLanes:t=>e({lanes:t}),loadSampleData:()=>e({facilities:y.default,lanes:_.default}),setSearch:t=>e(e=>({filters:{...e.filters,search:t}})),toggleBrand:t=>e(e=>({filters:{...e.filters,brands:e.filters.brands.includes(t)?e.filters.brands.filter(e=>e!==t):[...e.filters.brands,t]}})),toggleFacilityType:t=>e(e=>({filters:{...e.filters,facilityTypes:e.filters.facilityTypes.includes(t)?e.filters.facilityTypes.filter(e=>e!==t):[...e.filters.facilityTypes,t]}})),toggleStatus:t=>e(e=>({filters:{...e.filters,statuses:e.filters.statuses.includes(t)?e.filters.statuses.filter(e=>e!==t):[...e.filters.statuses,t]}})),toggleRegion:t=>e(e=>({filters:{...e.filters,regions:e.filters.regions.includes(t)?e.filters.regions.filter(e=>e!==t):[...e.filters.regions,t]}})),resetFilters:()=>e({filters:x}),setShowLanes:t=>e(e=>({toggles:{...e.toggles,showLanes:t}})),setShowLabels:t=>e(e=>({toggles:{...e.toggles,showLabels:t}})),setShowClusters:t=>e(e=>({toggles:{...e.toggles,showClusters:t}})),setAnimationEnabled:t=>e(e=>({toggles:{...e.toggles,animationEnabled:t}})),selectFacility:t=>e({selectedFacilityId:t,isDrawerOpen:null!==t}),setDrawerOpen:i=>e({isDrawerOpen:i,selectedFacilityId:i?t().selectedFacilityId:null}),setControlPanelOpen:t=>e({isControlPanelOpen:t}),setThemeStudioOpen:t=>e({isThemeStudioOpen:t}),setCSVImportOpen:t=>e({isCSVImportOpen:t}),setMapViewState:t=>e(e=>({mapViewState:{...e.mapViewState,...t}})),flyToFacility:t=>e({mapViewState:{longitude:t.lon,latitude:t.lat,zoom:12,pitch:45,bearing:0}}),setTheme:t=>e(e=>({theme:{...e.theme,...t}})),setThemeColors:t=>e(e=>({theme:{...e.theme,colors:{...e.theme.colors,...t}}})),setThemeTypography:t=>e(e=>({theme:{...e.theme,typography:{...e.theme.typography,...t}}})),setThemeIcons:t=>e(e=>({theme:{...e.theme,icons:{...e.theme.icons,...t}}})),setThemeLogos:t=>e(e=>({theme:{...e.theme,logos:{...e.theme.logos,...t}}})),resetTheme:()=>e({theme:u}),exportTheme:()=>JSON.stringify(t().theme,null,2),importTheme:t=>{try{let i=JSON.parse(t);if(i.colors&&i.typography&&i.icons&&i.logos)return e({theme:i}),!0;return!1}catch{return!1}}}),r={name:"primo-singularity-storage",storage:a(()=>localStorage),version:2,migrate:e=>({theme:e?.theme??u,toggles:e?.toggles??w}),partialize:e=>({theme:e.theme,toggles:e.toggles})},(e,t,n)=>{let s,o={storage:a(()=>localStorage),partialize:e=>e,version:0,merge:(e,t)=>({...t,...e}),...r},u=!1,c=new Set,h=new Set,d=o.storage;if(!d)return i((...t)=>{console.warn(`[zustand persist middleware] Unable to update item '${o.name}', the given storage is currently unavailable.`),e(...t)},t,n);let f=()=>{let e=o.partialize({...t()});return d.setItem(o.name,{state:e,version:o.version})},p=n.setState;n.setState=(e,t)=>(p(e,t),f());let g=i((...t)=>(e(...t),f()),t,n);n.getInitialState=()=>g;let m=()=>{var i,r;if(!d)return;u=!1,c.forEach(e=>{var i;return e(null!=(i=t())?i:g)});let n=(null==(r=o.onRehydrateStorage)?void 0:r.call(o,null!=(i=t())?i:g))||void 0;return l(d.getItem.bind(d))(o.name).then(e=>{if(e)if("number"!=typeof e.version||e.version===o.version)return[!1,e.state];else{if(o.migrate){let t=o.migrate(e.state,e.version);return t instanceof Promise?t.then(e=>[!0,e]):[!0,t]}console.error("State loaded from storage couldn't be migrated since no migrate function was provided")}return[!1,void 0]}).then(i=>{var r;let[n,a]=i;if(e(s=o.merge(a,null!=(r=t())?r:g),!0),n)return f()}).then(()=>{null==n||n(s,void 0),s=t(),u=!0,h.forEach(e=>e(s))}).catch(e=>{null==n||n(void 0,e)})};return n.persist={setOptions:e=>{o={...o,...e},e.storage&&(d=e.storage)},clearStorage:()=>{null==d||d.removeItem(o.name)},getOptions:()=>o,rehydrate:()=>m(),hasHydrated:()=>u,onHydrate:e=>(c.add(e),()=>{c.delete(e)}),onFinishHydration:e=>(h.add(e),()=>{h.delete(e)})},o.skipHydration||m(),s||g}));e.s(["selectFilteredFacilities",0,v,"selectFilteredLanes",0,b,"selectKPIs",0,e=>p(v(e),b(e)),"selectSelectedFacility",0,e=>e.selectedFacilityId&&e.facilities.find(t=>t.id===e.selectedFacilityId)||null,"selectUniqueBrands",0,e=>[...new Set(e.facilities.map(e=>e.brand))].sort(),"selectUniqueRegions",0,e=>[...new Set(e.facilities.map(e=>d(e.state)))].sort(),"usePrimoStore",0,k],72015)},62805,53817,86469,98677,45015,90459,89708,e=>{"use strict";let t,i,r,n,s,o,a,l;var u,c,h,d,f,p,g,m,y,_,v,b,x,w,k,T,S,P,E,C=e.i(71645);let I=C.createContext(null);function A(e,t){if(e===t)return!0;if(!e||!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!A(e[i],t[i]))return!1;return!0}if(Array.isArray(t))return!1;if("object"==typeof e&&"object"==typeof t){let i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(let r of i)if(!t.hasOwnProperty(r)||!A(e[r],t[r]))return!1;return!0}return!1}function M(e){return{longitude:e.center.lng,latitude:e.center.lat,zoom:e.zoom,pitch:e.pitch,bearing:e.bearing,padding:e.padding}}function L(e,t){let i=t.viewState||t,r={};return"longitude"in i&&"latitude"in i&&(i.longitude!==e.center.lng||i.latitude!==e.center.lat)&&(r.center=new e.center.constructor(i.longitude,i.latitude)),"zoom"in i&&i.zoom!==e.zoom&&(r.zoom=i.zoom),"bearing"in i&&i.bearing!==e.bearing&&(r.bearing=i.bearing),"pitch"in i&&i.pitch!==e.pitch&&(r.pitch=i.pitch),i.padding&&e.padding&&!A(i.padding,e.padding)&&(r.padding=i.padding),r}let O=["type","source","source-layer","minzoom","maxzoom","filter","layout"];function R(e){if(!e)return null;if("string"==typeof e||("toJS"in e&&(e=e.toJS()),!e.layers))return e;let t={};for(let i of e.layers)t[i.id]=i;let i=e.layers.map(e=>{let i=null;"interactive"in e&&(i=Object.assign({},e),delete i.interactive);let r=t[e.ref];if(r)for(let t of(i=i||Object.assign({},e),delete i.ref,O))t in r&&(i[t]=r[t]);return i||e});return{...e,layers:i}}let D={version:8,sources:{},layers:[]},F={mousedown:"onMouseDown",mouseup:"onMouseUp",mouseover:"onMouseOver",mousemove:"onMouseMove",click:"onClick",dblclick:"onDblClick",mouseenter:"onMouseEnter",mouseleave:"onMouseLeave",mouseout:"onMouseOut",contextmenu:"onContextMenu",touchstart:"onTouchStart",touchend:"onTouchEnd",touchmove:"onTouchMove",touchcancel:"onTouchCancel"},N={movestart:"onMoveStart",move:"onMove",moveend:"onMoveEnd",dragstart:"onDragStart",drag:"onDrag",dragend:"onDragEnd",zoomstart:"onZoomStart",zoom:"onZoom",zoomend:"onZoomEnd",rotatestart:"onRotateStart",rotate:"onRotate",rotateend:"onRotateEnd",pitchstart:"onPitchStart",pitch:"onPitch",pitchend:"onPitchEnd"},j={wheel:"onWheel",boxzoomstart:"onBoxZoomStart",boxzoomend:"onBoxZoomEnd",boxzoomcancel:"onBoxZoomCancel",resize:"onResize",load:"onLoad",render:"onRender",idle:"onIdle",remove:"onRemove",data:"onData",styledata:"onStyleData",sourcedata:"onSourceData",error:"onError"},z=["minZoom","maxZoom","minPitch","maxPitch","maxBounds","projection","renderWorldCopies"],U=["scrollZoom","boxZoom","dragRotate","dragPan","keyboard","doubleClickZoom","touchZoomRotate","touchPitch"];class B{constructor(e,t,i){this._map=null,this._internalUpdate=!1,this._hoveredFeatures=null,this._propsedCameraUpdate=null,this._styleComponents={},this._onEvent=e=>{let t=this.props[j[e.type]];t?t(e):"error"===e.type&&console.error(e.error)},this._onCameraEvent=e=>{if(this._internalUpdate)return;e.viewState=this._propsedCameraUpdate||M(this._map.transform);let t=this.props[N[e.type]];t&&t(e)},this._onCameraUpdate=e=>this._internalUpdate?e:(this._propsedCameraUpdate=M(e),L(e,this.props)),this._onPointerEvent=e=>{("mousemove"===e.type||"mouseout"===e.type)&&this._updateHover(e);let t=this.props[F[e.type]];t&&(this.props.interactiveLayerIds&&"mouseover"!==e.type&&"mouseout"!==e.type&&(e.features=this._hoveredFeatures||this._queryRenderedFeatures(e.point)),t(e),delete e.features)},this._MapClass=e,this.props=t,this._initialize(i)}get map(){return this._map}setProps(e){let t=this.props;this.props=e;let i=this._updateSettings(e,t),r=this._updateSize(e),n=this._updateViewState(e);this._updateStyle(e,t),this._updateStyleComponents(e),this._updateHandlers(e,t),(i||r||n&&!this._map.isMoving())&&this.redraw()}static reuse(e,t){let i=B.savedMaps.pop();if(!i)return null;let r=i.map,n=r.getContainer();for(t.className=n.className;n.childNodes.length>0;)t.appendChild(n.childNodes[0]);r._container=t;let s=r._resizeObserver;s&&(s.disconnect(),s.observe(t)),i.setProps({...e,styleDiffing:!1}),r.resize();let{initialViewState:o}=e;return o&&(o.bounds?r.fitBounds(o.bounds,{...o.fitBoundsOptions,duration:0}):i._updateViewState(o)),r.isStyleLoaded()?r.fire("load"):r.once("style.load",()=>r.fire("load")),r._update(),i}_initialize(e){let{props:t}=this,{mapStyle:i=D}=t,r={...t,...t.initialViewState,container:e,style:R(i)},n=r.initialViewState||r.viewState||r;if(Object.assign(r,{center:[n.longitude||0,n.latitude||0],zoom:n.zoom||0,pitch:n.pitch||0,bearing:n.bearing||0}),t.gl){let e=HTMLCanvasElement.prototype.getContext;HTMLCanvasElement.prototype.getContext=()=>(HTMLCanvasElement.prototype.getContext=e,t.gl)}let s=new this._MapClass(r);for(let e in n.padding&&s.setPadding(n.padding),t.cursor&&(s.getCanvas().style.cursor=t.cursor),s.transformCameraUpdate=this._onCameraUpdate,s.on("style.load",()=>{this._styleComponents={light:s.getLight(),sky:s.getSky(),projection:s.getProjection?.(),terrain:s.getTerrain()},this._updateStyleComponents(this.props)}),s.on("sourcedata",()=>{this._updateStyleComponents(this.props)}),F)s.on(e,this._onPointerEvent);for(let e in N)s.on(e,this._onCameraEvent);for(let e in j)s.on(e,this._onEvent);this._map=s}recycle(){let e=this.map.getContainer().querySelector("[mapboxgl-children]");e?.remove(),B.savedMaps.push(this)}destroy(){this._map.remove()}redraw(){let e=this._map;e.style&&(e._frame&&(e._frame.cancel(),e._frame=null),e._render())}_updateSize(e){let{viewState:t}=e;if(t){let e=this._map;if(t.width!==e.transform.width||t.height!==e.transform.height)return e.resize(),!0}return!1}_updateViewState(e){let t=this._map,i=t.transform;if(!t.isMoving()){let r=L(i,e);if(Object.keys(r).length>0)return this._internalUpdate=!0,t.jumpTo(r),this._internalUpdate=!1,!0}return!1}_updateSettings(e,t){let i=this._map,r=!1;for(let n of z)if(n in e&&!A(e[n],t[n])){r=!0;let t=i[`set${n[0].toUpperCase()}${n.slice(1)}`];t?.call(i,e[n])}return r}_updateStyle(e,t){if(e.cursor!==t.cursor&&(this._map.getCanvas().style.cursor=e.cursor||""),e.mapStyle!==t.mapStyle){let{mapStyle:t=D,styleDiffing:i=!0}=e,r={diff:i};"localIdeographFontFamily"in e&&(r.localIdeographFontFamily=e.localIdeographFontFamily),this._map.setStyle(R(t),r)}}_updateStyleComponents({light:e,projection:t,sky:i,terrain:r}){let n=this._map,s=this._styleComponents;n.style._loaded&&(e&&!A(e,s.light)&&(s.light=e,n.setLight(e)),t&&!A(t,s.projection)&&t!==s.projection?.type&&(s.projection="string"==typeof t?{type:t}:t,n.setProjection?.(s.projection)),i&&!A(i,s.sky)&&(s.sky=i,n.setSky(i)),void 0!==r&&!A(r,s.terrain)&&(!r||n.getSource(r.source))&&(s.terrain=r,n.setTerrain(r)))}_updateHandlers(e,t){let i=this._map;for(let r of U){let n=e[r]??!0;A(n,t[r]??!0)||(n?i[r].enable(n):i[r].disable())}}_queryRenderedFeatures(e){let t=this._map,{interactiveLayerIds:i=[]}=this.props;try{return t.queryRenderedFeatures(e,{layers:i.filter(t.getLayer.bind(t))})}catch{return[]}}_updateHover(e){let{props:t}=this;if(t.interactiveLayerIds&&(t.onMouseMove||t.onMouseEnter||t.onMouseLeave)){let t=e.type,i=this._hoveredFeatures?.length>0,r=this._queryRenderedFeatures(e.point),n=r.length>0;!n&&i&&(e.type="mouseleave",this._onPointerEvent(e)),this._hoveredFeatures=r,n&&!i&&(e.type="mouseenter",this._onPointerEvent(e)),e.type=t}else this._hoveredFeatures=null}}B.savedMaps=[];let $=["setMaxBounds","setMinZoom","setMaxZoom","setMinPitch","setMaxPitch","setRenderWorldCopies","setProjection","setStyle","addSource","removeSource","addLayer","removeLayer","setLayerZoomRange","setFilter","setPaintProperty","setLayoutProperty","setLight","setTerrain","setFog","remove"],V="undefined"!=typeof document?C.useLayoutEffect:C.useEffect,W=C.createContext(null),G=C.forwardRef(function(t,i){let r=(0,C.useContext)(I),[n,s]=(0,C.useState)(null),o=(0,C.useRef)(),{current:a}=(0,C.useRef)({mapLib:null,map:null});(0,C.useEffect)(()=>{let i,n=t.mapLib,l=!0;return Promise.resolve(n||e.A(53102)).then(e=>{if(!l)return;if(!e)throw Error("Invalid mapLib");let n="Map"in e?e:e.default;if(!n.Map)throw Error("Invalid mapLib");!function(e,t){let{RTLTextPlugin:i,maxParallelImageRequests:r,workerCount:n,workerUrl:s}=t;if(i&&e.getRTLTextPluginStatus&&"unavailable"===e.getRTLTextPluginStatus()){let{pluginUrl:t,lazy:r=!0}="string"==typeof i?{pluginUrl:i}:i;e.setRTLTextPlugin(t,e=>{e&&console.error(e)},r)}void 0!==r&&e.setMaxParallelImageRequests(r),void 0!==n&&e.setWorkerCount(n),void 0!==s&&e.setWorkerUrl(s)}(n,t),t.reuseMaps&&(i=B.reuse(t,o.current)),i||(i=new B(n.Map,t,o.current)),a.map=function(e){if(!e)return null;let t=e.map,i={getMap:()=>t};for(let e of function(e){let t=new Set,i=e;for(;i;){for(let r of Object.getOwnPropertyNames(i))"_"!==r[0]&&"function"==typeof e[r]&&"fire"!==r&&"setEventedParent"!==r&&t.add(r);i=Object.getPrototypeOf(i)}return Array.from(t)}(t))e in i||$.includes(e)||(i[e]=t[e].bind(t));return i}(i),a.mapLib=n,s(i),r?.onMapMount(a.map,t.id)}).catch(e=>{let{onError:i}=t;i?i({type:"error",target:null,originalEvent:null,error:e}):console.error(e)}),()=>{l=!1,i&&(r?.onMapUnmount(t.id),t.reuseMaps?i.recycle():i.destroy())}},[]),V(()=>{n&&n.setProps(t)}),(0,C.useImperativeHandle)(i,()=>a.map,[n]);let l=(0,C.useMemo)(()=>({position:"relative",width:"100%",height:"100%",...t.style}),[t.style]);return C.createElement("div",{id:t.id,ref:o,style:l},n&&C.createElement(W.Provider,{value:a},C.createElement("div",{"mapboxgl-children":"",style:{height:"100%"}},t.children)))});var q=e.i(74080);let H=/box|flex|grid|column|lineHeight|fontWeight|opacity|order|tabSize|zIndex/;function Y(e,t){if(!e||!t)return;let i=e.style;for(let e in t){let r=t[e];Number.isFinite(r)&&!H.test(e)?i[e]=`${r}px`:i[e]=r}}function X(e,t){if(e===t)return null;let i=Z(e),r=Z(t),n=[];for(let e of r)i.has(e)||n.push(e);for(let e of i)r.has(e)||n.push(e);return 0===n.length?null:n}function Z(e){return new Set(e?e.trim().split(/\s+/):[])}function K(e,t,i,r){let n=(0,C.useContext)(W),s=(0,C.useMemo)(()=>e(n),[]);return(0,C.useEffect)(()=>{let e="function"==typeof t&&"function"==typeof i?t:null,o="function"==typeof i?i:"function"==typeof t?t:null,{map:a}=n;return!a.hasControl(s)&&(a.addControl(s,(r||i||t)?.position),e&&e(n)),()=>{o&&o(n),a.hasControl(s)&&a.removeControl(s)}},[]),s}(0,C.memo)((0,C.forwardRef)((e,t)=>{var i;let r,n,s,o,{map:a,mapLib:l}=(0,C.useContext)(W),u=(0,C.useRef)({props:e}),c=(0,C.useMemo)(()=>{let t=!1;C.Children.forEach(e.children,e=>{e&&(t=!0)});let i={...e,element:t?document.createElement("div"):void 0},r=new l.Marker(i);return r.setLngLat([e.longitude,e.latitude]),r.getElement().addEventListener("click",e=>{u.current.props.onClick?.({type:"click",target:r,originalEvent:e})}),r.on("dragstart",e=>{e.lngLat=c.getLngLat(),u.current.props.onDragStart?.(e)}),r.on("drag",e=>{e.lngLat=c.getLngLat(),u.current.props.onDrag?.(e)}),r.on("dragend",e=>{e.lngLat=c.getLngLat(),u.current.props.onDragEnd?.(e)}),r},[]);(0,C.useEffect)(()=>(c.addTo(a.getMap()),()=>{c.remove()}),[]);let{longitude:h,latitude:d,offset:f,style:p,draggable:g=!1,popup:m=null,rotation:y=0,rotationAlignment:_="auto",pitchAlignment:v="auto"}=e;(0,C.useEffect)(()=>{Y(c.getElement(),p)},[p]),(0,C.useImperativeHandle)(t,()=>c,[]);let b=u.current.props;(c.getLngLat().lng!==h||c.getLngLat().lat!==d)&&c.setLngLat([h,d]),f&&(i=c.getOffset(),r=Array.isArray(i)?i[0]:i?i.x:0,n=Array.isArray(i)?i[1]:i?i.y:0,s=Array.isArray(f)?f[0]:f?f.x:0,o=Array.isArray(f)?f[1]:f?f.y:0,r!==s||n!==o)&&c.setOffset(f),c.isDraggable()!==g&&c.setDraggable(g),c.getRotation()!==y&&c.setRotation(y),c.getRotationAlignment()!==_&&c.setRotationAlignment(_),c.getPitchAlignment()!==v&&c.setPitchAlignment(v),c.getPopup()!==m&&c.setPopup(m);let x=X(b.className,e.className);if(x)for(let e of x)c.toggleClassName(e);return u.current.props=e,(0,q.createPortal)(e.children,c.getElement())})),(0,C.memo)((0,C.forwardRef)((e,t)=>{let{map:i,mapLib:r}=(0,C.useContext)(W),n=(0,C.useMemo)(()=>document.createElement("div"),[]),s=(0,C.useRef)({props:e}),o=(0,C.useMemo)(()=>{let t={...e},i=new r.Popup(t);return i.setLngLat([e.longitude,e.latitude]),i.once("open",e=>{s.current.props.onOpen?.(e)}),i},[]);if((0,C.useEffect)(()=>{let e=e=>{s.current.props.onClose?.(e)};return o.on("close",e),o.setDOMContent(n).addTo(i.getMap()),()=>{o.off("close",e),o.isOpen()&&o.remove()}},[]),(0,C.useEffect)(()=>{Y(o.getElement(),e.style)},[e.style]),(0,C.useImperativeHandle)(t,()=>o,[]),o.isOpen()){let t=s.current.props;(o.getLngLat().lng!==e.longitude||o.getLngLat().lat!==e.latitude)&&o.setLngLat([e.longitude,e.latitude]),e.offset&&!A(t.offset,e.offset)&&o.setOffset(e.offset),(t.anchor!==e.anchor||t.maxWidth!==e.maxWidth)&&(o.options.anchor=e.anchor,o.setMaxWidth(e.maxWidth));let i=X(t.className,e.className);if(i)for(let e of i)o.toggleClassName(e);s.current.props=e}return(0,q.createPortal)(e.children,n)})),(0,C.memo)(function(e){let t=K(({mapLib:t})=>new t.AttributionControl(e),{position:e.position});return(0,C.useEffect)(()=>{Y(t._container,e.style)},[e.style]),null}),(0,C.memo)(function(e){let t=K(({mapLib:t})=>new t.FullscreenControl({container:e.containerId&&document.getElementById(e.containerId)}),{position:e.position});return(0,C.useEffect)(()=>{Y(t._controlContainer,e.style)},[e.style]),null}),(0,C.memo)((0,C.forwardRef)(function(e,t){let i=(0,C.useRef)({props:e}),r=K(({mapLib:t})=>{let r=new t.GeolocateControl(e),n=r._setupUI;return r._setupUI=()=>{r._container.hasChildNodes()||n()},r.on("geolocate",e=>{i.current.props.onGeolocate?.(e)}),r.on("error",e=>{i.current.props.onError?.(e)}),r.on("outofmaxbounds",e=>{i.current.props.onOutOfMaxBounds?.(e)}),r.on("trackuserlocationstart",e=>{i.current.props.onTrackUserLocationStart?.(e)}),r.on("trackuserlocationend",e=>{i.current.props.onTrackUserLocationEnd?.(e)}),r},{position:e.position});return i.current.props=e,(0,C.useImperativeHandle)(t,()=>r,[]),(0,C.useEffect)(()=>{Y(r._container,e.style)},[e.style]),null}));let J=(0,C.memo)(function(e){let t=K(({mapLib:t})=>new t.NavigationControl(e),{position:e.position});return(0,C.useEffect)(()=>{Y(t._container,e.style)},[e.style]),null}),Q=(0,C.memo)(function(e){let t=K(({mapLib:t})=>new t.ScaleControl(e),{position:e.position}),i=(0,C.useRef)(e),r=i.current;i.current=e;let{style:n}=e;return void 0!==e.maxWidth&&e.maxWidth!==r.maxWidth&&(t.options.maxWidth=e.maxWidth),void 0!==e.unit&&e.unit!==r.unit&&t.setUnit(e.unit),(0,C.useEffect)(()=>{Y(t._container,n)},[n]),null});(0,C.memo)(function(e){let t=K(({mapLib:t})=>new t.TerrainControl(e),{position:e.position});return(0,C.useEffect)(()=>{Y(t._container,e.style)},[e.style]),null}),(0,C.memo)(function(e){let t=K(({mapLib:t})=>new t.LogoControl(e),{position:e.position});return(0,C.useEffect)(()=>{Y(t._container,e.style)},[e.style]),null}),e.s([],72877),e.s([],30233),e.s([],37838),e.s([],89918),e.s(["default",0,G],17662),e.s([],62805),e.s(["default",0,G],53817),e.i(17662),e.i(72877),e.i(30233),e.i(37838),e.i(89918),e.s(["NavigationControl",0,J,"ScaleControl",0,Q],86469);let ee=1,et=1;class ei{time=0;channels=new Map;animations=new Map;playing=!1;lastEngineTime=-1;addChannel(e){let{delay:t=0,duration:i=1/0,rate:r=1,repeat:n=1}=e,s=ee++,o={time:0,delay:t,duration:i,rate:r,repeat:n};return this._setChannelTime(o,this.time),this.channels.set(s,o),s}removeChannel(e){for(let[t,i]of(this.channels.delete(e),this.animations))i.channel===e&&this.detachAnimation(t)}isFinished(e){let t=this.channels.get(e);return void 0!==t&&this.time>=t.delay+t.duration*t.repeat}getTime(e){if(void 0===e)return this.time;let t=this.channels.get(e);return void 0===t?-1:t.time}setTime(e){for(let t of(this.time=Math.max(0,e),this.channels.values()))this._setChannelTime(t,this.time);for(let e of this.animations.values()){let{animation:t,channel:i}=e;t.setTime(this.getTime(i))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){let i=et++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(-1===this.lastEngineTime&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){let i=t-e.delay;i>=e.duration*e.repeat?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}}let er={number:{type:"number",validate:(e,t)=>Number.isFinite(e)&&"object"==typeof t&&(void 0===t.max||e<=t.max)&&(void 0===t.min||e>=t.min)},array:{type:"array",validate:(e,t)=>Array.isArray(e)||ArrayBuffer.isView(e)}};function en(e){return Array.isArray(e)||ArrayBuffer.isView(e)?"array":typeof e}let es={vertex:`\
#ifdef MODULE_LOGDEPTH
  logdepth_adjustPosition(gl_Position);
#endif
`,fragment:`\
#ifdef MODULE_MATERIAL
  fragColor = material_filterColor(fragColor);
#endif

#ifdef MODULE_LIGHTING
  fragColor = lighting_filterColor(fragColor);
#endif

#ifdef MODULE_FOG
  fragColor = fog_filterColor(fragColor);
#endif

#ifdef MODULE_PICKING
  fragColor = picking_filterHighlightColor(fragColor);
  fragColor = picking_filterPickingColor(fragColor);
#endif

#ifdef MODULE_LOGDEPTH
  logdepth_setFragDepth();
#endif
`},eo=/void\s+main\s*\([^)]*\)\s*\{\n?/,ea=/}\n?[^{}]*$/,el=[],eu="__LUMA_INJECT_DECLARATIONS__";function ec(e,t,i,r=!1){let n="vertex"===t;for(let t in i){let r=i[t];r.sort((e,t)=>e.order-t.order),el.length=r.length;for(let e=0,t=r.length;e<t;++e)el[e]=r[e].injection;let s=`${el.join("\n")}
`;switch(t){case"vs:#decl":n&&(e=e.replace(eu,s));break;case"vs:#main-start":n&&(e=e.replace(eo,e=>e+s));break;case"vs:#main-end":n&&(e=e.replace(ea,e=>s+e));break;case"fs:#decl":n||(e=e.replace(eu,s));break;case"fs:#main-start":n||(e=e.replace(eo,e=>e+s));break;case"fs:#main-end":n||(e=e.replace(ea,e=>s+e));break;default:e=e.replace(t,e=>e+s)}}return e=e.replace(eu,""),r&&(e=e.replace(/\}\s*$/,e=>e+es[t])),e}function eh(e){e.map(e=>(function(e){var t;if(e.instance)return;eh(e.dependencies||[]);let{propTypes:i={},deprecations:r=[],inject:n={}}=e,s={normalizedInjections:function(e){let t={vertex:{},fragment:{}};for(let i in e){let r=e[i];"string"==typeof r&&(r={order:0,injection:r}),t[function(e){let t=e.slice(0,2);switch(t){case"vs":return"vertex";case"fs":return"fragment";default:throw Error(t)}}(i)][i]=r}return t}(n),parsedDeprecations:((t=r).forEach(e=>{"function"===e.type?e.regex=RegExp(`\\b${e.old}\\(`):e.regex=RegExp(`${e.type} ${e.old};`)}),t)};i&&(s.propValidators=function(e){let t={};for(let[i,r]of Object.entries(e))t[i]=function(e){let t=en(e);if("object"!==t)return{value:e,...er[t],type:t};if("object"==typeof e)return e?void 0!==e.type?{...e,...er[e.type],type:e.type}:void 0===e.value?{type:"object",value:e}:(t=en(e.value),{...e,...er[t],type:t}):{type:"object",value:null};throw Error("props")}(r);return t}(i)),e.instance=s;let o={};i&&(o=Object.entries(i).reduce((e,[t,i])=>{let r=i?.value;return r&&(e[t]=r),e},{})),e.defaultUniforms={...e.defaultUniforms,...o}})(e))}function ed(e,t,i){e.deprecations?.forEach(e=>{e.regex?.test(t)&&(e.deprecated?i.deprecated(e.old,e.new)():i.removed(e.old,e.new)())})}function ef(e){eh(e);let t={},i={};!function e(t){let{modules:i,level:r,moduleMap:n,moduleDepth:s}=t;if(r>=5)throw Error("Possible loop in shader dependency graph");for(let e of i)n[e.name]=e,(void 0===s[e.name]||s[e.name]<r)&&(s[e.name]=r);for(let t of i)t.dependencies&&e({modules:t.dependencies,level:r+1,moduleMap:n,moduleDepth:s})}({modules:e,level:0,moduleMap:t,moduleDepth:i});let r=Object.keys(i).sort((e,t)=>i[t]-i[e]).map(e=>t[e]);return eh(r),r}let ep=[[/^(#version[ \t]+(100|300[ \t]+es))?[ \t]*\n/,"#version 300 es\n"],[/\btexture(2D|2DProj|Cube)Lod(EXT)?\(/g,"textureLod("],[/\btexture(2D|2DProj|Cube)(EXT)?\(/g,"texture("]],eg=[...ep,[e_("attribute"),"in $1"],[e_("varying"),"out $1"]],em=[...ep,[e_("varying"),"in $1"]];function ey(e,t){for(let[i,r]of t)e=e.replace(i,r);return e}function e_(e){return RegExp(`\\b${e}[ \\t]+(\\w+[ \\t]+\\w+(\\[\\w+\\])?;)`,"g")}function ev(e,t){let i="";for(let r in e){let n=e[r];if(i+=`void ${n.signature} {
`,n.header&&(i+=`  ${n.header}`),t[r]){let e=t[r];for(let t of(e.sort((e,t)=>e.order-t.order),e))i+=`  ${t.injection}
`}n.footer&&(i+=`  ${n.footer}`),i+="}\n"}return i}function eb(e){let t={vertex:{},fragment:{}};for(let i of e){let e,r;"string"!=typeof i?r=(e=i).hook:(e={},r=i);let[n,s]=(r=r.trim()).split(":"),o=r.replace(/\(.+/,""),a=Object.assign(e,{signature:s});switch(n){case"vs":t.vertex[o]=a;break;case"fs":t.fragment[o]=a;break;default:throw Error(n)}}return t}function ex(e,t){if(!e)throw Error(t||"shadertools: assertion failed.")}let ew=`

${eu}
`,ek=`\
precision highp float;
`;function eT(e,t){let{source:i,stage:r,language:n="glsl",modules:s,defines:o={},hookFunctions:a=[],inject:l={},prologue:u=!0,log:c}=t;ex("string"==typeof i,"shader source must be a string");let h="glsl"===n?({name:function(e,t="unnamed"){let i=/#define[^\S\r\n]*SHADER_NAME[^\S\r\n]*([A-Za-z0-9_-]+)\s*/.exec(e);return i?i[1]:t}(i,void 0),language:"glsl",version:function(e){let t=100,i=e.match(/[^\s]+/g);if(i&&i.length>=2&&"#version"===i[0]){let e=parseInt(i[1],10);Number.isFinite(e)&&(t=e)}if(100!==t&&300!==t)throw Error(`Invalid GLSL version ${t}`);return t}(i)}).version:-1,d=e.shaderLanguageVersion,f=100===h?"#version 100":"#version 300 es",p=i.split("\n").slice(1).join("\n"),g={};s.forEach(e=>{Object.assign(g,e.defines)}),Object.assign(g,o);let m="";switch(n){case"wgsl":break;case"glsl":m=u?`\
${f}

// ----- PROLOGUE -------------------------
#define SHADER_TYPE_${r.toUpperCase()}

${function(e){switch(e?.gpu.toLowerCase()){case"apple":return`\
#define APPLE_GPU
// Apple optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"nvidia":return`\
#define NVIDIA_GPU
// Nvidia optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
`;case"intel":return`\
#define INTEL_GPU
// Intel optimizes away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Intel's built-in 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// Intel GPU doesn't have full 32 bits precision in same cases, causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`;case"amd":return`\
#define AMD_GPU
`;default:return`\
#define DEFAULT_GPU
// Prevent driver from optimizing away the calculation necessary for emulated fp64
#define LUMA_FP64_CODE_ELIMINATION_WORKAROUND 1
// Headless Chrome's software shader 'tan' function doesn't have acceptable precision
#define LUMA_FP32_TAN_PRECISION_WORKAROUND 1
// If the GPU doesn't have full 32 bits precision, will causes overflow
#define LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND 1
`}}(e)}
${"fragment"===r?ek:""}

// ----- APPLICATION DEFINES -------------------------

${function(e={}){let t="";for(let i in e){let r=e[i];(r||Number.isFinite(r))&&(t+=`#define ${i.toUpperCase()} ${e[i]}
`)}return t}(g)}

`:`${f}
`}let y=eb(a),_={},v={},b={};for(let e in l){let t="string"==typeof l[e]?{injection:l[e],order:0}:l[e],i=/^(v|f)s:(#)?([\w-]+)$/.exec(e);if(i){let r=i[2],n=i[3];r?"decl"===n?v[e]=[t]:b[e]=[t]:_[e]=[t]}else b[e]=[t]}for(let e of s){c&&ed(e,p,c),m+=eP(e,r);let t=e.instance?.normalizedInjections[r]||{};for(let e in t){let i=/^(v|f)s:#([\w-]+)$/.exec(e);if(i){let r="decl"===i[2]?v:b;r[e]=r[e]||[],r[e].push(t[e])}else _[e]=_[e]||[],_[e].push(t[e])}}return m+="// ----- MAIN SHADER SOURCE -------------------------",m+=ew,m=ec(m,r,v)+ev(y[r],_)+p,m=ec(m,r,b),"glsl"===n&&h!==d&&(m=function(e,t){if(300!==Number(e.match(/^#version[ \t]+(\d+)/m)?.[1]||100))throw Error("luma.gl v9 only supports GLSL 3.00 shader sources");switch(t){case"vertex":return ey(e,eg);case"fragment":return ey(e,em);default:throw Error(t)}}(m,r)),m.trim()}function eS(e){return function(t){let i={};for(let r of e){let e=r.getUniforms?.(t,i);Object.assign(i,e)}return i}}function eP(e,t){let i;switch(t){case"vertex":i=e.vs||"";break;case"fragment":i=e.fs||"";break;case"wgsl":i=e.source||"";break;default:ex(!1)}if(!e.name)throw Error("Shader module must have a name");let r=e.name.toUpperCase().replace(/[^0-9a-z]/gi,"_"),n=`\
// ----- MODULE ${e.name} ---------------

`;return"wgsl"!==t&&(n+=`#define MODULE_${r}
`),n+=`${i}
`}let eE=/^\s*\#\s*ifdef\s*([a-zA-Z_]+)\s*$/,eC=/^\s*\#\s*endif\s*$/;class eI{static defaultShaderAssembler;_hookFunctions=[];_defaultModules=[];static getDefaultShaderAssembler(){return eI.defaultShaderAssembler=eI.defaultShaderAssembler||new eI,eI.defaultShaderAssembler}addDefaultModule(e){this._defaultModules.find(t=>t.name===("string"==typeof e?e:e.name))||this._defaultModules.push(e)}removeDefaultModule(e){let t="string"==typeof e?e:e.name;this._defaultModules=this._defaultModules.filter(e=>e.name!==t)}addShaderHook(e,t){t&&(e=Object.assign(t,{hook:e})),this._hookFunctions.push(e)}assembleWGSLShader(e){var t;let i,r=this._getModuleList(e.modules),n=this._hookFunctions,{source:s,getUniforms:o}=(i=ef((t={...e,source:e.source,modules:r,hookFunctions:n}).modules||[]),{source:function(e,t){let{source:i,stage:r,modules:n,hookFunctions:s=[],inject:o={},log:a}=t;ex("string"==typeof i,"shader source must be a string");let l="",u=eb(s),c={},h={},d={};for(let e in o){let t="string"==typeof o[e]?{injection:o[e],order:0}:o[e],i=/^(v|f)s:(#)?([\w-]+)$/.exec(e);if(i){let r=i[2],n=i[3];r?"decl"===n?h[e]=[t]:d[e]=[t]:c[e]=[t]}else d[e]=[t]}for(let e of n){a&&ed(e,i,a),l+=eP(e,"wgsl");let t=e.injections?.[r]||{};for(let e in t){let i=/^(v|f)s:#([\w-]+)$/.exec(e);if(i){let r="decl"===i[2]?h:d;r[e]=r[e]||[],r[e].push(t[e])}else c[e]=c[e]||[],c[e].push(t[e])}}return l+=ew,l=ec(l,r,h)+ev(u[r],c)+i,l=ec(l,r,d)}(t.platformInfo,{...t,source:t.source,stage:"vertex",modules:i}),getUniforms:eS(i)});return{source:"wgsl"===e.platformInfo.shaderLanguage?function(e,t){let i=e.split("\n"),r=[],n=!0;for(let e of i){let t=e.match(eE),i=e.match(eC);t?(t[1],n=!1):i?n=!0:n&&r.push(e)}return r.join("\n")}(s):s,getUniforms:o,modules:r}}assembleGLSLShaderPair(e){let t=this._getModuleList(e.modules),i=this._hookFunctions;return{...function(e){let{vs:t,fs:i}=e,r=ef(e.modules||[]);return{vs:eT(e.platformInfo,{...e,source:t,stage:"vertex",modules:r}),fs:eT(e.platformInfo,{...e,source:i,stage:"fragment",modules:r}),getUniforms:eS(r)}}({...e,vs:e.vs,fs:e.fs,modules:t,hookFunctions:i}),modules:t}}_getModuleList(e=[]){let t=Array(this._defaultModules.length+e.length),i={},r=0;for(let e=0,n=this._defaultModules.length;e<n;++e){let n=this._defaultModules[e],s=n.name;t[r++]=n,i[s]=!0}for(let n=0,s=e.length;n<s;++n){let s=e[n],o=s.name;i[o]||(t[r++]=s,i[o]=!0)}return t.length=r,eh(t),t}}var eA=e.i(12828);let eM=`\
precision highp int;

// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  vec3 color;
};

struct PointLight {
  vec3 color;
  vec3 position;
  vec3 attenuation; // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  vec3 color;
  vec3 direction;
};

uniform lightingUniforms {
  int enabled;
  int lightType;

  int directionalLightCount;
  int pointLightCount;

  vec3 ambientColor;

  vec3 lightColor0;
  vec3 lightPosition0;
  vec3 lightDirection0;
  vec3 lightAttenuation0;

  vec3 lightColor1;
  vec3 lightPosition1;
  vec3 lightDirection1;
  vec3 lightAttenuation1;

  vec3 lightColor2;
  vec3 lightPosition2;
  vec3 lightDirection2;
  vec3 lightAttenuation2;
} lighting;

PointLight lighting_getPointLight(int index) {
  switch (index) {
    case 0:
      return PointLight(lighting.lightColor0, lighting.lightPosition0, lighting.lightAttenuation0);
    case 1:
      return PointLight(lighting.lightColor1, lighting.lightPosition1, lighting.lightAttenuation1);
    case 2:
    default:  
      return PointLight(lighting.lightColor2, lighting.lightPosition2, lighting.lightAttenuation2);
  }
}

DirectionalLight lighting_getDirectionalLight(int index) {
  switch (index) {
    case 0:
      return DirectionalLight(lighting.lightColor0, lighting.lightDirection0);
    case 1:
      return DirectionalLight(lighting.lightColor1, lighting.lightDirection1);
    case 2:
    default:   
      return DirectionalLight(lighting.lightColor2, lighting.lightDirection2);
  }
} 

float getPointLightAttenuation(PointLight pointLight, float distance) {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}

// #endif
`,eL=`\
// #if (defined(SHADER_TYPE_FRAGMENT) && defined(LIGHTING_FRAGMENT)) || (defined(SHADER_TYPE_VERTEX) && defined(LIGHTING_VERTEX))
struct AmbientLight {
  color: vec3<f32>,
};

struct PointLight {
  color: vec3<f32>,
  position: vec3<f32>,
  attenuation: vec3<f32>, // 2nd order x:Constant-y:Linear-z:Exponential
};

struct DirectionalLight {
  color: vec3<f32>,
  direction: vec3<f32>,
};

struct lightingUniforms {
  enabled: i32,
  pointLightCount: i32,
  directionalLightCount: i32,

  ambientColor: vec3<f32>,

  // TODO - support multiple lights by uncommenting arrays below
  lightType: i32,
  lightColor: vec3<f32>,
  lightDirection: vec3<f32>,
  lightPosition: vec3<f32>,
  lightAttenuation: vec3<f32>,

  // AmbientLight ambientLight;
  // PointLight pointLight[MAX_LIGHTS];
  // DirectionalLight directionalLight[MAX_LIGHTS];
};

// Binding 0:1 is reserved for lighting (Note: could go into separate bind group as it is stable across draw calls)
@binding(1) @group(0) var<uniform> lighting : lightingUniforms;

fn lighting_getPointLight(index: i32) -> PointLight {
  return PointLight(lighting.lightColor, lighting.lightPosition, lighting.lightAttenuation);
}

fn lighting_getDirectionalLight(index: i32) -> DirectionalLight {
  return DirectionalLight(lighting.lightColor, lighting.lightDirection);
} 

fn getPointLightAttenuation(pointLight: PointLight, distance: f32) -> f32 {
  return pointLight.attenuation.x
       + pointLight.attenuation.y * distance
       + pointLight.attenuation.z * distance * distance;
}
`;(u=v||(v={}))[u.POINT=0]="POINT",u[u.DIRECTIONAL=1]="DIRECTIONAL";let eO={props:{},uniforms:{},name:"lighting",defines:{},uniformTypes:{enabled:"i32",lightType:"i32",directionalLightCount:"i32",pointLightCount:"i32",ambientColor:"vec3<f32>",lightColor0:"vec3<f32>",lightPosition0:"vec3<f32>",lightDirection0:"vec3<f32>",lightAttenuation0:"vec3<f32>",lightColor1:"vec3<f32>",lightPosition1:"vec3<f32>",lightDirection1:"vec3<f32>",lightAttenuation1:"vec3<f32>",lightColor2:"vec3<f32>",lightPosition2:"vec3<f32>",lightDirection2:"vec3<f32>",lightAttenuation2:"vec3<f32>"},defaultUniforms:{enabled:1,lightType:v.POINT,directionalLightCount:0,pointLightCount:0,ambientColor:[.1,.1,.1],lightColor0:[1,1,1],lightPosition0:[1,1,2],lightDirection0:[1,1,1],lightAttenuation0:[1,0,0],lightColor1:[1,1,1],lightPosition1:[1,1,2],lightDirection1:[1,1,1],lightAttenuation1:[1,0,0],lightColor2:[1,1,1],lightPosition2:[1,1,2],lightDirection2:[1,1,1],lightAttenuation2:[1,0,0]},source:eL,vs:eM,fs:eM,getUniforms:function(e,t={}){if(!(e=e?{...e}:e))return{...eO.defaultUniforms};e.lights&&(e={...e,...function(e){let t={pointLights:[],directionalLights:[]};for(let i of e||[])switch(i.type){case"ambient":t.ambientLight=i;break;case"directional":t.directionalLights?.push(i);break;case"point":t.pointLights?.push(i)}return t}(e.lights),lights:void 0});let{ambientLight:i,pointLights:r,directionalLights:n}=e||{};if(!(i||r&&r.length>0||n&&n.length>0))return{...eO.defaultUniforms,enabled:0};let s={...eO.defaultUniforms,...t,...function({ambientLight:e,pointLights:t=[],directionalLights:i=[]}){let r={};r.ambientColor=eR(e);let n=0;for(let e of t){r.lightType=v.POINT;let t=n;r[`lightColor${t}`]=eR(e),r[`lightPosition${t}`]=e.position,r[`lightAttenuation${t}`]=e.attenuation||[1,0,0],n++}for(let e of i){r.lightType=v.DIRECTIONAL;let t=n;r[`lightColor${t}`]=eR(e),r[`lightDirection${t}`]=e.direction,n++}return n>5&&eA.log.warn("MAX_LIGHTS exceeded")(),r.directionalLightCount=i.length,r.pointLightCount=t.length,r}({ambientLight:i,pointLights:r,directionalLights:n})};return void 0!==e.enabled&&(s.enabled=+!!e.enabled),s}};function eR(e={}){let{color:t=[0,0,0],intensity:i=1}=e;return t.map(e=>e*i/255)}let eD=`\
uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;
`,eF=`\
#define MAX_LIGHTS 3

uniform phongMaterialUniforms {
  uniform float ambient;
  uniform float diffuse;
  uniform float shininess;
  uniform vec3  specularColor;
} material;

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 light_direction, vec3 view_direction, vec3 normal_worldspace, vec3 color) {
  vec3 halfway_direction = normalize(light_direction + view_direction);
  float lambertian = dot(light_direction, normal_worldspace);
  float specular = 0.0;
  if (lambertian > 0.0) {
    float specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, material.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * material.diffuse * surfaceColor + specular * material.specularColor) * color;
}

vec3 lighting_getLightColor(vec3 surfaceColor, vec3 cameraPosition, vec3 position_worldspace, vec3 normal_worldspace) {
  vec3 lightColor = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  vec3 view_direction = normalize(cameraPosition - position_worldspace);
  lightColor = material.ambient * surfaceColor * lighting.ambientColor;

  for (int i = 0; i < lighting.pointLightCount; i++) {
    PointLight pointLight = lighting_getPointLight(i);
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    float light_attenuation = getPointLightAttenuation(pointLight, distance(light_position_worldspace, position_worldspace));
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color / light_attenuation);
  }

  int totalLights = min(MAX_LIGHTS, lighting.pointLightCount + lighting.directionalLightCount);
  for (int i = lighting.pointLightCount; i < totalLights; i++) {
    DirectionalLight directionalLight = lighting_getDirectionalLight(i);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
}
`,eN=`\
struct phongMaterialUniforms {
  ambient: f32,
  diffuse: f32,
  shininess: f32,
  specularColor: vec3<f32>,
};

@binding(2) @group(0) var<uniform> phongMaterial : phongMaterialUniforms;

fn lighting_getLightColor(surfaceColor: vec3<f32>, light_direction: vec3<f32>, view_direction: vec3<f32>, normal_worldspace: vec3<f32>, color: vec3<f32>) -> vec3<f32> {
  let halfway_direction: vec3<f32> = normalize(light_direction + view_direction);
  var lambertian: f32 = dot(light_direction, normal_worldspace);
  var specular: f32 = 0.0;
  if (lambertian > 0.0) {
    let specular_angle = max(dot(normal_worldspace, halfway_direction), 0.0);
    specular = pow(specular_angle, phongMaterial.shininess);
  }
  lambertian = max(lambertian, 0.0);
  return (lambertian * phongMaterial.diffuse * surfaceColor + specular * phongMaterial.specularColor) * color;
}

fn lighting_getLightColor2(surfaceColor: vec3<f32>, cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32> {
  var lightColor: vec3<f32> = surfaceColor;

  if (lighting.enabled == 0) {
    return lightColor;
  }

  let view_direction: vec3<f32> = normalize(cameraPosition - position_worldspace);
  lightColor = phongMaterial.ambient * surfaceColor * lighting.ambientColor;

  if (lighting.lightType == 0) {
    let pointLight: PointLight  = lighting_getPointLight(0);
    let light_position_worldspace: vec3<f32> = pointLight.position;
    let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  } else if (lighting.lightType == 1) {
    var directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  
  return lightColor;
  /*
  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.pointLightCount) {
      break;
    }
    PointLight pointLight = lighting.pointLight[i];
    vec3 light_position_worldspace = pointLight.position;
    vec3 light_direction = normalize(light_position_worldspace - position_worldspace);
    lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
  }

  for (int i = 0; i < MAX_LIGHTS; i++) {
    if (i >= lighting.directionalLightCount) {
      break;
    }
    DirectionalLight directionalLight = lighting.directionalLight[i];
    lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
  }
  */
}

fn lighting_getSpecularLightColor(cameraPosition: vec3<f32>, position_worldspace: vec3<f32>, normal_worldspace: vec3<f32>) -> vec3<f32>{
  var lightColor = vec3<f32>(0, 0, 0);
  let surfaceColor = vec3<f32>(0, 0, 0);

  if (lighting.enabled == 0) {
    let view_direction = normalize(cameraPosition - position_worldspace);

    switch (lighting.lightType) {
      case 0, default: {
        let pointLight: PointLight = lighting_getPointLight(0);
        let light_position_worldspace: vec3<f32> = pointLight.position;
        let light_direction: vec3<f32> = normalize(light_position_worldspace - position_worldspace);
        lightColor += lighting_getLightColor(surfaceColor, light_direction, view_direction, normal_worldspace, pointLight.color);
      }
      case 1: {
        let directionalLight: DirectionalLight = lighting_getDirectionalLight(0);
        lightColor += lighting_getLightColor(surfaceColor, -directionalLight.direction, view_direction, normal_worldspace, directionalLight.color);
      }
    }
  }
  return lightColor;
}
`,ej={props:{},name:"gouraudMaterial",vs:eF.replace("phongMaterial","gouraudMaterial"),fs:eD.replace("phongMaterial","gouraudMaterial"),source:eN.replaceAll("phongMaterial","gouraudMaterial"),defines:{LIGHTING_VERTEX:!0},dependencies:[eO],uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(e){let t={...e};return t.specularColor&&(t.specularColor=t.specularColor.map(e=>e/255)),{...ej.defaultUniforms,...t}}},ez={name:"phongMaterial",dependencies:[eO],source:eN,vs:eD,fs:eF,defines:{LIGHTING_FRAGMENT:!0},uniformTypes:{ambient:"f32",diffuse:"f32",shininess:"f32",specularColor:"vec3<f32>"},defaultUniforms:{ambient:.35,diffuse:.6,shininess:32,specularColor:[.15,.15,.15]},getUniforms(e){let t={...e};return t.specularColor&&(t.specularColor=t.specularColor.map(e=>e/255)),{...ez.defaultUniforms,...t}}},eU=`\
uniform layerUniforms {
  uniform float opacity;
} layer;
`,eB={name:"layer",vs:eU,fs:eU,getUniforms:e=>({opacity:Math.pow(e.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}},e$={name:"color",dependencies:[],source:`

struct ColorUniforms {
  opacity: f32,
};

var<private> color: ColorUniforms = ColorUniforms(1.0);
// TODO (kaapp) avoiding binding index collisions to handle layer opacity 
// requires some thought.
// @group(0) @binding(0) var<uniform> color: ColorUniforms;

@must_use
fn deckgl_premultiplied_alpha(fragColor: vec4<f32>) -> vec4<f32> {
    return vec4(fragColor.rgb * fragColor.a, fragColor.a); 
};
`,getUniforms:e=>({}),uniformTypes:{opacity:"f32"}},eV="#define SMOOTH_EDGE_RADIUS 0.5",eW={name:"geometry",source:`\
const SMOOTH_EDGE_RADIUS: f32 = 0.5;

struct VertexGeometry {
  position: vec4<f32>,
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

var<private> geometry_: VertexGeometry = VertexGeometry(
  vec4<f32>(0.0, 0.0, 1.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0),
  vec2<f32>(0.0, 0.0),
  vec3<f32>(0.0, 0.0, 0.0)
);

struct FragmentGeometry {
  uv: vec2<f32>,
};

var<private> fragmentGeometry: FragmentGeometry;

fn smoothedge(edge: f32, x: f32) -> f32 {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`,vs:`\
${eV}

struct VertexGeometry {
  vec4 position;
  vec3 worldPosition;
  vec3 worldPositionAlt;
  vec3 normal;
  vec2 uv;
  vec3 pickingColor;
} geometry = VertexGeometry(
  vec4(0.0, 0.0, 1.0, 0.0),
  vec3(0.0),
  vec3(0.0),
  vec3(0.0),
  vec2(0.0),
  vec3(0.0)
);
`,fs:`\
${eV}

struct FragmentGeometry {
  vec2 uv;
} geometry;

float smoothedge(float edge, float x) {
  return smoothstep(edge - SMOOTH_EDGE_RADIUS, edge + SMOOTH_EDGE_RADIUS, x);
}
`},eG=`\
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND

// All these functions are for substituting tan() function from Intel GPU only
const float TWO_PI = 6.2831854820251465;
const float PI_2 = 1.5707963705062866;
const float PI_16 = 0.1963495463132858;

const float SIN_TABLE_0 = 0.19509032368659973;
const float SIN_TABLE_1 = 0.3826834261417389;
const float SIN_TABLE_2 = 0.5555702447891235;
const float SIN_TABLE_3 = 0.7071067690849304;

const float COS_TABLE_0 = 0.9807852506637573;
const float COS_TABLE_1 = 0.9238795042037964;
const float COS_TABLE_2 = 0.8314695954322815;
const float COS_TABLE_3 = 0.7071067690849304;

const float INVERSE_FACTORIAL_3 = 1.666666716337204e-01; // 1/3!
const float INVERSE_FACTORIAL_5 = 8.333333767950535e-03; // 1/5!
const float INVERSE_FACTORIAL_7 = 1.9841270113829523e-04; // 1/7!
const float INVERSE_FACTORIAL_9 = 2.75573188446287533e-06; // 1/9!

float sin_taylor_fp32(float a) {
  float r, s, t, x;

  if (a == 0.0) {
    return 0.0;
  }

  x = -a * a;
  s = a;
  r = a;

  r = r * x;
  t = r * INVERSE_FACTORIAL_3;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_5;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_7;
  s = s + t;

  r = r * x;
  t = r * INVERSE_FACTORIAL_9;
  s = s + t;

  return s;
}

void sincos_taylor_fp32(float a, out float sin_t, out float cos_t) {
  if (a == 0.0) {
    sin_t = 0.0;
    cos_t = 1.0;
  }
  sin_t = sin_taylor_fp32(a);
  cos_t = sqrt(1.0 - sin_t * sin_t);
}

float tan_taylor_fp32(float a) {
    float sin_a;
    float cos_a;

    if (a == 0.0) {
        return 0.0;
    }

    // 2pi range reduction
    float z = floor(a / TWO_PI);
    float r = a - TWO_PI * z;

    float t;
    float q = floor(r / PI_2 + 0.5);
    int j = int(q);

    if (j < -2 || j > 2) {
        return 1.0 / 0.0;
    }

    t = r - PI_2 * q;

    q = floor(t / PI_16 + 0.5);
    int k = int(q);
    int abs_k = int(abs(float(k)));

    if (abs_k > 4) {
        return 1.0 / 0.0;
    } else {
        t = t - PI_16 * q;
    }

    float u = 0.0;
    float v = 0.0;

    float sin_t, cos_t;
    float s, c;
    sincos_taylor_fp32(t, sin_t, cos_t);

    if (k == 0) {
        s = sin_t;
        c = cos_t;
    } else {
        if (abs(float(abs_k) - 1.0) < 0.5) {
            u = COS_TABLE_0;
            v = SIN_TABLE_0;
        } else if (abs(float(abs_k) - 2.0) < 0.5) {
            u = COS_TABLE_1;
            v = SIN_TABLE_1;
        } else if (abs(float(abs_k) - 3.0) < 0.5) {
            u = COS_TABLE_2;
            v = SIN_TABLE_2;
        } else if (abs(float(abs_k) - 4.0) < 0.5) {
            u = COS_TABLE_3;
            v = SIN_TABLE_3;
        }
        if (k > 0) {
            s = u * sin_t + v * cos_t;
            c = u * cos_t - v * sin_t;
        } else {
            s = u * sin_t - v * cos_t;
            c = u * cos_t + v * sin_t;
        }
    }

    if (j == 0) {
        sin_a = s;
        cos_a = c;
    } else if (j == 1) {
        sin_a = c;
        cos_a = -s;
    } else if (j == -1) {
        sin_a = -c;
        cos_a = s;
    } else {
        sin_a = -s;
        cos_a = -c;
    }
    return sin_a / cos_a;
}
#endif

float tan_fp32(float a) {
#ifdef LUMA_FP32_TAN_PRECISION_WORKAROUND
  return tan_taylor_fp32(a);
#else
  return tan(a);
#endif
}
`,eq="undefined"!=typeof Float32Array?Float32Array:Array,eH=Math.random;function eY(e){return e>=0?Math.round(e):e%.5==0?Math.floor(e):Math.round(e)}function eX(){let e=new eq(16);return eq!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function eZ(e){let t=new eq(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function eK(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function eJ(e,t,i,r,n,s,o,a,l,u,c,h,d,f,p,g){let m=new eq(16);return m[0]=e,m[1]=t,m[2]=i,m[3]=r,m[4]=n,m[5]=s,m[6]=o,m[7]=a,m[8]=l,m[9]=u,m[10]=c,m[11]=h,m[12]=d,m[13]=f,m[14]=p,m[15]=g,m}function eQ(e,t,i,r,n,s,o,a,l,u,c,h,d,f,p,g,m){return e[0]=t,e[1]=i,e[2]=r,e[3]=n,e[4]=s,e[5]=o,e[6]=a,e[7]=l,e[8]=u,e[9]=c,e[10]=h,e[11]=d,e[12]=f,e[13]=p,e[14]=g,e[15]=m,e}function e0(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function e1(e,t){if(e===t){let i=t[1],r=t[2],n=t[3],s=t[6],o=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=s,e[11]=t[14],e[12]=n,e[13]=o,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function e2(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=t[4],a=t[5],l=t[6],u=t[7],c=t[8],h=t[9],d=t[10],f=t[11],p=t[12],g=t[13],m=t[14],y=t[15],_=i*a-r*o,v=i*l-n*o,b=i*u-s*o,x=r*l-n*a,w=r*u-s*a,k=n*u-s*l,T=c*g-h*p,S=c*m-d*p,P=c*y-f*p,E=h*m-d*g,C=h*y-f*g,I=d*y-f*m,A=_*I-v*C+b*E+x*P-w*S+k*T;return A?(A=1/A,e[0]=(a*I-l*C+u*E)*A,e[1]=(n*C-r*I-s*E)*A,e[2]=(g*k-m*w+y*x)*A,e[3]=(d*w-h*k-f*x)*A,e[4]=(l*P-o*I-u*S)*A,e[5]=(i*I-n*P+s*S)*A,e[6]=(m*b-p*k-y*v)*A,e[7]=(c*k-d*b+f*v)*A,e[8]=(o*C-a*P+u*T)*A,e[9]=(r*P-i*C-s*T)*A,e[10]=(p*w-g*b+y*_)*A,e[11]=(h*b-c*w-f*_)*A,e[12]=(a*S-o*E-l*T)*A,e[13]=(i*E-r*S+n*T)*A,e[14]=(g*v-p*x-m*_)*A,e[15]=(c*x-h*v+d*_)*A,e):null}function e3(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=t[4],a=t[5],l=t[6],u=t[7],c=t[8],h=t[9],d=t[10],f=t[11],p=t[12],g=t[13],m=t[14],y=t[15],_=i*a-r*o,v=i*l-n*o,b=i*u-s*o,x=r*l-n*a,w=r*u-s*a,k=n*u-s*l,T=c*g-h*p,S=c*m-d*p,P=c*y-f*p,E=h*m-d*g,C=h*y-f*g,I=d*y-f*m;return e[0]=a*I-l*C+u*E,e[1]=n*C-r*I-s*E,e[2]=g*k-m*w+y*x,e[3]=d*w-h*k-f*x,e[4]=l*P-o*I-u*S,e[5]=i*I-n*P+s*S,e[6]=m*b-p*k-y*v,e[7]=c*k-d*b+f*v,e[8]=o*C-a*P+u*T,e[9]=r*P-i*C-s*T,e[10]=p*w-g*b+y*_,e[11]=h*b-c*w-f*_,e[12]=a*S-o*E-l*T,e[13]=i*E-r*S+n*T,e[14]=g*v-p*x-m*_,e[15]=c*x-h*v+d*_,e}function e4(e){let t=e[0],i=e[1],r=e[2],n=e[3],s=e[4],o=e[5],a=e[6],l=e[7],u=e[8],c=e[9],h=e[10],d=e[11],f=e[12],p=e[13],g=e[14],m=e[15],y=t*o-i*s,_=t*a-r*s,v=i*a-r*o,b=u*p-c*f,x=u*g-h*f,w=c*g-h*p;return l*(t*w-i*x+r*b)-n*(s*w-o*x+a*b)+m*(u*v-c*_+h*y)-d*(f*v-p*_+g*y)}function e6(e,t,i){let r=t[0],n=t[1],s=t[2],o=t[3],a=t[4],l=t[5],u=t[6],c=t[7],h=t[8],d=t[9],f=t[10],p=t[11],g=t[12],m=t[13],y=t[14],_=t[15],v=i[0],b=i[1],x=i[2],w=i[3];return e[0]=v*r+b*a+x*h+w*g,e[1]=v*n+b*l+x*d+w*m,e[2]=v*s+b*u+x*f+w*y,e[3]=v*o+b*c+x*p+w*_,v=i[4],b=i[5],x=i[6],w=i[7],e[4]=v*r+b*a+x*h+w*g,e[5]=v*n+b*l+x*d+w*m,e[6]=v*s+b*u+x*f+w*y,e[7]=v*o+b*c+x*p+w*_,v=i[8],b=i[9],x=i[10],w=i[11],e[8]=v*r+b*a+x*h+w*g,e[9]=v*n+b*l+x*d+w*m,e[10]=v*s+b*u+x*f+w*y,e[11]=v*o+b*c+x*p+w*_,v=i[12],b=i[13],x=i[14],w=i[15],e[12]=v*r+b*a+x*h+w*g,e[13]=v*n+b*l+x*d+w*m,e[14]=v*s+b*u+x*f+w*y,e[15]=v*o+b*c+x*p+w*_,e}function e5(e,t,i){let r,n,s,o,a,l,u,c,h,d,f,p,g=i[0],m=i[1],y=i[2];return t===e?(e[12]=t[0]*g+t[4]*m+t[8]*y+t[12],e[13]=t[1]*g+t[5]*m+t[9]*y+t[13],e[14]=t[2]*g+t[6]*m+t[10]*y+t[14],e[15]=t[3]*g+t[7]*m+t[11]*y+t[15]):(r=t[0],n=t[1],s=t[2],o=t[3],a=t[4],l=t[5],u=t[6],c=t[7],h=t[8],d=t[9],f=t[10],p=t[11],e[0]=r,e[1]=n,e[2]=s,e[3]=o,e[4]=a,e[5]=l,e[6]=u,e[7]=c,e[8]=h,e[9]=d,e[10]=f,e[11]=p,e[12]=r*g+a*m+h*y+t[12],e[13]=n*g+l*m+d*y+t[13],e[14]=s*g+u*m+f*y+t[14],e[15]=o*g+c*m+p*y+t[15]),e}function e8(e,t,i){let r=i[0],n=i[1],s=i[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function e9(e,t,i,r){let n,s,o,a,l,u,c,h,d,f,p,g,m,y,_,v,b,x,w,k,T,S,P,E,C=r[0],I=r[1],A=r[2],M=Math.sqrt(C*C+I*I+A*A);return M<1e-6?null:(C*=M=1/M,I*=M,A*=M,s=Math.sin(i),o=1-(n=Math.cos(i)),a=t[0],l=t[1],u=t[2],c=t[3],h=t[4],d=t[5],f=t[6],p=t[7],g=t[8],m=t[9],y=t[10],_=t[11],v=C*C*o+n,b=I*C*o+A*s,x=A*C*o-I*s,w=C*I*o-A*s,k=I*I*o+n,T=A*I*o+C*s,S=C*A*o+I*s,P=I*A*o-C*s,E=A*A*o+n,e[0]=a*v+h*b+g*x,e[1]=l*v+d*b+m*x,e[2]=u*v+f*b+y*x,e[3]=c*v+p*b+_*x,e[4]=a*w+h*k+g*T,e[5]=l*w+d*k+m*T,e[6]=u*w+f*k+y*T,e[7]=c*w+p*k+_*T,e[8]=a*S+h*P+g*E,e[9]=l*S+d*P+m*E,e[10]=u*S+f*P+y*E,e[11]=c*S+p*P+_*E,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function e7(e,t,i){let r=Math.sin(i),n=Math.cos(i),s=t[4],o=t[5],a=t[6],l=t[7],u=t[8],c=t[9],h=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=s*n+u*r,e[5]=o*n+c*r,e[6]=a*n+h*r,e[7]=l*n+d*r,e[8]=u*n-s*r,e[9]=c*n-o*r,e[10]=h*n-a*r,e[11]=d*n-l*r,e}function te(e,t,i){let r=Math.sin(i),n=Math.cos(i),s=t[0],o=t[1],a=t[2],l=t[3],u=t[8],c=t[9],h=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*n-u*r,e[1]=o*n-c*r,e[2]=a*n-h*r,e[3]=l*n-d*r,e[8]=s*r+u*n,e[9]=o*r+c*n,e[10]=a*r+h*n,e[11]=l*r+d*n,e}function tt(e,t,i){let r=Math.sin(i),n=Math.cos(i),s=t[0],o=t[1],a=t[2],l=t[3],u=t[4],c=t[5],h=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=s*n+u*r,e[1]=o*n+c*r,e[2]=a*n+h*r,e[3]=l*n+d*r,e[4]=u*n-s*r,e[5]=c*n-o*r,e[6]=h*n-a*r,e[7]=d*n-l*r,e}function ti(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function tr(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function tn(e,t,i){let r,n,s,o=i[0],a=i[1],l=i[2],u=Math.sqrt(o*o+a*a+l*l);return u<1e-6?null:(o*=u=1/u,a*=u,l*=u,n=Math.sin(t),s=1-(r=Math.cos(t)),e[0]=o*o*s+r,e[1]=a*o*s+l*n,e[2]=l*o*s-a*n,e[3]=0,e[4]=o*a*s-l*n,e[5]=a*a*s+r,e[6]=l*a*s+o*n,e[7]=0,e[8]=o*l*s+a*n,e[9]=a*l*s-o*n,e[10]=l*l*s+r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function ts(e,t){let i=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function to(e,t){let i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ta(e,t){let i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function tl(e,t,i){let r=t[0],n=t[1],s=t[2],o=t[3],a=r+r,l=n+n,u=s+s,c=r*a,h=r*l,d=r*u,f=n*l,p=n*u,g=s*u,m=o*a,y=o*l,_=o*u;return e[0]=1-(f+g),e[1]=h+_,e[2]=d-y,e[3]=0,e[4]=h-_,e[5]=1-(c+g),e[6]=p+m,e[7]=0,e[8]=d+y,e[9]=p-m,e[10]=1-(c+f),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function tu(e,t){let i=new eq(3),r=-t[0],n=-t[1],s=-t[2],o=t[3],a=t[4],l=t[5],u=t[6],c=t[7],h=r*r+n*n+s*s+o*o;return h>0?(i[0]=(a*o+c*r+l*s-u*n)*2/h,i[1]=(l*o+c*n+u*r-a*s)*2/h,i[2]=(u*o+c*s+a*n-l*r)*2/h):(i[0]=(a*o+c*r+l*s-u*n)*2,i[1]=(l*o+c*n+u*r-a*s)*2,i[2]=(u*o+c*s+a*n-l*r)*2),tl(e,t,i),e}function tc(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function th(e,t){let i=t[0],r=t[1],n=t[2],s=t[4],o=t[5],a=t[6],l=t[8],u=t[9],c=t[10];return e[0]=Math.sqrt(i*i+r*r+n*n),e[1]=Math.sqrt(s*s+o*o+a*a),e[2]=Math.sqrt(l*l+u*u+c*c),e}function td(e,t){let i=new eq(3);th(i,t);let r=1/i[0],n=1/i[1],s=1/i[2],o=t[0]*r,a=t[1]*n,l=t[2]*s,u=t[4]*r,c=t[5]*n,h=t[6]*s,d=t[8]*r,f=t[9]*n,p=t[10]*s,g=o+c+p,m=0;return g>0?(m=2*Math.sqrt(g+1),e[3]=.25*m,e[0]=(h-f)/m,e[1]=(d-l)/m,e[2]=(a-u)/m):o>c&&o>p?(m=2*Math.sqrt(1+o-c-p),e[3]=(h-f)/m,e[0]=.25*m,e[1]=(a+u)/m,e[2]=(d+l)/m):c>p?(m=2*Math.sqrt(1+c-o-p),e[3]=(d-l)/m,e[0]=(a+u)/m,e[1]=.25*m,e[2]=(h+f)/m):(m=2*Math.sqrt(1+p-o-c),e[3]=(a-u)/m,e[0]=(d+l)/m,e[1]=(h+f)/m,e[2]=.25*m),e}function tf(e,t,i,r){t[0]=r[12],t[1]=r[13],t[2]=r[14];let n=r[0],s=r[1],o=r[2],a=r[4],l=r[5],u=r[6],c=r[8],h=r[9],d=r[10];i[0]=Math.sqrt(n*n+s*s+o*o),i[1]=Math.sqrt(a*a+l*l+u*u),i[2]=Math.sqrt(c*c+h*h+d*d);let f=1/i[0],p=1/i[1],g=1/i[2],m=n*f,y=s*p,_=o*g,v=a*f,b=l*p,x=u*g,w=c*f,k=h*p,T=d*g,S=m+b+T,P=0;return S>0?(P=2*Math.sqrt(S+1),e[3]=.25*P,e[0]=(x-k)/P,e[1]=(w-_)/P,e[2]=(y-v)/P):m>b&&m>T?(P=2*Math.sqrt(1+m-b-T),e[3]=(x-k)/P,e[0]=.25*P,e[1]=(y+v)/P,e[2]=(w+_)/P):b>T?(P=2*Math.sqrt(1+b-m-T),e[3]=(w-_)/P,e[0]=(y+v)/P,e[1]=.25*P,e[2]=(x+k)/P):(P=2*Math.sqrt(1+T-m-b),e[3]=(y-v)/P,e[0]=(w+_)/P,e[1]=(x+k)/P,e[2]=.25*P),e}function tp(e,t,i,r){let n=t[0],s=t[1],o=t[2],a=t[3],l=n+n,u=s+s,c=o+o,h=n*l,d=n*u,f=n*c,p=s*u,g=s*c,m=o*c,y=a*l,_=a*u,v=a*c,b=r[0],x=r[1],w=r[2];return e[0]=(1-(p+m))*b,e[1]=(d+v)*b,e[2]=(f-_)*b,e[3]=0,e[4]=(d-v)*x,e[5]=(1-(h+m))*x,e[6]=(g+y)*x,e[7]=0,e[8]=(f+_)*w,e[9]=(g-y)*w,e[10]=(1-(h+p))*w,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function tg(e,t,i,r,n){let s=t[0],o=t[1],a=t[2],l=t[3],u=s+s,c=o+o,h=a+a,d=s*u,f=s*c,p=s*h,g=o*c,m=o*h,y=a*h,_=l*u,v=l*c,b=l*h,x=r[0],w=r[1],k=r[2],T=n[0],S=n[1],P=n[2],E=(1-(g+y))*x,C=(f+b)*x,I=(p-v)*x,A=(f-b)*w,M=(1-(d+y))*w,L=(m+_)*w,O=(p+v)*k,R=(m-_)*k,D=(1-(d+g))*k;return e[0]=E,e[1]=C,e[2]=I,e[3]=0,e[4]=A,e[5]=M,e[6]=L,e[7]=0,e[8]=O,e[9]=R,e[10]=D,e[11]=0,e[12]=i[0]+T-(E*T+A*S+O*P),e[13]=i[1]+S-(C*T+M*S+R*P),e[14]=i[2]+P-(I*T+L*S+D*P),e[15]=1,e}function tm(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=i+i,a=r+r,l=n+n,u=i*o,c=r*o,h=r*a,d=n*o,f=n*a,p=n*l,g=s*o,m=s*a,y=s*l;return e[0]=1-h-p,e[1]=c+y,e[2]=d-m,e[3]=0,e[4]=c-y,e[5]=1-u-p,e[6]=f+g,e[7]=0,e[8]=d+m,e[9]=f-g,e[10]=1-u-h,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ty(e,t,i,r,n,s,o){let a=1/(i-t),l=1/(n-r),u=1/(s-o);return e[0]=2*s*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*s*l,e[6]=0,e[7]=0,e[8]=(i+t)*a,e[9]=(n+r)*l,e[10]=(o+s)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*s*2*u,e[15]=0,e}function t_(e,t,i,r,n){let s=1/Math.tan(t/2);if(e[0]=s/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0){let t=1/(r-n);e[10]=(n+r)*t,e[14]=2*n*r*t}else e[10]=-1,e[14]=-2*r;return e}function tv(e,t,i,r,n){let s=1/Math.tan(t/2);if(e[0]=s/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0){let t=1/(r-n);e[10]=n*t,e[14]=n*r*t}else e[10]=-1,e[14]=-r;return e}function tb(e,t,i,r){let n=Math.tan(t.upDegrees*Math.PI/180),s=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),l=2/(o+a),u=2/(n+s);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=u,e[6]=0,e[7]=0,e[8]=-((o-a)*l*.5),e[9]=(n-s)*u*.5,e[10]=r/(i-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*i/(i-r),e[15]=0,e}function tx(e,t,i,r,n,s,o){let a=1/(t-i),l=1/(r-n),u=1/(s-o);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+i)*a,e[13]=(n+r)*l,e[14]=(o+s)*u,e[15]=1,e}function tw(e,t,i,r,n,s,o){let a=1/(t-i),l=1/(r-n),u=1/(s-o);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=u,e[11]=0,e[12]=(t+i)*a,e[13]=(n+r)*l,e[14]=s*u,e[15]=1,e}function tk(e,t,i,r){let n,s,o,a,l,u,c,h,d,f,p=t[0],g=t[1],m=t[2],y=r[0],_=r[1],v=r[2],b=i[0],x=i[1],w=i[2];return 1e-6>Math.abs(p-b)&&1e-6>Math.abs(g-x)&&1e-6>Math.abs(m-w)?e0(e):(n=1/Math.sqrt((h=p-b)*h+(d=g-x)*d+(f=m-w)*f),h*=n,d*=n,f*=n,(n=Math.sqrt((s=_*f-v*d)*s+(o=v*h-y*f)*o+(a=y*d-_*h)*a))?(s*=n=1/n,o*=n,a*=n):(s=0,o=0,a=0),(n=Math.sqrt((l=d*a-f*o)*l+(u=f*s-h*a)*u+(c=h*o-d*s)*c))?(l*=n=1/n,u*=n,c*=n):(l=0,u=0,c=0),e[0]=s,e[1]=l,e[2]=h,e[3]=0,e[4]=o,e[5]=u,e[6]=d,e[7]=0,e[8]=a,e[9]=c,e[10]=f,e[11]=0,e[12]=-(s*p+o*g+a*m),e[13]=-(l*p+u*g+c*m),e[14]=-(h*p+d*g+f*m),e[15]=1,e)}function tT(e,t,i,r){let n=t[0],s=t[1],o=t[2],a=r[0],l=r[1],u=r[2],c=n-i[0],h=s-i[1],d=o-i[2],f=c*c+h*h+d*d;f>0&&(c*=f=1/Math.sqrt(f),h*=f,d*=f);let p=l*d-u*h,g=u*c-a*d,m=a*h-l*c;return(f=p*p+g*g+m*m)>0&&(p*=f=1/Math.sqrt(f),g*=f,m*=f),e[0]=p,e[1]=g,e[2]=m,e[3]=0,e[4]=h*m-d*g,e[5]=d*p-c*m,e[6]=c*g-h*p,e[7]=0,e[8]=c,e[9]=h,e[10]=d,e[11]=0,e[12]=n,e[13]=s,e[14]=o,e[15]=1,e}function tS(e){return`mat4(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]}, ${e[4]}, ${e[5]}, ${e[6]}, ${e[7]}, ${e[8]}, ${e[9]}, ${e[10]}, ${e[11]}, ${e[12]}, ${e[13]}, ${e[14]}, ${e[15]})`}function tP(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]+e[3]*e[3]+e[4]*e[4]+e[5]*e[5]+e[6]*e[6]+e[7]*e[7]+e[8]*e[8]+e[9]*e[9]+e[10]*e[10]+e[11]*e[11]+e[12]*e[12]+e[13]*e[13]+e[14]*e[14]+e[15]*e[15])}function tE(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e[9]=t[9]+i[9],e[10]=t[10]+i[10],e[11]=t[11]+i[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]+i[15],e}function tC(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e[9]=t[9]-i[9],e[10]=t[10]-i[10],e[11]=t[11]-i[11],e[12]=t[12]-i[12],e[13]=t[13]-i[13],e[14]=t[14]-i[14],e[15]=t[15]-i[15],e}function tI(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12]*i,e[13]=t[13]*i,e[14]=t[14]*i,e[15]=t[15]*i,e}function tA(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e[9]=t[9]+i[9]*r,e[10]=t[10]+i[10]*r,e[11]=t[11]+i[11]*r,e[12]=t[12]+i[12]*r,e[13]=t[13]+i[13]*r,e[14]=t[14]+i[14]*r,e[15]=t[15]+i[15]*r,e}function tM(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function tL(e,t){let i=e[0],r=e[1],n=e[2],s=e[3],o=e[4],a=e[5],l=e[6],u=e[7],c=e[8],h=e[9],d=e[10],f=e[11],p=e[12],g=e[13],m=e[14],y=e[15],_=t[0],v=t[1],b=t[2],x=t[3],w=t[4],k=t[5],T=t[6],S=t[7],P=t[8],E=t[9],C=t[10],I=t[11],A=t[12],M=t[13],L=t[14],O=t[15];return Math.abs(i-_)<=1e-6*Math.max(1,Math.abs(i),Math.abs(_))&&Math.abs(r-v)<=1e-6*Math.max(1,Math.abs(r),Math.abs(v))&&Math.abs(n-b)<=1e-6*Math.max(1,Math.abs(n),Math.abs(b))&&Math.abs(s-x)<=1e-6*Math.max(1,Math.abs(s),Math.abs(x))&&Math.abs(o-w)<=1e-6*Math.max(1,Math.abs(o),Math.abs(w))&&Math.abs(a-k)<=1e-6*Math.max(1,Math.abs(a),Math.abs(k))&&Math.abs(l-T)<=1e-6*Math.max(1,Math.abs(l),Math.abs(T))&&Math.abs(u-S)<=1e-6*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(c-P)<=1e-6*Math.max(1,Math.abs(c),Math.abs(P))&&Math.abs(h-E)<=1e-6*Math.max(1,Math.abs(h),Math.abs(E))&&Math.abs(d-C)<=1e-6*Math.max(1,Math.abs(d),Math.abs(C))&&Math.abs(f-I)<=1e-6*Math.max(1,Math.abs(f),Math.abs(I))&&Math.abs(p-A)<=1e-6*Math.max(1,Math.abs(p),Math.abs(A))&&Math.abs(g-M)<=1e-6*Math.max(1,Math.abs(g),Math.abs(M))&&Math.abs(m-L)<=1e-6*Math.max(1,Math.abs(m),Math.abs(L))&&Math.abs(y-O)<=1e-6*Math.max(1,Math.abs(y),Math.abs(O))}e.s(["add",()=>tE,"adjoint",()=>e3,"clone",()=>eZ,"copy",()=>eK,"create",()=>eX,"decompose",()=>tf,"determinant",()=>e4,"equals",()=>tL,"exactEquals",()=>tM,"frob",()=>tP,"fromQuat",()=>tm,"fromQuat2",()=>tu,"fromRotation",()=>tn,"fromRotationTranslation",()=>tl,"fromRotationTranslationScale",()=>tp,"fromRotationTranslationScaleOrigin",()=>tg,"fromScaling",()=>tr,"fromTranslation",()=>ti,"fromValues",()=>eJ,"fromXRotation",()=>ts,"fromYRotation",()=>to,"fromZRotation",()=>ta,"frustum",()=>ty,"getRotation",()=>td,"getScaling",()=>th,"getTranslation",()=>tc,"identity",()=>e0,"invert",()=>e2,"lookAt",()=>tk,"mul",0,e6,"multiply",()=>e6,"multiplyScalar",()=>tI,"multiplyScalarAndAdd",()=>tA,"ortho",0,tx,"orthoNO",()=>tx,"orthoZO",()=>tw,"perspective",0,t_,"perspectiveFromFieldOfView",()=>tb,"perspectiveNO",()=>t_,"perspectiveZO",()=>tv,"rotate",()=>e9,"rotateX",()=>e7,"rotateY",()=>te,"rotateZ",()=>tt,"scale",()=>e8,"set",()=>eQ,"str",()=>tS,"sub",0,tC,"subtract",()=>tC,"targetTo",()=>tT,"translate",()=>e5,"transpose",()=>e1],32664);var tO=e.i(32664),tO=tO;function tR(){let e=new eq(4);return eq!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function tD(e){let t=new eq(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function tF(e,t,i,r){let n=new eq(4);return n[0]=e,n[1]=t,n[2]=i,n[3]=r,n}function tN(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function tj(e,t,i,r,n){return e[0]=t,e[1]=i,e[2]=r,e[3]=n,e}function tz(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function tU(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function tB(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e}function t$(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e}function tV(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function tW(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function tG(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e}function tq(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e}function tH(e,t){return e[0]=eY(t[0]),e[1]=eY(t[1]),e[2]=eY(t[2]),e[3]=eY(t[3]),e}function tY(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function tX(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}function tZ(e,t){let i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2],s=t[3]-e[3];return Math.sqrt(i*i+r*r+n*n+s*s)}function tK(e,t){let i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2],s=t[3]-e[3];return i*i+r*r+n*n+s*s}function tJ(e){let t=e[0],i=e[1],r=e[2],n=e[3];return Math.sqrt(t*t+i*i+r*r+n*n)}function tQ(e){let t=e[0],i=e[1],r=e[2],n=e[3];return t*t+i*i+r*r+n*n}function t0(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function t1(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function t2(e,t){let i=t[0],r=t[1],n=t[2],s=t[3],o=i*i+r*r+n*n+s*s;return o>0&&(o=1/Math.sqrt(o)),e[0]=i*o,e[1]=r*o,e[2]=n*o,e[3]=s*o,e}function t3(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function t4(e,t,i,r){let n=i[0]*r[1]-i[1]*r[0],s=i[0]*r[2]-i[2]*r[0],o=i[0]*r[3]-i[3]*r[0],a=i[1]*r[2]-i[2]*r[1],l=i[1]*r[3]-i[3]*r[1],u=i[2]*r[3]-i[3]*r[2],c=t[0],h=t[1],d=t[2],f=t[3];return e[0]=h*u-d*l+f*a,e[1]=-(c*u)+d*o-f*s,e[2]=c*l-h*o+f*n,e[3]=-(c*a)+h*s-d*n,e}function t6(e,t,i,r){let n=t[0],s=t[1],o=t[2],a=t[3];return e[0]=n+r*(i[0]-n),e[1]=s+r*(i[1]-s),e[2]=o+r*(i[2]-o),e[3]=a+r*(i[3]-a),e}function t5(e,t){let i,r,n,s,o,a;t=void 0===t?1:t;do o=(i=2*eH()-1)*i+(r=2*eH()-1)*r;while(o>=1)do a=(n=2*eH()-1)*n+(s=2*eH()-1)*s;while(a>=1)let l=Math.sqrt((1-o)/a);return e[0]=t*i,e[1]=t*r,e[2]=t*n*l,e[3]=t*s*l,e}function t8(e,t,i){let r=t[0],n=t[1],s=t[2],o=t[3];return e[0]=i[0]*r+i[4]*n+i[8]*s+i[12]*o,e[1]=i[1]*r+i[5]*n+i[9]*s+i[13]*o,e[2]=i[2]*r+i[6]*n+i[10]*s+i[14]*o,e[3]=i[3]*r+i[7]*n+i[11]*s+i[15]*o,e}function t9(e,t,i){let r=t[0],n=t[1],s=t[2],o=i[0],a=i[1],l=i[2],u=i[3],c=u*r+a*s-l*n,h=u*n+l*r-o*s,d=u*s+o*n-a*r,f=-o*r-a*n-l*s;return e[0]=c*u+-(f*o)+-(h*l)- -(d*a),e[1]=h*u+-(f*a)+-(d*o)- -(c*l),e[2]=d*u+-(f*l)+-(c*a)- -(h*o),e[3]=t[3],e}function t7(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function ie(e){return`vec4(${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`}function it(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function ii(e,t){let i=e[0],r=e[1],n=e[2],s=e[3],o=t[0],a=t[1],l=t[2],u=t[3];return Math.abs(i-o)<=1e-6*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=1e-6*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(n-l)<=1e-6*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(s-u)<=1e-6*Math.max(1,Math.abs(s),Math.abs(u))}let ir=(s=tR(),function(e,t,i,r,n,o){let a,l;for(t||(t=4),i||(i=0),l=r?Math.min(r*t+i,e.length):e.length,a=i;a<l;a+=t)s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],s[3]=e[a+3],n(s,s,o),e[a]=s[0],e[a+1]=s[1],e[a+2]=s[2],e[a+3]=s[3];return e});e.s(["add",()=>tz,"ceil",()=>tV,"clone",()=>tD,"copy",()=>tN,"create",()=>tR,"cross",()=>t4,"dist",0,tZ,"distance",()=>tZ,"div",0,t$,"divide",()=>t$,"dot",()=>t3,"equals",()=>ii,"exactEquals",()=>it,"floor",()=>tW,"forEach",0,ir,"fromValues",()=>tF,"inverse",()=>t1,"len",0,tJ,"length",()=>tJ,"lerp",()=>t6,"max",()=>tq,"min",()=>tG,"mul",0,tB,"multiply",()=>tB,"negate",()=>t0,"normalize",()=>t2,"random",()=>t5,"round",()=>tH,"scale",()=>tY,"scaleAndAdd",()=>tX,"set",()=>tj,"sqrDist",0,tK,"sqrLen",0,tQ,"squaredDistance",()=>tK,"squaredLength",()=>tQ,"str",()=>ie,"sub",0,tU,"subtract",()=>tU,"transformMat4",()=>t8,"transformQuat",()=>t9,"zero",()=>t7],22642);var is=e.i(22642),is=is,io=e.i(85612);let ia=new io.Log({id:"deck"});(c=b||(b={}))[c.Start=1]="Start",c[c.Move=2]="Move",c[c.End=4]="End",c[c.Cancel=8]="Cancel",(h=x||(x={}))[h.None=0]="None",h[h.Left=1]="Left",h[h.Right=2]="Right",h[h.Up=4]="Up",h[h.Down=8]="Down",h[h.Horizontal=3]="Horizontal",h[h.Vertical=12]="Vertical",h[h.All=15]="All",(d=w||(w={}))[d.Possible=1]="Possible",d[d.Began=2]="Began",d[d.Changed=4]="Changed",d[d.Ended=8]="Ended",d[d.Recognized=8]="Recognized",d[d.Cancelled=16]="Cancelled",d[d.Failed=32]="Failed";let il="manipulation",iu="none",ic="pan-x",ih="pan-y";class id{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){"compute"===e&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(let t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));var t=e.join(" ");if(t.includes(iu))return iu;let i=t.includes(ic),r=t.includes(ih);return i&&r?iu:i||r?i?ic:ih:t.includes(il)?il:"auto"}}function ip(e){return e.trim().split(/\s+/g)}function ig(e,t,i){if(e)for(let r of ip(t))e.addEventListener(r,i,!1)}function im(e,t,i){if(e)for(let r of ip(t))e.removeEventListener(r,i,!1)}function iy(e){return(e.ownerDocument||e).defaultView}function i_(e){let t=e.length;if(1===t)return{x:Math.round(e[0].clientX),y:Math.round(e[0].clientY)};let i=0,r=0,n=0;for(;n<t;)i+=e[n].clientX,r+=e[n].clientY,n++;return{x:Math.round(i/t),y:Math.round(r/t)}}function iv(e){let t=[],i=0;for(;i<e.pointers.length;)t[i]={clientX:Math.round(e.pointers[i].clientX),clientY:Math.round(e.pointers[i].clientY)},i++;return{timeStamp:Date.now(),pointers:t,center:i_(t),deltaX:e.deltaX,deltaY:e.deltaY}}function ib(e,t){let i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function ix(e,t){let i=t.clientX-e.clientX,r=t.clientY-e.clientY;return Math.sqrt(i*i+r*r)}function iw(e,t){let i=t.clientX-e.clientX;return 180*Math.atan2(t.clientY-e.clientY,i)/Math.PI}function ik(e,t){return e===t?x.None:Math.abs(e)>=Math.abs(t)?e<0?x.Left:x.Right:t<0?x.Up:x.Down}function iT(e,t,i){return{x:t/e||0,y:i/e||0}}class iS{constructor(e){this.evEl="",this.evWin="",this.evTarget="",this.domHandler=e=>{this.manager.options.enable&&this.handler(e)},this.manager=e,this.element=e.element,this.target=e.options.inputTarget||e.element}callback(e,t){var i;let r,n,s,o,a;i=this.manager,r=t.pointers.length,n=t.changedPointers.length,s=e&b.Start&&r-n==0,o=e&(b.End|b.Cancel)&&r-n==0,t.isFirst=!!s,t.isFinal=!!o,s&&(i.session={}),t.eventType=e,a=function(e,t){var i,r;let n,s,o,a,l,{session:u}=e,{pointers:c}=t,{length:h}=c;u.firstInput||(u.firstInput=iv(t)),h>1&&!u.firstMultiple?u.firstMultiple=iv(t):1===h&&(u.firstMultiple=!1);let{firstInput:d,firstMultiple:f}=u,p=f?f.center:d.center,g=t.center=i_(c);t.timeStamp=Date.now(),t.deltaTime=t.timeStamp-d.timeStamp,n=g.x-p.x,t.angle=180*Math.atan2(g.y-p.y,n)/Math.PI,t.distance=ib(p,g);let{deltaX:m,deltaY:y}=(s=t.center,o=u.offsetDelta,a=u.prevDelta,l=u.prevInput,(t.eventType===b.Start||l?.eventType===b.End)&&(a=u.prevDelta={x:l?.deltaX||0,y:l?.deltaY||0},o=u.offsetDelta={x:s.x,y:s.y}),{deltaX:a.x+(s.x-o.x),deltaY:a.y+(s.y-o.y)});t.deltaX=m,t.deltaY=y,t.offsetDirection=ik(t.deltaX,t.deltaY);let _=iT(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=_.x,t.overallVelocityY=_.y,t.overallVelocity=Math.abs(_.x)>Math.abs(_.y)?_.x:_.y,t.scale=f?(i=f.pointers,ix(c[0],c[1])/ix(i[0],i[1])):1,t.rotation=f?(r=f.pointers,iw(c[1],c[0])-iw(r[1],r[0])):0,t.maxPointers=u.prevInput?t.pointers.length>u.prevInput.maxPointers?t.pointers.length:u.prevInput.maxPointers:t.pointers.length;let v=e.element;return function(e,t){let i=e;for(;i;){if(i===t)return!0;i=i.parentNode}return!1}(t.srcEvent.target,v)&&(v=t.srcEvent.target),t.target=v,!function(e,t){let i,r,n,s,o=e.lastInterval||t,a=t.timeStamp-o.timeStamp;if(t.eventType!==b.Cancel&&(a>25||void 0===o.velocity)){let l=t.deltaX-o.deltaX,u=t.deltaY-o.deltaY,c=iT(a,l,u);r=c.x,n=c.y,i=Math.abs(c.x)>Math.abs(c.y)?c.x:c.y,s=ik(l,u),e.lastInterval=t}else i=o.velocity,r=o.velocityX,n=o.velocityY,s=o.direction;t.velocity=i,t.velocityX=r,t.velocityY=n,t.direction=s}(u,t),t}(i,t),i.emit("hammer.input",a),i.recognize(a),i.session.prevInput=a}init(){ig(this.element,this.evEl,this.domHandler),ig(this.target,this.evTarget,this.domHandler),ig(iy(this.element),this.evWin,this.domHandler)}destroy(){im(this.element,this.evEl,this.domHandler),im(this.target,this.evTarget,this.domHandler),im(iy(this.element),this.evWin,this.domHandler)}}let iP={pointerdown:b.Start,pointermove:b.Move,pointerup:b.End,pointercancel:b.Cancel,pointerout:b.Cancel};class iE extends iS{constructor(e){super(e),this.evEl="pointerdown",this.evWin="pointermove pointerup pointercancel",this.store=this.manager.session.pointerEvents=[],this.init()}handler(e){let{store:t}=this,i=!1,r=iP[e.type],n=e.pointerType,s="touch"===n,o=t.findIndex(t=>t.pointerId===e.pointerId);r&b.Start&&(e.buttons||s)?o<0&&(t.push(e),o=t.length-1):r&(b.End|b.Cancel)&&(i=!0),!(o<0)&&(t[o]=e,this.callback(r,{pointers:t,changedPointers:[e],eventType:r,pointerType:n,srcEvent:e}),i&&t.splice(o,1))}}let iC=["","webkit","Moz","MS","ms","o"],iI={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class iA{constructor(e,t){this.options={...iI,...t,cssProps:{...iI.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new iE(this),this.touchAction=new id(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?2:1}recognize(e){let t,{session:i}=this;if(i.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let{recognizers:r}=this,{curRecognizer:n}=i;(!n||n&&n.state&w.Recognized)&&(n=i.curRecognizer=null);let s=0;for(;s<r.length;)t=r[s],2!==i.stopped&&(!n||t===n||t.canRecognizeWith(n))?t.recognize(e):t.reset(),!n&&t.state&(w.Began|w.Changed|w.Ended)&&(n=i.curRecognizer=t),s++}get(e){let{recognizers:t}=this;for(let i=0;i<t.length;i++)if(t[i].options.event===e)return t[i];return null}add(e){if(Array.isArray(e)){for(let t of e)this.add(t);return this}let t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(let t of e)this.remove(t);return this}let t="string"==typeof e?this.get(e):e;if(t){let{recognizers:e}=this,i=e.indexOf(t);-1!==i&&(e.splice(i,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;let{handlers:i}=this;for(let r of ip(e))i[r]=i[r]||[],i[r].push(t)}off(e,t){if(!e)return;let{handlers:i}=this;for(let r of ip(e))t?i[r]&&i[r].splice(i[r].indexOf(t),1):delete i[r]}emit(e,t){let i=this.handlers[e]&&this.handlers[e].slice();if(!i||!i.length)return;t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};let r=0;for(;r<i.length;)i[r](t),r++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){let{element:t}=this;if(t){for(let[i,r]of Object.entries(this.options.cssProps)){let n=function(e,t){let i=t[0].toUpperCase()+t.slice(1);for(let r of iC){let n=r?r+i:t;if(n in e)return n}}(t.style,i);e?(this.oldCssProps[n]=t.style[n],t.style[n]=r):t.style[n]=this.oldCssProps[n]||""}e||(this.oldCssProps={})}}}let iM=1;function iL(e){return e&w.Cancelled?"cancel":e&w.Ended?"end":e&w.Changed?"move":e&w.Began?"start":""}class iO{constructor(e){this.options=e,this.id=iM++,this.state=w.Possible,this.simultaneous={},this.requireFail=[]}set(e){return Object.assign(this.options,e),this.manager.touchAction.update(),this}recognizeWith(e){let t;if(Array.isArray(e)){for(let t of e)this.recognizeWith(t);return this}if("string"==typeof e){if(!(t=this.manager.get(e)))throw Error(`Cannot find recognizer ${e}`)}else t=e;let{simultaneous:i}=this;return i[t.id]||(i[t.id]=t,t.recognizeWith(this)),this}dropRecognizeWith(e){let t;if(Array.isArray(e)){for(let t of e)this.dropRecognizeWith(t);return this}return(t="string"==typeof e?this.manager.get(e):e)&&delete this.simultaneous[t.id],this}requireFailure(e){let t;if(Array.isArray(e)){for(let t of e)this.requireFailure(t);return this}if("string"==typeof e){if(!(t=this.manager.get(e)))throw Error(`Cannot find recognizer ${e}`)}else t=e;let{requireFail:i}=this;return -1===i.indexOf(t)&&(i.push(t),t.requireFailure(this)),this}dropRequireFailure(e){let t;if(Array.isArray(e)){for(let t of e)this.dropRequireFailure(t);return this}if(t="string"==typeof e?this.manager.get(e):e){let e=this.requireFail.indexOf(t);e>-1&&this.requireFail.splice(e,1)}return this}hasRequireFailures(){return!!this.requireFail.find(e=>e.options.enable)}canRecognizeWith(e){return!!this.simultaneous[e.id]}emit(e){if(!e)return;let{state:t}=this;t<w.Ended&&this.manager.emit(this.options.event+iL(t),e),this.manager.emit(this.options.event,e),e.additionalEvent&&this.manager.emit(e.additionalEvent,e),t>=w.Ended&&this.manager.emit(this.options.event+iL(t),e)}tryEmit(e){this.canEmit()?this.emit(e):this.state=w.Failed}canEmit(){let e=0;for(;e<this.requireFail.length;){if(!(this.requireFail[e].state&(w.Failed|w.Possible)))return!1;e++}return!0}recognize(e){let t={...e};if(!this.options.enable){this.reset(),this.state=w.Failed;return}this.state&(w.Recognized|w.Cancelled|w.Failed)&&(this.state=w.Possible),this.state=this.process(t),this.state&(w.Began|w.Changed|w.Ended|w.Cancelled)&&this.tryEmit(t)}getEventNames(){return[this.options.event]}reset(){}}class iR extends iO{attrTest(e){let t=this.options.pointers;return 0===t||e.pointers.length===t}process(e){let{state:t}=this,{eventType:i}=e,r=t&(w.Began|w.Changed),n=this.attrTest(e);return r&&(i&b.Cancel||!n)?t|w.Cancelled:r||n?i&b.End?t|w.Ended:t&w.Began?t|w.Changed:w.Began:w.Failed}}class iD extends iO{constructor(e={}){super({enable:!0,event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10,...e}),this.pTime=null,this.pCenter=null,this._timer=null,this._input=null,this.count=0}getTouchAction(){return[il]}process(e){let{options:t}=this,i=e.pointers.length===t.pointers,r=e.distance<t.threshold,n=e.deltaTime<t.time;if(this.reset(),e.eventType&b.Start&&0===this.count)return this.failTimeout();if(r&&n&&i){if(e.eventType!==b.End)return this.failTimeout();let i=!this.pTime||e.timeStamp-this.pTime<t.interval,r=!this.pCenter||ib(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,r&&i?this.count+=1:this.count=1,this._input=e,0==this.count%t.taps)return this.hasRequireFailures()?(this._timer=setTimeout(()=>{this.state=w.Recognized,this.tryEmit(this._input)},t.interval),w.Began):w.Recognized}return w.Failed}failTimeout(){return this._timer=setTimeout(()=>{this.state=w.Failed},this.options.interval),w.Failed}reset(){clearTimeout(this._timer)}emit(e){this.state===w.Recognized&&(e.tapCount=this.count,this.manager.emit(this.options.event,e))}}let iF=["","start","move","end","cancel","up","down","left","right"];class iN extends iR{constructor(e={}){super({enable:!0,pointers:1,event:"pan",threshold:10,direction:x.All,...e}),this.pX=null,this.pY=null}getTouchAction(){let{options:{direction:e}}=this,t=[];return e&x.Horizontal&&t.push(ih),e&x.Vertical&&t.push(ic),t}getEventNames(){return iF.map(e=>this.options.event+e)}directionTest(e){let{options:t}=this,i=!0,{distance:r}=e,{direction:n}=e,s=e.deltaX,o=e.deltaY;return n&t.direction||(t.direction&x.Horizontal?(n=0===s?x.None:s<0?x.Left:x.Right,i=s!==this.pX,r=Math.abs(e.deltaX)):(n=0===o?x.None:o<0?x.Up:x.Down,i=o!==this.pY,r=Math.abs(e.deltaY))),e.direction=n,i&&r>t.threshold&&!!(n&t.direction)}attrTest(e){return super.attrTest(e)&&(!!(this.state&w.Began)||!(this.state&w.Began)&&this.directionTest(e))}emit(e){this.pX=e.deltaX,this.pY=e.deltaY;let t=x[e.direction].toLowerCase();t&&(e.additionalEvent=this.options.event+t),super.emit(e)}}let ij=["","start","move","end","cancel","in","out"];class iz{constructor(e,t,i){this.element=e,this.callback=t,this.options=i}}let iU="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"";"undefined"!=typeof window?window:e.g,e.g;let iB=-1!==iU.indexOf("firefox");class i$ extends iz{constructor(e,t,i){super(e,t,{enable:!0,...i}),this.handleEvent=e=>{if(!this.options.enable)return;let t=e.deltaY;globalThis.WheelEvent&&(iB&&e.deltaMode===globalThis.WheelEvent.DOM_DELTA_PIXEL&&(t/=globalThis.devicePixelRatio),e.deltaMode===globalThis.WheelEvent.DOM_DELTA_LINE&&(t*=40)),0!==t&&t%4.000244140625==0&&(t=Math.floor(t/4.000244140625)),e.shiftKey&&t&&(t*=.25),this.callback({type:"wheel",center:{x:e.clientX,y:e.clientY},delta:-t,srcEvent:e,pointerType:"mouse",target:e.target})},e.addEventListener("wheel",this.handleEvent,{passive:!1})}destroy(){this.element.removeEventListener("wheel",this.handleEvent)}enableEventType(e,t){"wheel"===e&&(this.options.enable=t)}}let iV=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class iW extends iz{constructor(e,t,i){super(e,t,{enable:!0,...i}),this.handleEvent=e=>{this.handleOverEvent(e),this.handleOutEvent(e),this.handleEnterEvent(e),this.handleLeaveEvent(e),this.handleMoveEvent(e)},this.pressed=!1;const{enable:r}=this.options;this.enableMoveEvent=r,this.enableLeaveEvent=r,this.enableEnterEvent=r,this.enableOutEvent=r,this.enableOverEvent=r,iV.forEach(t=>e.addEventListener(t,this.handleEvent))}destroy(){iV.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t}}handleOverEvent(e){this.enableOverEvent&&"mouseover"===e.type&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&"mouseout"===e.type&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&"mouseenter"===e.type&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&"mouseleave"===e.type&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":0===e.buttons&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}let iG=["keydown","keyup"];class iq extends iz{constructor(e,t,i){super(e,t,{enable:!0,tabIndex:0,...i}),this.handleEvent=e=>{let t=e.target||e.srcElement;("INPUT"!==t.tagName||"text"!==t.type)&&"TEXTAREA"!==t.tagName&&(this.enableDownEvent&&"keydown"===e.type&&this.callback({type:"keydown",srcEvent:e,key:e.key,target:e.target}),this.enableUpEvent&&"keyup"===e.type&&this.callback({type:"keyup",srcEvent:e,key:e.key,target:e.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",iG.forEach(t=>e.addEventListener(t,this.handleEvent))}destroy(){iG.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){"keydown"===e&&(this.enableDownEvent=t),"keyup"===e&&(this.enableUpEvent=t)}}class iH extends iz{constructor(e,t,i){super(e,t,i),this.handleEvent=e=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:e.clientX,y:e.clientY},srcEvent:e,pointerType:"mouse",target:e.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){"contextmenu"===e&&(this.options.enable=t)}}let iY={pointerdown:1,pointermove:2,pointerup:4,mousedown:1,mousemove:2,mouseup:4},iX={srcElement:"root",priority:0};class iZ{constructor(e,t){this.handleEvent=e=>{if(this.isEmpty())return;let t=this._normalizeEvent(e),i=e.srcEvent.target;for(;i&&i!==t.rootElement;){if(this._emit(t,i),t.handled)return;i=i.parentNode}this._emit(t,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,r=!1,n=!1){let{handlers:s,handlersByElement:o}=this,a={...iX,...i},l=o.get(a.srcElement);l||(l=[],o.set(a.srcElement,l));let u={type:e,handler:t,srcElement:a.srcElement,priority:a.priority};r&&(u.once=!0),n&&(u.passive=!0),s.push(u),this._active=this._active||!u.passive;let c=l.length-1;for(;c>=0&&!(l[c].priority>=u.priority);)c--;l.splice(c+1,0,u)}remove(e,t){let{handlers:i,handlersByElement:r}=this;for(let n=i.length-1;n>=0;n--){let s=i[n];if(s.type===e&&s.handler===t){i.splice(n,1);let e=r.get(s.srcElement);e.splice(e.indexOf(s),1),0===e.length&&r.delete(s.srcElement)}}this._active=i.some(e=>!e.passive)}_emit(e,t){let i=this.handlersByElement.get(t);if(i){let t=!1,r=()=>{e.handled=!0},n=()=>{e.handled=!0,t=!0},s=[];for(let o=0;o<i.length;o++){let{type:a,handler:l,once:u}=i[o];if(l({...e,type:a,stopPropagation:r,stopImmediatePropagation:n}),u&&s.push(i[o]),t)break}for(let e=0;e<s.length;e++){let{type:t,handler:i}=s[e];this.remove(t,i)}}}_normalizeEvent(e){let t=this.eventManager.getElement();return{...e,...function(e){let t=iY[e.srcEvent.type];if(!t)return null;let{buttons:i,button:r}=e.srcEvent,n=!1,s=!1,o=!1;return 2===t?(n=!!(1&i),s=!!(4&i),o=!!(2&i)):(n=0===r,s=1===r,o=2===r),{leftButton:n,middleButton:s,rightButton:o}}(e),...function(e,t){let i=e.center;if(!i)return null;let r=t.getBoundingClientRect(),n=r.width/t.offsetWidth||1,s=r.height/t.offsetHeight||1,o={x:(i.x-r.left-t.clientLeft)/n,y:(i.y-r.top-t.clientTop)/s};return{center:i,offsetCenter:o}}(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}class iK{constructor(e=null,t={}){if(this._onBasicInput=e=>{this.manager.emit(e.srcEvent.type,e)},this._onOtherEvent=e=>{this.manager.emit(e.type,e)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!e)return;for(const t of(this.manager=new iA(e,this.options),this.options.recognizers)){const{recognizer:e,recognizeWith:i,requireFailure:r}=function(e){let t;if("recognizer"in e)return e;let i=Array.isArray(e)?[...e]:[e];return{recognizer:t="function"==typeof i[0]?new(i.shift())(i.shift()||{}):i.shift(),recognizeWith:"string"==typeof i[0]?[i[0]]:i[0],requireFailure:"string"==typeof i[1]?[i[1]]:i[1]}}(t);this.manager.add(e),i&&e.recognizeWith(i),r&&e.requireFailure(r)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new i$(e,this._onOtherEvent,{enable:!1}),this.moveInput=new iW(e,this._onOtherEvent,{enable:!1}),this.keyInput=new iq(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new iH(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){let{manager:i}=this;if(!i)return;let r=i.get(e);r&&(r.set({enable:t}),i.touchAction.update()),this.wheelInput?.enableEventType(e,t),this.moveInput?.enableEventType(e,t),this.keyInput?.enableEventType(e,t),this.contextmenuInput?.enableEventType(e,t)}_addEventHandler(e,t,i,r,n){if("string"!=typeof e){for(let[s,o]of(i=t,Object.entries(e)))this._addEventHandler(s,o,i,r,n);return}let{manager:s,events:o}=this;if(!s)return;let a=o.get(e);!a&&(a=new iZ(this,this._getRecognizerName(e)||e),o.set(e,a),s&&s.on(e,a.handleEvent)),a.add(e,t,i,r,n),a.isEmpty()||this._toggleRecognizer(a.recognizerName,!0)}_removeEventHandler(e,t){if("string"!=typeof e){for(let[t,i]of Object.entries(e))this._removeEventHandler(t,i);return}let{events:i}=this,r=i.get(e);if(r&&(r.remove(e,t),r.isEmpty())){let{recognizerName:e}=r,t=!1;for(let r of i.values())if(r.recognizerName===e&&!r.isEmpty()){t=!0;break}t||this._toggleRecognizer(e,!1)}}_getRecognizerName(e){return this.manager.recognizers.find(t=>t.getEventNames().includes(e))?.options.event}}let iJ={DEFAULT:-1,LNGLAT:1,METER_OFFSETS:2,LNGLAT_OFFSETS:3,CARTESIAN:0};Object.defineProperty(iJ,"IDENTITY",{get:()=>(ia.deprecated("COORDINATE_SYSTEM.IDENTITY","COORDINATE_SYSTEM.CARTESIAN")(),0)});let iQ={WEB_MERCATOR:1,GLOBE:2,WEB_MERCATOR_AUTO_OFFSET:4,IDENTITY:0},i0={common:0,meters:1,pixels:2},i1={click:"onClick",dblclick:"onClick",panstart:"onDragStart",panmove:"onDrag",panend:"onDragEnd"},i2={multipan:[iN,{threshold:10,direction:x.Vertical,pointers:2}],pinch:[class extends iR{constructor(e={}){super({enable:!0,event:"pinch",threshold:0,pointers:2,...e})}getTouchAction(){return[iu]}getEventNames(){return ij.map(e=>this.options.event+e)}attrTest(e){return super.attrTest(e)&&(Math.abs(e.scale-1)>this.options.threshold||!!(this.state&w.Began))}emit(e){if(1!==e.scale){let t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}super.emit(e)}},{},null,["multipan"]],pan:[iN,{threshold:1},["pinch"],["multipan"]],dblclick:[iD,{event:"dblclick",taps:2}],click:[iD,{event:"click"},null,["dblclick"]]};function i3(e){let t,i={};return r=>{for(let n in r)if(!function(e,t){if(e===t)return!0;if(Array.isArray(e)){let i=e.length;if(!t||t.length!==i)return!1;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0}return!1}(r[n],i[n])){t=e(r),i=r;break}return t}}let i4=[0,0,0,0],i6=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],i5=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],i8=[0,0,0],i9=[0,0,0],i7=i3(function({viewport:e,devicePixelRatio:t,coordinateSystem:i,coordinateOrigin:r}){let{projectionCenter:n,viewProjectionMatrix:s,originCommon:o,cameraPosCommon:a,shaderCoordinateOrigin:l,geospatialOrigin:u}=function(e,t,i){let{viewMatrixUncentered:r,projectionMatrix:n}=e,{viewMatrix:s,viewProjectionMatrix:o}=e,a=i4,l=i4,u=e.cameraPosition,{geospatialOrigin:c,shaderCoordinateOrigin:h,offsetMode:d}=re(e,t,i);return d&&(l=e.projectPosition(c||h),u=[u[0]-l[0],u[1]-l[1],u[2]-l[2]],l[3]=1,a=is.transformMat4([],l,o),s=r||s,o=tO.multiply([],n,s),o=tO.multiply([],o,i6)),{viewMatrix:s,viewProjectionMatrix:o,projectionCenter:a,originCommon:l,cameraPosCommon:u,shaderCoordinateOrigin:h,geospatialOrigin:c}}(e,i,r),c=e.getDistanceScales(),h=[e.width*t,e.height*t],d=is.transformMat4([],[0,0,-e.focalDistance,1],e.projectionMatrix)[3]||1,f={coordinateSystem:i,projectionMode:e.projectionMode,coordinateOrigin:l,commonOrigin:o.slice(0,3),center:n,pseudoMeters:!!e._pseudoMeters,viewportSize:h,devicePixelRatio:t,focalDistance:d,commonUnitsPerMeter:c.unitsPerMeter,commonUnitsPerWorldUnit:c.unitsPerMeter,commonUnitsPerWorldUnit2:i8,scale:e.scale,wrapLongitude:!1,viewProjectionMatrix:s,modelMatrix:i5,cameraPosition:a};if(u){let t=e.getDistanceScales(u);switch(i){case iJ.METER_OFFSETS:f.commonUnitsPerWorldUnit=t.unitsPerMeter,f.commonUnitsPerWorldUnit2=t.unitsPerMeter2;break;case iJ.LNGLAT:case iJ.LNGLAT_OFFSETS:e._pseudoMeters||(f.commonUnitsPerMeter=t.unitsPerMeter),f.commonUnitsPerWorldUnit=t.unitsPerDegree,f.commonUnitsPerWorldUnit2=t.unitsPerDegree2;break;case iJ.CARTESIAN:f.commonUnitsPerWorldUnit=[1,1,t.unitsPerMeter[2]],f.commonUnitsPerWorldUnit2=[0,0,t.unitsPerMeter2[2]]}}return f});function re(e,t,i=i9){let r;i.length<3&&(i=[i[0],i[1],0]);let n=i,s=!0;switch(r=t===iJ.LNGLAT_OFFSETS||t===iJ.METER_OFFSETS?i:e.isGeospatial?[Math.fround(e.longitude),Math.fround(e.latitude),0]:null,e.projectionMode){case iQ.WEB_MERCATOR:(t===iJ.LNGLAT||t===iJ.CARTESIAN)&&(r=[0,0,0],s=!1);break;case iQ.WEB_MERCATOR_AUTO_OFFSET:t===iJ.LNGLAT?n=r:t===iJ.CARTESIAN&&(n=[Math.fround(e.center[0]),Math.fround(e.center[1]),0],r=e.unprojectPosition(n),n[0]-=i[0],n[1]-=i[1],n[2]-=i[2]);break;case iQ.IDENTITY:(n=e.position.map(Math.fround))[2]=n[2]||0;break;case iQ.GLOBE:s=!1,r=null;break;default:s=!1}return{geospatialOrigin:r,shaderCoordinateOrigin:n,offsetMode:s}}let rt=Object.keys(iJ).map(e=>`const COORDINATE_SYSTEM_${e}: i32 = ${iJ[e]};`).join(""),ri=Object.keys(iQ).map(e=>`const PROJECTION_MODE_${e}: i32 = ${iQ[e]};`).join(""),rr=Object.keys(i0).map(e=>`const UNIT_${e.toUpperCase()}: i32 = ${i0[e]};`).join(""),rn=`\
${rt}
${ri}
${rr}

const TILE_SIZE: f32 = 512.0;
const PI: f32 = 3.1415926536;
const WORLD_SCALE: f32 = TILE_SIZE / (PI * 2.0);
const ZERO_64_LOW: vec3<f32> = vec3<f32>(0.0, 0.0, 0.0);
const EARTH_RADIUS: f32 = 6370972.0; // meters
const GLOBE_RADIUS: f32 = 256.0;

// -----------------------------------------------------------------------------
// Uniform block (converted from GLSL uniform block)
// -----------------------------------------------------------------------------
struct ProjectUniforms {
  wrapLongitude: i32,
  coordinateSystem: i32,
  commonUnitsPerMeter: vec3<f32>,
  projectionMode: i32,
  scale: f32,
  commonUnitsPerWorldUnit: vec3<f32>,
  commonUnitsPerWorldUnit2: vec3<f32>,
  center: vec4<f32>,
  modelMatrix: mat4x4<f32>,
  viewProjectionMatrix: mat4x4<f32>,
  viewportSize: vec2<f32>,
  devicePixelRatio: f32,
  focalDistance: f32,
  cameraPosition: vec3<f32>,
  coordinateOrigin: vec3<f32>,
  commonOrigin: vec3<f32>,
  pseudoMeters: i32,
};

@group(0) @binding(0)
var<uniform> project: ProjectUniforms;

// -----------------------------------------------------------------------------
// Geometry data
// (In your GLSL code, "geometry" was assumed to be available globally. In WGSL,
// you might supply this via vertex attributes or a uniform. Here we define a
// uniform struct for demonstration.)
// -----------------------------------------------------------------------------

// Structure to carry additional geometry data used by deck.gl filters.
struct Geometry {
  worldPosition: vec3<f32>,
  worldPositionAlt: vec3<f32>,
  position: vec4<f32>,
  normal: vec3<f32>,
  uv: vec2<f32>,
  pickingColor: vec3<f32>,
};

// @group(0) @binding(1)
var<private> geometry: Geometry;
`,rs=`\
${rn}

// -----------------------------------------------------------------------------
// Functions
// -----------------------------------------------------------------------------

// Returns an adjustment factor for commonUnitsPerMeter
fn _project_size_at_latitude(lat: f32) -> f32 {
  let y = clamp(lat, -89.9, 89.9);
  return 1.0 / cos(radians(y));
}

// Overloaded version: scales a value in meters at a given latitude.
fn _project_size_at_latitude_m(meters: f32, lat: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * _project_size_at_latitude(lat);
}

// Computes a non-linear scale factor based on geometry.
// (Note: This function relies on "geometry" being provided.)
fn project_size() -> f32 {
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
      project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
      project.pseudoMeters == 0) {
    if (geometry.position.w == 0.0) {
      return _project_size_at_latitude(geometry.worldPosition.y);
    }
    let y: f32 = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
    let y2 = y * y;
    let y4 = y2 * y2;
    let y6 = y4 * y2;
    return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
  }
  return 1.0;
}

// Overloads to scale offsets (meters to world units)
fn project_size_float(meters: f32) -> f32 {
  return meters * project.commonUnitsPerMeter.z * project_size();
}

fn project_size_vec2(meters: vec2<f32>) -> vec2<f32> {
  return meters * project.commonUnitsPerMeter.xy * project_size();
}

fn project_size_vec3(meters: vec3<f32>) -> vec3<f32> {
  return meters * project.commonUnitsPerMeter * project_size();
}

fn project_size_vec4(meters: vec4<f32>) -> vec4<f32> {
  return vec4<f32>(meters.xyz * project.commonUnitsPerMeter, meters.w);
}

// Returns a rotation matrix aligning the zaxis with the given up vector.
fn project_get_orientation_matrix(up: vec3<f32>) -> mat3x3<f32> {
  let uz = normalize(up);
  let ux = select(
    vec3<f32>(1.0, 0.0, 0.0),
    normalize(vec3<f32>(uz.y, -uz.x, 0.0)),
    abs(uz.z) == 1.0
  );
  let uy = cross(uz, ux);
  return mat3x3<f32>(ux, uy, uz);
}

// Since WGSL does not support "out" parameters, we return a struct.
struct RotationResult {
  needsRotation: bool,
  transform: mat3x3<f32>,
};

fn project_needs_rotation(commonPosition: vec3<f32>) -> RotationResult {
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    return RotationResult(true, project_get_orientation_matrix(commonPosition));
  } else {
    return RotationResult(false, mat3x3<f32>());  // identity alternative if needed
  };
}

// Projects a normal vector from the current coordinate system to world space.
fn project_normal(vector: vec3<f32>) -> vec3<f32> {
  let normal_modelspace = project.modelMatrix * vec4<f32>(vector, 0.0);
  var n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
  let rotResult = project_needs_rotation(geometry.position.xyz);
  if (rotResult.needsRotation) {
    n = rotResult.transform * n;
  }
  return n;
}

// Applies a scale offset based on y-offset (dy)
fn project_offset_(offset: vec4<f32>) -> vec4<f32> {
  let dy: f32 = offset.y;
  let commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
  return vec4<f32>(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}

// Projects lng/lat coordinates to a unit tile [0,1]
fn project_mercator_(lnglat: vec2<f32>) -> vec2<f32> {
  var x = lnglat.x;
  if (project.wrapLongitude != 0) {
    x = ((x + 180.0) % 360.0) - 180.0;
  }
  let y = clamp(lnglat.y, -89.9, 89.9);
  return vec2<f32>(
    radians(x) + PI,
    PI + log(tan(PI * 0.25 + radians(y) * 0.5))
  ) * WORLD_SCALE;
}

// Projects lng/lat/z coordinates for a globe projection.
fn project_globe_(lnglatz: vec3<f32>) -> vec3<f32> {
  let lambda = radians(lnglatz.x);
  let phi = radians(lnglatz.y);
  let cosPhi = cos(phi);
  let D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
  return vec3<f32>(
    sin(lambda) * cosPhi,
    -cos(lambda) * cosPhi,
    sin(phi)
  ) * D;
}

// Projects positions (with an optional 64-bit low part) from the input
// coordinate system to the common space.
fn project_position_vec4_f64(position: vec4<f32>, position64Low: vec3<f32>) -> vec4<f32> {
  var position_world = project.modelMatrix * position;

  // Work around for a Mac+NVIDIA bug:
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_mercator_(position_world.xy),
        _project_size_at_latitude_m(position_world.z, position_world.y),
        position_world.w
      );
    }
    if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
      position_world = vec4f(position_world.xyz + project.coordinateOrigin, position_world.w);
    }
  }
  if (project.projectionMode == PROJECTION_MODE_GLOBE) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      return vec4<f32>(
        project_globe_(position_world.xyz),
        position_world.w
      );
    }
  }
  if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
    if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
      if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
        return vec4<f32>(
          project_mercator_(position_world.xy) - project.commonOrigin.xy,
          project_size_float(position_world.z),
          position_world.w
        );
      }
    }
  }
  if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
      (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
       (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
        project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
    position_world = vec4f(position_world.xyz - project.coordinateOrigin, position_world.w);
  }

  return project_offset_(position_world) +
         project_offset_(project.modelMatrix * vec4<f32>(position64Low, 0.0));
}

// Overloaded versions for different input types.
fn project_position_vec4_f32(position: vec4<f32>) -> vec4<f32> {
  return project_position_vec4_f64(position, ZERO_64_LOW);
}

fn project_position_vec3_f64(position: vec3<f32>, position64Low: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), position64Low);
  return projected_position.xyz;
}

fn project_position_vec3_f32(position: vec3<f32>) -> vec3<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 1.0), ZERO_64_LOW);
  return projected_position.xyz;
}

fn project_position_vec2_f32(position: vec2<f32>) -> vec2<f32> {
  let projected_position = project_position_vec4_f64(vec4<f32>(position, 0.0, 1.0), ZERO_64_LOW);
  return projected_position.xy;
}

// Transforms a common space position to clip space.
fn project_common_position_to_clipspace_with_projection(position: vec4<f32>, viewProjectionMatrix: mat4x4<f32>, center: vec4<f32>) -> vec4<f32> {
  return viewProjectionMatrix * position + center;
}

// Uses the project viewProjectionMatrix and center.
fn project_common_position_to_clipspace(position: vec4<f32>) -> vec4<f32> {
  return project_common_position_to_clipspace_with_projection(position, project.viewProjectionMatrix, project.center);
}

// Returns a clip space offset corresponding to a given number of screen pixels.
fn project_pixel_size_to_clipspace(pixels: vec2<f32>) -> vec2<f32> {
  let offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
  return offset * project.focalDistance;
}

fn project_meter_size_to_pixel(meters: f32) -> f32 {
  return project_size_float(meters) * project.scale;
}

fn project_unit_size_to_pixel(size: f32, unit: i32) -> f32 {
  if (unit == UNIT_METERS) {
    return project_meter_size_to_pixel(size);
  } else if (unit == UNIT_COMMON) {
    return size * project.scale;
  }
  // UNIT_PIXELS: no scaling applied.
  return size;
}

fn project_pixel_size_float(pixels: f32) -> f32 {
  return pixels / project.scale;
}

fn project_pixel_size_vec2(pixels: vec2<f32>) -> vec2<f32> {
  return pixels / project.scale;
}
`,ro=Object.keys(iJ).map(e=>`const int COORDINATE_SYSTEM_${e} = ${iJ[e]};`).join(""),ra=Object.keys(iQ).map(e=>`const int PROJECTION_MODE_${e} = ${iQ[e]};`).join(""),rl=Object.keys(i0).map(e=>`const int UNIT_${e.toUpperCase()} = ${i0[e]};`).join(""),ru={},rc={name:"project",dependencies:[{name:"fp32",vs:eG},eW],source:rs,vs:`\
${ro}
${ra}
${rl}
uniform projectUniforms {
bool wrapLongitude;
int coordinateSystem;
vec3 commonUnitsPerMeter;
int projectionMode;
float scale;
vec3 commonUnitsPerWorldUnit;
vec3 commonUnitsPerWorldUnit2;
vec4 center;
mat4 modelMatrix;
mat4 viewProjectionMatrix;
vec2 viewportSize;
float devicePixelRatio;
float focalDistance;
vec3 cameraPosition;
vec3 coordinateOrigin;
vec3 commonOrigin;
bool pseudoMeters;
} project;
const float TILE_SIZE = 512.0;
const float PI = 3.1415926536;
const float WORLD_SCALE = TILE_SIZE / (PI * 2.0);
const vec3 ZERO_64_LOW = vec3(0.0);
const float EARTH_RADIUS = 6370972.0;
const float GLOBE_RADIUS = 256.0;
float project_size_at_latitude(float lat) {
float y = clamp(lat, -89.9, 89.9);
return 1.0 / cos(radians(y));
}
float project_size() {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR &&
project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT &&
project.pseudoMeters == false) {
if (geometry.position.w == 0.0) {
return project_size_at_latitude(geometry.worldPosition.y);
}
float y = geometry.position.y / TILE_SIZE * 2.0 - 1.0;
float y2 = y * y;
float y4 = y2 * y2;
float y6 = y4 * y2;
return 1.0 + 4.9348 * y2 + 4.0587 * y4 + 1.5642 * y6;
}
return 1.0;
}
float project_size_at_latitude(float meters, float lat) {
return meters * project.commonUnitsPerMeter.z * project_size_at_latitude(lat);
}
float project_size(float meters) {
return meters * project.commonUnitsPerMeter.z * project_size();
}
vec2 project_size(vec2 meters) {
return meters * project.commonUnitsPerMeter.xy * project_size();
}
vec3 project_size(vec3 meters) {
return meters * project.commonUnitsPerMeter * project_size();
}
vec4 project_size(vec4 meters) {
return vec4(meters.xyz * project.commonUnitsPerMeter, meters.w);
}
mat3 project_get_orientation_matrix(vec3 up) {
vec3 uz = normalize(up);
vec3 ux = abs(uz.z) == 1.0 ? vec3(1.0, 0.0, 0.0) : normalize(vec3(uz.y, -uz.x, 0));
vec3 uy = cross(uz, ux);
return mat3(ux, uy, uz);
}
bool project_needs_rotation(vec3 commonPosition, out mat3 transform) {
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
transform = project_get_orientation_matrix(commonPosition);
return true;
}
return false;
}
vec3 project_normal(vec3 vector) {
vec4 normal_modelspace = project.modelMatrix * vec4(vector, 0.0);
vec3 n = normalize(normal_modelspace.xyz * project.commonUnitsPerMeter);
mat3 rotation;
if (project_needs_rotation(geometry.position.xyz, rotation)) {
n = rotation * n;
}
return n;
}
vec4 project_offset_(vec4 offset) {
float dy = offset.y;
vec3 commonUnitsPerWorldUnit = project.commonUnitsPerWorldUnit + project.commonUnitsPerWorldUnit2 * dy;
return vec4(offset.xyz * commonUnitsPerWorldUnit, offset.w);
}
vec2 project_mercator_(vec2 lnglat) {
float x = lnglat.x;
if (project.wrapLongitude) {
x = mod(x + 180., 360.0) - 180.;
}
float y = clamp(lnglat.y, -89.9, 89.9);
return vec2(
radians(x) + PI,
PI + log(tan_fp32(PI * 0.25 + radians(y) * 0.5))
) * WORLD_SCALE;
}
vec3 project_globe_(vec3 lnglatz) {
float lambda = radians(lnglatz.x);
float phi = radians(lnglatz.y);
float cosPhi = cos(phi);
float D = (lnglatz.z / EARTH_RADIUS + 1.0) * GLOBE_RADIUS;
return vec3(
sin(lambda) * cosPhi,
-cos(lambda) * cosPhi,
sin(phi)
) * D;
}
vec4 project_position(vec4 position, vec3 position64Low) {
vec4 position_world = project.modelMatrix * position;
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_mercator_(position_world.xy),
project_size_at_latitude(position_world.z, position_world.y),
position_world.w
);
}
if (project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN) {
position_world.xyz += project.coordinateOrigin;
}
}
if (project.projectionMode == PROJECTION_MODE_GLOBE) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
return vec4(
project_globe_(position_world.xyz),
position_world.w
);
}
}
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
if (project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
if (abs(position_world.y - project.coordinateOrigin.y) > 0.25) {
return vec4(
project_mercator_(position_world.xy) - project.commonOrigin.xy,
project_size(position_world.z),
position_world.w
);
}
}
}
if (project.projectionMode == PROJECTION_MODE_IDENTITY ||
(project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET &&
(project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT ||
project.coordinateSystem == COORDINATE_SYSTEM_CARTESIAN))) {
position_world.xyz -= project.coordinateOrigin;
}
return project_offset_(position_world) + project_offset_(project.modelMatrix * vec4(position64Low, 0.0));
}
vec4 project_position(vec4 position) {
return project_position(position, ZERO_64_LOW);
}
vec3 project_position(vec3 position, vec3 position64Low) {
vec4 projected_position = project_position(vec4(position, 1.0), position64Low);
return projected_position.xyz;
}
vec3 project_position(vec3 position) {
vec4 projected_position = project_position(vec4(position, 1.0), ZERO_64_LOW);
return projected_position.xyz;
}
vec2 project_position(vec2 position) {
vec4 projected_position = project_position(vec4(position, 0.0, 1.0), ZERO_64_LOW);
return projected_position.xy;
}
vec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {
return viewProjectionMatrix * position + center;
}
vec4 project_common_position_to_clipspace(vec4 position) {
return project_common_position_to_clipspace(position, project.viewProjectionMatrix, project.center);
}
vec2 project_pixel_size_to_clipspace(vec2 pixels) {
vec2 offset = pixels / project.viewportSize * project.devicePixelRatio * 2.0;
return offset * project.focalDistance;
}
float project_size_to_pixel(float meters) {
return project_size(meters) * project.scale;
}
float project_size_to_pixel(float size, int unit) {
if (unit == UNIT_METERS) return project_size_to_pixel(size);
if (unit == UNIT_COMMON) return size * project.scale;
return size;
}
float project_pixel_size(float pixels) {
return pixels / project.scale;
}
vec2 project_pixel_size(vec2 pixels) {
return pixels / project.scale;
}
`,getUniforms:function(e=ru){return"viewport"in e?function({viewport:e,devicePixelRatio:t=1,modelMatrix:i=null,coordinateSystem:r=iJ.DEFAULT,coordinateOrigin:n=i9,autoWrapLongitude:s=!1}){r===iJ.DEFAULT&&(r=e.isGeospatial?iJ.LNGLAT:iJ.CARTESIAN);let o=i7({viewport:e,devicePixelRatio:t,coordinateSystem:r,coordinateOrigin:n});return o.wrapLongitude=s,o.modelMatrix=i||i5,o}(e):{}},uniformTypes:{wrapLongitude:"f32",coordinateSystem:"i32",commonUnitsPerMeter:"vec3<f32>",projectionMode:"i32",scale:"f32",commonUnitsPerWorldUnit:"vec3<f32>",commonUnitsPerWorldUnit2:"vec3<f32>",center:"vec4<f32>",modelMatrix:"mat4x4<f32>",viewProjectionMatrix:"mat4x4<f32>",viewportSize:"vec2<f32>",devicePixelRatio:"f32",focalDistance:"f32",cameraPosition:"vec3<f32>",coordinateOrigin:"vec3<f32>",commonOrigin:"vec3<f32>",pseudoMeters:"f32"}},rh={name:"project32",dependencies:[rc],source:`\
// Define a structure to hold both the clip-space position and the common position.
struct ProjectResult {
  clipPosition: vec4<f32>,
  commonPosition: vec4<f32>,
};

// This function mimics the GLSL version with the 'out' parameter by returning both values.
fn project_position_to_clipspace_and_commonspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> ProjectResult {
  // Compute the projected position.
  let projectedPosition: vec3<f32> = project_position_vec3_f64(position, position64Low);

  // Start with the provided offset.
  var finalOffset: vec3<f32> = offset;

  // Get whether a rotation is needed and the rotation matrix.
  let rotationResult = project_needs_rotation(projectedPosition);

  // If rotation is needed, update the offset.
  if (rotationResult.needsRotation) {
    finalOffset = rotationResult.transform * offset;
  }

  // Compute the common position.
  let commonPosition: vec4<f32> = vec4<f32>(projectedPosition + finalOffset, 1.0);

  // Convert to clip-space.
  let clipPosition: vec4<f32> = project_common_position_to_clipspace(commonPosition);

  return ProjectResult(clipPosition, commonPosition);
}

// A convenience overload that returns only the clip-space position.
fn project_position_to_clipspace(
    position: vec3<f32>,
    position64Low: vec3<f32>,
    offset: vec3<f32>
) -> vec4<f32> {
  return project_position_to_clipspace_and_commonspace(position, position64Low, offset).clipPosition;
}
`,vs:`\
vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset, out vec4 commonPosition
) {
  vec3 projectedPosition = project_position(position, position64Low);
  mat3 rotation;
  if (project_needs_rotation(projectedPosition, rotation)) {
    // offset is specified as ENU
    // when in globe projection, rotate offset so that the ground alighs with the surface of the globe
    offset = rotation * offset;
  }
  commonPosition = vec4(projectedPosition + offset, 1.0);
  return project_common_position_to_clipspace(commonPosition);
}

vec4 project_position_to_clipspace(
  vec3 position, vec3 position64Low, vec3 offset
) {
  vec4 commonPosition;
  return project_position_to_clipspace(position, position64Low, offset, commonPosition);
}
`};globalThis.mathgl=globalThis.mathgl||{config:{EPSILON:1e-12,debug:!1,precision:4,printTypes:!1,printDegrees:!1,printRowMajor:!0,_cartographicRadians:!1}};let rd=globalThis.mathgl.config;function rf(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&!(e instanceof DataView)}function rp(e,t,i){return function(e,t,i){if(rf(e)){i=i||(e.clone?e.clone():Array(e.length));for(let r=0;r<i.length&&r<e.length;++r){let n="number"==typeof e?e:e[r];i[r]=t(n,r,i)}return i}return t(e)}(e,e=>Math.max(t,Math.min(i,e)))}function rg(e,t,i){return rf(e)?e.map((e,r)=>rg(e,t[r],i)):i*t+(1-i)*e}function rm(e,t,i){let r=rd.EPSILON;i&&(rd.EPSILON=i);try{if(e===t)return!0;if(rf(e)&&rf(t)){if(e.length!==t.length)return!1;for(let i=0;i<e.length;++i)if(!rm(e[i],t[i]))return!1;return!0}if(e&&e.equals)return e.equals(t);if(t&&t.equals)return t.equals(e);if("number"==typeof e&&"number"==typeof t)return Math.abs(e-t)<=rd.EPSILON*Math.max(1,Math.abs(e),Math.abs(t));return!1}finally{rd.EPSILON=r}}class ry extends Array{clone(){return new this.constructor().copy(this)}fromArray(e,t=0){for(let i=0;i<this.ELEMENTS;++i)this[i]=e[i+t];return this.check()}toArray(e=[],t=0){for(let i=0;i<this.ELEMENTS;++i)e[t+i]=this[i];return e}toObject(e){return e}from(e){return Array.isArray(e)?this.copy(e):this.fromObject(e)}to(e){return e===this?this:rf(e)?this.toArray(e):this.toObject(e)}toTarget(e){return e?this.to(e):this}toFloat32Array(){return new Float32Array(this)}toString(){return this.formatString(rd)}formatString(e){let t="";for(let i=0;i<this.ELEMENTS;++i)t+=(i>0?", ":"")+function(e,{precision:t=rd.precision}={}){return e=Math.round(e/rd.EPSILON)*rd.EPSILON,`${parseFloat(e.toPrecision(t))}`}(this[i],e);return`${e.printTypes?this.constructor.name:""}[${t}]`}equals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(!rm(this[t],e[t]))return!1;return!0}exactEquals(e){if(!e||this.length!==e.length)return!1;for(let t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}negate(){for(let e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}lerp(e,t,i){if(void 0===i)return this.lerp(this,e,t);for(let r=0;r<this.ELEMENTS;++r){let n=e[r],s="number"==typeof t?t:t[r];this[r]=n+i*(s-n)}return this.check()}min(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}max(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}clamp(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e[i]),t[i]);return this.check()}add(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]+=t[e];return this.check()}subtract(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]-=t[e];return this.check()}scale(e){if("number"==typeof e)for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;else for(let t=0;t<this.ELEMENTS&&t<e.length;++t)this[t]*=e[t];return this.check()}multiplyByScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}check(){if(rd.debug&&!this.validate())throw Error(`math.gl: ${this.constructor.name} some fields set to invalid numbers'`);return this}validate(){let e=this.length===this.ELEMENTS;for(let t=0;t<this.ELEMENTS;++t)e=e&&Number.isFinite(this[t]);return e}sub(e){return this.subtract(e)}setScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}addScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}subScalar(e){return this.addScalar(-e)}multiplyScalar(e){for(let t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}divideScalar(e){return this.multiplyByScalar(1/e)}clampScalar(e,t){for(let i=0;i<this.ELEMENTS;++i)this[i]=Math.min(Math.max(this[i],e),t);return this.check()}get elements(){return this}}function r_(e){if(!Number.isFinite(e))throw Error(`Invalid number ${JSON.stringify(e)}`);return e}function rv(e,t,i=""){if(rd.debug&&!function(e,t){if(e.length!==t)return!1;for(let t=0;t<e.length;++t)if(!Number.isFinite(e[t]))return!1;return!0}(e,t))throw Error(`math.gl: ${i} some fields set to invalid numbers'`);return e}function rb(e,t){if(!e)throw Error(`math.gl assertion ${t}`)}class rx extends ry{get x(){return this[0]}set x(e){this[0]=r_(e)}get y(){return this[1]}set y(e){this[1]=r_(e)}len(){return Math.sqrt(this.lengthSquared())}magnitude(){return this.len()}lengthSquared(){let e=0;for(let t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}magnitudeSquared(){return this.lengthSquared()}distance(e){return Math.sqrt(this.distanceSquared(e))}distanceSquared(e){let t=0;for(let i=0;i<this.ELEMENTS;++i){let r=this[i]-e[i];t+=r*r}return r_(t)}dot(e){let t=0;for(let i=0;i<this.ELEMENTS;++i)t+=this[i]*e[i];return r_(t)}normalize(){let e=this.magnitude();if(0!==e)for(let t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}multiply(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]*=t[e];return this.check()}divide(...e){for(let t of e)for(let e=0;e<this.ELEMENTS;++e)this[e]/=t[e];return this.check()}lengthSq(){return this.lengthSquared()}distanceTo(e){return this.distance(e)}distanceToSquared(e){return this.distanceSquared(e)}getComponent(e){return rb(e>=0&&e<this.ELEMENTS,"index is out of range"),r_(this[e])}setComponent(e,t){return rb(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}addVectors(e,t){return this.copy(e).add(t)}subVectors(e,t){return this.copy(e).subtract(t)}multiplyVectors(e,t){return this.copy(e).multiply(t)}addScaledVector(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}}function rw(){let e=new eq(3);return eq!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function rk(e){let t=new eq(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function rT(e){let t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)}function rS(e,t,i){let r=new eq(3);return r[0]=e,r[1]=t,r[2]=i,r}function rP(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function rE(e,t,i,r){return e[0]=t,e[1]=i,e[2]=r,e}function rC(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function rI(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function rA(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function rM(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e}function rL(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function rO(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function rR(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e}function rD(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e}function rF(e,t){return e[0]=eY(t[0]),e[1]=eY(t[1]),e[2]=eY(t[2]),e}function rN(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function rj(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e}function rz(e,t){let i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(i*i+r*r+n*n)}function rU(e,t){let i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2];return i*i+r*r+n*n}function rB(e){let t=e[0],i=e[1],r=e[2];return t*t+i*i+r*r}function r$(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function rV(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function rW(e,t){let i=t[0],r=t[1],n=t[2],s=i*i+r*r+n*n;return s>0&&(s=1/Math.sqrt(s)),e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e}function rG(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function rq(e,t,i){let r=t[0],n=t[1],s=t[2],o=i[0],a=i[1],l=i[2];return e[0]=n*l-s*a,e[1]=s*o-r*l,e[2]=r*a-n*o,e}function rH(e,t,i,r){let n=t[0],s=t[1],o=t[2];return e[0]=n+r*(i[0]-n),e[1]=s+r*(i[1]-s),e[2]=o+r*(i[2]-o),e}function rY(e,t,i,r){let n=Math.acos(Math.min(Math.max(rG(t,i),-1),1)),s=Math.sin(n),o=Math.sin((1-r)*n)/s,a=Math.sin(r*n)/s;return e[0]=o*t[0]+a*i[0],e[1]=o*t[1]+a*i[1],e[2]=o*t[2]+a*i[2],e}function rX(e,t,i,r,n,s){let o=s*s,a=o*(2*s-3)+1,l=o*(s-2)+s,u=o*(s-1),c=o*(3-2*s);return e[0]=t[0]*a+i[0]*l+r[0]*u+n[0]*c,e[1]=t[1]*a+i[1]*l+r[1]*u+n[1]*c,e[2]=t[2]*a+i[2]*l+r[2]*u+n[2]*c,e}function rZ(e,t,i,r,n,s){let o=1-s,a=o*o,l=s*s,u=a*o,c=3*s*a,h=3*l*o,d=l*s;return e[0]=t[0]*u+i[0]*c+r[0]*h+n[0]*d,e[1]=t[1]*u+i[1]*c+r[1]*h+n[1]*d,e[2]=t[2]*u+i[2]*c+r[2]*h+n[2]*d,e}function rK(e,t){t=void 0===t?1:t;let i=2*eH()*Math.PI,r=2*eH()-1,n=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(i)*n,e[1]=Math.sin(i)*n,e[2]=r*t,e}function rJ(e,t,i){let r=t[0],n=t[1],s=t[2],o=i[3]*r+i[7]*n+i[11]*s+i[15];return o=o||1,e[0]=(i[0]*r+i[4]*n+i[8]*s+i[12])/o,e[1]=(i[1]*r+i[5]*n+i[9]*s+i[13])/o,e[2]=(i[2]*r+i[6]*n+i[10]*s+i[14])/o,e}function rQ(e,t,i){let r=t[0],n=t[1],s=t[2];return e[0]=r*i[0]+n*i[3]+s*i[6],e[1]=r*i[1]+n*i[4]+s*i[7],e[2]=r*i[2]+n*i[5]+s*i[8],e}function r0(e,t,i){let r=i[0],n=i[1],s=i[2],o=i[3],a=t[0],l=t[1],u=t[2],c=n*u-s*l,h=s*a-r*u,d=r*l-n*a,f=n*d-s*h,p=s*c-r*d,g=r*h-n*c,m=2*o;return c*=m,h*=m,d*=m,f*=2,p*=2,g*=2,e[0]=a+c+f,e[1]=l+h+p,e[2]=u+d+g,e}function r1(e,t,i,r){let n=[],s=[];return n[0]=t[0]-i[0],n[1]=t[1]-i[1],n[2]=t[2]-i[2],s[0]=n[0],s[1]=n[1]*Math.cos(r)-n[2]*Math.sin(r),s[2]=n[1]*Math.sin(r)+n[2]*Math.cos(r),e[0]=s[0]+i[0],e[1]=s[1]+i[1],e[2]=s[2]+i[2],e}function r2(e,t,i,r){let n=[],s=[];return n[0]=t[0]-i[0],n[1]=t[1]-i[1],n[2]=t[2]-i[2],s[0]=n[2]*Math.sin(r)+n[0]*Math.cos(r),s[1]=n[1],s[2]=n[2]*Math.cos(r)-n[0]*Math.sin(r),e[0]=s[0]+i[0],e[1]=s[1]+i[1],e[2]=s[2]+i[2],e}function r3(e,t,i,r){let n=[],s=[];return n[0]=t[0]-i[0],n[1]=t[1]-i[1],n[2]=t[2]-i[2],s[0]=n[0]*Math.cos(r)-n[1]*Math.sin(r),s[1]=n[0]*Math.sin(r)+n[1]*Math.cos(r),s[2]=n[2],e[0]=s[0]+i[0],e[1]=s[1]+i[1],e[2]=s[2]+i[2],e}function r4(e,t){let i=e[0],r=e[1],n=e[2],s=t[0],o=t[1],a=t[2],l=Math.sqrt((i*i+r*r+n*n)*(s*s+o*o+a*a));return Math.acos(Math.min(Math.max(l&&rG(e,t)/l,-1),1))}function r6(e){return e[0]=0,e[1]=0,e[2]=0,e}function r5(e){return`vec3(${e[0]}, ${e[1]}, ${e[2]})`}function r8(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function r9(e,t){let i=e[0],r=e[1],n=e[2],s=t[0],o=t[1],a=t[2];return Math.abs(i-s)<=1e-6*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-o)<=1e-6*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(n-a)<=1e-6*Math.max(1,Math.abs(n),Math.abs(a))}let r7=(o=rw(),function(e,t,i,r,n,s){let a,l;for(t||(t=3),i||(i=0),l=r?Math.min(r*t+i,e.length):e.length,a=i;a<l;a+=t)o[0]=e[a],o[1]=e[a+1],o[2]=e[a+2],n(o,o,s),e[a]=o[0],e[a+1]=o[1],e[a+2]=o[2];return e});function ne(e,t,i){let r=t[0],n=t[1],s=t[2],o=i[3]*r+i[7]*n+i[11]*s||1;return e[0]=(i[0]*r+i[4]*n+i[8]*s)/o,e[1]=(i[1]*r+i[5]*n+i[9]*s)/o,e[2]=(i[2]*r+i[6]*n+i[10]*s)/o,e}e.s(["add",()=>rC,"angle",()=>r4,"bezier",()=>rZ,"ceil",()=>rL,"clone",()=>rk,"copy",()=>rP,"create",()=>rw,"cross",()=>rq,"dist",0,rz,"distance",()=>rz,"div",0,rM,"divide",()=>rM,"dot",()=>rG,"equals",()=>r9,"exactEquals",()=>r8,"floor",()=>rO,"forEach",0,r7,"fromValues",()=>rS,"hermite",()=>rX,"inverse",()=>rV,"len",0,rT,"length",()=>rT,"lerp",()=>rH,"max",()=>rD,"min",()=>rR,"mul",0,rA,"multiply",()=>rA,"negate",()=>r$,"normalize",()=>rW,"random",()=>rK,"rotateX",()=>r1,"rotateY",()=>r2,"rotateZ",()=>r3,"round",()=>rF,"scale",()=>rN,"scaleAndAdd",()=>rj,"set",()=>rE,"slerp",()=>rY,"sqrDist",0,rU,"sqrLen",0,rB,"squaredDistance",()=>rU,"squaredLength",()=>rB,"str",()=>r5,"sub",0,rI,"subtract",()=>rI,"transformMat3",()=>rQ,"transformMat4",()=>rJ,"transformQuat",()=>r0,"zero",()=>r6],93311);let nt=[0,0,0];class ni extends rx{static get ZERO(){return t||Object.freeze(t=new ni(0,0,0)),t}constructor(e=0,t=0,i=0){super(-0,-0,-0),1==arguments.length&&rf(e)?this.copy(e):(rd.debug&&(r_(e),r_(t),r_(i)),this[0]=e,this[1]=t,this[2]=i)}set(e,t,i){return this[0]=e,this[1]=t,this[2]=i,this.check()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this.check()}fromObject(e){return rd.debug&&(r_(e.x),r_(e.y),r_(e.z)),this[0]=e.x,this[1]=e.y,this[2]=e.z,this.check()}toObject(e){return e.x=this[0],e.y=this[1],e.z=this[2],e}get ELEMENTS(){return 3}get z(){return this[2]}set z(e){this[2]=r_(e)}angle(e){return r4(this,e)}cross(e){return rq(this,this,e),this.check()}rotateX({radians:e,origin:t=nt}){return r1(this,this,t,e),this.check()}rotateY({radians:e,origin:t=nt}){return r2(this,this,t,e),this.check()}rotateZ({radians:e,origin:t=nt}){return r3(this,this,t,e),this.check()}transform(e){return this.transformAsPoint(e)}transformAsPoint(e){return rJ(this,this,e),this.check()}transformAsVector(e){return ne(this,this,e),this.check()}transformByMatrix3(e){return rQ(this,this,e),this.check()}transformByMatrix2(e){let t,i;return t=this[0],i=this[1],this[0]=e[0]*t+e[2]*i,this[1]=e[1]*t+e[3]*i,this[2]=this[2],this.check()}transformByQuaternion(e){return r0(this,this,e),this.check()}}class nr extends ry{toString(){let e="[";if(rd.printRowMajor){e+="row-major:";for(let t=0;t<this.RANK;++t)for(let i=0;i<this.RANK;++i)e+=` ${this[i*this.RANK+t]}`}else{e+="column-major:";for(let t=0;t<this.ELEMENTS;++t)e+=` ${this[t]}`}return e+"]"}getElementIndex(e,t){return t*this.RANK+e}getElement(e,t){return this[t*this.RANK+e]}setElement(e,t,i){return this[t*this.RANK+e]=r_(i),this}getColumn(e,t=Array(this.RANK).fill(-0)){let i=e*this.RANK;for(let e=0;e<this.RANK;++e)t[e]=this[i+e];return t}setColumn(e,t){let i=e*this.RANK;for(let e=0;e<this.RANK;++e)this[i+e]=t[e];return this}}function nn(){let e=new eq(2);return eq!=Float32Array&&(e[0]=0,e[1]=0),e}function ns(e){let t=new eq(2);return t[0]=e[0],t[1]=e[1],t}function no(e,t){let i=new eq(2);return i[0]=e,i[1]=t,i}function na(e,t){return e[0]=t[0],e[1]=t[1],e}function nl(e,t,i){return e[0]=t,e[1]=i,e}function nu(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function nc(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function nh(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function nd(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function nf(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function np(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function ng(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e}function nm(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e}function ny(e,t){return e[0]=eY(t[0]),e[1]=eY(t[1]),e}function n_(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function nv(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e}function nb(e,t){let i=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(i*i+r*r)}function nx(e,t){let i=t[0]-e[0],r=t[1]-e[1];return i*i+r*r}function nw(e){let t=e[0],i=e[1];return Math.sqrt(t*t+i*i)}function nk(e){let t=e[0],i=e[1];return t*t+i*i}function nT(e,t){return e[0]=-t[0],e[1]=-t[1],e}function nS(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function nP(e,t){let i=t[0],r=t[1],n=i*i+r*r;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e}function nE(e,t){return e[0]*t[0]+e[1]*t[1]}function nC(e,t,i){let r=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=r,e}function nI(e,t,i,r){let n=t[0],s=t[1];return e[0]=n+r*(i[0]-n),e[1]=s+r*(i[1]-s),e}function nA(e,t){t=void 0===t?1:t;let i=2*eH()*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e}function nM(e,t,i){let r=t[0],n=t[1];return e[0]=i[0]*r+i[2]*n,e[1]=i[1]*r+i[3]*n,e}function nL(e,t,i){let r=t[0],n=t[1];return e[0]=i[0]*r+i[2]*n+i[4],e[1]=i[1]*r+i[3]*n+i[5],e}function nO(e,t,i){let r=t[0],n=t[1];return e[0]=i[0]*r+i[3]*n+i[6],e[1]=i[1]*r+i[4]*n+i[7],e}function nR(e,t,i){let r=t[0],n=t[1];return e[0]=i[0]*r+i[4]*n+i[12],e[1]=i[1]*r+i[5]*n+i[13],e}function nD(e,t,i,r){let n=t[0]-i[0],s=t[1]-i[1],o=Math.sin(r),a=Math.cos(r);return e[0]=n*a-s*o+i[0],e[1]=n*o+s*a+i[1],e}function nF(e,t){let i=e[0],r=e[1],n=t[0],s=t[1],o=Math.sqrt((i*i+r*r)*(n*n+s*s));return Math.acos(Math.min(Math.max(o&&(i*n+r*s)/o,-1),1))}function nN(e){return e[0]=0,e[1]=0,e}function nj(e){return`vec2(${e[0]}, ${e[1]})`}function nz(e,t){return e[0]===t[0]&&e[1]===t[1]}function nU(e,t){let i=e[0],r=e[1],n=t[0],s=t[1];return Math.abs(i-n)<=1e-6*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-s)<=1e-6*Math.max(1,Math.abs(r),Math.abs(s))}let nB=(a=nn(),function(e,t,i,r,n,s){let o,l;for(t||(t=2),i||(i=0),l=r?Math.min(r*t+i,e.length):e.length,o=i;o<l;o+=t)a[0]=e[o],a[1]=e[o+1],n(a,a,s),e[o]=a[0],e[o+1]=a[1];return e});e.s(["add",()=>nu,"angle",()=>nF,"ceil",()=>nf,"clone",()=>ns,"copy",()=>na,"create",()=>nn,"cross",()=>nC,"dist",0,nb,"distance",()=>nb,"div",0,nd,"divide",()=>nd,"dot",()=>nE,"equals",()=>nU,"exactEquals",()=>nz,"floor",()=>np,"forEach",0,nB,"fromValues",()=>no,"inverse",()=>nS,"len",0,nw,"length",()=>nw,"lerp",()=>nI,"max",()=>nm,"min",()=>ng,"mul",0,nh,"multiply",()=>nh,"negate",()=>nT,"normalize",()=>nP,"random",()=>nA,"rotate",()=>nD,"round",()=>ny,"scale",()=>n_,"scaleAndAdd",()=>nv,"set",()=>nl,"sqrDist",0,nx,"sqrLen",0,nk,"squaredDistance",()=>nx,"squaredLength",()=>nk,"str",()=>nj,"sub",0,nc,"subtract",()=>nc,"transformMat2",()=>nM,"transformMat2d",()=>nL,"transformMat3",()=>nO,"transformMat4",()=>nR,"zero",()=>nN],60113),(f=k||(k={}))[f.COL0ROW0=0]="COL0ROW0",f[f.COL0ROW1=1]="COL0ROW1",f[f.COL0ROW2=2]="COL0ROW2",f[f.COL0ROW3=3]="COL0ROW3",f[f.COL1ROW0=4]="COL1ROW0",f[f.COL1ROW1=5]="COL1ROW1",f[f.COL1ROW2=6]="COL1ROW2",f[f.COL1ROW3=7]="COL1ROW3",f[f.COL2ROW0=8]="COL2ROW0",f[f.COL2ROW1=9]="COL2ROW1",f[f.COL2ROW2=10]="COL2ROW2",f[f.COL2ROW3=11]="COL2ROW3",f[f.COL3ROW0=12]="COL3ROW0",f[f.COL3ROW1=13]="COL3ROW1",f[f.COL3ROW2=14]="COL3ROW2",f[f.COL3ROW3=15]="COL3ROW3";let n$=45*Math.PI/180,nV=Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class nW extends nr{static get IDENTITY(){return r||Object.freeze(r=new nW),r}static get ZERO(){return i||Object.freeze(i=new nW([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])),i}get ELEMENTS(){return 16}get RANK(){return 4}get INDICES(){return k}constructor(e){super(-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0),1==arguments.length&&Array.isArray(e)?this.copy(e):this.identity()}copy(e){return this[0]=e[0],this[1]=e[1],this[2]=e[2],this[3]=e[3],this[4]=e[4],this[5]=e[5],this[6]=e[6],this[7]=e[7],this[8]=e[8],this[9]=e[9],this[10]=e[10],this[11]=e[11],this[12]=e[12],this[13]=e[13],this[14]=e[14],this[15]=e[15],this.check()}set(e,t,i,r,n,s,o,a,l,u,c,h,d,f,p,g){return this[0]=e,this[1]=t,this[2]=i,this[3]=r,this[4]=n,this[5]=s,this[6]=o,this[7]=a,this[8]=l,this[9]=u,this[10]=c,this[11]=h,this[12]=d,this[13]=f,this[14]=p,this[15]=g,this.check()}setRowMajor(e,t,i,r,n,s,o,a,l,u,c,h,d,f,p,g){return this[0]=e,this[1]=n,this[2]=l,this[3]=d,this[4]=t,this[5]=s,this[6]=u,this[7]=f,this[8]=i,this[9]=o,this[10]=c,this[11]=p,this[12]=r,this[13]=a,this[14]=h,this[15]=g,this.check()}toRowMajor(e){return e[0]=this[0],e[1]=this[4],e[2]=this[8],e[3]=this[12],e[4]=this[1],e[5]=this[5],e[6]=this[9],e[7]=this[13],e[8]=this[2],e[9]=this[6],e[10]=this[10],e[11]=this[14],e[12]=this[3],e[13]=this[7],e[14]=this[11],e[15]=this[15],e}identity(){return this.copy(nV)}fromObject(e){return this.check()}fromQuaternion(e){return tm(this,e),this.check()}frustum(e){var t,i,r,n,s,o;let{left:a,right:l,bottom:u,top:c,near:h=.1,far:d=500}=e;return d===1/0?(t=this,i=a,r=l,n=u,s=c,o=h,t[0]=2*o/(r-i),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*o/(s-n),t[6]=0,t[7]=0,t[8]=(r+i)/(r-i),t[9]=(s+n)/(s-n),t[10]=-1,t[11]=-1,t[12]=0,t[13]=0,t[14]=-2*o,t[15]=0):ty(this,a,l,u,c,h,d),this.check()}lookAt(e){let{eye:t,center:i=[0,0,0],up:r=[0,1,0]}=e;return tk(this,t,i,r),this.check()}ortho(e){let{left:t,right:i,bottom:r,top:n,near:s=.1,far:o=500}=e;return tx(this,t,i,r,n,s,o),this.check()}orthographic(e){let{fovy:t=n$,aspect:i=1,focalDistance:r=1,near:n=.1,far:s=500}=e;nG(t);let o=r*Math.tan(t/2),a=o*i;return this.ortho({left:-a,right:a,bottom:-o,top:o,near:n,far:s})}perspective(e){let{fovy:t=45*Math.PI/180,aspect:i=1,near:r=.1,far:n=500}=e;return nG(t),t_(this,t,i,r,n),this.check()}determinant(){return e4(this)}getScale(e=[-0,-0,-0]){return e[0]=Math.sqrt(this[0]*this[0]+this[1]*this[1]+this[2]*this[2]),e[1]=Math.sqrt(this[4]*this[4]+this[5]*this[5]+this[6]*this[6]),e[2]=Math.sqrt(this[8]*this[8]+this[9]*this[9]+this[10]*this[10]),e}getTranslation(e=[-0,-0,-0]){return e[0]=this[12],e[1]=this[13],e[2]=this[14],e}getRotation(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),r=1/i[0],n=1/i[1],s=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*n,e[2]=this[2]*s,e[3]=0,e[4]=this[4]*r,e[5]=this[5]*n,e[6]=this[6]*s,e[7]=0,e[8]=this[8]*r,e[9]=this[9]*n,e[10]=this[10]*s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}getRotationMatrix3(e,t){e=e||[-0,-0,-0,-0,-0,-0,-0,-0,-0],t=t||[-0,-0,-0];let i=this.getScale(t),r=1/i[0],n=1/i[1],s=1/i[2];return e[0]=this[0]*r,e[1]=this[1]*n,e[2]=this[2]*s,e[3]=this[4]*r,e[4]=this[5]*n,e[5]=this[6]*s,e[6]=this[8]*r,e[7]=this[9]*n,e[8]=this[10]*s,e}transpose(){return e1(this,this),this.check()}invert(){return e2(this,this),this.check()}multiplyLeft(e){return e6(this,e,this),this.check()}multiplyRight(e){return e6(this,this,e),this.check()}rotateX(e){return e7(this,this,e),this.check()}rotateY(e){return te(this,this,e),this.check()}rotateZ(e){return tt(this,this,e),this.check()}rotateXYZ(e){return this.rotateX(e[0]).rotateY(e[1]).rotateZ(e[2])}rotateAxis(e,t){return e9(this,this,e,t),this.check()}scale(e){return e8(this,this,Array.isArray(e)?e:[e,e,e]),this.check()}translate(e){return e5(this,this,e),this.check()}transform(e,t){return 4===e.length?(rv(t=t8(t||[-0,-0,-0,-0],e,this),4),t):this.transformAsPoint(e,t)}transformAsPoint(e,t){let i,{length:r}=e;switch(r){case 2:i=nR(t||[-0,-0],e,this);break;case 3:i=rJ(t||[-0,-0,-0],e,this);break;default:throw Error("Illegal vector")}return rv(i,e.length),i}transformAsVector(e,t){let i;switch(e.length){case 2:var r;let n,s,o;r=t||[-0,-0],n=e[0],s=e[1],o=this[3]*n+this[7]*s||1,r[0]=(this[0]*n+this[4]*s)/o,r[1]=(this[1]*n+this[5]*s)/o,i=r;break;case 3:i=ne(t||[-0,-0,-0],e,this);break;default:throw Error("Illegal vector")}return rv(i,e.length),i}transformPoint(e,t){return this.transformAsPoint(e,t)}transformVector(e,t){return this.transformAsPoint(e,t)}transformDirection(e,t){return this.transformAsVector(e,t)}makeRotationX(e){return this.identity().rotateX(e)}makeTranslation(e,t,i){return this.identity().translate([e,t,i])}}function nG(e){if(e>2*Math.PI)throw Error("expected radians")}var is=is;function nq(e,t){let i=is.transformMat4([],t,e);return is.scale(i,i,1/i[3]),i}function nH(e,t){let i=e%t;return i<0?t+i:i}function nY(e,t,i){return e<t?t:e>i?i:e}let nX=Math.log2||function(e){return Math.log(e)*Math.LOG2E};var tO=tO,nZ=e.i(60113),nZ=nZ,nK=e.i(93311),nK=nK;function nJ(e,t){if(!e)throw Error(t||"@math.gl/web-mercator: assertion failed.")}let nQ=Math.PI,n0=nQ/4,n1=nQ/180,n2=180/nQ;function n3(e){let[t,i]=e;nJ(Number.isFinite(t)),nJ(Number.isFinite(i)&&i>=-90&&i<=90,"invalid latitude");let r=512*(nQ+Math.log(Math.tan(n0+i*n1*.5)))/(2*nQ);return[512*(t*n1+nQ)/(2*nQ),r]}function n4(e){let[t,i]=e,r=2*(Math.atan(Math.exp(i/512*(2*nQ)-nQ))-n0);return[(t/512*(2*nQ)-nQ)*n2,r*n2]}function n6(e){return 512/4003e4/Math.cos(e*n1)}function n5(e){let{latitude:t,longitude:i,highPrecision:r=!1}=e;nJ(Number.isFinite(t)&&Number.isFinite(i));let n=Math.cos(t*n1),s=512/360/n,o=512/4003e4/n,a={unitsPerMeter:[o,o,o],metersPerUnit:[1/o,1/o,1/o],unitsPerDegree:[512/360,s,o],degreesPerUnit:[1/(512/360),1/s,1/o]};if(r){let e=n1*Math.tan(t*n1)/n,i=512/4003e4*e,r=i/s*o;a.unitsPerDegree2=[0,512/360*e/2,i],a.unitsPerMeter2=[r,0,r]}return a}function n8(e,t){let[i,r,n]=e,[s,o,a]=t,{unitsPerMeter:l,unitsPerMeter2:u}=n5({longitude:i,latitude:r,highPrecision:!0}),c=n3(e);c[0]+=s*(l[0]+u[0]*o),c[1]+=o*(l[1]+u[1]*o);let h=n4(c);return Number.isFinite(n)||Number.isFinite(a)?[h[0],h[1],(n||0)+(a||0)]:h}function n9(e){return 2*Math.atan(.5/e)*n2}function n7(e){return .5/Math.tan(.5*e*n1)}function se(e,t){let[i,r,n=0]=e;return nJ(Number.isFinite(i)&&Number.isFinite(r)&&Number.isFinite(n)),nq(t,[i,r,n,1])}function st(e,t,i=0){let[r,n,s]=e;if(nJ(Number.isFinite(r)&&Number.isFinite(n),"invalid pixel coordinate"),Number.isFinite(s))return nq(t,[r,n,s,1]);let o=nq(t,[r,n,0,1]),a=nq(t,[r,n,1,1]),l=o[2],u=a[2];return nZ.lerp([],o,a,l===u?0:((i||0)-l)/(u-l))}var nZ=nZ;let si=Math.PI/180;function sr(e,t,i){let{pixelUnprojectionMatrix:r}=e,n=nq(r,[t,0,1,1]),s=nq(r,[t,e.height,1,1]),o=(i*e.distanceScales.unitsPerMeter[2]-n[2])/(s[2]-n[2]),a=n4(nZ.lerp([],n,s,o));return a.push(i),a}var tO=tO,nZ=nZ,nK=nK;let sn=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,ss=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,so=`
${sn}
${ss}
`,sa=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,sl=`
${sn}
${sa}
`,su=i3(function({viewport:e,center:t}){return new nW(e.viewProjectionMatrix).invert().transform(t)}),sc=i3(function({viewport:e,shadowMatrices:t}){let i=[],r=e.pixelUnprojectionMatrix,n=e.isGeospatial?void 0:1,s=[[0,0,n],[e.width,0,n],[0,e.height,n],[e.width,e.height,n],[0,0,-1],[e.width,0,-1],[0,e.height,-1],[e.width,e.height,-1]].map(e=>(function(e,t){let[i,r,n]=e,s=st([i,r,n],t);return Number.isFinite(n)?s:[s[0],s[1],0]})(e,r));for(let r of t){let t=r.clone().translate(new ni(e.center).negate()),n=s.map(e=>t.transform(e)),o=new nW().ortho({left:Math.min(...n.map(e=>e[0])),right:Math.max(...n.map(e=>e[0])),bottom:Math.min(...n.map(e=>e[1])),top:Math.max(...n.map(e=>e[1])),near:Math.min(...n.map(e=>-e[2])),far:Math.max(...n.map(e=>-e[2]))});i.push(o.multiplyRight(r))}return i}),sh=[0,0,0,1],sd=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],sf={name:"shadow",dependencies:[rc],vs:so,fs:sl,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:function(e){let{shadowEnabled:t=!0,project:i}=e;if(!t||!i||!e.shadowMatrices||!e.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:e.dummyShadowMap,shadow_uShadowMap1:e.dummyShadowMap};let r=rc.getUniforms(i),n=su({viewport:i.viewport,center:r.center}),s=[],o=sc({shadowMatrices:e.shadowMatrices,viewport:i.viewport}).slice();for(let t=0;t<e.shadowMatrices.length;t++){let e=o[t],a=e.clone().translate(new ni(i.viewport.center).negate());r.coordinateSystem===iJ.LNGLAT&&r.projectionMode===iQ.WEB_MERCATOR?(o[t]=a,s[t]=n):(o[t]=e.clone().multiplyRight(sd),s[t]=a.transform(n))}let a={drawShadowMap:!!e.drawToShadowMap,useShadowMap:!!e.shadowMaps&&e.shadowMaps.length>0,color:e.shadowColor||sh,lightId:e.shadowLightId||0,lightCount:e.shadowMatrices.length,shadow_uShadowMap0:e.dummyShadowMap,shadow_uShadowMap1:e.dummyShadowMap};for(let e=0;e<o.length;e++)a[`viewProjectionMatrix${e}`]=o[e],a[`projectCenter${e}`]=s[e];for(let t=0;t<2;t++)a[`shadow_uShadowMap${t}`]=e.shadowMaps&&e.shadowMaps[t]||e.dummyShadowMap;return a},uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},sp={props:{},uniforms:{},name:"picking",uniformTypes:{isActive:"f32",isAttribute:"f32",isHighlightActive:"f32",useFloatColors:"f32",highlightedObjectColor:"vec3<f32>",highlightColor:"vec4<f32>"},defaultUniforms:{isActive:!1,isAttribute:!1,isHighlightActive:!1,useFloatColors:!0,highlightedObjectColor:[0,0,0],highlightColor:[0,1,1,1]},vs:`\
uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

out vec4 picking_vRGBcolor_Avalid;

// Normalize unsigned byte color to 0-1 range
vec3 picking_normalizeColor(vec3 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

// Normalize unsigned byte color to 0-1 range
vec4 picking_normalizeColor(vec4 color) {
  return picking.useFloatColors > 0.5 ? color : color / 255.0;
}

bool picking_isColorZero(vec3 color) {
  return dot(color, vec3(1.0)) < 0.00001;
}

bool picking_isColorValid(vec3 color) {
  return dot(color, vec3(1.0)) > 0.00001;
}

// Check if this vertex is highlighted 
bool isVertexHighlighted(vec3 vertexColor) {
  vec3 highlightedObjectColor = picking_normalizeColor(picking.highlightedObjectColor);
  return
    bool(picking.isHighlightActive) && picking_isColorZero(abs(vertexColor - highlightedObjectColor));
}

// Set the current picking color
void picking_setPickingColor(vec3 pickingColor) {
  pickingColor = picking_normalizeColor(pickingColor);

  if (bool(picking.isActive)) {
    // Use alpha as the validity flag. If pickingColor is [0, 0, 0] fragment is non-pickable
    picking_vRGBcolor_Avalid.a = float(picking_isColorValid(pickingColor));

    if (!bool(picking.isAttribute)) {
      // Stores the picking color so that the fragment shader can render it during picking
      picking_vRGBcolor_Avalid.rgb = pickingColor;
    }
  } else {
    // Do the comparison with selected item color in vertex shader as it should mean fewer compares
    picking_vRGBcolor_Avalid.a = float(isVertexHighlighted(pickingColor));
  }
}

void picking_setPickingAttribute(float value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.r = value;
  }
}

void picking_setPickingAttribute(vec2 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rg = value;
  }
}

void picking_setPickingAttribute(vec3 value) {
  if (bool(picking.isAttribute)) {
    picking_vRGBcolor_Avalid.rgb = value;
  }
}
`,fs:`\
uniform pickingUniforms {
  float isActive;
  float isAttribute;
  float isHighlightActive;
  float useFloatColors;
  vec3 highlightedObjectColor;
  vec4 highlightColor;
} picking;

in vec4 picking_vRGBcolor_Avalid;

/*
 * Returns highlight color if this item is selected.
 */
vec4 picking_filterHighlightColor(vec4 color) {
  // If we are still picking, we don't highlight
  if (picking.isActive > 0.5) {
    return color;
  }

  bool selected = bool(picking_vRGBcolor_Avalid.a);

  if (selected) {
    // Blend in highlight color based on its alpha value
    float highLightAlpha = picking.highlightColor.a;
    float blendedAlpha = highLightAlpha + color.a * (1.0 - highLightAlpha);
    float highLightRatio = highLightAlpha / blendedAlpha;

    vec3 blendedRGB = mix(color.rgb, picking.highlightColor.rgb, highLightRatio);
    return vec4(blendedRGB, blendedAlpha);
  } else {
    return color;
  }
}

/*
 * Returns picking color if picking enabled else unmodified argument.
 */
vec4 picking_filterPickingColor(vec4 color) {
  if (bool(picking.isActive)) {
    if (picking_vRGBcolor_Avalid.a == 0.0) {
      discard;
    }
    return picking_vRGBcolor_Avalid;
  }
  return color;
}

/*
 * Returns picking color if picking is enabled if not
 * highlight color if this item is selected, otherwise unmodified argument.
 */
vec4 picking_filterColor(vec4 color) {
  vec4 highlightColor = picking_filterHighlightColor(color);
  return picking_filterPickingColor(highlightColor);
}
`,getUniforms:function(e={},t){let i={};if(void 0===e.highlightedObjectColor||(null===e.highlightedObjectColor?i.isHighlightActive=!1:(i.isHighlightActive=!0,i.highlightedObjectColor=e.highlightedObjectColor.slice(0,3))),e.highlightColor){let t=Array.from(e.highlightColor,e=>e/255);Number.isFinite(t[3])||(t[3]=1),i.highlightColor=t}return void 0!==e.isActive&&(i.isActive=!!e.isActive,i.isAttribute=!!e.isAttribute),void 0!==e.useFloatColors&&(i.useFloatColors=!!e.useFloatColors),i}},sg={...sp,defaultUniforms:{...sp.defaultUniforms,useFloatColors:!1},inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    // for picking depth values
    picking_setPickingAttribute(position.z / position.w);
  `,"vs:DECKGL_FILTER_COLOR":`
  picking_setPickingColor(geometry.pickingColor);
  `,"fs:DECKGL_FILTER_COLOR":{order:99,injection:`
  // use highlight color if this fragment belongs to the selected object.
  color = picking_filterHighlightColor(color);

  // use picking color if rendering to picking FBO.
  color = picking_filterPickingColor(color);
    `}}},sm=[eW],sy=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],s_=[],sv=Symbol.for("component"),sb=Symbol.for("propTypes"),sx=Symbol.for("deprecatedProps"),sw=Symbol.for("asyncPropDefaults"),sk=Symbol.for("asyncPropOriginal"),sT=Symbol.for("asyncPropResolved");var sS=e.i(47167);let sP={};function sE(e){sP=e}function sC(e,t,i,r){ia.level>0&&sP[e]&&sP[e].call(null,t,i,r)}function sI(e,t=()=>!0){return Array.isArray(e)?function e(t,i,r){let n=-1;for(;++n<t.length;){let s=t[n];Array.isArray(s)?e(s,i,r):i(s)&&r.push(s)}return r}(e,t,[]):t(e)?[e]:[]}e.i(23635);var sA=e.i(9685);let sM=e=>null!==e&&"object"==typeof e,sL=e=>sM(e)&&e.constructor===({}).constructor,sO=e=>"undefined"!=typeof Response&&e instanceof Response||e&&e.arrayBuffer&&e.text&&e.json,sR=e=>"undefined"!=typeof Blob&&e instanceof Blob,sD=e=>{let t,i;return t=e,"undefined"!=typeof ReadableStream&&t instanceof ReadableStream||sM(t)&&"function"==typeof t.tee&&"function"==typeof t.cancel&&"function"==typeof t.getReader||sM(i=e)&&"function"==typeof i.read&&"function"==typeof i.pipe&&"boolean"==typeof i.readable};function sF(e,t){if(!e)throw Error(t||"loader assertion failed.")}function sN(e){return!!e&&(Array.isArray(e)&&(e=e[0]),Array.isArray(e?.extensions))}function sj(e){let t;return sF(e,"null loader"),sF(sN(e),"invalid loader"),Array.isArray(e)&&(t=e[1],e={...e=e[0],options:{...e.options,...t}}),(e?.parseTextSync||e?.parseText)&&(e.text=!0),e.text||(e.binary=!0),e}let sz={};class sU extends Error{constructor(e,t){super(e),this.reason=t.reason,this.url=t.url,this.response=t.response}reason;url;response}let sB=/^data:([-\w.]+\/[-\w.+]+)(;|,)/,s$=/^([-\w.]+\/[-\w.+]+)/;function sV(e,t){return e.toLowerCase()===t.toLowerCase()}function sW(e){let t=sB.exec(e);return t?t[1]:""}let sG=/\?.*/;function sq(e){return e.replace(sG,"")}function sH(e){return sO(e)?e.url:sR(e)?e.name||"":"string"==typeof e?e:""}function sY(e){if(sO(e)){let t,i=e.headers.get("content-type")||"",r=sq(e.url);return((t=s$.exec(i))?t[1]:i)||sW(r)}return sR(e)?e.type||"":"string"==typeof e?sW(e):""}async function sX(e){var t;if(sO(e))return e;let i={},r=sO(t=e)?t.headers["content-length"]||-1:sR(t)?t.size:"string"==typeof t?t.length:t instanceof ArrayBuffer||ArrayBuffer.isView(t)?t.byteLength:-1;r>=0&&(i["content-length"]=String(r));let n=sH(e),s=sY(e);s&&(i["content-type"]=s);let o=await sJ(e);o&&(i["x-first-bytes"]=o),"string"==typeof e&&(e=new TextEncoder().encode(e));let a=new Response(e,{headers:i});return Object.defineProperty(a,"url",{value:n}),a}async function sZ(e){if(!e.ok)throw await sK(e)}async function sK(e){let t=function(e){if(e.length<50)return e;let t=e.slice(e.length-15),i=e.substr(0,32);return`${i}...${t}`}(e.url),i=`Failed to fetch resource (${e.status}) ${e.statusText}: ${t}`;i=i.length>100?`${i.slice(0,100)}...`:i;let r={reason:e.statusText,url:e.url,response:e};try{let t=e.headers.get("Content-Type");r.reason=!e.bodyUsed&&t?.includes("application/json")?await e.json():await e.text()}catch(e){}return new sU(i,r)}async function sJ(e){if("string"==typeof e)return`data:,${e.slice(0,5)}`;if(e instanceof Blob){let t=e.slice(0,5);return await new Promise(e=>{let i=new FileReader;i.onload=t=>e(t?.target?.result),i.readAsDataURL(t)})}if(e instanceof ArrayBuffer){let t=function(e){let t="",i=new Uint8Array(e);for(let e=0;e<i.byteLength;e++)t+=String.fromCharCode(i[e]);return btoa(t)}(e.slice(0,5));return`data:base64,${t}`}return null}async function sQ(e,t){if("string"==typeof e){var i;let r=function(e){for(let t in sz)if(e.startsWith(t)){let i=sz[t];e=e.replace(t,i)}return e.startsWith("http://")||e.startsWith("https://")||(e=`${e}`),e}(e);return!((i=r).startsWith("http:")||i.startsWith("https:"))&&!r.startsWith("data:")&&globalThis.loaders?.fetchNode?globalThis.loaders?.fetchNode(r,t):await fetch(r,t)}return await sX(e)}let s0=new io.Log({id:"loaders.gl"});class s1{log(){return()=>{}}info(){return()=>{}}warn(){return()=>{}}error(){return()=>{}}}let s2={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:e.g,document:"undefined"!=typeof document&&document};s2.self||s2.window||s2.global,s2.window||s2.self||s2.global,s2.global||s2.self||s2.window,s2.document;let s3=("object"!=typeof sS.default||"[object process]"!==String(sS.default),!0),s4=void 0!==sS.default&&sS.default.version&&/v([0-9]*)/.exec(sS.default.version);s4&&parseFloat(s4[1]);let s6={fetch:null,mimeType:void 0,nothrow:!1,log:new class{console;constructor(){this.console=console}log(...e){return this.console.log.bind(this.console,...e)}info(...e){return this.console.info.bind(this.console,...e)}warn(...e){return this.console.warn.bind(this.console,...e)}error(...e){return this.console.error.bind(this.console,...e)}},useLocalLibraries:!1,CDN:"https://unpkg.com/@loaders.gl",worker:!0,maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:s3,_nodeWorkers:!1,_workerType:"",limit:0,_limitMB:0,batchSize:"auto",batchDebounceMs:0,metadata:!1,transforms:[]},s5={throws:"nothrow",dataType:"(no longer used)",uri:"baseUri",method:"fetch.method",headers:"fetch.headers",body:"fetch.body",mode:"fetch.mode",credentials:"fetch.credentials",cache:"fetch.cache",redirect:"fetch.redirect",referrer:"fetch.referrer",referrerPolicy:"fetch.referrerPolicy",integrity:"fetch.integrity",keepalive:"fetch.keepalive",signal:"fetch.signal"};function s8(){globalThis.loaders=globalThis.loaders||{};let{loaders:e}=globalThis;return e._state||(e._state={}),e._state}function s9(){let e=s8();return e.globalOptions=e.globalOptions||{...s6},e.globalOptions}function s7(e,t,i,r,n){let s=t||"Top level",o=t?`${t}.`:"";for(let a in e){let l=!t&&sM(e[a]),u="baseUri"===a&&!t,c="workerUrl"===a&&t;if(!(a in i)&&!u&&!c){if(a in r)s0.warn(`${s} loader option '${o}${a}' no longer supported, use '${r[a]}'`)();else if(!l){let e=function(e,t){let i=e.toLowerCase(),r="";for(let n of t)for(let t in n.options){if(e===t)return`Did you mean '${n.id}.${t}'?`;let s=t.toLowerCase();(i.startsWith(s)||s.startsWith(i))&&(r=r||`Did you mean '${n.id}.${t}'?`)}return r}(a,n);s0.warn(`${s} loader option '${o}${a}' not recognized. ${e}`)()}}}}function oe(e,t){for(let i in t)i in t&&(sL(t[i])&&sL(e[i])?e[i]={...e[i],...t[i]}:e[i]=t[i])}function ot(e,t){let i=s9(),r=e||i;return"function"==typeof r.fetch?r.fetch:sM(r.fetch)?e=>sQ(e,r.fetch):t?.fetch?t?.fetch:sQ}let oi={self:"undefined"!=typeof self&&self,window:"undefined"!=typeof window&&window,global:e.g,document:"undefined"!=typeof document&&document};oi.self||oi.window||oi.global,oi.window||oi.self||oi.global,oi.global||oi.self||oi.window,oi.document;let or="object"!=typeof sS.default||"[object process]"!==String(sS.default)||!0,on="undefined"!=typeof window&&void 0!==window.orientation,os=void 0!==sS.default&&sS.default.version&&/v([0-9]*)/.exec(sS.default.version);os&&parseFloat(os[1]);class oo{terminate(){}}function oa(e,t){if(!e)throw Error(t||"loaders.gl assertion failed.")}let ol=new Map;function ou(e){let t=new Blob([e],{type:"application/javascript"});return URL.createObjectURL(t)}function oc(e){return!!e&&!!(e instanceof ArrayBuffer||"undefined"!=typeof MessagePort&&e instanceof MessagePort||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas)}let oh=()=>{};class od{name;source;url;terminated=!1;worker;onMessage;onError;_loadableURL="";static isSupported(){return"undefined"!=typeof Worker&&or||!or}constructor(e){const{name:t,source:i,url:r}=e;oa(i||r),this.name=t,this.source=i,this.url=r,this.onMessage=oh,this.onError=e=>console.log(e),this.worker=or?this._createBrowserWorker():this._createNodeWorker()}destroy(){this.onMessage=oh,this.onError=oh,this.worker.terminate(),this.terminated=!0}get isRunning(){return!!this.onMessage}postMessage(e,t){t=t||function e(t,i=!0,r){let n=r||new Set;if(t){if(oc(t))n.add(t);else if(oc(t.buffer))n.add(t.buffer);else if(ArrayBuffer.isView(t));else if(i&&"object"==typeof t)for(let r in t)e(t[r],i,n)}return void 0===r?Array.from(n):[]}(e),this.worker.postMessage(e,t)}_getErrorFromErrorEvent(e){let t="Failed to load ";return t+=`worker ${this.name} from ${this.url}. `,e.message&&(t+=`${e.message} in `),e.lineno&&(t+=`:${e.lineno}:${e.colno}`),Error(t)}_createBrowserWorker(){var e,t,i;let r;this._loadableURL=(oa((e={source:this.source,url:this.url}).source&&!e.url||!e.source&&e.url),(r=ol.get(e.source||e.url))||(e.url&&(r=(t=e.url).startsWith("http")?ou((i=t,`\
try {
  importScripts('${i}');
} catch (error) {
  console.error(error);
  throw error;
}`)):t,ol.set(e.url,r)),e.source&&(r=ou(e.source),ol.set(e.source,r))),oa(r),r);let n=new Worker(this._loadableURL,{name:this.name});return n.onmessage=e=>{e.data?this.onMessage(e.data):this.onError(Error("No data received"))},n.onerror=e=>{this.onError(this._getErrorFromErrorEvent(e)),this.terminated=!0},n.onmessageerror=e=>console.error(e),n}_createNodeWorker(){let e;if(this.url)e=new oo(this.url.includes(":/")||this.url.startsWith("/")?this.url:`./${this.url}`,{eval:!1});else if(this.source)e=new oo(this.source,{eval:!0});else throw Error("no worker");return e.on("message",e=>{this.onMessage(e)}),e.on("error",e=>{this.onError(e)}),e.on("exit",e=>{}),e}}class of{name;workerThread;isRunning=!0;result;_resolve=()=>{};_reject=()=>{};constructor(e,t){this.name=e,this.workerThread=t,this.result=new Promise((e,t)=>{this._resolve=e,this._reject=t})}postMessage(e,t){this.workerThread.postMessage({source:"loaders.gl",type:e,payload:t})}done(e){oa(this.isRunning),this.isRunning=!1,this._resolve(e)}error(e){oa(this.isRunning),this.isRunning=!1,this._reject(e)}}class op{name="unnamed";source;url;maxConcurrency=1;maxMobileConcurrency=1;onDebug=()=>{};reuseWorkers=!0;props={};jobQueue=[];idleQueue=[];count=0;isDestroyed=!1;static isSupported(){return od.isSupported()}constructor(e){this.source=e.source,this.url=e.url,this.setProps(e)}destroy(){this.idleQueue.forEach(e=>e.destroy()),this.isDestroyed=!0}setProps(e){this.props={...this.props,...e},void 0!==e.name&&(this.name=e.name),void 0!==e.maxConcurrency&&(this.maxConcurrency=e.maxConcurrency),void 0!==e.maxMobileConcurrency&&(this.maxMobileConcurrency=e.maxMobileConcurrency),void 0!==e.reuseWorkers&&(this.reuseWorkers=e.reuseWorkers),void 0!==e.onDebug&&(this.onDebug=e.onDebug)}async startJob(e,t=(e,t,i)=>e.done(i),i=(e,t)=>e.error(t)){let r=new Promise(r=>(this.jobQueue.push({name:e,onMessage:t,onError:i,onStart:r}),this));return this._startQueuedJob(),await r}async _startQueuedJob(){if(!this.jobQueue.length)return;let e=this._getAvailableWorker();if(!e)return;let t=this.jobQueue.shift();if(t){this.onDebug({message:"Starting job",name:t.name,workerThread:e,backlog:this.jobQueue.length});let i=new of(t.name,e);e.onMessage=e=>t.onMessage(i,e.type,e.payload),e.onError=e=>t.onError(i,e),t.onStart(i);try{await i.result}catch(e){console.error(`Worker exception: ${e}`)}finally{this.returnWorkerToQueue(e)}}}returnWorkerToQueue(e){!or||this.isDestroyed||!this.reuseWorkers||this.count>this._getMaxConcurrency()?(e.destroy(),this.count--):this.idleQueue.push(e),this.isDestroyed||this._startQueuedJob()}_getAvailableWorker(){return this.idleQueue.length>0?this.idleQueue.shift()||null:this.count<this._getMaxConcurrency()?(this.count++,new od({name:`${this.name.toLowerCase()} (#${this.count} of ${this.maxConcurrency})`,source:this.source,url:this.url})):null}_getMaxConcurrency(){return on?this.maxMobileConcurrency:this.maxConcurrency}}let og={maxConcurrency:3,maxMobileConcurrency:1,reuseWorkers:!0,onDebug:()=>{}};class om{props;workerPools=new Map;static _workerFarm;static isSupported(){return od.isSupported()}static getWorkerFarm(e={}){return om._workerFarm=om._workerFarm||new om({}),om._workerFarm.setProps(e),om._workerFarm}constructor(e){this.props={...og},this.setProps(e),this.workerPools=new Map}destroy(){for(let e of this.workerPools.values())e.destroy();this.workerPools=new Map}setProps(e){for(let t of(this.props={...this.props,...e},this.workerPools.values()))t.setProps(this._getWorkerPoolProps())}getWorkerPool(e){let{name:t,source:i,url:r}=e,n=this.workerPools.get(t);return n||((n=new op({name:t,source:i,url:r})).setProps(this._getWorkerPoolProps()),this.workerPools.set(t,n)),n}_getWorkerPoolProps(){return{maxConcurrency:this.props.maxConcurrency,maxMobileConcurrency:this.props.maxMobileConcurrency,reuseWorkers:this.props.reuseWorkers,onDebug:this.props.onDebug}}}let oy=(globalThis._loadersgl_?.version||(globalThis._loadersgl_=globalThis._loadersgl_||{},globalThis._loadersgl_.version="4.3.3"),globalThis._loadersgl_.version);async function o_(e,t,i,r,n){let s=e.id,o=function(e,t={}){let i=t[e.id]||{},r=or?`${e.id}-worker.js`:`${e.id}-worker-node.js`,n=i.workerUrl;if(n||"compression"!==e.id||(n=t.workerUrl),"test"===t._workerType&&(n=or?`modules/${e.module}/dist/${r}`:`modules/${e.module}/src/workers/${e.id}-worker-node.ts`),!n){let t=e.version;"latest"===t&&(t="latest");let i=t?`@${t}`:"";n=`https://unpkg.com/@loaders.gl/${e.module}${i}/dist/${r}`}return oa(n),n}(e,i),a=om.getWorkerFarm(i).getWorkerPool({name:s,url:o});i=JSON.parse(JSON.stringify(i)),r=JSON.parse(JSON.stringify(r||{}));let l=await a.startJob("process-on-worker",ov.bind(null,n));l.postMessage("process",{input:t,options:i,context:r});let u=await l.result;return await u.result}async function ov(e,t,i,r){switch(i){case"done":t.done(r);break;case"error":t.error(Error(r.error));break;case"process":let{id:n,input:s,options:o}=r;try{let i=await e(s,o);t.postMessage("done",{id:n,result:i})}catch(i){let e=i instanceof Error?i.message:"unknown error";t.postMessage("error",{id:n,error:e})}break;default:console.warn(`parse-with-worker unknown message ${i}`)}}async function ob(e){let t=[];for await(let i of e)t.push(i);return function(...e){var t=e;let i=t.map(e=>e instanceof ArrayBuffer?new Uint8Array(e):e),r=new Uint8Array(i.reduce((e,t)=>e+t.byteLength,0)),n=0;for(let e of i)r.set(e,n),n+=e.byteLength;return r.buffer}(...t)}async function*ox(e,t){let i=t?.chunkSize||1048576,r=0;for(;r<e.size;){let t=r+i,n=await e.slice(r,t).arrayBuffer();r=t,yield n}}function ow(e){if(e&&"object"==typeof e&&e.isBuffer||e instanceof ArrayBuffer)return e;if(ArrayBuffer.isView(e))return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength);if("string"==typeof e)return new TextEncoder().encode(e).buffer;if(e&&"object"==typeof e&&e._toArrayBuffer)return e._toArrayBuffer();throw Error("toArrayBuffer")}function ok(e,t){return s3?oT(e,t):oS(e,t)}async function*oT(e,t){let i,r=e.getReader();try{for(;;){let e=i||r.read();t?._streamReadAhead&&(i=r.read());let{done:n,value:s}=await e;if(n)return;yield ow(s)}}catch(e){r.releaseLock()}}async function*oS(e,t){for await(let t of e)yield ow(t)}let oP="Cannot convert supplied data type";async function oE(e,t,i){let r,n,s=e instanceof ArrayBuffer||ArrayBuffer.isView(e);if("string"==typeof e||s){let i;var o=e;if(t.text&&"string"==typeof o)return o;if((i=o)&&"object"==typeof i&&i.isBuffer&&(o=o.buffer),o instanceof ArrayBuffer){let e=o;return t.text&&!t.binary?new TextDecoder("utf8").decode(e):e}if(ArrayBuffer.isView(o)){if(t.text&&!t.binary)return new TextDecoder("utf8").decode(o);let e=o.buffer,i=o.byteLength||o.length;return(0!==o.byteOffset||i!==e.byteLength)&&(e=e.slice(o.byteOffset,o.byteOffset+i)),e}throw Error(oP)}if(sR(e)&&(e=await sX(e)),sO(e)){let i=e;return await sZ(i),t.binary?await i.arrayBuffer():await i.text()}if(sD(e)&&(e=function(e,t){if("string"==typeof e)return function*(e,t){let i=t?.chunkSize||262144,r=0,n=new TextEncoder;for(;r<e.length;){let t=Math.min(e.length-r,i),s=e.slice(r,r+t);r+=t,yield n.encode(s)}}(e,t);if(e instanceof ArrayBuffer)return function*(e,t={}){let{chunkSize:i=262144}=t,r=0;for(;r<e.byteLength;){let t=Math.min(e.byteLength-r,i),n=new ArrayBuffer(t),s=new Uint8Array(e,r,t);new Uint8Array(n).set(s),r+=t,yield n}}(e,t);if(sR(e))return ox(e,t);if(sD(e))return ok(e,t);if(sO(e))return ok(e.body,t);throw Error("makeIterator")}(e,i)),(r=e)&&"function"==typeof r[Symbol.iterator]||(n=e)&&"function"==typeof n[Symbol.asyncIterator])return ob(e);throw Error(oP)}function oC(e){let t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(t+1):""}function oI(e){let t=e?e.lastIndexOf("/"):-1;return t>=0?e.substr(0,t):""}function oA(...e){return(e=e.map((t,i)=>(i&&(t=t.replace(RegExp("^/"),"")),i!==e.length-1&&(t=t.replace(RegExp("/$"),"")),t))).join("/")}function oM(...e){let t,i=[];for(let t=0;t<e.length;t++)i[t]=e[t];let r="",n=!1;for(let e=i.length-1;e>=-1&&!n;e--){let s;e>=0?s=i[e]:(void 0===t&&(t=function(){if(void 0!==sS.default&&void 0!==sS.default.cwd)return sS.default.cwd();let e=window.location?.pathname;return e?.slice(0,e.lastIndexOf("/")+1)||""}()),s=t),0!==s.length&&(r=`${s}/${r}`,n=s.charCodeAt(0)===oL)}return(r=function(e,t){let i,r="",n=-1,s=0,o=!1;for(let a=0;a<=e.length;++a){if(a<e.length)i=e.charCodeAt(a);else if(i===oL)break;else i=oL;if(i===oL){if(n===a-1||1===s);else if(n!==a-1&&2===s){if(r.length<2||!o||46!==r.charCodeAt(r.length-1)||46!==r.charCodeAt(r.length-2)){if(r.length>2){let e=r.length-1,t=e;for(;t>=0&&r.charCodeAt(t)!==oL;--t);if(t!==e){r=-1===t?"":r.slice(0,t),n=a,s=0,o=!1;continue}}else if(2===r.length||1===r.length){r="",n=a,s=0,o=!1;continue}}t&&(r.length>0?r+="/..":r="..",o=!0)}else{let t=e.slice(n+1,a);r.length>0?r+=`/${t}`:r=t,o=!1}n=a,s=0}else 46===i&&-1!==s?++s:s=-1}return r}(r,!n),n)?`/${r}`:r.length>0?r:"."}let oL=47;e.s(["dirname",()=>oI,"filename",()=>oC,"join",()=>oA,"resolve",()=>oM],73276);var oO=e.i(73276),oO=oO,oO=oO;let oR="4.3.3",oD=oR[0]>="0"&&oR[0]<="9"?`v${oR}`:"",oF=(l=new io.Log({id:"loaders.gl"}),globalThis.loaders=globalThis.loaders||{},globalThis.loaders.log=l,globalThis.loaders.version=oD,globalThis.probe=globalThis.probe||{},globalThis.probe.loaders=l,l),oN=()=>{let e=s8();return e.loaderRegistry=e.loaderRegistry||[],e.loaderRegistry},oj=/\.([^.]+)$/;async function oz(e,t=[],i,r){if(!oB(e))return null;let n=oU(e,t,{...i,nothrow:!0},r);if(n)return n;if(sR(e)&&(n=oU(e=await e.slice(0,10).arrayBuffer(),t,i,r)),!n&&!i?.nothrow)throw Error(o$(e));return n}function oU(e,t=[],i,r){var n,s,o,a,l,u;let c,h,d,f,p,g,m;if(!oB(e))return null;if(t&&!Array.isArray(t))return sj(t);let y=[];t&&(y=y.concat(t)),i?.ignoreRegisteredLoaders||y.push(...oN()),function(e){for(let t of e)sj(t)}(y);let _=(n=e,s=y,o=i,a=r,c=sH(n),h=sY(n),d=sq(c)||a?.url,f=null,p="",o?.mimeType&&(f=oV(s,o?.mimeType),p=`match forced by supplied MIME type ${o?.mimeType}`),f=f||(l=s,(m=(g=(u=d)&&oj.exec(u))&&g[1])?function(e,t){for(let i of(t=t.toLowerCase(),e))for(let e of i.extensions)if(e.toLowerCase()===t)return i;return null}(l,m):null),p=p||(f?`matched url ${d}`:""),f=f||oV(s,h),p=p||(f?`matched MIME type ${h}`:""),f=f||function(e,t){if(!t)return null;for(let i of e)if("string"==typeof t){if(function(e,t){return t.testText?t.testText(e):(Array.isArray(t.tests)?t.tests:[t.tests]).some(t=>e.startsWith(t))}(t,i))return i}else if(ArrayBuffer.isView(t)){if(oW(t.buffer,t.byteOffset,i))return i}else if(t instanceof ArrayBuffer&&oW(t,0,i))return i;return null}(s,n),p=p||(f?`matched initial data ${oG(n)}`:""),o?.fallbackMimeType&&(f=f||oV(s,o?.fallbackMimeType),p=p||(f?`matched fallback MIME type ${h}`:"")),p&&oF.log(1,`selectLoader selected ${f?.name}: ${p}.`),f);if(!_&&!i?.nothrow)throw Error(o$(e));return _}function oB(e){return!(e instanceof Response)||204!==e.status}function o$(e){let t=sH(e),i=sY(e),r="No valid loader found (";r+=(t?`${oO.filename(t)}, `:"no url provided, ")+`MIME type: ${i?`"${i}"`:"not provided"}, `;let n=e?oG(e):"";return r+((n?` first bytes: "${n}"`:"first bytes: not available")+")")}function oV(e,t){for(let i of e)if(i.mimeTypes?.some(e=>sV(t,e))||sV(t,`application/x.${i.id}`))return i;return null}function oW(e,t,i){return(Array.isArray(i.tests)?i.tests:[i.tests]).some(i=>(function(e,t,i,r){if(r instanceof ArrayBuffer)return function(e,t,i){if(i=i||e.byteLength,e.byteLength<i||t.byteLength<i)return!1;let r=new Uint8Array(e),n=new Uint8Array(t);for(let e=0;e<r.length;++e)if(r[e]!==n[e])return!1;return!0}(r,e,r.byteLength);switch(typeof r){case"function":return r(e);case"string":let n=oq(e,t,r.length);return r===n;default:return!1}})(e,t,0,i))}function oG(e,t=5){return"string"==typeof e?e.slice(0,t):ArrayBuffer.isView(e)?oq(e.buffer,e.byteOffset,t):e instanceof ArrayBuffer?oq(e,0,t):""}function oq(e,t,i){if(e.byteLength<t+i)return"";let r=new DataView(e),n="";for(let e=0;e<i;e++)n+=String.fromCharCode(r.getUint8(t+e));return n}async function oH(e,t,i,r){var n,s,o,a,l,u,c;let h;!t||Array.isArray(t)||sN(t)||(r=void 0,i=t,t=void 0),e=await e,i=i||{};let d=sH(e),f=function(e,t){let i;if(e&&!Array.isArray(e))return e;if(e&&(i=Array.isArray(e)?e:[e]),t&&t.loaders){let e=Array.isArray(t.loaders)?t.loaders:[t.loaders];i=i?[...i,...e]:e}return i&&i.length?i:void 0}(t,r),p=await oz(e,f,i);if(!p)return null;return function(e,t){for(let i of(s7(e,null,s6,s5,t),t)){let r=e&&e[i.id]||{},n=i.options&&i.options[i.id]||{},s=i.deprecatedOptions&&i.deprecatedOptions[i.id]||{};s7(r,i.id,n,s,t)}}(n=i,s=Array.isArray(s=(s=f)||[])?s:[s]),r=function(e,t,i){if(i)return i;let r={fetch:ot(t,e),...e};if(r.url){let e,t=sq(r.url);r.baseUrl=t,e=r.url.match(sG),r.queryString=e&&e[0],r.filename=oO.filename(t),r.baseUrl=oO.dirname(t)}return Array.isArray(r.loaders)||(r.loaders=null),r}({url:d,_parse:oH,loaders:f},(o=p,a=n,l=d,u=h={...o.options||{}},!(c=l)||"baseUri"in u||(u.baseUri=c),null===h.log&&(h.log=new s1),oe(h,s9()),oe(h,a),i=h),r||null),await oY(p,e,i,r)}async function oY(e,t,i,r){var n;if(!function(e,t=oy){oa(e,"no worker provided");e.version}(e),i=function e(t,i,r=0){if(r>3)return i;let n={...t};for(let[t,s]of Object.entries(i))s&&"object"==typeof s&&!Array.isArray(s)?n[t]=e(n[t]||{},i[t],r+1):n[t]=i[t];return n}(e.options||{},i),sO(t)){let e=t,{ok:i,redirected:n,status:s,statusText:o,type:a,url:l}=e;r.response={headers:Object.fromEntries(e.headers.entries()),ok:i,redirected:n,status:s,statusText:o,type:a,url:l}}if(t=await oE(t,e,i),e.parseTextSync&&"string"==typeof t)return e.parseTextSync(t,i,r);if(n=i,om.isSupported()&&(or||n?._nodeWorkers)&&e.worker&&n?.worker)return await o_(e,t,i,r,oH);if(e.parseText&&"string"==typeof t)return await e.parseText(t,i,r);if(e.parse)return await e.parse(t,i,r);throw oa(!e.parseSync),Error(`${e.id} loader - no parser found and worker is disabled`)}async function oX(e,t,i,r){let n,s;Array.isArray(t)||sN(t)?(n=t,s=i):(n=[],s=t);let o=ot(s),a=e;return"string"==typeof e&&(a=await o(e)),sR(e)&&(a=await o(e)),Array.isArray(n),await oH(a,n,s)}class oZ{constructor(e,t,i){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;let i=++this._loadCount,r=e;for(let t of("string"==typeof e&&(r=oX(e)),r instanceof Promise?(this.isLoaded=!1,this._loader=r.then(e=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=e)}).catch(e=>{this._loadCount===i&&(this.isLoaded=!0,this._error=e||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e),this._subscribers))t.onChange(this.getData())}}class oK{constructor(e){this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:e.device?.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return!!e.startsWith(this.protocol)||e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:r=!0}){let n=this._resources[e];n?n.setData(t,i):(n=new oZ(e,t,this._context),this._resources[e]=n),n.persistent=r}remove(e){let t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){let t=this._consumers[e];if(t){for(let e in t){let i=t[e],r=this._resources[i.resourceId];r&&r.unsubscribe(i)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:r="default"}){let{_resources:n,protocol:s}=this;e.startsWith(s)&&(n[e=e.replace(s,"")]||this.add({resourceId:e,data:null,persistent:!1}));let o=n[e];if(this._track(i,r,o,t),o)return o.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(let e in this._resources)this._resources[e].delete()}_track(e,t,i,r){let n=this._consumers,s=n[e]=n[e]||{},o=s[t],a=o&&o.resourceId&&this._resources[o.resourceId];a&&(a.unsubscribe(o),this.prune()),i&&(o?(o.onChange=r,o.resourceId=i.id):o={onChange:r,resourceId:i.id},s[t]=o,i.subscribe(o))}_prune(){for(let e of(this._pruneRequest=null,Object.keys(this._resources))){let t=this._resources[e];t.persistent||t.inUse()||(t.delete(),delete this._resources[e])}}}let oJ=new class{constructor(e={}){this._pool=[],this.opts={overAlloc:2,poolSize:100},this.setOptions(e)}setOptions(e){Object.assign(this.opts,e)}allocate(e,t,{size:i=1,type:r,padding:n=0,copy:s=!1,initialize:o=!1,maxCount:a}){let l=r||e&&e.constructor||Float32Array,u=t*i+n;if(ArrayBuffer.isView(e)){if(u<=e.length)return e;if(u*e.BYTES_PER_ELEMENT<=e.buffer.byteLength)return new l(e.buffer,0,u)}let c=1/0;a&&(c=a*i+n);let h=this._allocate(l,u,o,c);return e&&s?h.set(e):o||h.fill(0,0,4),this._release(e),h}release(e){this._release(e)}_allocate(e,t,i,r){let n=Math.max(Math.ceil(t*this.opts.overAlloc),1);n>r&&(n=r);let s=this._pool,o=e.BYTES_PER_ELEMENT*n,a=s.findIndex(e=>e.byteLength>=o);if(a>=0){let t=new e(s.splice(a,1)[0],0,n);return i&&t.fill(0),t}return new e(n)}_release(e){if(!ArrayBuffer.isView(e))return;let t=this._pool,{buffer:i}=e,{byteLength:r}=i,n=t.findIndex(e=>e.byteLength>=r);n<0?t.push(i):(n>0||t.length<this.opts.poolSize)&&t.splice(n,0,i),t.length>this.opts.poolSize&&t.shift()}};function oQ(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}let o0=new ni;function o1(e,t,i,r){o0.set(e,t,i);let n=o0.len();return{distance:r/n,normal:new ni(-e/n,-t/n,-i/n)}}function o2(e,t){let{size:i=1,startIndex:r=0}=t,s=void 0!==t.endIndex?t.endIndex:e.length,o=(s-r)/i;n=oJ.allocate(n,o,{type:Float32Array,size:2*i});let a=r,l=0;for(;a<s;){for(let t=0;t<i;t++){let r=e[a++];n[l+t]=r,n[l+t+i]=r-Math.fround(r)}l+=2*i}return n.subarray(0,o*i*2)}function o3(e){let t=null,i=!1;for(let r of e)r&&(t?(i||(t=[[t[0][0],t[0][1]],[t[1][0],t[1][1]]],i=!0),t[0][0]=Math.min(t[0][0],r[0][0]),t[0][1]=Math.min(t[0][1],r[0][1]),t[1][0]=Math.max(t[1][0],r[1][0]),t[1][1]=Math.max(t[1][1],r[1][1])):t=r);return t}var tO=tO;let o4=Math.PI/180,o6=oQ(),o5=[0,0,0],o8={unitsPerMeter:[1,1,1],metersPerUnit:[1,1,1]};class o9{constructor(e={}){this._frustumPlanes={},this.id=e.id||this.constructor.displayName||"viewport",this.x=e.x||0,this.y=e.y||0,this.width=e.width||1,this.height=e.height||1,this.zoom=e.zoom||0,this.padding=e.padding,this.distanceScales=e.distanceScales||o8,this.focalDistance=e.focalDistance||1,this.position=e.position||o5,this.modelMatrix=e.modelMatrix||null;const{longitude:t,latitude:i}=e;this.isGeospatial=Number.isFinite(i)&&Number.isFinite(t),this._initProps(e),this._initMatrices(e),this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}get subViewports(){return null}get metersPerPixel(){return this.distanceScales.metersPerUnit[2]/this.scale}get projectionMode(){return this.isGeospatial?this.zoom<12?iQ.WEB_MERCATOR:iQ.WEB_MERCATOR_AUTO_OFFSET:iQ.IDENTITY}equals(e){return e instanceof o9&&(this===e||e.width===this.width&&e.height===this.height&&e.scale===this.scale&&rm(e.projectionMatrix,this.projectionMatrix)&&rm(e.viewMatrix,this.viewMatrix))}project(e,{topLeft:t=!0}={}){let i=se(this.projectPosition(e),this.pixelProjectionMatrix),[r,n]=i,s=t?n:this.height-n;return 2===e.length?[r,s]:[r,s,i[2]]}unproject(e,{topLeft:t=!0,targetZ:i}={}){let[r,n,s]=e,o=t?n:this.height-n,a=i&&i*this.distanceScales.unitsPerMeter[2],l=st([r,o,s],this.pixelUnprojectionMatrix,a),[u,c,h]=this.unprojectPosition(l);return Number.isFinite(s)?[u,c,h]:Number.isFinite(i)?[u,c,i]:[u,c]}projectPosition(e){let[t,i]=this.projectFlat(e);return[t,i,(e[2]||0)*this.distanceScales.unitsPerMeter[2]]}unprojectPosition(e){let[t,i]=this.unprojectFlat(e);return[t,i,(e[2]||0)*this.distanceScales.metersPerUnit[2]]}projectFlat(e){if(this.isGeospatial){let t=n3(e);return t[1]=rp(t[1],-318,830),t}return e}unprojectFlat(e){return this.isGeospatial?n4(e):e}getBounds(e={}){let t={targetZ:e.z||0},i=this.unproject([0,0],t),r=this.unproject([this.width,0],t),n=this.unproject([0,this.height],t),s=this.unproject([this.width,this.height],t);return[Math.min(i[0],r[0],n[0],s[0]),Math.min(i[1],r[1],n[1],s[1]),Math.max(i[0],r[0],n[0],s[0]),Math.max(i[1],r[1],n[1],s[1])]}getDistanceScales(e){return e&&this.isGeospatial?n5({longitude:e[0],latitude:e[1],highPrecision:!0}):this.distanceScales}containsPixel({x:e,y:t,width:i=1,height:r=1}){return e<this.x+this.width&&this.x<e+i&&t<this.y+this.height&&this.y<t+r}getFrustumPlanes(){var e;return this._frustumPlanes.near?this._frustumPlanes:(Object.assign(this._frustumPlanes,{left:o1((e=this.viewProjectionMatrix)[3]+e[0],e[7]+e[4],e[11]+e[8],e[15]+e[12]),right:o1(e[3]-e[0],e[7]-e[4],e[11]-e[8],e[15]-e[12]),bottom:o1(e[3]+e[1],e[7]+e[5],e[11]+e[9],e[15]+e[13]),top:o1(e[3]-e[1],e[7]-e[5],e[11]-e[9],e[15]-e[13]),near:o1(e[3]+e[2],e[7]+e[6],e[11]+e[10],e[15]+e[14]),far:o1(e[3]-e[2],e[7]-e[6],e[11]-e[10],e[15]-e[14])}),this._frustumPlanes)}panByPosition(e,t){return null}_initProps(e){let t=e.longitude,i=e.latitude;this.isGeospatial&&(Number.isFinite(e.zoom)||(this.zoom=function(e){let{latitude:t}=e;return nJ(Number.isFinite(t)),nX(4003e4*Math.cos(t*n1))-9}({latitude:i})+Math.log2(this.focalDistance)),this.distanceScales=e.distanceScales||n5({latitude:i,longitude:t}));let r=Math.pow(2,this.zoom);this.scale=r;let{position:n,modelMatrix:s}=e,o=o5;if(n&&(o=s?new nW(s).transformAsVector(n,[]):n),this.isGeospatial){let e=this.projectPosition([t,i,0]);this.center=new ni(o).scale(this.distanceScales.unitsPerMeter).add(e)}else this.center=this.projectPosition(o)}_initMatrices(e){var t;let{viewMatrix:i=o6,projectionMatrix:r=null,orthographic:n=!1,fovyRadians:s,fovy:o=75,near:a=.1,far:l=1e3,padding:u=null,focalDistance:c=1}=e;this.viewMatrixUncentered=i,this.viewMatrix=new nW().multiplyRight(i).translate(new ni(this.center).negate()),this.projectionMatrix=r||function({width:e,height:t,orthographic:i,fovyRadians:r,focalDistance:n,padding:s,near:o,far:a}){let l=e/t,u=i?new nW().orthographic({fovy:r,aspect:l,focalDistance:n,near:o,far:a}):new nW().perspective({fovy:r,aspect:l,near:o,far:a});if(s){let{left:i=0,right:r=0,top:n=0,bottom:o=0}=s,a=rp((i+e-r)/2,0,e)-e/2,l=rp((n+t-o)/2,0,t)-t/2;u[8]-=2*a/e,u[9]+=2*l/t}return u}({width:this.width,height:this.height,orthographic:n,fovyRadians:s||o*o4,focalDistance:c,padding:u,near:a,far:l});let h=oQ();tO.multiply(h,h,this.projectionMatrix),tO.multiply(h,h,this.viewMatrix),this.viewProjectionMatrix=h,this.viewMatrixInverse=tO.invert([],this.viewMatrix)||this.viewMatrix,this.cameraPosition=[(t=this.viewMatrixInverse)[12],t[13],t[14]];let d=oQ(),f=oQ();tO.scale(d,d,[this.width/2,-this.height/2,1]),tO.translate(d,d,[1,-1,0]),tO.multiply(f,d,this.viewProjectionMatrix),this.pixelProjectionMatrix=f,this.pixelUnprojectionMatrix=tO.invert(oQ(),this.pixelProjectionMatrix),this.pixelUnprojectionMatrix||ia.warn("Pixel project matrix not invertible")()}}o9.displayName="Viewport";let o7=o9;class ae{constructor(e,t){this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=e=>{sC("layerManager.activateViewport",this,e),e&&(this.context.viewport=e)};const{deck:i,stats:r,viewport:n,timeline:s}=t||{};this.layers=[],this.resourceManager=new oK({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e?.gl,deck:i,shaderAssembler:function(e){let t=eI.getDefaultShaderAssembler();for(let e of sm)t.addDefaultModule(e);for(let i of(t._hookFunctions.length=0,"glsl"===e?sy:s_))t.addShaderHook(i);return t}(e?.info?.shadingLanguage||"glsl"),defaultShaderModules:[eB],renderPass:void 0,stats:r||new sA.Stats({id:"deck.gl"}),viewport:n||new o7({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:s||new ei,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){for(let e of(this.resourceManager.finalize(),this.layers))this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;for(let i of(e.clearRedrawFlags&&(this._needsRedraw=!1),this.layers)){let r=i.getNeedsRedraw(e);t=t||r}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(e=>0===t.id.indexOf(e))):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){sC("layerManager.setLayers",this,t,e),this._lastRenderedLayers=e;let i=sI(e,Boolean);for(let e of i)e.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){let e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){let{defaultShaderModules:t}=this.context;t.find(t=>t.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){let{defaultShaderModules:t}=this.context,i=t.findIndex(t=>t.name===e.name);i>=0&&(t.splice(i,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,i){i.raiseError(t,`${e} of ${i}`)}_updateLayers(e,t){let i={};for(let t of e)i[t.id]?ia.warn(`Multiple old layers with same id ${t.id}`)():i[t.id]=t;if(this._defaultShaderModulesChanged){for(let t of e)t.setNeedsUpdate(),t.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}let r=[];this._updateSublayersRecursively(t,i,r),this._finalizeOldLayers(i);let n=!1;for(let e of r)if(e.hasUniformTransition()){n=`Uniform transition in ${e}`;break}this._needsUpdate=n,this.layers=r}_updateSublayersRecursively(e,t,i){for(let r of e){r.context=this.context;let e=t[r.id];null===e&&ia.warn(`Multiple new layers with same id ${r.id}`)(),t[r.id]=null;let n=null;try{this._debug&&e!==r&&r.validateProps(),e?(this._transferLayerState(e,r),this._updateLayer(r)):this._initializeLayer(r),i.push(r),n=r.isComposite?r.getSubLayers():null}catch(e){this._handleError("matching",e,r)}n&&this._updateSublayersRecursively(n,t,i)}}_finalizeOldLayers(e){for(let t in e){let i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle="Initialized"}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle="Matched. State transferred from previous layer",t!==e&&(e.lifecycle="Discarded. Awaiting garbage collection")}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle="No longer matched. Awaiting garbage collection";try{e._finalize(),e.lifecycle="Finalized! Awaiting garbage collection"}catch(t){this._handleError("finalization",t,e)}}}function at(e,t,i){if(e===t)return!0;if(!i||!e||!t)return!1;if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(!at(e[r],t[r],i-1))return!1;return!0}if(Array.isArray(t))return!1;if("object"==typeof e&&"object"==typeof t){let r=Object.keys(e),n=Object.keys(t);if(r.length!==n.length)return!1;for(let n of r)if(!t.hasOwnProperty(n)||!at(e[n],t[n],i-1))return!1;return!0}return!1}class ai{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(let e in this.controllers){let t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(let e in this.controllers){let t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){let e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){let t="string"==typeof e?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){let i=this.getViewports(),r={x:e[0],y:e[1]};for(let n=i.length-1;n>=0;--n){let s=i[n];if(s.containsPixel(r)){let i=e.slice();return i[0]-=s.x,i[1]-=s.y,s.unproject(i,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=sI(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(at(e,this.viewState,3)||this.setNeedsUpdate("viewState changed"),this.viewState=e):ia.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){return new t.type({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:t=>this.getView(e.id)?.makeViewport({viewState:t,width:this.width,height:this.height})})}_updateController(e,t,i,r){let n=e.controller;if(n&&i){let s={...t,...n,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return r&&r.constructor===n.type||(r=this._createController(e,s)),r&&r.setProps(s),r}return null}_rebuildViewports(){let{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let r=e.length;r--;){let n=e[r],s=this.getViewState(n),o=n.makeViewport({viewState:s,width:this.width,height:this.height}),a=t[n.id],l=!!n.controller;l&&!a&&(i=!0),(i||!l)&&a&&(a.finalize(),a=null),this.controllers[n.id]=this._updateController(n,s,o,a),o&&this._viewports.unshift(o)}for(let e in t){let i=t[e];i&&!this.controllers[e]&&i.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length||e.some((i,r)=>!e[r].equals(t[r]))}}let ar=/([0-9]+\.?[0-9]*)(%|px)/;function an(e){switch(typeof e){case"number":return{position:e,relative:!1};case"string":let t=ar.exec(e);if(t&&t.length>=3){let e="%"===t[2],i=parseFloat(t[1]);return{position:e?i/100:i,relative:e}}default:throw Error(`Could not parse position string ${e}`)}}function as(e,t){return e.relative?Math.round(e.position*t):e.position}class ao{constructor(e){const{id:t,x:i=0,y:r=0,width:n="100%",height:s="100%",padding:o=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=an(i),this._y=an(r),this._width=an(n),this._height=an(s),this._padding=o&&{left:an(o.left||0),right:an(o.right||0),top:an(o.top||0),bottom:an(o.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e||this.constructor===e.constructor&&at(this.props,e.props,2)}clone(e){return new this.constructor({...this.props,...e})}makeViewport({width:e,height:t,viewState:i}){i=this.filterViewState(i);let r=this.getDimensions({width:e,height:t});return r.height&&r.width?new(this.getViewportType(i))({...i,...this.props,...r}):null}getViewStateId(){let{viewState:e}=this.props;return"string"==typeof e?e:e?.id||this.id}filterViewState(e){if(this.props.viewState&&"object"==typeof this.props.viewState){if(!this.props.viewState.id)return this.props.viewState;let t={...e};for(let e in this.props.viewState)"id"!==e&&(t[e]=this.props.viewState[e]);return t}return e}getDimensions({width:e,height:t}){let i={x:as(this._x,e),y:as(this._y,t),width:as(this._width,e),height:as(this._height,t)};return this._padding&&(i.padding={left:as(this._padding.left,e),top:as(this._padding.top,t),right:as(this._padding.right,e),bottom:as(this._padding.bottom,t)}),i}get controller(){let e=this.props.controller;return e?!0===e?{type:this.ControllerType}:"function"==typeof e?{type:e}:{type:this.ControllerType,...e}:null}}var nZ=nZ;class aa extends o7{constructor(e={}){let t;const{latitude:i=0,longitude:r=0,zoom:n=0,pitch:s=0,bearing:o=0,nearZMultiplier:a=.1,farZMultiplier:l=1.01,nearZ:u,farZ:c,orthographic:h=!1,projectionMatrix:d,repeat:f=!1,worldOffset:p=0,position:g,padding:m,legacyMeterSizes:y=!1}=e;let{width:_,height:v,altitude:b=1.5}=e;const x=Math.pow(2,n);_=_||1,v=v||1;let w=null;if(d)t=n9(b=d[5]/2);else{let r;if(e.fovy?b=n7(t=e.fovy):t=n9(b),m){const{top:e=0,bottom:t=0}=m;r=[0,rp((e+v-t)/2,0,v)-v/2]}w=function(e){let{width:t,height:i,altitude:r,pitch:n=0,offset:s,center:o,scale:a,nearZMultiplier:l=1,farZMultiplier:u=1}=e,{fovy:c=n9(1.5)}=e;void 0!==r&&(c=n9(r));let h=c*n1,d=n*n1,f=n7(c),p=f;o&&(p+=o[2]*a/Math.cos(d)/i);let g=h*(.5+(s?s[1]:0)/i),m=Math.sin(g)*p/Math.sin(nY(Math.PI/2-d-g,.01,Math.PI-.01));return{fov:h,aspect:t/i,focalDistance:f,near:l,far:Math.min((Math.sin(d)*m+p)*u,10*p)}}({width:_,height:v,scale:x,center:g&&[0,0,g[2]*n6(i)],offset:r,pitch:s,fovy:t,nearZMultiplier:a,farZMultiplier:l}),Number.isFinite(u)&&(w.near=u),Number.isFinite(c)&&(w.far=c)}let k=function(e){let{height:t,pitch:i,bearing:r,altitude:n,scale:s,center:o}=e,a=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];tO.translate(a,a,[0,0,-n]),tO.rotateX(a,a,-i*n1),tO.rotateZ(a,a,r*n1);let l=s/t;return tO.scale(a,a,[l,l,l]),o&&tO.translate(a,a,nK.negate([],o)),a}({height:v,pitch:s,bearing:o,scale:x,altitude:b});p&&(k=new nW().translate([512*p,0,0]).multiplyLeft(k)),super({...e,width:_,height:v,viewMatrix:k,longitude:r,latitude:i,zoom:n,...w,fovy:t,focalDistance:b}),this.latitude=i,this.longitude=r,this.zoom=n,this.pitch=s,this.bearing=o,this.altitude=b,this.fovy=t,this.orthographic=h,this._subViewports=f?[]:null,this._pseudoMeters=y,Object.freeze(this)}get subViewports(){if(this._subViewports&&!this._subViewports.length){let e=this.getBounds(),t=Math.floor((e[0]+180)/360),i=Math.ceil((e[2]-180)/360);for(let e=t;e<=i;e++){let t=e?new aa({...this,worldOffset:e}):this;this._subViewports.push(t)}}return this._subViewports}projectPosition(e){if(this._pseudoMeters)return super.projectPosition(e);let[t,i]=this.projectFlat(e);return[t,i,(e[2]||0)*n6(e[1])]}unprojectPosition(e){if(this._pseudoMeters)return super.unprojectPosition(e);let[t,i]=this.unprojectFlat(e),r=(e[2]||0)/n6(i);return[t,i,r]}addMetersToLngLat(e,t){return n8(e,t)}panByPosition(e,t){let i=st(t,this.pixelUnprojectionMatrix),r=this.projectFlat(e),n=nZ.add([],r,nZ.negate([],i)),s=nZ.add([],this.center,n),[o,a]=this.unprojectFlat(s);return{longitude:o,latitude:a}}getBounds(e={}){let t=function(e,t=0){let i,r,{width:n,height:s,unproject:o}=e,a={targetZ:t},l=o([0,s],a),u=o([n,s],a);return(e.fovy?.5*e.fovy*si:Math.atan(.5/e.altitude))>(90-e.pitch)*si-.01?(i=sr(e,0,t),r=sr(e,n,t)):(i=o([0,0],a),r=o([n,0],a)),[l,u,r,i]}(this,e.z||0);return[Math.min(t[0][0],t[1][0],t[2][0],t[3][0]),Math.min(t[0][1],t[1][1],t[2][1],t[3][1]),Math.max(t[0][0],t[1][0],t[2][0],t[3][0]),Math.max(t[0][1],t[1][1],t[2][1],t[3][1])]}fitBounds(e,t={}){let{width:i,height:r}=this,{longitude:n,latitude:s,zoom:o}=function(e){let{width:t,height:i,bounds:r,minExtent:n=0,maxZoom:s=24,offset:o=[0,0]}=e,[[a,l],[u,c]]=r,h=function(e=0){return"number"==typeof e?{top:e,bottom:e,left:e,right:e}:(nJ(Number.isFinite(e.top)&&Number.isFinite(e.bottom)&&Number.isFinite(e.left)&&Number.isFinite(e.right)),e)}(e.padding),d=n3([a,nY(c,-85.051129,85.051129)]),f=n3([u,nY(l,-85.051129,85.051129)]),p=[Math.max(Math.abs(f[0]-d[0]),n),Math.max(Math.abs(f[1]-d[1]),n)],g=[t-h.left-h.right-2*Math.abs(o[0]),i-h.top-h.bottom-2*Math.abs(o[1])];nJ(g[0]>0&&g[1]>0);let m=g[0]/p[0],y=g[1]/p[1],_=(h.right-h.left)/2/m,v=(h.top-h.bottom)/2/y,b=n4([(f[0]+d[0])/2+_,(f[1]+d[1])/2+v]),x=Math.min(s,nX(Math.abs(Math.min(m,y))));return nJ(Number.isFinite(x)),{longitude:b[0],latitude:b[1],zoom:x}}({width:i,height:r,bounds:e,...t});return new aa({width:i,height:r,longitude:n,latitude:s,zoom:o})}}aa.displayName="WebMercatorViewport";class al{constructor(e){this._inProgress=!1,this._handle=null,this.time=0,this.settings={duration:0},this._timeline=e}get inProgress(){return this._inProgress}start(e){this.cancel(),this.settings=e,this._inProgress=!0,this.settings.onStart?.(this)}end(){this._inProgress&&(this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1,this.settings.onEnd?.(this))}cancel(){this._inProgress&&(this.settings.onInterrupt?.(this),this._timeline.removeChannel(this._handle),this._handle=null,this._inProgress=!1)}update(){if(!this._inProgress)return!1;if(null===this._handle){let{_timeline:e,settings:t}=this;this._handle=e.addChannel({delay:e.getTime(),duration:t.duration})}return this.time=this._timeline.getTime(this._handle),this._onUpdate(),this.settings.onUpdate?.(this),this._timeline.isFinished(this._handle)&&this.end(),!0}_onUpdate(){}}let au=()=>{},ac=e=>e;class ah{constructor(e){this._onTransitionUpdate=e=>{let{time:t,settings:{interpolator:i,startProps:r,endProps:n,duration:s,easing:o}}=e,a=o(t/s),l=i.interpolateProps(r,n,a);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new al(e.timeline),this.onViewStateChange=e.onViewStateChange||au,this.onStateChange=e.onStateChange||au}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1,i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let r=i;if(this.transition.inProgress){let{interruption:e,endProps:t}=this.transition.settings;r={...i,...2===e?t:this.propsInTransition||i}}this._triggerTransition(r,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){let{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||"auto"===t)&&!!i}_isUpdateDueToCurrentTransition(e){return!!this.transition.inProgress&&!!this.propsInTransition&&this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition)}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?3===this.transition.settings.interruption||this._isUpdateDueToCurrentTransition(t):!this._isTransitionEnabled(t)||t.transitionInterpolator.arePropsEqual(e,t)}_triggerTransition(e,t){let i=this.getControllerState(e),r=this.getControllerState(t).shortestPathFrom(i),n=t.transitionInterpolator,s=n.getDuration?n.getDuration(e,t):t.transitionDuration;if(0===s)return;let o=n.initializeProps(e,r);this.propsInTransition={};let a={duration:s,easing:t.transitionEasing||ac,interpolator:n,interruption:t.transitionInterruption||1,startProps:o.start,endProps:o.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(a),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e?.(t)}}}function ad(e,t){if(!e)throw Error(t||"deck.gl: assertion failed.")}class af{constructor(e){const{compare:t,extract:i,required:r}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=r}arePropsEqual(e,t){for(let i of this._propsToCompare)if(!(i in e)||!(i in t)||!rm(e[i],t[i]))return!1;return!0}initializeProps(e,t){let i={},r={};for(let n of this._propsToExtract)(n in e||n in t)&&(i[n]=e[n],r[n]=t[n]);return this._checkRequiredProps(i),this._checkRequiredProps(r),{start:i,end:r}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{let i=e[t];ad(Number.isFinite(i)||Array.isArray(i),`${t} is required for transition`)})}}let ap=["longitude","latitude","zoom","bearing","pitch"],ag=["longitude","latitude","zoom"];class am extends af{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:ap,required:ag},super(i.transitionProps),this.opts=i}initializeProps(e,t){let i=super.initializeProps(e,t),{makeViewport:r,around:n}=this.opts;if(r&&n){let s=r(e),o=r(t),a=s.unproject(n);i.start.around=n,Object.assign(i.end,{around:o.project(a),aroundPosition:a,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){let r={};for(let n of this._propsToExtract)r[n]=rg(e[n]||0,t[n]||0,i);if(t.aroundPosition&&this.opts.makeViewport){let n=this.opts.makeViewport({...t,...r});Object.assign(r,n.panByPosition(t.aroundPosition,rg(e.around,t.around,i)))}return r}}let ay={transitionDuration:0},a_=e=>1-(1-e)*(1-e),av=["wheel"],ab=["panstart","panmove","panend"],ax=["pinchstart","pinchmove","pinchend"],aw=["multipanstart","multipanmove","multipanend"],ak=["dblclick"],aT=["keydown"],aS={};class aP{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new ah({...e,getControllerState:e=>new this.ControllerState(e),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){for(let e in this._events)this._events[e]&&this.eventManager?.off(e,this.handleEvent);this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;let t=this._eventStartBlocked;switch(e.type){case"panstart":return!t&&this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return!t&&this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return!t&&this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){let{x:t,y:i}=this.props,{offsetCenter:r}=e;return[r.x-t,r.y-i]}isPointInBounds(e,t){let{width:i,height:r}=this.props;if(t&&t.handled)return!1;let n=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=r;return n&&t&&t.stopPropagation(),n}isFunctionKeyPressed(e){let{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){let t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);let{inertia:t}=e;this.inertia=Number.isFinite(t)?t:300*(!0===t);let{scrollZoom:i=!0,dragPan:r=!0,dragRotate:n=!0,doubleClickZoom:s=!0,touchZoom:o=!0,touchRotate:a=!1,keyboard:l=!0}=e,u=!!this.onViewStateChange;this.toggleEvents(av,u&&i),this.toggleEvents(ab,u),this.toggleEvents(ax,u&&(o||a)),this.toggleEvents(aw,u&&a),this.toggleEvents(ak,u&&s),this.toggleEvents(aT,u&&l),this.scrollZoom=i,this.dragPan=r,this.dragRotate=n,this.doubleClickZoom=s,this.touchZoom=o,this.touchRotate=a,this.keyboard=l}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(e=>{this._events[e]!==t&&(this._events[e]=t,t?this.eventManager.on(e,this.handleEvent):this.eventManager.off(e,this.handleEvent))})}updateViewport(e,t=null,i={}){let r={...e.getViewportProps(),...t},n=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),n){let e=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:r,interactionState:this._interactionState,oldViewState:e,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||"pan"===this.dragMode)&&(i=!i);let r=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(r,ay,{isDragging:!0}),!0}_onPan(e){return!!this.isDragging()&&(this._panMove?this._onPanMove(e):this._onPanRotate(e))}_onPanEnd(e){return!!this.isDragging()&&(this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e))}_onPanMove(e){if(!this.dragPan)return!1;let t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,ay,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){let{inertia:t}=this;if(this.dragPan&&t&&e.velocity){let i=this.getCenter(e),r=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],n=this.controllerState.pan({pos:r}).panEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:a_},{isDragging:!1,isPanning:!0})}else{let e=this.controllerState.panEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;let t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,ay,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){let{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){let i=this.getCenter(e),r=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],n=this.controllerState.rotate({pos:r}).rotateEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:a_},{isDragging:!1,isRotating:!0})}else{let e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();let{speed:i=.01,smooth:r=!1}=!0===this.scrollZoom?{}:this.scrollZoom,{delta:n}=e,s=2/(1+Math.exp(-Math.abs(n*i)));n<0&&0!==s&&(s=1/s);let o=r?{...this._getTransitionProps({around:t}),transitionDuration:250}:ay,a=this.controllerState.zoom({pos:t,scale:s});return this.updateViewport(a,o,{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,ay,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;let t=this.getCenter(e);t[0]-=e.deltaX;let i=this.controllerState.rotate({pos:t});return this.updateViewport(i,ay,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){let i=this.getCenter(e),r=[i[0],i[1]+=e.velocityY*t/2],n=this.controllerState.rotate({pos:r});this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:a_},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{let e=this.controllerState.rotateEnd();this.updateViewport(e,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return aS._startPinchRotation=e.rotation,aS._lastPinchEvent=e,this.updateViewport(i,ay,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){let{scale:i}=e,r=this.getCenter(e);t=t.zoom({pos:r,scale:i})}if(this.touchRotate){let{rotation:i}=e;t=t.rotate({deltaAngleX:aS._startPinchRotation-i})}return this.updateViewport(t,ay,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),aS._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;let{inertia:t}=this,{_lastPinchEvent:i}=aS;if(this.touchZoom&&t&&i&&e.scale!==i.scale){let r=this.getCenter(e),n=this.controllerState.rotateEnd(),s=Math.log2(e.scale),o=(s-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),a=Math.pow(2,s+o*t/2);n=n.zoom({pos:r,scale:a}).zoomEnd(),this.updateViewport(n,{...this._getTransitionProps({around:r}),transitionDuration:t,transitionEasing:a_},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{let e=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(e,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return aS._startPinchRotation=null,aS._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;let t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e),r=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(r,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){let t;if(!this.keyboard)return!1;let i=this.isFunctionKeyPressed(e),{zoomSpeed:r,moveSpeed:n,rotateSpeedX:s,rotateSpeedY:o}=!0===this.keyboard?{}:this.keyboard,{controllerState:a}=this,l={};switch(e.srcEvent.code){case"Minus":t=i?a.zoomOut(r).zoomOut(r):a.zoomOut(r),l.isZooming=!0;break;case"Equal":t=i?a.zoomIn(r).zoomIn(r):a.zoomIn(r),l.isZooming=!0;break;case"ArrowLeft":i?(t=a.rotateLeft(s),l.isRotating=!0):(t=a.moveLeft(n),l.isPanning=!0);break;case"ArrowRight":i?(t=a.rotateRight(s),l.isRotating=!0):(t=a.moveRight(n),l.isPanning=!0);break;case"ArrowUp":i?(t=a.rotateUp(o),l.isRotating=!0):(t=a.moveUp(n),l.isPanning=!0);break;case"ArrowDown":i?(t=a.rotateDown(o),l.isRotating=!0):(t=a.moveDown(n),l.isPanning=!0);break;default:return!1}return this.updateViewport(t,this._getTransitionProps(),l),!0}_getTransitionProps(e){let{transition:t}=this;return t&&t.transitionInterpolator?e?{...t,transitionInterpolator:new am({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t:ay}}class aE{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}class aC extends aE{constructor(e){const{width:t,height:i,latitude:r,longitude:n,zoom:s,bearing:o=0,pitch:a=0,altitude:l=1.5,position:u=[0,0,0],maxZoom:c=20,minZoom:h=0,maxPitch:d=60,minPitch:f=0,startPanLngLat:p,startZoomLngLat:g,startRotatePos:m,startBearing:y,startPitch:_,startZoom:v,normalize:b=!0}=e;ad(Number.isFinite(n)),ad(Number.isFinite(r)),ad(Number.isFinite(s)),super({width:t,height:i,latitude:r,longitude:n,zoom:s,bearing:o,pitch:a,altitude:l,maxZoom:c,minZoom:h,maxPitch:d,minPitch:f,normalize:b,position:u},{startPanLngLat:p,startZoomLngLat:g,startRotatePos:m,startBearing:y,startPitch:_,startZoom:v}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){let i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;let r=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(r)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){let r,{startRotatePos:n,startBearing:s,startPitch:o}=this.getState();return n&&void 0!==s&&void 0!==o?(r=e?this._getNewRotation(e,n,o,s):{bearing:s+t,pitch:o+i},this._getUpdatedState(r)):this}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:r,startZoomLngLat:n}=this.getState();if(n||(r=this.getViewportProps().zoom,n=this._unproject(t)||this._unproject(e)),!n)return this;let{maxZoom:s,minZoom:o}=this.getViewportProps(),a=r+Math.log2(i);a=rp(a,o,s);let l=this.makeViewport({...this.getViewportProps(),zoom:a});return this._getUpdatedState({zoom:a,...l.panByPosition(n,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){let t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:r,longitude:n}=i;return Math.abs(r-t.bearing)>180&&(i.bearing=r<0?r+360:r-360),Math.abs(n-t.longitude)>180&&(i.longitude=n<0?n+360:n-360),i}applyConstraints(e){let{maxZoom:t,minZoom:i,zoom:r}=e;e.zoom=rp(r,i,t);let{maxPitch:n,minPitch:s,pitch:o}=e;e.pitch=rp(o,s,n);let{normalize:a=!0}=e;return a&&Object.assign(e,function(e){let{width:t,height:i,pitch:r=0}=e,{longitude:n,latitude:s,zoom:o,bearing:a=0}=e;(n<-180||n>180)&&(n=nH(n+180,360)-180),(a<-180||a>180)&&(a=nH(a+180,360)-180);let l=nX(i/512);if(o<=l)o=l,s=0;else{let e=i/2/Math.pow(2,o),t=n4([0,e])[1];if(s<t)s=t;else{let t=n4([0,512-e])[1];s>t&&(s=t)}}return{width:t,height:i,longitude:n,latitude:s,zoom:o,pitch:r,bearing:a}}(e)),e}_zoomFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){let{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){let t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,r){let n=e[0]-t[0],s=e[1]-t[1],o=e[1],a=t[1],{width:l,height:u}=this.getViewportProps(),c=0;s>0?Math.abs(u-a)>5&&(c=s/(a-u)*1.2):s<0&&a>5&&(c=1-o/a),c=rp(c,-1,1);let{minPitch:h,maxPitch:d}=this.getViewportProps(),f=i;return c>0?f=i+c*(d-i):c<0&&(f=i-c*(h-i)),{pitch:f,bearing:r+n/l*180}}}class aI extends aP{constructor(){super(...arguments),this.ControllerState=aC,this.transition={transitionDuration:300,transitionInterpolator:new am({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];let t=this.props;super.setProps(e),t&&t.height===e.height||this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class aA extends ao{constructor(e={}){super(e)}getViewportType(){return aa}get ControllerType(){return aI}}aA.displayName="MapView";let aM=[255,255,255],aL=0;class aO{constructor(e={}){this.type="ambient";const{color:t=aM}=e,{intensity:i=1}=e;this.id=e.id||`ambient-${aL++}`,this.color=t,this.intensity=i}}let aR=[255,255,255],aD=[0,0,-1],aF=0;class aN{constructor(e={}){this.type="directional";const{color:t=aR}=e,{intensity:i=1}=e,{direction:r=aD}=e,{_shadow:n=!1}=e;this.id=e.id||`directional-${aF++}`,this.color=t,this.intensity=i,this.type="directional",this.direction=new ni(r).normalize().toArray(),this.shadow=n}getProjectedLight(e){return this}}class aj{constructor(e,t={id:"pass"}){const{id:i}=t;this.id=i,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class az extends aj{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){let[t,i]=this.device.canvasContext.getDrawingBufferSize(),r=e.clearCanvas??!0,n=e.clearColor??(!!r&&[0,0,0,0]),s=e.colorMask??15,o={viewport:[0,0,t,i]};e.colorMask&&(o.colorMask=s),e.scissorRect&&(o.scissorRect=e.scissorRect);let a=this.device.beginRenderPass({framebuffer:e.target,parameters:o,clearColor:n,clearDepth:!!r&&1,clearStencil:!!r&&0});try{return this._drawLayers(a,e)}finally{a.end(),this.device.submit()}}_drawLayers(e,t){let{target:i,shaderModuleProps:r,viewports:n,views:s,onViewportActive:o,clearStack:a=!0}=t;t.pass=t.pass||"unknown",a&&(this._lastRenderIndex=-1);let l=[];for(let a of n){let n=s&&s[a.id];o?.(a);let u=this._getDrawLayerParams(a,t);for(let s of a.subViewports||[a]){let o=this._drawLayersInViewport(e,{target:i,shaderModuleProps:r,viewport:s,view:n,pass:t.pass,layers:t.layers},u);l.push(o)}}return l}_getDrawLayerParams(e,{layers:t,pass:i,isPicking:r=!1,layerFilter:n,cullRect:s,effects:o,shaderModuleProps:a},l=!1){let u=[],c=function e(t=0,i={}){let r={},n=(s,o)=>{let a,l=s.props._offset,u=s.id,c=s.parent&&s.parent.id;if(!c||c in i||n(s.parent,!1),c in r){let t=r[c]=r[c]||e(i[c],i);a=t(s,o),r[u]=t}else Number.isFinite(l)?(a=l+(i[c]||0),r[u]=null):a=t;return o&&a>=t&&(t=a+1),i[u]=a,a};return n}(this._lastRenderIndex+1),h={layer:t[0],viewport:e,isPicking:r,renderPass:i,cullRect:s},d={};for(let r=0;r<t.length;r++){let s=t[r],f=this._shouldDrawLayer(s,h,n,d),p={shouldDrawLayer:f};f&&!l&&(p.shouldDrawLayer=!0,p.layerRenderIndex=c(s,f),p.shaderModuleProps=this._getShaderModuleProps(s,o,i,a),p.layerParameters={...s.context.deck?.props.parameters,...this.getLayerParameters(s,r,e)}),u[r]=p}return u}_drawLayersInViewport(e,{layers:t,shaderModuleProps:i,pass:r,target:n,viewport:s,view:o},a){let l=function(e,{shaderModuleProps:t,target:i,viewport:r}){let n=t?.project?.devicePixelRatio??e.canvasContext.cssToDeviceRatio(),[,s]=e.canvasContext.getDrawingBufferSize(),o=i?i.height:s;return[r.x*n,o-(r.y+r.height)*n,r.width*n,r.height*n]}(this.device,{shaderModuleProps:i,target:n,viewport:s});if(o){let{clear:e,clearColor:t,clearDepth:i,clearStencil:r}=o.props;if(e){let e=[0,0,0,0],s=1,o=0;Array.isArray(t)?e=[...t.slice(0,3),t[3]||255].map(e=>e/255):!1===t&&(e=!1),void 0!==i&&(s=i),void 0!==r&&(o=r),this.device.beginRenderPass({framebuffer:n,parameters:{viewport:l,scissorRect:l},clearColor:e,clearDepth:s,clearStencil:o}).end()}}let u={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:l});for(let i=0;i<t.length;i++){let n=t[i],o=a[i],{shouldDrawLayer:l}=o;if(l&&n.props.pickable&&u.pickableCount++,n.isComposite&&u.compositeCount++,n.isDrawable&&o.shouldDrawLayer){let{layerRenderIndex:t,shaderModuleProps:i,layerParameters:a}=o;u.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,t),i.project&&(i.project.viewport=s),n.context.renderPass=e;try{n._drawLayer({renderPass:e,shaderModuleProps:i,uniforms:{layerIndex:t},parameters:a})}catch(e){n.raiseError(e,`drawing ${n} to ${r}`)}}}return u}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,i){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,r){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let n=e.parent;for(;n;){if(!n.props.visible||!n.filterSubLayer(t))return!1;t.layer=n,n=n.parent}if(i){let e=t.layer.id;if(e in r||(r[e]=i(t)),!r[e])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,i,r){let n=this.device.canvasContext.cssToDeviceRatio(),s=e.internalState?.propsInTransition||e.props,o={layer:s,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:n,modelMatrix:s.modelMatrix,coordinateSystem:s.coordinateSystem,coordinateOrigin:s.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(let i of t)aU(o,i.getShaderModuleProps?.(e,o));return aU(o,this.getShaderModuleProps(e,t,o),r)}}function aU(e,...t){for(let i of t)if(i)for(let t in i)e[t]?Object.assign(e[t],i[t]):e[t]=i[t];return e}class aB extends az{constructor(e,t){super(e,t);const i=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"}}),r=e.createTexture({format:"depth16unorm",width:1,height:1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[i],depthStencilAttachment:r})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){let t=this.fbo,i=this.device.canvasContext.cssToDeviceRatio(),r=e.viewports[0],n=r.width*i,s=r.height*i;(n!==t.width||s!==t.height)&&t.resize({width:n,height:s}),super.render({...e,clearColor:[1,1,1,1],target:t,pass:"shadow"})}getLayerParameters(e,t,i){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return!1!==e.props.shadowEnabled}getShaderModuleProps(e,t,i){return{shadow:{project:i.project,drawToShadowMap:!0}}}}let a$={color:[255,255,255],intensity:1},aV=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],aW=[0,0,0,200/255];class aG{constructor(e={}){this.id="lighting-effect",this.shadowColor=aW,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;let{device:t,deck:i}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),i._addDefaultShaderModule(sf),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){for(let t in this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[],e){let i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i)}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(e=>e.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:i,onViewportActive:r,views:n}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let s=0;s<this.shadowPasses.length;s++)this.shadowPasses[s].render({layers:e,layerFilter:t,viewports:i,onViewportActive:r,views:n,shaderModuleProps:{shadow:{shadowLightId:s,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){let i=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(e=>e.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},r={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(t=>t.getProjectedLight({layer:e})),pointLights:this.pointLights.map(t=>t.getProjectedLight({layer:e}))},n=e.props.material;return{shadow:i,lighting:r,phongMaterial:n,gouraudMaterial:n}}cleanup(e){for(let e of this.shadowPasses)e.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(sf))}_calculateMatrices(){let e=[];for(let t of this.directionalLights){let i=new nW().lookAt({eye:new ni(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){let i=new aB(e);this.shadowPasses[t]=i}}_applyDefaultLights(){let{ambientLight:e,pointLights:t,directionalLights:i}=this;e||0!==t.length||0!==i.length||(this.ambientLight=new aO(a$),this.directionalLights.push(new aN(aV[0]),new aN(aV[1])))}}let aq=new aG;class aH{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){let t=this._defaultEffects;if(!t.find(t=>t.id===e.id)){let i=t.findIndex(t=>(t.order??1/0)-(e.order??1/0)>0);i<0?t.push(e):t.splice(i,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&!at(e.effects,this.effects,1)&&this._setEffects(e.effects)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){let t={};for(let e of this.effects)t[e.id]=e;let i=[];for(let r of e){let e=t[r.id],n=r;e&&e!==r?e.setProps?(e.setProps(r.props),n=e):e.cleanup(this._context):e||r.setup(this._context),i.push(n),delete t[r.id]}for(let e in t)t[e].cleanup(this._context);this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),e.some(e=>e instanceof aG)||this._resolvedEffects.push(aq),this._needsRedraw="effects changed"}finalize(){for(let e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class aY extends az{shouldDrawLayer(e){let{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}let aX={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant",blendAlphaDstFactor:"zero"};class aZ extends az{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:r,onViewportActive:n,pickingFBO:s,deviceRect:{x:o,y:a,width:l,height:u},cullRect:c,effects:h,pass:d="picking",pickZ:f,shaderModuleProps:p}){this.pickZ=f;let g=this._resetColorEncoder(f),m=super.render({target:s,layers:e,layerFilter:t,views:i,viewports:r,onViewportActive:n,cullRect:c,effects:h?.filter(e=>e.useInPicking),pass:d,isPicking:!0,shaderModuleProps:p,clearColor:[0,0,0,0],colorMask:15,scissorRect:[o,a,l,u]});return this._colorEncoderState=null,{decodePickingColor:g&&aK.bind(null,g),stats:m}}shouldDrawLayer(e){let{pickable:t,operation:i}=e.props;return t&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getShaderModuleProps(e,t,i){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,i){let r={...e.props.parameters},{pickable:n,operation:s}=e.props;return!this._colorEncoderState||s.includes("terrain")?r.blend=!1:n&&s.includes("draw")&&(Object.assign(r,aX),r.blend=!0,r.blendColor=function(e,t,i){let r,{byLayer:n,byAlpha:s}=e,o=n.get(t);return o?(o.viewports.push(i),r=o.a):(r=n.size+1)<=255?(o={a:r,layer:t,viewports:[i]},n.set(t,o),s[r]=o):(ia.warn("Too many pickable layers, only picking the first 255")(),r=0),[0,0,0,r/255]}(this._colorEncoderState,e,i)),r}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function aK(e,t){let i=e.byAlpha[t[3]];return i&&{pickedLayer:i.layer,pickedViewports:i.viewports,pickedObjectIndex:i.layer.decodePickingColor(t)}}class aJ{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new aY(e),this.pickLayersPass=new aZ(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;let t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};i.effects&&this._preRender(i.effects,i);let r=this.lastPostProcessEffect?this.renderBuffers[0]:i.target;this.lastPostProcessEffect&&(i.clearColor=[0,0,0,0],i.clearCanvas=!0);let n=t.render({...i,target:r});i.effects&&(this.lastPostProcessEffect&&(i.clearCanvas=void 0===e.clearCanvas||e.clearCanvas),this._postRender(i.effects,i)),this.renderCount++,sC("deckRenderer.renderLayers",this,n,e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){let{renderBuffers:e}=this;for(let t of e)t.delete();e.length=0}_preRender(e,t){for(let i of(this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{},e))t.preRenderStats[i.id]=i.preRender(t),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){let{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize(),[i,r]=t;for(let n of(0===e.length&&[0,1].map(t=>{let n=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"},width:i,height:r});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${t}`,colorAttachments:[n]}))}),e))n.resize(t)}_postRender(e,t){let{renderBuffers:i}=this,r={...t,inputBuffer:i[0],swapBuffer:i[1]};for(let n of e)if(n.postRender){r.target=n.id===this.lastPostProcessEffect?t.target:void 0;let e=n.postRender(r);r.inputBuffer=e,r.swapBuffer=e===i[0]?i[1]:i[0]}}}let aQ={pickedColor:null,pickedObjectIndex:-1};function a0({pickedColors:e,decodePickingColor:t,deviceX:i,deviceY:r,deviceRadius:n,deviceRect:s}){let{x:o,y:a,width:l,height:u}=s,c=n*n,h=-1,d=0;for(let t=0;t<u;t++){let n=t+a-r,s=n*n;if(s>c)d+=4*l;else for(let t=0;t<l;t++){if(e[d+3]-1>=0){let e=t+o-i,r=e*e+s;r<=c&&(c=r,h=d)}d+=4}}if(h>=0){let i=e.slice(h,h+4),r=t(i);if(r){let e=Math.floor(h/4/l),t=h/4-e*l;return{...r,pickedColor:i,pickedX:o+t,pickedY:a+e}}ia.error("Picked non-existent layer. Is picking buffer corrupt?")()}return aQ}function a1({pickedColors:e,decodePickingColor:t}){let i=new Map;if(e){for(let r=0;r<e.length;r+=4)if(e[r+3]-1>=0){let n=e.slice(r,r+4),s=n.join(",");if(!i.has(s)){let e=t(n);e?i.set(s,{...e,color:n}):ia.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(i.values())}function a2({pickInfo:e,viewports:t,pixelRatio:i,x:r,y:n,z:s}){let o,a=t[0];if(t.length>1&&(a=function(e,t){for(let i=e.length-1;i>=0;i--){let r=e[i];if(r.containsPixel(t))return r}return e[0]}(e?.pickedViewports||t,{x:r,y:n})),a){let e=[r-a.x,n-a.y];void 0!==s&&(e[2]=s),o=a.unproject(e)}return{color:null,layer:null,viewport:a,index:-1,picked:!1,x:r,y:n,pixel:[r,n],coordinate:o,devicePixel:e&&"pickedX"in e?[e.pickedX,e.pickedY]:void 0,pixelRatio:i}}function a3(e){let{pickInfo:t,lastPickedInfo:i,mode:r,layers:n}=e,{pickedColor:s,pickedLayer:o,pickedObjectIndex:a}=t,l=o?[o]:[];if("hover"===r){let e=i.index,t=i.layerId,r=o?o.props.id:null;if(r!==t||a!==e){if(r!==t){let e=n.find(e=>e.props.id===t);e&&l.unshift(e)}i.layerId=r,i.index=a,i.info=null}}let u=a2(e),c=new Map;return c.set(null,u),l.forEach(e=>{let t={...u};e===o&&(t.color=s,t.index=a,t.picked=!0);let n=(t=a4({layer:e,info:t,mode:r})).layer;e===o&&"hover"===r&&(i.info=t),c.set(n.id,t),"hover"===r&&n.updateAutoHighlight(t)}),c}function a4({layer:e,info:t,mode:i}){for(;e&&t;){let r=t.layer||null;t.sourceLayer=r,t.layer=e,t=e.getPickingInfo({info:t,mode:i,sourceLayer:r}),e=e.parent}return t}class a6{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new aZ(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObjectAsync(e){return this._pickClosestObjectAsync(e)}pickObjectsAsync(e){return this._pickVisibleObjectsAsync(e)}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:r},n=this.lastPickedInfo.info){let s=n&&n.layer&&n.layer.id,o=n&&n.viewport&&n.viewport.id,a=s?i.find(e=>e.id===s):null,l=o&&r.find(e=>e.id===o)||r[0],u=l&&l.unproject([e-l.x,t-l.y]);return{...n,x:e,y:t,viewport:l,coordinate:u,layer:a}}_resizeBuffer(){if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){let e=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=e}let{canvas:e}=this.device.getDefaultCanvasContext();this.pickingFBO?.resize({width:e.width,height:e.height}),this.depthFBO?.resize({width:e.width,height:e.height})}_getPickable(e){if(!1===this._pickable)return null;let t=e.filter(e=>this.pickLayersPass.shouldDrawLayer(e)&&!e.isComposite);return t.length?t:null}async _pickClosestObjectAsync({layers:e,views:t,viewports:i,x:r,y:n,radius:s=0,depth:o=1,mode:a="query",unproject3D:l,onViewportActive:u,effects:c}){let h,d=this.device.canvasContext.cssToDeviceRatio(),f=this._getPickable(e);if(!f||0===i.length)return{result:[],emptyInfo:a2({viewports:i,x:r,y:n,pixelRatio:d})};this._resizeBuffer();let p=this.device.canvasContext.cssToDevicePixels([r,n],!0),g=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],m=Math.round(s*d),{width:y,height:_}=this.pickingFBO,v=this._getPickingRect({deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceWidth:y,deviceHeight:_}),b={x:r-s,y:n-s,width:2*s+1,height:2*s+1},x=[],w=new Set;for(let e=0;e<o;e++){let s,p;if((s=v?a0({...this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:u,deviceRect:v,cullRect:b,effects:c,pass:`picking:${a}`}),deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceRect:v}):{pickedColor:null,pickedObjectIndex:-1}).pickedLayer&&l&&this.depthFBO){let{pickedColors:e}=this._drawAndSample({layers:[s.pickedLayer],views:t,viewports:i,onViewportActive:u,deviceRect:{x:s.pickedX,y:s.pickedY,width:1,height:1},cullRect:b,effects:c,pass:`picking:${a}:z`},!0);e[3]&&(p=e[0])}for(let t of(s.pickedLayer&&e+1<o&&(w.add(s.pickedLayer),s.pickedLayer.disablePickingIndex(s.pickedObjectIndex)),(h=a3({pickInfo:s,lastPickedInfo:this.lastPickedInfo,mode:a,layers:f,viewports:i,x:r,y:n,z:p,pixelRatio:d})).values()))t.layer&&x.push(t);if(!s.pickedColor)break}for(let e of w)e.restorePickingColors();return{result:x,emptyInfo:h.get(null)}}_pickClosestObject({layers:e,views:t,viewports:i,x:r,y:n,radius:s=0,depth:o=1,mode:a="query",unproject3D:l,onViewportActive:u,effects:c}){let h,d=this.device.canvasContext.cssToDeviceRatio(),f=this._getPickable(e);if(!f||0===i.length)return{result:[],emptyInfo:a2({viewports:i,x:r,y:n,pixelRatio:d})};this._resizeBuffer();let p=this.device.canvasContext.cssToDevicePixels([r,n],!0),g=[p.x+Math.floor(p.width/2),p.y+Math.floor(p.height/2)],m=Math.round(s*d),{width:y,height:_}=this.pickingFBO,v=this._getPickingRect({deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceWidth:y,deviceHeight:_}),b={x:r-s,y:n-s,width:2*s+1,height:2*s+1},x=[],w=new Set;for(let e=0;e<o;e++){let s,p;if((s=v?a0({...this._drawAndSample({layers:f,views:t,viewports:i,onViewportActive:u,deviceRect:v,cullRect:b,effects:c,pass:`picking:${a}`}),deviceX:g[0],deviceY:g[1],deviceRadius:m,deviceRect:v}):{pickedColor:null,pickedObjectIndex:-1}).pickedLayer&&l&&this.depthFBO){let{pickedColors:e}=this._drawAndSample({layers:[s.pickedLayer],views:t,viewports:i,onViewportActive:u,deviceRect:{x:s.pickedX,y:s.pickedY,width:1,height:1},cullRect:b,effects:c,pass:`picking:${a}:z`},!0);e[3]&&(p=e[0])}for(let t of(s.pickedLayer&&e+1<o&&(w.add(s.pickedLayer),s.pickedLayer.disablePickingIndex(s.pickedObjectIndex)),(h=a3({pickInfo:s,lastPickedInfo:this.lastPickedInfo,mode:a,layers:f,viewports:i,x:r,y:n,z:p,pixelRatio:d})).values()))t.layer&&x.push(t);if(!s.pickedColor)break}for(let e of w)e.restorePickingColors();return{result:x,emptyInfo:h.get(null)}}async _pickVisibleObjectsAsync({layers:e,views:t,viewports:i,x:r,y:n,width:s=1,height:o=1,mode:a="query",maxObjects:l=null,onViewportActive:u,effects:c}){let h=this._getPickable(e);if(!h||0===i.length)return[];this._resizeBuffer();let d=this.device.canvasContext.cssToDeviceRatio(),f=this.device.canvasContext.cssToDevicePixels([r,n],!0),p=f.x,g=f.y+f.height,m=this.device.canvasContext.cssToDevicePixels([r+s,n+o],!0),y=m.x+m.width,_=m.y,v=this._drawAndSample({layers:h,views:t,viewports:i,onViewportActive:u,deviceRect:{x:p,y:_,width:y-p,height:g-_},cullRect:{x:r,y:n,width:s,height:o},effects:c,pass:`picking:${a}`}),b=a1(v),x=new Map,w=[],k=Number.isFinite(l);for(let e=0;e<b.length&&(!k||!(w.length>=l));e++){let t=b[e],i={color:t.pickedColor,layer:null,index:t.pickedObjectIndex,picked:!0,x:r,y:n,pixelRatio:d},s=(i=a4({layer:t.pickedLayer,info:i,mode:a})).layer.id;x.has(s)||x.set(s,new Set);let o=x.get(s),l=i.object??i.index;o.has(l)||(o.add(l),w.push(i))}return w}_pickVisibleObjects({layers:e,views:t,viewports:i,x:r,y:n,width:s=1,height:o=1,mode:a="query",maxObjects:l=null,onViewportActive:u,effects:c}){let h=this._getPickable(e);if(!h||0===i.length)return[];this._resizeBuffer();let d=this.device.canvasContext.cssToDeviceRatio(),f=this.device.canvasContext.cssToDevicePixels([r,n],!0),p=f.x,g=f.y+f.height,m=this.device.canvasContext.cssToDevicePixels([r+s,n+o],!0),y=m.x+m.width,_=m.y,v=this._drawAndSample({layers:h,views:t,viewports:i,onViewportActive:u,deviceRect:{x:p,y:_,width:y-p,height:g-_},cullRect:{x:r,y:n,width:s,height:o},effects:c,pass:`picking:${a}`}),b=a1(v),x=new Map,w=[],k=Number.isFinite(l);for(let e=0;e<b.length&&(!k||!(w.length>=l));e++){let t=b[e],i={color:t.pickedColor,layer:null,index:t.pickedObjectIndex,picked:!0,x:r,y:n,pixelRatio:d},s=(i=a4({layer:t.pickedLayer,info:i,mode:a})).layer.id;x.has(s)||x.set(s,new Set);let o=x.get(s),l=i.object??i.index;o.has(l)||(o.add(l),w.push(i))}return w}async _drawAndSampleAsync({layers:e,views:t,viewports:i,onViewportActive:r,deviceRect:n,cullRect:s,effects:o,pass:a},l=!1){let u=l?this.depthFBO:this.pickingFBO,c={layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:r,pickingFBO:u,deviceRect:n,cullRect:s,effects:o,pass:a,pickZ:l,preRenderStats:{},isPicking:!0};for(let e of o)e.useInPicking&&(c.preRenderStats[e.id]=e.preRender(c));let{decodePickingColor:h}=this.pickLayersPass.render(c),{x:d,y:f,width:p,height:g}=n,m=new(l?Float32Array:Uint8Array)(p*g*4);return this.device.readPixelsToArrayWebGL(u,{sourceX:d,sourceY:f,sourceWidth:p,sourceHeight:g,target:m}),{pickedColors:m,decodePickingColor:h}}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:r,deviceRect:n,cullRect:s,effects:o,pass:a},l=!1){let u=l?this.depthFBO:this.pickingFBO,c={layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:r,pickingFBO:u,deviceRect:n,cullRect:s,effects:o,pass:a,pickZ:l,preRenderStats:{},isPicking:!0};for(let e of o)e.useInPicking&&(c.preRenderStats[e.id]=e.preRender(c));let{decodePickingColor:h}=this.pickLayersPass.render(c),{x:d,y:f,width:p,height:g}=n,m=new(l?Float32Array:Uint8Array)(p*g*4);return this.device.readPixelsToArrayWebGL(u,{sourceX:d,sourceY:f,sourceWidth:p,sourceHeight:g,target:m}),{pickedColors:m,decodePickingColor:h}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:r,deviceHeight:n}){let s=Math.max(0,e-i),o=Math.max(0,t-i),a=Math.min(r,e+i+1)-s,l=Math.min(n,t+i+1)-o;return a<=0||l<=0?null:{x:s,y:o,width:a,height:l}}}let a5={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},a8="__root";class a9{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,t?.classList.add("deck-widget-container"),this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){if(e.widgets&&!at(e.widgets,this.widgets,1)){let t=e.widgets.filter(Boolean);this._setWidgets(t)}}finalize(){for(let e of this.getWidgets())this._removeWidget(e);for(let e in this.defaultWidgets.length=0,this.resolvedWidgets.length=0,this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._addWidget(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}onRedraw({viewports:e,layers:t}){let i=e.reduce((e,t)=>(e[t.id]=t,e),{});for(let r of this.getWidgets()){let{viewId:n}=r;if(n){let e=i[n];e&&(r.onViewportChange&&r.onViewportChange(e),r.onRedraw?.({viewports:[e],layers:t}))}else{if(r.onViewportChange)for(let t of e)r.onViewportChange(t);r.onRedraw?.({viewports:e,layers:t})}}this.lastViewports=i,this._updateContainers()}onHover(e,t){for(let i of this.getWidgets()){let{viewId:r}=i;r&&r!==e.viewport?.id||i.onHover?.(e,t)}}onEvent(e,t){let i=i1[t.type];if(i)for(let r of this.getWidgets()){let{viewId:n}=r;n&&n!==e.viewport?.id||r[i]?.(e,t)}}_setWidgets(e){let t={};for(let e of this.resolvedWidgets)t[e.id]=e;for(let e of(this.resolvedWidgets.length=0,this.defaultWidgets))t[e.id]=null,this.resolvedWidgets.push(e);for(let i of e){let e=t[i.id];e?e.viewId!==i.viewId||e.placement!==i.placement?(this._removeWidget(e),this._addWidget(i)):i!==e&&(e.setProps(i.props),i=e):this._addWidget(i),t[i.id]=null,this.resolvedWidgets.push(i)}for(let e in t){let i=t[e];i&&this._removeWidget(i)}this.widgets=e}_addWidget(e){let{viewId:t=null,placement:i="top-left"}=e;e.widgetManager=this,e.deck=this.deck,e.rootElement=e._onAdd({deck:this.deck,viewId:t}),e.rootElement&&this._getContainer(t,i).append(e.rootElement),e.updateHTML()}_removeWidget(e){e.onRemove?.(),e.rootElement&&e.rootElement.remove(),e.rootElement=void 0,e.deck=void 0,e.widgetManager=void 0}_getContainer(e,t){let i=e||a8,r=this.containers[i];r||((r=document.createElement("div")).style.pointerEvents="none",r.style.position="absolute",r.style.overflow="hidden",this.parentElement?.append(r),this.containers[i]=r);let n=r.querySelector(`.${t}`);return n||((n=globalThis.document.createElement("div")).className=t,n.style.position="absolute",n.style.zIndex="2",Object.assign(n.style,a5[t]),r.append(n)),n}_updateContainers(){let e=this.deck.width,t=this.deck.height;for(let i in this.containers){let r=this.lastViewports[i]||null,n=i===a8||r,s=this.containers[i];n?(s.style.display="block",s.style.left=`${r?r.x:0}px`,s.style.top=`${r?r.y:0}px`,s.style.width=`${r?r.width:e}px`,s.style.height=`${r?r.height:t}px`):s.style.display="none"}}}function a7(e,t){t&&Object.entries(t).map(([t,i])=>{t.startsWith("--")?e.style.setProperty(t,i):e.style[t]=i})}class le{constructor(e){this.viewId=null,this.props={...this.constructor.defaultProps,...e},this.id=this.props.id}setProps(e){let t=this.props,i=this.rootElement;if(i&&t.className!==e.className&&(t.className&&i.classList.remove(t.className),e.className&&i.classList.add(e.className)),i&&!at(t.style,e.style,1)){var r;(r=t.style)&&Object.keys(r).map(e=>{e.startsWith("--")?i.style.removeProperty(e):i.style[e]=""}),a7(i,e.style)}Object.assign(this.props,e),this.updateHTML()}updateHTML(){this.rootElement&&this.onRenderHTML(this.rootElement)}onCreateRootElement(){let e=["deck-widget",this.className,this.props.className],t=document.createElement("div");return e.filter(e=>"string"==typeof e&&e.length>0).forEach(e=>t.classList.add(e)),a7(t,this.props.style),t}_onAdd(e){return this.onAdd(e)??this.onCreateRootElement()}onAdd(e){}onRemove(){}onViewportChange(e){}onRedraw(e){}onHover(e,t){}onClick(e,t){}onDrag(e,t){}onDragStart(e,t){}onDragEnd(e,t){}}le.defaultProps={id:"widget",style:{},className:""};let lt={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class li extends le{constructor(e={}){super(e),this.id="default-tooltip",this.placement="fill",this.className="deck-tooltip",this.isVisible=!1,this.setProps(e)}onCreateRootElement(){let e=document.createElement("div");return e.className=this.className,Object.assign(e.style,lt),e}onRenderHTML(e){}onViewportChange(e){this.isVisible&&e.id===this.lastViewport?.id&&!e.equals(this.lastViewport)&&this.setTooltip(null),this.lastViewport=e}onHover(e){let{deck:t}=this,i=t&&t.props.getTooltip;if(!i)return;let r=i(e);this.setTooltip(r,e.x,e.y)}setTooltip(e,t,i){let r=this.rootElement;if(r){if("string"==typeof e)r.innerText=e;else if(e)e.text&&(r.innerText=e.text),e.html&&(r.innerHTML=e.html),e.className&&(r.className=e.className);else{this.isVisible=!1,r.style.display="none";return}this.isVisible=!0,r.style.display="block",r.style.transform=`translate(${t}px, ${i}px)`,e&&"object"==typeof e&&"style"in e&&Object.assign(r.style,e.style)}}}li.defaultProps={...le.defaultProps};let lr=globalThis.loaders?.parseImageNode,ln="undefined"!=typeof Image,ls="undefined"!=typeof ImageBitmap,lo=!!s3||!!lr,la=/^data:image\/svg\+xml/,ll=/\.svg((\?|#).*)?$/;function lu(e){return e&&(la.test(e)||ll.test(e))}function lc(e,t){if(lu(t))throw Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(e)])}async function lh(e,t,i){let r=function(e,t){if(lu(t)){let t=new TextDecoder().decode(e);try{"function"==typeof unescape&&"function"==typeof encodeURIComponent&&(t=unescape(encodeURIComponent(t)))}catch(e){throw Error(e.message)}return`data:image/svg+xml;base64,${btoa(t)}`}return lc(e,t)}(e,i),n=self.URL||self.webkitURL,s="string"!=typeof r&&n.createObjectURL(r);try{return await ld(s||r,t)}finally{s&&n.revokeObjectURL(s)}}async function ld(e,t){let i=new Image;return(i.src=e,t.image&&t.image.decode&&i.decode)?(await i.decode(),i):await new Promise((e,t)=>{try{i.onload=()=>e(i),i.onerror=e=>{let i=e instanceof Error?e.message:"error";t(Error(i))}}catch(e){t(e)}})}let lf={},lp=!0;async function lg(e,t,i){let r;r=lu(i)?await lh(e,t,i):lc(e,i);let n=t&&t.imagebitmap;return await lm(r,n)}async function lm(e,t=null){if((function(e){for(let t in e||lf)return!1;return!0}(t)||!lp)&&(t=null),t)try{return await createImageBitmap(e,t)}catch(e){console.warn(e),lp=!1}return await createImageBitmap(e)}function ly(e){var t,i;let r,n,s,o,a=l_(e);return((r=l_(a)).byteLength>=24&&0x89504e47===r.getUint32(0,!1)?{mimeType:"image/png",width:r.getUint32(16,!1),height:r.getUint32(20,!1)}:null)||function(e){let t=l_(e);if(!(t.byteLength>=3&&65496===t.getUint16(0,!1)&&255===t.getUint8(2)))return null;let{tableMarkers:i,sofMarkers:r}=function(){let e=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)e.add(t);return{tableMarkers:e,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}(),n=2;for(;n+9<t.byteLength;){let e=t.getUint16(n,!1);if(r.has(e))return{mimeType:"image/jpeg",height:t.getUint16(n+5,!1),width:t.getUint16(n+7,!1)};if(!i.has(e))break;n+=2,n+=t.getUint16(n,!1)}return null}(a)||((n=l_(a)).byteLength>=10&&0x47494638===n.getUint32(0,!1)?{mimeType:"image/gif",width:n.getUint16(6,!0),height:n.getUint16(8,!0)}:null)||((s=l_(a)).byteLength>=14&&16973===s.getUint16(0,!1)&&s.getUint32(2,!0)===s.byteLength?{mimeType:"image/bmp",width:s.getUint32(18,!0),height:s.getUint32(22,!0)}:null)||((o=!function(e,t,i=0){let r=[...t].map(e=>e.charCodeAt(0));for(let t=0;t<r.length;++t)if(r[t]!==e[t+i])return!1;return!0}(i=new Uint8Array((t=a)instanceof DataView?t.buffer:t),"ftyp",4)||(96&i[8])==0?null:function(e){switch(String.fromCharCode(...e.slice(8,12)).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}(i))?{mimeType:o.mimeType,width:0,height:0}:null)}function l_(e){if(e instanceof DataView)return e;if(ArrayBuffer.isView(e))return new DataView(e.buffer);if(e instanceof ArrayBuffer)return new DataView(e);throw Error("toDataView")}async function lv(e,t){let{mimeType:i}=ly(e)||{},r=globalThis.loaders?.parseImageNode;return sF(r),await r(e,i)}let lb={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:"4.3.3",mimeTypes:["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],extensions:["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],parse:async function e(e,t,i){let r,n=((t=t||{}).image||{}).type||"auto",{url:s}=i||{};switch(function(e){switch(e){case"auto":case"data":if(ls)return"imagebitmap";if(ln)return"image";if(lo)return"data";throw Error("Install '@loaders.gl/polyfills' to parse images under Node.js");default:return!function(e){switch(e){case"auto":return ls;case"imagebitmap":case"image":case"data":return;default:throw Error(`@loaders.gl/images: image ${e} not supported in this environment`)}}(e),e}}(n)){case"imagebitmap":r=await lg(e,t,s);break;case"image":r=await lh(e,t,s);break;case"data":r=await lv(e,t);break;default:sF(!1)}return"data"===n&&(r=function(e){switch(function(e){var t;let i=(t=e,"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap?"imagebitmap":"undefined"!=typeof Image&&t instanceof Image?"image":t&&"object"==typeof t&&t.data&&t.width&&t.height?"data":null);if(!i)throw Error("Not an image");return i}(e)){case"data":return e;case"image":case"imagebitmap":let t=document.createElement("canvas"),i=t.getContext("2d");if(!i)throw Error("getImageData");return t.width=e.width,t.height=e.height,i.drawImage(e,0,0),i.getImageData(0,0,e.width,e.height);default:throw Error("getImageData")}}(r)),r},tests:[e=>!!ly(new DataView(e))],options:{image:{type:"auto",decode:!0}}},lx={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:function(e){let t=e[0],i=e[e.length-1];return"{"===t&&"}"===i||"["===t&&"]"===i},parseTextSync:JSON.parse},lw=function(){let e="9.2.5",t=globalThis.deck&&globalThis.deck.VERSION;if(t&&t!==e)throw Error(`deck.gl - multiple versions detected: ${t} vs ${e}`);if(!t){ia.log(1,`deck.gl ${e}`)(),globalThis.deck={...globalThis.deck,VERSION:e,version:e,log:ia,_registerLoggers:sE};var i=[lx,[lb,{imagebitmap:{premultiplyAlpha:"none"}}]];let t=oN();for(let e of i=Array.isArray(i)?i:[i]){let i=sj(e);t.find(e=>i===e)||t.unshift(i)}}return e}();var lk=e.i(9900),lT=e.i(4819);let lS="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.";class lP{static defaultProps={...lk.Device.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0};stats=lT.lumaStats;log=eA.log;VERSION="9.2.5";spector;preregisteredAdapters=new Map;constructor(){if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw eA.log.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),eA.log.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),Error("luma.gl - multiple versions detected: see console log");eA.log.error("This version of luma.gl has already been initialized")()}eA.log.log(1,`${this.VERSION} - set luma.log.level=1 (or higher) to trace rendering`)(),globalThis.luma=this}async createDevice(e={}){let t={...lP.defaultProps,...e},i=this.selectAdapter(t.type,t.adapters);if(!i)throw Error(lS);return t.waitForPageLoad&&await i.pageLoaded,await i.create(t)}async attachDevice(e,t){let i=this._getTypeFromHandle(e,t.adapters),r=i&&this.selectAdapter(i,t.adapters);if(!r)throw Error(lS);return await r?.attach?.(e,t)}registerAdapters(e){for(let t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){return Array.from(this._getAdapterMap(e)).map(([,e])=>e).filter(e=>e.isSupported?.()).map(e=>e.type)}getBestAvailableAdapterType(e=[]){let t=this._getAdapterMap(e);for(let e of["webgpu","webgl","null"])if(t.get(e)?.isSupported?.())return e;return null}selectAdapter(e,t=[]){let i=e;"best-available"===e&&(i=this.getBestAvailableAdapterType(t));let r=this._getAdapterMap(t);return i&&r.get(i)||null}enforceWebGL2(e=!0,t=[]){let i=this._getAdapterMap(t).get("webgl");i||eA.log.warn("enforceWebGL2: webgl adapter not found")(),i?.enforceWebGL2?.(e)}setDefaultDeviceProps(e){Object.assign(lP.defaultProps,e)}_getAdapterMap(e=[]){let t=new Map(this.preregisteredAdapters);for(let i of e)t.set(i.type,i);return t}_getTypeFromHandle(e,t=[]){return e instanceof WebGL2RenderingContext?"webgl":"undefined"!=typeof GPUDevice&&e instanceof GPUDevice||e?.queue?"webgpu":null===e?"null":(e instanceof WebGLRenderingContext?eA.log.warn("WebGL1 is not supported",e)():eA.log.warn("Unknown handle type",e)(),null)}}let lE=new lP;var lC=e.i(40021);class lI{get pageLoaded(){return lM||(lM=lA&&"complete"===document.readyState||"undefined"==typeof window?Promise.resolve():new Promise(e=>window.addEventListener("load",()=>e()))),lM}}let lA=(0,lC.isBrowser)()&&"undefined"!=typeof document,lM=null,lL={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}};var lO=e.i(31934),lR=e.i(7784);let lD=new class extends lI{type="webgl";constructor(){super(),lk.Device.defaultProps={...lk.Device.defaultProps,...lO.DEFAULT_SPECTOR_PROPS}}enforceWebGL2(e){!function(e=!0){let t=HTMLCanvasElement.prototype;if(!e&&t.originalGetContext){t.getContext=t.originalGetContext,t.originalGetContext=void 0;return}t.originalGetContext=t.getContext,t.getContext=function(e,t){if("webgl"===e||"experimental-webgl"===e){let e=this.originalGetContext("webgl2",t);return e instanceof HTMLElement&&function(e){e.getExtension("EXT_color_buffer_float");let t={...lL,WEBGL_disjoint_timer_query:e.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:{drawBuffersWEBGL:t=>e.drawBuffers(t),COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067},OES_vertex_array_object:{VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES:()=>e.createVertexArray(),deleteVertexArrayOES:t=>e.deleteVertexArray(t),isVertexArrayOES:t=>e.isVertexArray(t),bindVertexArrayOES:t=>e.bindVertexArray(t)},ANGLE_instanced_arrays:{VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE:(...t)=>e.drawArraysInstanced(...t),drawElementsInstancedANGLE:(...t)=>e.drawElementsInstanced(...t),vertexAttribDivisorANGLE:(...t)=>e.vertexAttribDivisor(...t)}},i=e.getExtension;e.getExtension=function(r){let n=i.call(e,r);return n||(r in t?t[r]:null)};let r=e.getSupportedExtensions;e.getSupportedExtensions=function(){let i=r.apply(e)||[];return i?.concat(Object.keys(t))}}(e),e}return this.originalGetContext(e,t)}}(e)}isSupported(){return"undefined"!=typeof WebGL2RenderingContext}isDeviceHandle(e){return!!("undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext)||("undefined"!=typeof WebGLRenderingContext&&e instanceof WebGLRenderingContext&&eA.log.warn("WebGL1 is not supported",e)(),!1)}async attach(t,i={}){var r;let{WebGLDevice:n}=await e.A(76084);if(t instanceof n)return t;if(t?.device instanceof n)return t.device;if(r=t,!("undefined"!=typeof WebGL2RenderingContext&&r instanceof WebGL2RenderingContext||r&&Number.isFinite(r._version)))throw Error("Invalid WebGL2RenderingContext");let s=!0===i.createCanvasContext?{}:i.createCanvasContext;return new n({...i,_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1,...s}})}async create(t={}){let{WebGLDevice:i}=await e.A(76084);eA.log.groupCollapsed(1,"WebGLDevice created")();try{let e=[];for(let i of((t.debugWebGL||t.debug)&&e.push((0,lR.loadWebGLDeveloperTools)()),t.debugSpectorJS&&e.push((0,lO.loadSpectorJS)(t)),await Promise.allSettled(e)))"rejected"===i.status&&eA.log.error(`Failed to initialize debug libraries ${i.reason}`)();let r=new i(t),n=`\
${r._reused?"Reusing":"Created"} device with WebGL2 ${r.props.debug?"debug ":""}context: \
${r.info.vendor}, ${r.info.renderer} for canvas: ${r.canvasContext.id}`;return eA.log.probe(1,n)(),eA.log.table(1,r.info)(),r}finally{eA.log.groupEnd(1)()}}},lF=0;class lN{static defaultAnimationLoopProps={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:e=>console.error(e),stats:lE.stats.get(`animation-loop-${lF++}`),autoResizeViewport:!1};device=null;canvas=null;props;animationProps=null;timeline=null;stats;cpuTime;gpuTime;frameRate;display;needsRedraw="initialized";_initialized=!1;_running=!1;_animationFrameId=null;_nextFramePromise=null;_resolveNextFrame=null;_cpuStartTime=0;_error=null;constructor(e){if(this.props={...lN.defaultAnimationLoopProps,...e},!(e=this.props).device)throw Error("No device provided");this.stats=e.stats||new sA.Stats({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}reportError(e){this.props.onError(e),this._error=e}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;if(this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),!this._running)return null;return!1!==e&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this}catch(t){let e=t instanceof Error?t:Error("Unknown error");throw this.props.onError(e),e}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){return this.device?.isLost||this._error||(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers()),this}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){if(this._running){var e;this._animationFrameId=(e=this._animationFrame.bind(this),"undefined"!=typeof window&&window.requestAnimationFrame?window.requestAnimationFrame(e):setTimeout(e,1e3/60))}}_cancelAnimationFrame(){if(null!==this._animationFrameId){var e;e=this._animationFrameId,"undefined"!=typeof window&&window.cancelAnimationFrame?window.cancelAnimationFrame(e):clearTimeout(e),this._animationFrameId=null}}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){this.display?this.display._renderFrame(e):(this.props.onRender(this._getAnimationProps()),this.device?.submit())}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeViewport()}_initializeAnimationProps(){let e=this.device?.getDefaultCanvasContext();if(!this.device||!e)throw Error("loop");let t=e?.canvas,i=e.props.useDevicePixels;this.animationProps={animationLoop:this,device:this.device,canvasContext:e,canvas:t,useDevicePixels:i,timeline:this.timeline,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;let{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){if(this.device=await this.props.device,!this.device)throw Error("No device provided");this.canvas=this.device.getDefaultCanvasContext().canvas||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){let e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";let t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);let i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){if(!this.device)return{width:1,height:1,aspect:1};let[e,t]=this.device?.getDefaultCanvasContext().getDevicePixelSize()||[1,1],i=1,r=this.device?.getDefaultCanvasContext().canvas;return r&&r.clientHeight?i=r.clientWidth/r.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}function lj(){}let lz={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:lj,onWebGLInitialized:lj,onResize:lj,onViewStateChange:lj,onInteractionStateChange:lj,onBeforeRender:lj,onAfterRender:lj,onLoad:lj,onError:e=>ia.error(e.message,e.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:({isDragging:e})=>e?"grabbing":"grab",getTooltip:null,debug:!1,drawPickingColors:!1};class lU{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new sA.Stats({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=e=>{let{_pickRequest:t}=this;if("pointerleave"===e.type)t.x=-1,t.y=-1,t.radius=0;else{if(e.leftButton||e.rightButton)return;let i=e.offsetCenter;if(!i)return;t.x=i.x,t.y=i.y,t.radius=this.props.pickingRadius}this.layerManager&&(this.layerManager.context.mousePosition={x:t.x,y:t.y}),t.event=e},this._onEvent=e=>{let t=i1[e.type],i=e.offsetCenter;if(!t||!i||!this.layerManager)return;let r=this.layerManager.getLayers(),n=this.deckPicker.getLastPickedObject({x:i.x,y:i.y,layers:r,viewports:this.getViewports(i)},this._lastPointerDownInfo),{layer:s}=n,o=s&&(s[t]||s.props[t]),a=this.props[t],l=!1;o&&(l=o.call(s,n,e)),l||(a?.(n,e),this.widgetManager.onEvent(n,e))},this._onPointerDown=e=>{if(this.device?.type==="webgpu")return;let t=e.offsetCenter,i=this._pick("pickObject","pickObject Time",{x:t.x,y:t.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=i.result[0]||i.emptyInfo},this.props={...lz,...e},(e=this.props).viewState&&e.initialViewState&&ia.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;if(!t&&e.gl){e.gl instanceof WebGLRenderingContext&&ia.error("WebGL1 context not supported.")();const i=this.props.deviceProps?.onResize;t=lD.attach(e.gl,{...this.props.deviceProps,onResize:(e,t)=>{let{width:r,height:n}=e.canvas;e.drawingBufferWidth=r,e.drawingBufferHeight=n,this._needsRedraw="Canvas resized",i?.(e,t)}})}t||(t=this._createDevice(e)),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&oJ.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){this.animationLoop?.stop(),this.animationLoop?.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,this.layerManager?.finalize(),this.layerManager=null,this.viewManager?.finalize(),this.viewManager=null,this.effectManager?.finalize(),this.effectManager=null,this.deckRenderer?.finalize(),this.deckRenderer=null,this.deckPicker?.finalize(),this.deckPicker=null,this.eventManager?.destroy(),this.eventManager=null,this.widgetManager?.finalize(),this.widgetManager=null,this.props.canvas||this.props.device||this.props.gl||!this.canvas||(this.canvas.parentElement?.removeChild(this.canvas),this.canvas=null)}setProps(e){this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&ia.removed("onLayerHover","onHover")(),"onLayerClick"in e&&ia.removed("onLayerClick","onClick")(),e.initialViewState&&!at(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);let t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),e.device&&e.device.id!==this.device?.id&&(this.animationLoop?.stop(),this.canvas!==e.device.canvasContext?.canvas&&(this.canvas?.remove(),this.eventManager?.destroy(),this.canvas=null),ia.log(`recreating animation loop for new device! id=${e.device.id}`)(),this.animationLoop=this._createAnimationLoop(e.device,e),this.animationLoop.start()),this.animationLoop?.setProps(t),void 0!==e.useDevicePixels&&this.device?.canvasContext&&this.device.canvasContext.setProps({useDevicePixels:e.useDevicePixels}),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);let i=this.viewManager.needsRedraw(e),r=this.layerManager.needsRedraw(e),n=this.effectManager.needsRedraw(e),s=this.deckRenderer.needsRedraw(e);return t||i||r||n||s}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});(t=e||t)&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return null!==this.viewManager}getViews(){return ad(this.viewManager),this.viewManager.views}getViewports(e){return ad(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){let t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(let i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(let t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){this.layerManager?.removeDefaultShaderModule(e)}_pick(e,t,i){ad(this.deckPicker);let{stats:r}=this;r.get("Pick Count").incrementCount(),r.get(t).timeStart();let n=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return r.get(t).timeEnd(),n}_createCanvas(e){let t=e.canvas;return"string"==typeof t&&ad(t=document.getElementById(t)),t||((t=document.createElement("canvas")).id=e.id||"deckgl-overlay",e.width&&"number"==typeof e.width&&(t.width=e.width),e.height&&"number"==typeof e.height&&(t.height=e.height),(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){if(!this.canvas)return;let{width:t,height:i}=e;if(t||0===t){let e=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=e}if(i||0===i){let t=Number.isFinite(i)?`${i}px`:i;this.canvas.style.position=e.style?.position||"absolute",this.canvas.style.height=t}}_updateCanvasSize(){let{canvas:e}=this;if(!e)return;let t=e.clientWidth??e.width,i=e.clientHeight??e.height;(t!==this.width||i!==this.height)&&(this.width=t,this.height=i,this.viewManager?.setProps({width:t,height:i}),this.layerManager?.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:i}))}_createAnimationLoop(e,t){let{gl:i,onError:r}=t;return new lN({device:e,autoResizeDrawingBuffer:!i,autoResizeViewport:!1,onInitialize:e=>this._setDevice(e.device),onRender:this._onRenderFrame.bind(this),onError:r})}_createDevice(e){let t=this.props.deviceProps?.createCanvasContext,i={adapters:[],_cacheShaders:!0,_cachePipelines:!0,...e.deviceProps};i.adapters.includes(lD)||i.adapters.push(lD);let r={alphaMode:this.props.deviceProps?.type==="webgpu"?"premultiplied":void 0},n=this.props.deviceProps?.onResize;return lE.createDevice({_reuseDevices:!0,type:"webgl",...i,createCanvasContext:{...r,..."object"==typeof t?t:void 0,canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!0},onResize:(e,t)=>{this._needsRedraw="Canvas resized",n?.(e,t)}})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){let{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new aA({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){let{onError:e}=this.props;this.animationLoop&&e&&e(Error("WebGL context is lost"))}_pickAndCallback(){if(this.device?.type==="webgpu")return;let{_pickRequest:e}=this;if(e.event){let{result:t,emptyInfo:i}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=t.length>0;let r=i,n=!1;for(let i of t)r=i,n=i.layer?.onHover(i,e.event)||n;n||(this.props.onHover?.(r,e.event),this.widgetManager.onHover(r,e.event)),e.event=null}}_updateCursor(){let e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=this.device.canvasContext?.canvas,!this.canvas.isConnected&&this.props.parent&&this.props.parent.insertBefore(this.canvas,this.props.parent.firstChild)),"webgl"===this.device.type&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),"webgl"===this.device.type&&this.props.onWebGLInitialized(this.device.gl);let t=new ei;for(let e in t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new iK(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(i2).map(e=>{let[t,i,r,n]=i2[e],s=this.props.eventRecognizerOptions?.[e];return{recognizer:new t({...i,...s,event:e}),recognizeWith:r,requestFailure:n}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}}),i1)this.eventManager.on(e,this._onEvent);this.viewManager=new ai({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});let i=this.viewManager.getViewports()[0];this.layerManager=new ae(this.device,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new aH({deck:this,device:this.device}),this.deckRenderer=new aJ(this.device),this.deckPicker=new a6(this.device),this.widgetManager=new a9({deck:this,parentElement:this.canvas?.parentElement}),this.widgetManager.addDefault(new li),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){let{device:i,gl:r}=this.layerManager.context;this.props.onBeforeRender({device:i,gl:r});let n={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};this.deckRenderer?.renderLayers(n),"screen"===n.pass&&this.widgetManager.onRedraw({viewports:n.viewports,layers:n.layers}),this.props.onAfterRender({device:i,gl:r})}_onRenderFrame(){this._getFrameStats(),this._metricsCounter++%60==0&&(this._getMetrics(),this.stats.reset(),ia.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),this.device?.type!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){let t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},!this.props.viewState&&this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){let{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();let t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){let{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();let i=lE.stats.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}}lU.defaultProps=lz,lU.VERSION=lw;let lB=C.useLayoutEffect;function l$(e,t){for(;e;){if(e===t)return!0;e=Object.getPrototypeOf(e)}return!1}var lV=e.i(6145),lW=e.i(95002),lG=e.i(44135);let lq=lG.getDataType;function lH(e,t,i){let r="webgpu"===i&&"uint8"===t.type?"unorm8":t.type;return{attribute:e,format:t.size>1?`${r}x${t.size}`:t.type,byteOffset:t.offset||0}}function lY(e){return e.stride||e.size*e.bytesPerElement}function lX(e,t){t.offset&&ia.removed("shaderAttribute.offset","vertexOffset, elementOffset")();let i=lY(e),r=(void 0!==t.vertexOffset?t.vertexOffset:e.vertexOffset||0)*i+(t.elementOffset||0)*e.bytesPerElement+(e.offset||0);return{...t,offset:r,stride:i}}class lZ{constructor(e,t,i){let r;this._buffer=null,this.device=e,this.id=t.id||"",this.size=t.size||1;const n=t.logicalType||t.type,s="float64"===n;let{defaultValue:o}=t;o=Number.isFinite(o)?[o]:o||Array(this.size).fill(0),r=s?"float32":!n&&t.isIndexed?"uint32":n||"float32";let a=function(e){switch(e){case"float64":return Float64Array;case"uint8":case"unorm8":return Uint8ClampedArray;default:return(0,lG.getTypedArrayConstructor)(e)}}(n||r);this.doublePrecision=s,s&&!1===t.fp64&&(a=Float32Array),this.value=null,this.settings={...t,defaultType:a,defaultValue:o,logicalType:n,type:r,normalized:r.includes("norm"),size:this.size,bytesPerElement:a.BYTES_PER_ELEMENT},this.state={...i,externalBuffer:null,bufferAccessor:this.settings,allocatedValue:null,numInstances:0,bounds:null,constant:!1}}get isConstant(){return this.state.constant}get buffer(){return this._buffer}get byteOffset(){let e=this.getAccessor();return e.vertexOffset?e.vertexOffset*lY(e):0}get numInstances(){return this.state.numInstances}set numInstances(e){this.state.numInstances=e}delete(){this._buffer&&(this._buffer.delete(),this._buffer=null),oJ.release(this.state.allocatedValue)}getBuffer(){return this.state.constant?null:this.state.externalBuffer||this._buffer}getValue(e=this.id,t=null){let i={};if(this.state.constant){let r=this.value;if(t){let n=lX(this.getAccessor(),t),s=n.offset/r.BYTES_PER_ELEMENT,o=n.size||this.size;i[e]=r.subarray(s,s+o)}else i[e]=r}else i[e]=this.getBuffer();return this.doublePrecision&&(this.value instanceof Float64Array?i[`${e}64Low`]=i[e]:i[`${e}64Low`]=new Float32Array(this.size)),i}_getBufferLayout(e=this.id,t=null){let i=this.getAccessor(),r=[],n={name:this.id,byteStride:lY(i),attributes:r};if(this.doublePrecision){let n,s={high:n=lX(i,t||{}),low:{...n,offset:n.offset+4*i.size}};r.push(lH(e,{...i,...s.high},this.device.type),lH(`${e}64Low`,{...i,...s.low},this.device.type))}else if(t){let n=lX(i,t);r.push(lH(e,{...i,...n},this.device.type))}else r.push(lH(e,i,this.device.type));return n}setAccessor(e){this.state.bufferAccessor=e}getAccessor(){return this.state.bufferAccessor}getBounds(){if(this.state.bounds)return this.state.bounds;let e=null;if(this.state.constant&&this.value){let t=Array.from(this.value);e=[t,t]}else{let{value:t,numInstances:i,size:r}=this,n=i*r;if(t&&n&&t.length>=n){let i=Array(r).fill(1/0),s=Array(r).fill(-1/0);for(let e=0;e<n;)for(let n=0;n<r;n++){let r=t[e++];r<i[n]&&(i[n]=r),r>s[n]&&(s[n]=r)}e=[i,s]}}return this.state.bounds=e,e}setData(e){let t,{state:i}=this;t=ArrayBuffer.isView(e)?{value:e}:e instanceof lV.Buffer?{buffer:e}:e;let r={...this.settings,...t};if(ArrayBuffer.isView(t.value)){if(!t.type)if(this.doublePrecision&&t.value instanceof Float64Array)r.type="float32";else{let e=lq(t.value);r.type=r.normalized?e.replace("int","norm"):e}r.bytesPerElement=t.value.BYTES_PER_ELEMENT,r.stride=lY(r)}if(i.bounds=null,t.constant){let e=t.value;if(e=this._normalizeValue(e,[],0),this.settings.normalized&&(e=this.normalizeConstant(e)),!(!i.constant||!this._areValuesEqual(e,this.value)))return!1;i.externalBuffer=null,i.constant=!0,this.value=ArrayBuffer.isView(e)?e:new Float32Array(e)}else if(t.buffer)i.externalBuffer=t.buffer,i.constant=!1,this.value=t.value||null;else if(t.value){this._checkExternalBuffer(t);let e=t.value;i.externalBuffer=null,i.constant=!1,this.value=e;let{buffer:n}=this,s=lY(r),o=(r.vertexOffset||0)*s;if(this.doublePrecision&&e instanceof Float64Array&&(e=o2(e,r)),this.settings.isIndexed){let t=this.settings.defaultType;e.constructor!==t&&(e=new t(e))}let a=e.byteLength+o+2*s;(!n||n.byteLength<a)&&(n=this._createBuffer(a)),n.write(e,o)}return this.setAccessor(r),!0}updateSubBuffer(e={}){this.state.bounds=null;let t=this.value,{startOffset:i=0,endOffset:r}=e;this.buffer.write(this.doublePrecision&&t instanceof Float64Array?o2(t,{size:this.size,startIndex:i,endIndex:r}):t.subarray(i,r),i*t.BYTES_PER_ELEMENT+this.byteOffset)}allocate(e,t=!1){let{state:i}=this,r=i.allocatedValue,n=oJ.allocate(r,e+1,{size:this.size,type:this.settings.defaultType,copy:t});this.value=n;let{byteOffset:s}=this,{buffer:o}=this;return(!o||o.byteLength<n.byteLength+s)&&(o=this._createBuffer(n.byteLength+s),t&&r&&o.write(r instanceof Float64Array?o2(r,this):r,s)),i.allocatedValue=n,i.constant=!1,i.externalBuffer=null,this.setAccessor(this.settings),!0}_checkExternalBuffer(e){let{value:t}=e;if(!ArrayBuffer.isView(t))throw Error(`Attribute ${this.id} value is not TypedArray`);let i=this.settings.defaultType,r=!1;if(this.doublePrecision&&(r=t.BYTES_PER_ELEMENT<4),r)throw Error(`Attribute ${this.id} does not support ${t.constructor.name}`);t instanceof i||!this.settings.normalized||"normalized"in e||ia.warn(`Attribute ${this.id} is normalized`)()}normalizeConstant(e){switch(this.settings.type){case"snorm8":return new Float32Array(e).map(e=>(e+128)/255*2-1);case"snorm16":return new Float32Array(e).map(e=>(e+32768)/65535*2-1);case"unorm8":return new Float32Array(e).map(e=>e/255);case"unorm16":return new Float32Array(e).map(e=>e/65535);default:return e}}_normalizeValue(e,t,i){let{defaultValue:r,size:n}=this.settings;if(Number.isFinite(e))return t[i]=e,t;if(!e){let e=n;for(;--e>=0;)t[i+e]=r[e];return t}switch(n){case 4:t[i+3]=Number.isFinite(e[3])?e[3]:r[3];case 3:t[i+2]=Number.isFinite(e[2])?e[2]:r[2];case 2:t[i+1]=Number.isFinite(e[1])?e[1]:r[1];case 1:t[i+0]=Number.isFinite(e[0])?e[0]:r[0];break;default:let s=n;for(;--s>=0;)t[i+s]=Number.isFinite(e[s])?e[s]:r[s]}return t}_areValuesEqual(e,t){if(!e||!t)return!1;let{size:i}=this;for(let r=0;r<i;r++)if(e[r]!==t[r])return!1;return!0}_createBuffer(e){this._buffer&&this._buffer.destroy();let{isIndexed:t,type:i}=this.settings;return this._buffer=this.device.createBuffer({...this._buffer?.props,id:this.id,usage:(t?lV.Buffer.INDEX:lV.Buffer.VERTEX)|lV.Buffer.COPY_DST,indexType:t?i:void 0,byteLength:e}),this._buffer}}let lK=[],lJ=[];function lQ(e,t=0,i=1/0){let r=lK,n={index:-1,data:e,target:[]};return e?"function"==typeof e[Symbol.iterator]?r=e:e.length>0&&(lJ.length=e.length,r=lJ):r=lK,(t>0||Number.isFinite(i))&&(r=(Array.isArray(r)?r:Array.from(r)).slice(t,i),n.index=t-1),{iterable:r,objectInfo:n}}function l0(e){return e&&e[Symbol.asyncIterator]}let l1=[],l2=[[0,1/0]],l3={interpolation:{duration:0,easing:e=>e},spring:{stiffness:.05,damping:.5}};function l4(e,t){if(!e)return null;Number.isFinite(e)&&(e={type:"interpolation",duration:e});let i=e.type||"interpolation";return{...l3[i],...t,...e,type:i}}class l6 extends lZ{constructor(e,t){super(e,t,{startIndices:null,lastExternalBuffer:null,binaryValue:null,binaryAccessor:null,needsUpdate:!0,needsRedraw:!1,layoutChanged:!1,updateRanges:l2}),this.constant=!1,this.settings.update=t.update||(t.accessor?this._autoUpdater:void 0),Object.seal(this.settings),Object.seal(this.state),this._validateAttributeUpdaters()}get startIndices(){return this.state.startIndices}set startIndices(e){this.state.startIndices=e}needsUpdate(){return this.state.needsUpdate}needsRedraw({clearChangedFlags:e=!1}={}){let t=this.state.needsRedraw;return this.state.needsRedraw=t&&!e,t}layoutChanged(){return this.state.layoutChanged}setAccessor(e){var t,i;(t=this.state).layoutChanged||(i=this.getAccessor(),t.layoutChanged=e.type!==i.type||e.size!==i.size||lY(e)!==lY(i)||(e.offset||0)!==(i.offset||0)),super.setAccessor(e)}getUpdateTriggers(){let{accessor:e}=this.settings;return[this.id].concat("function"!=typeof e&&e||[])}supportsTransition(){return!!this.settings.transition}getTransitionSetting(e){if(!e||!this.supportsTransition())return null;let{accessor:t}=this.settings,i=this.settings.transition;return l4(Array.isArray(t)?e[t.find(t=>e[t])]:e[t],i)}setNeedsUpdate(e=this.id,t){if(this.state.needsUpdate=this.state.needsUpdate||e,this.setNeedsRedraw(e),t){let{startRow:e=0,endRow:i=1/0}=t;this.state.updateRanges=function(e,t){if(e===l2||(t[0]<0&&(t[0]=0),t[0]>=t[1]))return e;let i=[],r=e.length,n=0;for(let s=0;s<r;s++){let r=e[s];r[1]<t[0]?(i.push(r),n=s+1):r[0]>t[1]?i.push(r):t=[Math.min(r[0],t[0]),Math.max(r[1],t[1])]}return i.splice(n,0,t),i}(this.state.updateRanges,[e,i])}else this.state.updateRanges=l2}clearNeedsUpdate(){this.state.needsUpdate=!1,this.state.updateRanges=l1}setNeedsRedraw(e=this.id){this.state.needsRedraw=this.state.needsRedraw||e}allocate(e){let{state:t,settings:i}=this;return!i.noAlloc&&!!i.update&&(super.allocate(e,t.updateRanges!==l2),!0)}updateBuffer({numInstances:e,data:t,props:i,context:r}){if(!this.needsUpdate())return!1;let{state:{updateRanges:n},settings:{update:s,noAlloc:o}}=this,a=!0;if(s){for(let[o,a]of n)s.call(r,this,{data:t,startRow:o,endRow:a,props:i,numInstances:e});if(this.value)if(this.constant||!this.buffer||this.buffer.byteLength<this.value.byteLength+this.byteOffset)this.setData({value:this.value,constant:this.constant}),this.constant=!1;else for(let[t,i]of n){let r=Number.isFinite(t)?this.getVertexOffset(t):0,n=Number.isFinite(i)?this.getVertexOffset(i):o||!Number.isFinite(e)?this.value.length:e*this.size;super.updateSubBuffer({startOffset:r,endOffset:n})}this._checkAttributeArray()}else a=!1;return this.clearNeedsUpdate(),this.setNeedsRedraw(),a}setConstantValue(e,t){let i="webgpu"===this.device.type;if(i||void 0===t||"function"==typeof t){if(i&&"function"!=typeof t){let e=this._normalizeValue(t,[],0);this._areValuesEqual(e,this.value)||this.setNeedsUpdate("WebGPU constant updated")}return!1}let r=this.settings.transform&&e?this.settings.transform.call(e,t):t;return this.setData({constant:!0,value:r})&&this.setNeedsRedraw(),this.clearNeedsUpdate(),!0}setExternalBuffer(e){let{state:t}=this;return e?(this.clearNeedsUpdate(),t.lastExternalBuffer===e||(t.lastExternalBuffer=e,this.setNeedsRedraw(),this.setData(e),!0)):(t.lastExternalBuffer=null,!1)}setBinaryValue(e,t=null){let{state:i,settings:r}=this;if(!e)return i.binaryValue=null,i.binaryAccessor=null,!1;if(r.noAlloc)return!1;if(i.binaryValue===e)return this.clearNeedsUpdate(),!0;if(i.binaryValue=e,this.setNeedsRedraw(),r.transform||t!==this.startIndices){ArrayBuffer.isView(e)&&(e={value:e});let n=e;ad(ArrayBuffer.isView(n.value),`invalid ${r.accessor}`);let s=!!n.size&&n.size!==this.size;return i.binaryAccessor=function(e,t){let{size:i,stride:r,offset:n,startIndices:s,nested:o}=t,a=e.BYTES_PER_ELEMENT,l=r?r/a:i,u=n?n/a:0,c=Math.floor((e.length-u)/l);return(t,{index:r,target:n})=>{let a;if(!s){let t=r*l+u;for(let r=0;r<i;r++)n[r]=e[t+r];return n}let h=s[r],d=s[r+1]||c;if(o){a=Array(d-h);for(let t=h;t<d;t++){let r=t*l+u;n=Array(i);for(let t=0;t<i;t++)n[t]=e[r+t];a[t-h]=n}}else if(l===i)a=e.subarray(h*i+u,d*i+u);else{a=new e.constructor((d-h)*i);let t=0;for(let r=h;r<d;r++){let n=r*l+u;for(let r=0;r<i;r++)a[t++]=e[n+r]}}return a}}(n.value,{size:n.size||this.size,stride:n.stride,offset:n.offset,startIndices:t,nested:s}),!1}return this.clearNeedsUpdate(),this.setData(e),!0}getVertexOffset(e){let{startIndices:t}=this;return(t?e<t.length?t[e]:this.numInstances:e)*this.size}getValue(){let e=this.settings.shaderAttributes,t=super.getValue();if(!e)return t;for(let i in e)Object.assign(t,super.getValue(i,e[i]));return t}getBufferLayout(e){this.state.layoutChanged=!1;let t=this.settings.shaderAttributes,i=super._getBufferLayout(),{stepMode:r}=this.settings;if("dynamic"===r?i.stepMode=e?e.isInstanced?"instance":"vertex":"instance":i.stepMode=r??"vertex",!t)return i;for(let e in t){let r=super._getBufferLayout(e,t[e]);i.attributes.push(...r.attributes)}return i}_autoUpdater(e,{data:t,startRow:i,endRow:r,props:n,numInstances:s}){if(e.constant&&"webgpu"!==this.context.device.type)return;let{settings:o,state:a,value:l,size:u,startIndices:c}=e,{accessor:h,transform:d}=o,f=a.binaryAccessor||("function"==typeof h?h:n[h]);"function"!=typeof f&&"string"==typeof h&&(f=()=>n[h]),ad("function"==typeof f,`accessor "${h}" is not a function`);let p=e.getVertexOffset(i),{iterable:g,objectInfo:m}=lQ(t,i,r);for(let t of g){m.index++;let i=f(t,m);if(d&&(i=d.call(this,i)),c){let t=(m.index<c.length-1?c[m.index+1]:s)-c[m.index];if(i&&Array.isArray(i[0])){let t=p;for(let r of i)e._normalizeValue(r,l,t),t+=u}else i&&i.length>u?l.set(i,p):(e._normalizeValue(i,m.target,0),function({target:e,source:t,start:i=0,count:r=1}){let n=t.length,s=r*n,o=0;for(let r=i;o<n;o++)e[r++]=t[o];for(;o<s;)o<s-o?(e.copyWithin(i+o,i,i+o),o*=2):(e.copyWithin(i+o,i,i+s-o),o=s)}({target:l,source:m.target,start:p,count:t}));p+=t*u}else e._normalizeValue(i,l,p),p+=u}}_validateAttributeUpdaters(){let{settings:e}=this;if(!(e.noAlloc||"function"==typeof e.update))throw Error(`Attribute ${this.id} missing update or accessor`)}_checkAttributeArray(){let{value:e}=this,t=Math.min(4,this.size);if(e&&e.length>=t){let i=!0;switch(t){case 4:i=i&&Number.isFinite(e[3]);case 3:i=i&&Number.isFinite(e[2]);case 2:i=i&&Number.isFinite(e[1]);case 1:i=i&&Number.isFinite(e[0]);break;default:i=!1}if(!i)throw Error(`Illegal attribute generated for ${this.id}`)}}}let l5=`\
out vec4 transform_output;
void main() {
  transform_output = vec4(0);
}`,l8=`#version 300 es
${l5}`;var l9=e.i(25458),l7=e.i(96204),ue=e.i(88396),ut=e.i(49494);function ui(e){return Array.isArray(e)?0===e.length||"number"==typeof e[0]:ArrayBuffer.isView(e)&&!(e instanceof DataView)}class ur{name;uniforms={};modifiedUniforms={};modified=!0;bindingLayout={};needsRedraw="initialized";constructor(e){if(this.name=e?.name||"unnamed",e?.name&&e?.shaderLayout){const t=e?.shaderLayout.bindings?.find(t=>"uniform"===t.type&&t.name===e?.name);if(!t)throw Error(e?.name);for(const e of t.uniforms||[])this.bindingLayout[e.name]=e}}setUniforms(e){for(let[t,i]of Object.entries(e))this._setUniform(t,i),this.needsRedraw||this.setNeedsRedraw(`${this.name}.${t}=${i}`)}setNeedsRedraw(e){this.needsRedraw=this.needsRedraw||e}getAllUniforms(){return this.modifiedUniforms={},this.needsRedraw=!1,this.uniforms||{}}_setUniform(e,t){!function(e,t,i=16){if(e!==t||!ui(e))return!1;if(ui(t)&&e.length===t.length){for(let i=0;i<e.length;++i)if(t[i]!==e[i])return!1}return!0}(this.uniforms[e],t)&&(this.uniforms[e]=ui(t)?t.slice():t,this.modifiedUniforms[e]=!0,this.modified=!0)}}var un=e.i(72288),us=e.i(4121);class uo{layout={};byteLength;constructor(e,t={}){let i=0;for(const[r,n]of Object.entries(e)){const{type:e,components:s}=(0,un.getVariableShaderTypeInfo)(n),o=s*(t?.[r]??1),a=i=(0,lG.alignTo)(i,o);i+=o,this.layout[r]={type:e,size:o,offset:a}}const r=4*(i+=(4-i%4)%4);this.byteLength=Math.max(r,1024)}getData(e){let t=(0,us.getScratchArrayBuffer)(this.byteLength),i={i32:new Int32Array(t),u32:new Uint32Array(t),f32:new Float32Array(t),f16:new Uint16Array(t)};for(let[t,r]of Object.entries(e)){let e=this.layout[t];if(!e){eA.log.warn(`Supplied uniform value ${t} not present in uniform block layout`)();continue}let{type:n,size:s,offset:o}=e,a=i[n];if(1===s){if("number"!=typeof r&&"boolean"!=typeof r){eA.log.warn(`Supplied value for single component uniform ${t} is not a number: ${r}`)();continue}a[o]=Number(r)}else{if(!ui(r)){eA.log.warn(`Supplied value for multi component / array uniform ${t} is not a numeric array: ${r}`)();continue}a.set(r,o)}}return new Uint8Array(t,0,this.byteLength)}has(e){return!!this.layout[e]}get(e){return this.layout[e]}}class ua{uniformBlocks=new Map;uniformBufferLayouts=new Map;uniformBuffers=new Map;constructor(e){for(const[t,i]of Object.entries(e)){const e=new uo(i.uniformTypes??{},i.uniformSizes??{});this.uniformBufferLayouts.set(t,e);const r=new ur({name:t});r.setUniforms(i.defaultUniforms||{}),this.uniformBlocks.set(t,r)}}destroy(){for(let e of this.uniformBuffers.values())e.destroy()}setUniforms(e){for(let[t,i]of Object.entries(e))this.uniformBlocks.get(t)?.setUniforms(i);this.updateUniformBuffers()}getUniformBufferByteLength(e){return this.uniformBufferLayouts.get(e)?.byteLength||0}getUniformBufferData(e){let t=this.uniformBlocks.get(e)?.getAllUniforms()||{};return this.uniformBufferLayouts.get(e)?.getData(t)}createUniformBuffer(e,t,i){i&&this.setUniforms(i);let r=this.getUniformBufferByteLength(t),n=e.createBuffer({usage:lV.Buffer.UNIFORM|lV.Buffer.COPY_DST,byteLength:r}),s=this.getUniformBufferData(t);return n.write(s),n}getManagedUniformBuffer(e,t){if(!this.uniformBuffers.get(t)){let i=this.getUniformBufferByteLength(t),r=e.createBuffer({usage:lV.Buffer.UNIFORM|lV.Buffer.COPY_DST,byteLength:i});this.uniformBuffers.set(t,r)}return this.uniformBuffers.get(t)}updateUniformBuffers(){let e=!1;for(let t of this.uniformBlocks.keys()){let i=this.updateUniformBuffer(t);e||=i}return e&&eA.log.log(3,`UniformStore.updateUniformBuffers(): ${e}`)(),e}updateUniformBuffer(e){let t=this.uniformBlocks.get(e),i=this.uniformBuffers.get(e),r=!1;if(i&&t?.needsRedraw){r||=t.needsRedraw;let n=this.getUniformBufferData(e);i=this.uniformBuffers.get(e),i?.write(n);let s=this.uniformBlocks.get(e)?.getAllUniforms();eA.log.log(4,`Writing to uniform buffer ${String(e)}`,n,s)()}return r}}var ul=e.i(65880);class uu{constructor(e,t){this.name=e,this.attributes=t,this.size=0}get isArray(){return!1}get isStruct(){return!1}get isTemplate(){return!1}get isPointer(){return!1}getTypeName(){return this.name}}class uc{constructor(e,t,i){this.name=e,this.type=t,this.attributes=i,this.offset=0,this.size=0}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class uh extends uu{constructor(e,t){super(e,t),this.members=[],this.align=0,this.startLine=-1,this.endLine=-1,this.inUse=!1}get isStruct(){return!0}}class ud extends uu{constructor(e,t){super(e,t),this.count=0,this.stride=0}get isArray(){return!0}getTypeName(){return`array<${this.format.getTypeName()}, ${this.count}>`}}class uf extends uu{constructor(e,t,i){super(e,i),this.format=t}get isPointer(){return!0}getTypeName(){return`&${this.format.getTypeName()}`}}class up extends uu{constructor(e,t,i,r){super(e,i),this.format=t,this.access=r}get isTemplate(){return!0}getTypeName(){let e=this.name;if(null!==this.format){if("vec2"===e||"vec3"===e||"vec4"===e||"mat2x2"===e||"mat2x3"===e||"mat2x4"===e||"mat3x2"===e||"mat3x3"===e||"mat3x4"===e||"mat4x2"===e||"mat4x3"===e||"mat4x4"===e){if("f32"===this.format.name)return e+"f";if("i32"===this.format.name)return e+"i";if("u32"===this.format.name)return e+"u";if("bool"===this.format.name)return e+"b";if("f16"===this.format.name)return e+"h"}e+=`<${this.format.name}>`}return e}}(p=T||(T={}))[p.Uniform=0]="Uniform",p[p.Storage=1]="Storage",p[p.Texture=2]="Texture",p[p.Sampler=3]="Sampler",p[p.StorageTexture=4]="StorageTexture";class ug{constructor(e,t,i,r,n,s,o){this.name=e,this.type=t,this.group=i,this.binding=r,this.attributes=n,this.resourceType=s,this.access=o}get isArray(){return this.type.isArray}get isStruct(){return this.type.isStruct}get isTemplate(){return this.type.isTemplate}get size(){return this.type.size}get align(){return this.type.isStruct?this.type.align:0}get members(){return this.type.isStruct?this.type.members:null}get format(){return this.type.isArray||this.type.isTemplate?this.type.format:null}get count(){return this.type.isArray?this.type.count:0}get stride(){return this.type.isArray?this.type.stride:this.size}}class um{constructor(e,t){this.name=e,this.type=t}}class uy{constructor(e,t,i,r){this.name=e,this.type=t,this.locationType=i,this.location=r,this.interpolation=null}}class u_{constructor(e,t,i,r){this.name=e,this.type=t,this.locationType=i,this.location=r}}class uv{constructor(e,t,i,r){this.name=e,this.type=t,this.attributes=i,this.id=r}}class ub{constructor(e,t,i){this.name=e,this.type=t,this.attributes=i}}class ux{constructor(e,t=null,i){this.stage=null,this.inputs=[],this.outputs=[],this.arguments=[],this.returnType=null,this.resources=[],this.overrides=[],this.startLine=-1,this.endLine=-1,this.inUse=!1,this.calls=new Set,this.name=e,this.stage=t,this.attributes=i}}class uw{constructor(){this.vertex=[],this.fragment=[],this.compute=[]}}let uk=new Float32Array(1),uT=new Int32Array(uk.buffer),uS=new Uint16Array(1),uP=new Uint32Array(1),uE=new Float32Array(uP.buffer,0,1);function uC(e){return uP[0]=112+(e>>6&31)<<23|(63&e)<<17,uE[0]}function uI(e,t,i,r){let n=[0,0,0,0];for(let s=0;s<r;++s)switch(i){case"8unorm":n[s]=e[t]/255,t++;break;case"8snorm":n[s]=e[t]/255*2-1,t++;break;case"8uint":n[s]=e[t],t++;break;case"8sint":n[s]=e[t]-127,t++;break;case"16uint":n[s]=e[t]|e[t+1]<<8,t+=2;break;case"16sint":n[s]=(e[t]|e[t+1]<<8)-32768,t+=2;break;case"16float":n[s]=function(e){var t=(32768&e)>>15,i=(31744&e)>>10,r=1023&e;return 0==i?(t?-1:1)*6103515625e-14*(r/1024):31==i?r?NaN:1/0*(t?-1:1):(t?-1:1)*Math.pow(2,i-15)*(1+r/1024)}(e[t]|e[t+1]<<8),t+=2;break;case"32uint":case"32sint":n[s]=e[t]|e[t+1]<<8|e[t+2]<<16|e[t+3]<<24,t+=4;break;case"32float":n[s]=new Float32Array(e.buffer,t,1)[0],t+=4}return n}function uA(e,t,i,r,n){for(let s=0;s<r;++s)switch(i){case"8unorm":e[t]=255*n[s],t++;break;case"8snorm":e[t]=.5*(n[s]+1)*255,t++;break;case"8uint":e[t]=n[s],t++;break;case"8sint":e[t]=n[s]+127,t++;break;case"16uint":new Uint16Array(e.buffer,t,1)[0]=n[s],t+=2;break;case"16sint":new Int16Array(e.buffer,t,1)[0]=n[s],t+=2;break;case"16float":{let i=function(e){uk[0]=e;let t=uT[0],i=t>>31&1,r=t>>23&255,n=8388607&t;if(255===r)return uS[0]=i<<15|31744|512*(0!==n),uS[0];if(0===r){if(0===n)return uS[0]=i<<15,uS[0];n|=8388608;let e=113;for(;!(8388608&n);)n<<=1,e--;return n&=8388607,(r=127-e)>0?(n=(n>>126-r)+(n>>127-r&1),uS[0]=i<<15|r<<10|n>>13):uS[0]=i<<15,uS[0]}return(r=r-127+15)>=31?uS[0]=i<<15|31744:r<=0?r<-10?uS[0]=i<<15:(n=(8388608|n)>>1-r,uS[0]=i<<15|n>>13):(n>>=13,uS[0]=i<<15|r<<10|n),uS[0]}(n[s]);new Uint16Array(e.buffer,t,1)[0]=i,t+=2;break}case"32uint":new Uint32Array(e.buffer,t,1)[0]=n[s],t+=4;break;case"32sint":new Int32Array(e.buffer,t,1)[0]=n[s],t+=4;break;case"32float":new Float32Array(e.buffer,t,1)[0]=n[s],t+=4}return n}let uM={r8unorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8snorm:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8uint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r8sint:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg8unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8snorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg8sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"rgba8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8snorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba8sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},bgra8unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bgra8unorm-srgb":{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r16uint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16sint:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r16float:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg16uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg16float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba16uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba16float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},r32uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32sint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},r32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:1},rg32uint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32sint:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rg32float:{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,channels:2},rgba32uint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32sint:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgba32float:{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2uint:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rgb10a2unorm:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},rg11b10ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},stencil8:{bytesPerBlock:1,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!1,hasStencil:!0,channels:1},depth16unorm:{bytesPerBlock:2,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},depth24plus:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,depthOnlyFormat:"depth32float",channels:1},"depth24plus-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,depthOnlyFormat:"depth32float",channels:1},depth32float:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!1,channels:1},"depth32float-stencil8":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!1,isDepthStencil:!0,hasDepth:!0,hasStencil:!0,stencilOnlyFormat:"depth32float",channels:1},rgb9e5ufloat:{bytesPerBlock:4,blockWidth:1,blockHeight:1,isCompressed:!1,channels:4},"bc1-rgba-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc1-rgba-unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc2-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc3-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc4-r-unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc4-r-snorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:1},"bc5-rg-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc5-rg-snorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:2},"bc6h-rgb-ufloat":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc6h-rgb-float":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"bc7-rgba-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgb8a1unorm-srgb":{bytesPerBlock:8,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"etc2-rgba8unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"eac-r11unorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-r11snorm":{bytesPerBlock:8,blockWidth:1,blockHeight:1,isCompressed:!0,channels:1},"eac-rg11unorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"eac-rg11snorm":{bytesPerBlock:16,blockWidth:1,blockHeight:1,isCompressed:!0,channels:2},"astc-4x4-unorm":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-4x4-unorm-srgb":{bytesPerBlock:16,blockWidth:4,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x4-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:4,isCompressed:!0,channels:4},"astc-5x5-unorm":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-5x5-unorm-srgb":{bytesPerBlock:16,blockWidth:5,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x5-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:5,isCompressed:!0,channels:4},"astc-6x6-unorm":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-6x6-unorm-srgb":{bytesPerBlock:16,blockWidth:6,blockHeight:6,isCompressed:!0,channels:4},"astc-8x5-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x5-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:5,isCompressed:!0,channels:4},"astc-8x6-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x6-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:6,isCompressed:!0,channels:4},"astc-8x8-unorm":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-8x8-unorm-srgb":{bytesPerBlock:16,blockWidth:8,blockHeight:8,isCompressed:!0,channels:4},"astc-10x5-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x5-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:5,isCompressed:!0,channels:4},"astc-10x6-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x6-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:6,isCompressed:!0,channels:4},"astc-10x8-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x8-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:8,isCompressed:!0,channels:4},"astc-10x10-unorm":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-10x10-unorm-srgb":{bytesPerBlock:16,blockWidth:10,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x10-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:10,isCompressed:!0,channels:4},"astc-12x12-unorm":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4},"astc-12x12-unorm-srgb":{bytesPerBlock:16,blockWidth:12,blockHeight:12,isCompressed:!0,channels:4}};class uL{constructor(){this.id=uL._id++,this.line=0}get isAstNode(){return!0}get astNodeType(){return""}search(e){e(this)}searchBlock(e,t){if(e){for(let i of(t(uO.instance),e))i instanceof Array?this.searchBlock(i,t):i.search(t);t(uR.instance)}}constEvaluate(e,t){throw Error("Cannot evaluate node")}constEvaluateString(e){return this.constEvaluate(e).toString()}}uL._id=0;class uO extends uL{}uO.instance=new uO;class uR extends uL{}uR.instance=new uR;let uD=new Set(["all","all","any","select","arrayLength","abs","acos","acosh","asin","asinh","atan","atanh","atan2","ceil","clamp","cos","cosh","countLeadingZeros","countOneBits","countTrailingZeros","cross","degrees","determinant","distance","dot","dot4U8Packed","dot4I8Packed","exp","exp2","extractBits","faceForward","firstLeadingBit","firstTrailingBit","floor","fma","fract","frexp","insertBits","inverseSqrt","ldexp","length","log","log2","max","min","mix","modf","normalize","pow","quantizeToF16","radians","reflect","refract","reverseBits","round","saturate","sign","sin","sinh","smoothStep","sqrt","step","tan","tanh","transpose","trunc","dpdx","dpdxCoarse","dpdxFine","dpdy","dpdyCoarse","dpdyFine","fwidth","fwidthCoarse","fwidthFine","textureDimensions","textureGather","textureGatherCompare","textureLoad","textureNumLayers","textureNumLevels","textureNumSamples","textureSample","textureSampleBias","textureSampleCompare","textureSampleCompareLevel","textureSampleGrad","textureSampleLevel","textureSampleBaseClampToEdge","textureStore","atomicLoad","atomicStore","atomicAdd","atomicSub","atomicMax","atomicMin","atomicAnd","atomicOr","atomicXor","atomicExchange","atomicCompareExchangeWeak","pack4x8snorm","pack4x8unorm","pack4xI8","pack4xU8","pack4x8Clamp","pack4xU8Clamp","pack2x16snorm","pack2x16unorm","pack2x16float","unpack4x8snorm","unpack4x8unorm","unpack4xI8","unpack4xU8","unpack2x16snorm","unpack2x16unorm","unpack2x16float","storageBarrier","textureBarrier","workgroupBarrier","workgroupUniformLoad","subgroupAdd","subgroupExclusiveAdd","subgroupInclusiveAdd","subgroupAll","subgroupAnd","subgroupAny","subgroupBallot","subgroupBroadcast","subgroupBroadcastFirst","subgroupElect","subgroupMax","subgroupMin","subgroupMul","subgroupExclusiveMul","subgroupInclusiveMul","subgroupOr","subgroupShuffle","subgroupShuffleDown","subgroupShuffleUp","subgroupShuffleXor","subgroupXor","quadBroadcast","quadSwapDiagonal","quadSwapX","quadSwapY"]);class uF extends uL{constructor(){super()}}class uN extends uF{constructor(e,t,i,r,n,s){super(),this.calls=new Set,this.name=e,this.args=t,this.returnType=i,this.body=r,this.startLine=n,this.endLine=s}get astNodeType(){return"function"}search(e){if(this.attributes)for(let t of this.attributes)e(t);for(let t of(e(this),this.args))e(t);this.searchBlock(this.body,e)}}class uj extends uF{constructor(e){super(),this.expression=e}get astNodeType(){return"staticAssert"}search(e){this.expression.search(e)}}class uz extends uF{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"while"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class uU extends uF{constructor(e,t){super(),this.body=e,this.loopId=t}get astNodeType(){return"continuing"}search(e){this.searchBlock(this.body,e)}}class uB extends uF{constructor(e,t,i,r){super(),this.init=e,this.condition=t,this.increment=i,this.body=r}get astNodeType(){return"for"}search(e){var t,i,r;null==(t=this.init)||t.search(e),null==(i=this.condition)||i.search(e),null==(r=this.increment)||r.search(e),this.searchBlock(this.body,e)}}class u$ extends uF{constructor(e,t,i,r,n){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=n}get astNodeType(){return"var"}search(e){var t;e(this),null==(t=this.value)||t.search(e)}}class uV extends uF{constructor(e,t,i){super(),this.attributes=null,this.name=e,this.type=t,this.value=i}get astNodeType(){return"override"}search(e){var t;null==(t=this.value)||t.search(e)}}class uW extends uF{constructor(e,t,i,r,n){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=n}get astNodeType(){return"let"}search(e){var t;e(this),null==(t=this.value)||t.search(e)}}class uG extends uF{constructor(e,t,i,r,n){super(),this.attributes=null,this.name=e,this.type=t,this.storage=i,this.access=r,this.value=n}get astNodeType(){return"const"}constEvaluate(e,t){return this.value.constEvaluate(e,t)}search(e){var t;e(this),null==(t=this.value)||t.search(e)}}(g=S||(S={})).increment="++",g.decrement="--",(m=S||(S={})).parse=function(e){if("parse"==e)throw Error("Invalid value for IncrementOperator");return m[e]};class uq extends uF{constructor(e,t){super(),this.operator=e,this.variable=t}get astNodeType(){return"increment"}search(e){this.variable.search(e)}}(y=P||(P={})).assign="=",y.addAssign="+=",y.subtractAssin="-=",y.multiplyAssign="*=",y.divideAssign="/=",y.moduloAssign="%=",y.andAssign="&=",y.orAssign="|=",y.xorAssign="^=",y.shiftLeftAssign="<<=",y.shiftRightAssign=">>=",(P||(P={})).parse=function(e){if("parse"==e)throw Error("Invalid value for AssignOperator");return e};class uH extends uF{constructor(e,t,i){super(),this.operator=e,this.variable=t,this.value=i}get astNodeType(){return"assign"}search(e){this.variable.search(e),this.value.search(e)}}class uY extends uF{constructor(e,t){super(),this.name=e,this.args=t}get astNodeType(){return"call"}isBuiltin(){return uD.has(this.name)}search(e){for(let t of this.args)t.search(e);e(this)}}class uX extends uF{constructor(e,t){super(),this.body=e,this.continuing=t}get astNodeType(){return"loop"}search(e){var t;this.searchBlock(this.body,e),null==(t=this.continuing)||t.search(e)}}class uZ extends uF{constructor(e,t){super(),this.condition=e,this.cases=t}get astNodeType(){return"switch"}search(e){for(let t of(e(this),this.cases))t.search(e)}}class uK extends uF{constructor(e,t,i,r){super(),this.condition=e,this.body=t,this.elseif=i,this.else=r}get astNodeType(){return"if"}search(e){this.condition.search(e),this.searchBlock(this.body,e),this.searchBlock(this.elseif,e),this.searchBlock(this.else,e)}}class uJ extends uF{constructor(e){super(),this.value=e}get astNodeType(){return"return"}search(e){var t;null==(t=this.value)||t.search(e)}}class uQ extends uF{constructor(e){super(),this.name=e}get astNodeType(){return"enable"}}class u0 extends uF{constructor(e){super(),this.extensions=e}get astNodeType(){return"requires"}}class u1 extends uF{constructor(e,t){super(),this.severity=e,this.rule=t}get astNodeType(){return"diagnostic"}}class u2 extends uF{constructor(e,t){super(),this.name=e,this.type=t}get astNodeType(){return"alias"}}class u3 extends uF{constructor(){super()}get astNodeType(){return"discard"}}class u4 extends uF{constructor(){super(),this.condition=null,this.loopId=-1}get astNodeType(){return"break"}}class u6 extends uF{constructor(){super(),this.loopId=-1}get astNodeType(){return"continue"}}class u5 extends uF{constructor(e){super(),this.attributes=null,this.name=e}get astNodeType(){return"type"}get isStruct(){return!1}get isArray(){return!1}static maxFormatType(e){let t=e[0];if("f32"===t.name)return t;for(let i=1;i<e.length;++i){let r=u5._priority.get(t.name);u5._priority.get(e[i].name)<r&&(t=e[i])}return"x32"===t.name?u5.i32:t}getTypeName(){return this.name}}u5.x32=new u5("x32"),u5.f32=new u5("f32"),u5.i32=new u5("i32"),u5.u32=new u5("u32"),u5.f16=new u5("f16"),u5.bool=new u5("bool"),u5.void=new u5("void"),u5._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class u8 extends u5{constructor(e){super(e)}}class u9 extends u5{constructor(e,t,i,r){super(e),this.members=t,this.startLine=i,this.endLine=r}get astNodeType(){return"struct"}get isStruct(){return!0}getMemberIndex(e){for(let t=0;t<this.members.length;t++)if(this.members[t].name==e)return t;return -1}search(e){for(let t of this.members)e(t)}}class u7 extends u5{constructor(e,t,i){super(e),this.format=t,this.access=i}get astNodeType(){return"template"}getTypeName(){let e=this.name;if(null!==this.format){if("vec2"===e||"vec3"===e||"vec4"===e||"mat2x2"===e||"mat2x3"===e||"mat2x4"===e||"mat3x2"===e||"mat3x3"===e||"mat3x4"===e||"mat4x2"===e||"mat4x3"===e||"mat4x4"===e){if("f32"===this.format.name)return e+"f";if("i32"===this.format.name)return e+"i";if("u32"===this.format.name)return e+"u";if("bool"===this.format.name)return e+"b";if("f16"===this.format.name)return e+"h"}e+=`<${this.format.name}>`}return e}}u7.vec2f=new u7("vec2",u5.f32,null),u7.vec3f=new u7("vec3",u5.f32,null),u7.vec4f=new u7("vec4",u5.f32,null),u7.vec2i=new u7("vec2",u5.i32,null),u7.vec3i=new u7("vec3",u5.i32,null),u7.vec4i=new u7("vec4",u5.i32,null),u7.vec2u=new u7("vec2",u5.u32,null),u7.vec3u=new u7("vec3",u5.u32,null),u7.vec4u=new u7("vec4",u5.u32,null),u7.vec2h=new u7("vec2",u5.f16,null),u7.vec3h=new u7("vec3",u5.f16,null),u7.vec4h=new u7("vec4",u5.f16,null),u7.vec2b=new u7("vec2",u5.bool,null),u7.vec3b=new u7("vec3",u5.bool,null),u7.vec4b=new u7("vec4",u5.bool,null),u7.mat2x2f=new u7("mat2x2",u5.f32,null),u7.mat2x3f=new u7("mat2x3",u5.f32,null),u7.mat2x4f=new u7("mat2x4",u5.f32,null),u7.mat3x2f=new u7("mat3x2",u5.f32,null),u7.mat3x3f=new u7("mat3x3",u5.f32,null),u7.mat3x4f=new u7("mat3x4",u5.f32,null),u7.mat4x2f=new u7("mat4x2",u5.f32,null),u7.mat4x3f=new u7("mat4x3",u5.f32,null),u7.mat4x4f=new u7("mat4x4",u5.f32,null),u7.mat2x2h=new u7("mat2x2",u5.f16,null),u7.mat2x3h=new u7("mat2x3",u5.f16,null),u7.mat2x4h=new u7("mat2x4",u5.f16,null),u7.mat3x2h=new u7("mat3x2",u5.f16,null),u7.mat3x3h=new u7("mat3x3",u5.f16,null),u7.mat3x4h=new u7("mat3x4",u5.f16,null),u7.mat4x2h=new u7("mat4x2",u5.f16,null),u7.mat4x3h=new u7("mat4x3",u5.f16,null),u7.mat4x4h=new u7("mat4x4",u5.f16,null),u7.mat2x2i=new u7("mat2x2",u5.i32,null),u7.mat2x3i=new u7("mat2x3",u5.i32,null),u7.mat2x4i=new u7("mat2x4",u5.i32,null),u7.mat3x2i=new u7("mat3x2",u5.i32,null),u7.mat3x3i=new u7("mat3x3",u5.i32,null),u7.mat3x4i=new u7("mat3x4",u5.i32,null),u7.mat4x2i=new u7("mat4x2",u5.i32,null),u7.mat4x3i=new u7("mat4x3",u5.i32,null),u7.mat4x4i=new u7("mat4x4",u5.i32,null),u7.mat2x2u=new u7("mat2x2",u5.u32,null),u7.mat2x3u=new u7("mat2x3",u5.u32,null),u7.mat2x4u=new u7("mat2x4",u5.u32,null),u7.mat3x2u=new u7("mat3x2",u5.u32,null),u7.mat3x3u=new u7("mat3x3",u5.u32,null),u7.mat3x4u=new u7("mat3x4",u5.u32,null),u7.mat4x2u=new u7("mat4x2",u5.u32,null),u7.mat4x3u=new u7("mat4x3",u5.u32,null),u7.mat4x4u=new u7("mat4x4",u5.u32,null);class ce extends u5{constructor(e,t,i,r){super(e),this.storage=t,this.type=i,this.access=r}get astNodeType(){return"pointer"}}class ct extends u5{constructor(e,t,i,r){super(e),this.attributes=t,this.format=i,this.count=r}get astNodeType(){return"array"}get isArray(){return!0}}class ci extends u5{constructor(e,t,i){super(e),this.format=t,this.access=i}get astNodeType(){return"sampler"}}class cr extends uL{constructor(){super(),this.postfix=null}}class cn extends cr{constructor(e){super(),this.value=e}get astNodeType(){return"stringExpr"}toString(){return this.value}constEvaluateString(){return this.value}}class cs extends cr{constructor(e,t){super(),this.type=e,this.args=t}get astNodeType(){return"createExpr"}search(e){if(e(this),this.args)for(let t of this.args)t.search(e)}constEvaluate(e,t){return t&&(t[0]=this.type),e.evalExpression(this,e.context)}}class co extends cr{constructor(e,t){super(),this.cachedReturnValue=null,this.name=e,this.args=t}get astNodeType(){return"callExpr"}setCachedReturnValue(e){this.cachedReturnValue=e}get isBuiltin(){return uD.has(this.name)}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){for(let t of this.args)t.search(e);e(this)}}class ca extends cr{constructor(e){super(),this.name=e}get astNodeType(){return"varExpr"}search(e){e(this),this.postfix&&this.postfix.search(e)}constEvaluate(e,t){return e.evalExpression(this,e.context)}}class cl extends cr{constructor(e,t){super(),this.name=e,this.initializer=t}get astNodeType(){return"constExpr"}constEvaluate(e,t){if(this.initializer){let t=e.evalExpression(this.initializer,e.context);return null!==t&&this.postfix?t.getSubData(e,this.postfix,e.context):t}return null}search(e){this.initializer.search(e)}}class cu extends cr{constructor(e,t){super(),this.value=e,this.type=t}get astNodeType(){return"literalExpr"}constEvaluate(e,t){return void 0!==t&&(t[0]=this.type),this.value}get isScalar(){return this.value instanceof cP}get isVector(){return this.value instanceof cE||this.value instanceof cC}get scalarValue(){return this.value instanceof cP?this.value.value:(console.error("Value is not scalar."),0)}get vectorValue(){return this.value instanceof cE||this.value instanceof cC?this.value.data:(console.error("Value is not a vector or matrix."),new Float32Array(0))}}class cc extends cr{constructor(e,t){super(),this.type=e,this.value=t}get astNodeType(){return"bitcastExpr"}search(e){this.value.search(e)}}class ch extends cr{constructor(e){super(),this.index=e}search(e){this.index.search(e)}}class cd extends cr{constructor(){super()}}class cf extends cd{constructor(e,t){super(),this.operator=e,this.right=t}get astNodeType(){return"unaryOp"}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.right.search(e)}}class cp extends cd{constructor(e,t,i){super(),this.operator=e,this.left=t,this.right=i}get astNodeType(){return"binaryOp"}_getPromotedType(e,t){return e.name===t.name?e:"f32"===e.name||"f32"===t.name?u5.f32:"u32"===e.name||"u32"===t.name?u5.u32:u5.i32}constEvaluate(e,t){return e.evalExpression(this,e.context)}search(e){this.left.search(e),this.right.search(e)}}class cg extends uL{constructor(e){super(),this.body=e}search(e){e(this),this.searchBlock(this.body,e)}}class cm extends cr{constructor(){super()}get astNodeType(){return"default"}}class cy extends cg{constructor(e,t){super(t),this.selectors=e}get astNodeType(){return"case"}search(e){this.searchBlock(this.body,e)}}class c_ extends cg{constructor(e){super(e)}get astNodeType(){return"default"}search(e){this.searchBlock(this.body,e)}}class cv extends uL{constructor(e,t,i){super(),this.name=e,this.type=t,this.attributes=i}get astNodeType(){return"argument"}}class cb extends uL{constructor(e,t){super(),this.condition=e,this.body=t}get astNodeType(){return"elseif"}search(e){this.condition.search(e),this.searchBlock(this.body,e)}}class cx extends uL{constructor(e,t,i){super(),this.name=e,this.type=t,this.attributes=i}get astNodeType(){return"member"}}class cw extends uL{constructor(e,t){super(),this.name=e,this.value=t}get astNodeType(){return"attribute"}}class ck{constructor(e,t){this.parent=null,this.typeInfo=e,this.parent=t,this.id=ck._id++}clone(){throw`Clone: Not implemented for ${this.constructor.name}`}setDataValue(e,t,i,r){console.error(`SetDataValue: Not implemented for ${this.constructor.name}`)}getSubData(e,t,i){return console.error(`GetDataValue: Not implemented for ${this.constructor.name}`),null}toString(){return`<${this.typeInfo.getTypeName()}>`}}ck._id=0;class cT extends ck{constructor(){super(new uu("void",null),null)}toString(){return"void"}}cT.void=new cT;class cS extends ck{constructor(e){super(new uf("pointer",e.typeInfo,null),null),this.reference=e}clone(){return this}setDataValue(e,t,i,r){this.reference.setDataValue(e,t,i,r)}getSubData(e,t,i){return t?this.reference.getSubData(e,t,i):this}toString(){return`&${this.reference.toString()}`}}class cP extends ck{constructor(e,t,i=null){super(t,i),e instanceof Int32Array||e instanceof Uint32Array||e instanceof Float32Array?this.data=e:"x32"===this.typeInfo.name?e-Math.floor(e)!=0?this.data=new Float32Array([e]):this.data=e>=0?new Uint32Array([e]):new Int32Array([e]):"i32"===this.typeInfo.name||"bool"===this.typeInfo.name?this.data=new Int32Array([e]):"u32"===this.typeInfo.name?this.data=new Uint32Array([e]):"f32"===this.typeInfo.name||"f16"===this.typeInfo.name?this.data=new Float32Array([e]):console.error("ScalarData2: Invalid type",t)}clone(){if(this.data instanceof Float32Array)return new cP(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new cP(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new cP(new Uint32Array(this.data),this.typeInfo,null);throw"ScalarData: Invalid data type"}get value(){return this.data[0]}set value(e){this.data[0]=e}setDataValue(e,t,i,r){if(i)return void console.error("SetDataValue: Scalar data does not support postfix",i);if(!(t instanceof cP))return void console.error("SetDataValue: Invalid value",t);let n=t.data[0];"i32"===this.typeInfo.name||"u32"===this.typeInfo.name?n=Math.floor(n):"bool"===this.typeInfo.name&&(n=+!!n),this.data[0]=n}getSubData(e,t,i){return t?(console.error("getSubData: Scalar data does not support postfix",t),null):this}toString(){return`${this.value}`}}class cE extends ck{constructor(e,t,i=null){if(super(t,i),e instanceof Float32Array||e instanceof Uint32Array||e instanceof Int32Array)this.data=e;else{const t=this.typeInfo.name;"vec2f"===t||"vec3f"===t||"vec4f"===t?this.data=new Float32Array(e):"vec2i"===t||"vec3i"===t||"vec4i"===t?this.data=new Int32Array(e):"vec2u"===t||"vec3u"===t||"vec4u"===t?this.data=new Uint32Array(e):"vec2h"===t||"vec3h"===t||"vec4h"===t?this.data=new Float32Array(e):"vec2b"===t||"vec3b"===t||"vec4b"===t?this.data=new Int32Array(e):"vec2"===t||"vec3"===t||"vec4"===t?this.data=new Float32Array(e):console.error(`VectorData: Invalid type ${t}`)}}clone(){if(this.data instanceof Float32Array)return new cE(new Float32Array(this.data),this.typeInfo,null);if(this.data instanceof Int32Array)return new cE(new Int32Array(this.data),this.typeInfo,null);if(this.data instanceof Uint32Array)return new cE(new Uint32Array(this.data),this.typeInfo,null);throw"VectorData: Invalid data type"}setDataValue(e,t,i,r){i instanceof cn?console.error("TODO: Set vector postfix"):t instanceof cE?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,i){if(null===t)return this;let r=e.getTypeInfo("f32");if(this.typeInfo instanceof up)r=this.typeInfo.format||r;else{let t=this.typeInfo.name;"vec2f"===t||"vec3f"===t||"vec4f"===t?r=e.getTypeInfo("f32"):"vec2i"===t||"vec3i"===t||"vec4i"===t?r=e.getTypeInfo("i32"):"vec2b"===t||"vec3b"===t||"vec4b"===t?r=e.getTypeInfo("bool"):"vec2u"===t||"vec3u"===t||"vec4u"===t?r=e.getTypeInfo("u32"):"vec2h"===t||"vec3h"===t||"vec4h"===t?r=e.getTypeInfo("f16"):console.error(`GetSubData: Unknown type ${t}`)}let n=this;for(;null!==t&&null!==n;){if(t instanceof ch){let s=t.index,o=-1;if(s instanceof cu){if(!(s.value instanceof cP))return console.error(`GetSubData: Invalid array index ${s.value}`),null;o=s.value.value}else{let t=e.evalExpression(s,i);if(!(t instanceof cP))return console.error("GetSubData: Unknown index type",s),null;o=t.value}if(o<0||o>=n.data.length)return console.error("GetSubData: Index out of range",o),null;if(n.data instanceof Float32Array)return new cP(new Float32Array(n.data.buffer,n.data.byteOffset+4*o,1),r);if(n.data instanceof Int32Array)return new cP(new Int32Array(n.data.buffer,n.data.byteOffset+4*o,1),r);if(n.data instanceof Uint32Array)return new cP(new Uint32Array(n.data.buffer,n.data.byteOffset+4*o,1),r);throw"GetSubData: Invalid data type"}if(!(t instanceof cn))return console.error("GetSubData: Unknown postfix",t),null;{let i=t.value.toLowerCase();if(1===i.length){let e=0;if("x"===i||"r"===i)e=0;else if("y"===i||"g"===i)e=1;else if("z"===i||"b"===i)e=2;else{if("w"!==i&&"a"!==i)return console.error(`GetSubData: Unknown member ${i}`),null;e=3}if(this.data instanceof Float32Array)return new cP(new Float32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this);if(this.data instanceof Int32Array)return new cP(new Int32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this);if(this.data instanceof Uint32Array)return new cP(new Uint32Array(this.data.buffer,this.data.byteOffset+4*e,1),r,this)}let s=[];for(let e of i)"x"===e||"r"===e?s.push(this.data[0]):"y"===e||"g"===e?s.push(this.data[1]):"z"===e||"b"===e?s.push(this.data[2]):"w"===e||"a"===e?s.push(this.data[3]):console.error(`GetDataValue: Unknown member ${e}`);n=function(e,t,i){let r=t.length;return 2===r?"f32"===i?new cE(new Float32Array(t),e.getTypeInfo("vec2f")):"i32"===i||"bool"===i?new cE(new Int32Array(t),e.getTypeInfo("vec2i")):"u32"===i?new cE(new Uint32Array(t),e.getTypeInfo("vec2u")):"f16"===i?new cE(new Float32Array(t),e.getTypeInfo("vec2h")):(console.error(`getSubData: Unknown format ${i}`),null):3===r?"f32"===i?new cE(new Float32Array(t),e.getTypeInfo("vec3f")):"i32"===i||"bool"===i?new cE(new Int32Array(t),e.getTypeInfo("vec3i")):"u32"===i?new cE(new Uint32Array(t),e.getTypeInfo("vec3u")):"f16"===i?new cE(new Float32Array(t),e.getTypeInfo("vec3h")):(console.error(`getSubData: Unknown format ${i}`),null):4===r?"f32"===i?new cE(new Float32Array(t),e.getTypeInfo("vec4f")):"i32"===i||"bool"===i?new cE(new Int32Array(t),e.getTypeInfo("vec4i")):"u32"===i?new cE(new Uint32Array(t),e.getTypeInfo("vec4u")):"f16"===i?new cE(new Float32Array(t),e.getTypeInfo("vec4h")):(console.error(`getSubData: Unknown format ${i}`),null):(console.error(`getSubData: Invalid vector size ${t.length}`),null)}(e,s,r.name)}t=t.postfix}return n}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class cC extends ck{constructor(e,t,i=null){super(t,i),e instanceof Float32Array?this.data=e:this.data=new Float32Array(e)}clone(){return new cC(new Float32Array(this.data),this.typeInfo,null)}setDataValue(e,t,i,r){i instanceof cn?console.error("TODO: Set matrix postfix"):t instanceof cC?this.data=t.data:console.error("SetDataValue: Invalid value",t)}getSubData(e,t,i){if(null===t)return this;let r=this.typeInfo.name;if(e.getTypeInfo("f32"),this.typeInfo instanceof up)this.typeInfo.format;else if(r.endsWith("f"))e.getTypeInfo("f32");else if(r.endsWith("i"))e.getTypeInfo("i32");else if(r.endsWith("u"))e.getTypeInfo("u32");else{if(!r.endsWith("h"))return console.error(`GetDataValue: Unknown type ${r}`),null;e.getTypeInfo("f16")}if(t instanceof ch){let n,s=t.index,o=-1;if(s instanceof cu){if(!(s.value instanceof cP))return console.error(`GetDataValue: Invalid array index ${s.value}`),null;o=s.value.value}else{let t=e.evalExpression(s,i);if(!(t instanceof cP))return console.error("GetDataValue: Unknown index type",s),null;o=t.value}if(o<0||o>=this.data.length)return console.error("GetDataValue: Index out of range",o),null;let a=r.endsWith("h")?"h":"f";if("mat2x2"===r||"mat2x2f"===r||"mat2x2h"===r||"mat3x2"===r||"mat3x2f"===r||"mat3x2h"===r||"mat4x2"===r||"mat4x2f"===r||"mat4x2h"===r)n=new cE(new Float32Array(this.data.buffer,this.data.byteOffset+2*o*4,2),e.getTypeInfo(`vec2${a}`));else if("mat2x3"===r||"mat2x3f"===r||"mat2x3h"===r||"mat3x3"===r||"mat3x3f"===r||"mat3x3h"===r||"mat4x3"===r||"mat4x3f"===r||"mat4x3h"===r)n=new cE(new Float32Array(this.data.buffer,this.data.byteOffset+3*o*4,3),e.getTypeInfo(`vec3${a}`));else{if("mat2x4"!==r&&"mat2x4f"!==r&&"mat2x4h"!==r&&"mat3x4"!==r&&"mat3x4f"!==r&&"mat3x4h"!==r&&"mat4x4"!==r&&"mat4x4f"!==r&&"mat4x4h"!==r)return console.error(`GetDataValue: Unknown type ${r}`),null;n=new cE(new Float32Array(this.data.buffer,this.data.byteOffset+4*o*4,4),e.getTypeInfo(`vec4${a}`))}return t.postfix?n.getSubData(e,t.postfix,i):n}return console.error("GetDataValue: Invalid postfix",t),null}toString(){let e=`${this.data[0]}`;for(let t=1;t<this.data.length;++t)e+=`, ${this.data[t]}`;return e}}class cI extends ck{constructor(e,t,i=0,r=null){super(t,r),this.buffer=e instanceof ArrayBuffer?e:e.buffer,this.offset=i}clone(){return new cI(new Uint8Array(new Uint8Array(this.buffer,this.offset,this.typeInfo.size)).buffer,this.typeInfo,0,null)}setDataValue(e,t,i,r){if(null===t)return void console.log("setDataValue: NULL data.");let n=this.offset,s=this.typeInfo;for(;i;){if(i instanceof ch)if(s instanceof ud){let t=i.index;if(t instanceof cu){if(!(t.value instanceof cP))return void console.error(`SetDataValue: Invalid index type ${t.value}`);n+=t.value.value*s.stride}else{let i=e.evalExpression(t,r);if(!(i instanceof cP))return void console.error("SetDataValue: Unknown index type",t);n+=i.value*s.stride}s=s.format}else console.error(`SetDataValue: Type ${s.getTypeName()} is not an array`);else{if(!(i instanceof cn))return void console.error("SetDataValue: Unknown postfix type",i);{let e=i.value;if(s instanceof uh){let t=!1;for(let i of s.members)if(i.name===e){n+=i.offset,s=i.type,t=!0;break}if(!t)return void console.error(`SetDataValue: Member ${e} not found`)}else if(s instanceof uu){let i=s.getTypeName(),r=0;if("x"===e||"r"===e)r=0;else if("y"===e||"g"===e)r=1;else if("z"===e||"b"===e)r=2;else{if("w"!==e&&"a"!==e)return void console.error(`SetDataValue: Unknown member ${e}`);r=3}if(!(t instanceof cP))return void console.error("SetDataValue: Invalid value",t);let o=t.value;return"vec2f"===i?void(new Float32Array(this.buffer,n,2)[r]=o):"vec3f"===i?void(new Float32Array(this.buffer,n,3)[r]=o):"vec4f"===i?void(new Float32Array(this.buffer,n,4)[r]=o):"vec2i"===i?void(new Int32Array(this.buffer,n,2)[r]=o):"vec3i"===i?void(new Int32Array(this.buffer,n,3)[r]=o):"vec4i"===i?void(new Int32Array(this.buffer,n,4)[r]=o):"vec2u"===i?void(new Uint32Array(this.buffer,n,2)[r]=o):"vec3u"===i?void(new Uint32Array(this.buffer,n,3)[r]=o):"vec4u"===i?void(new Uint32Array(this.buffer,n,4)[r]=o):void console.error(`SetDataValue: Type ${i} is not a struct`)}}}i=i.postfix}this.setData(e,t,s,n,r)}setData(e,t,i,r,n){let s=i.getTypeName();if("f32"!==s&&"f16"!==s)if("i32"!==s&&"atomic<i32>"!==s&&"x32"!==s)if("u32"!==s&&"atomic<u32>"!==s)if("bool"!==s){if("vec2f"===s||"vec2h"===s){let e=new Float32Array(this.buffer,r,2);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3f"===s||"vec3h"===s){let e=new Float32Array(this.buffer,r,3);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4f"===s||"vec4h"===s){let e=new Float32Array(this.buffer,r,4);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("vec2i"===s){let e=new Int32Array(this.buffer,r,2);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3i"===s){let e=new Int32Array(this.buffer,r,3);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4i"===s){let e=new Int32Array(this.buffer,r,4);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("vec2u"===s){let e=new Uint32Array(this.buffer,r,2);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3u"===s){let e=new Uint32Array(this.buffer,r,3);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4u"===s){let e=new Uint32Array(this.buffer,r,4);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("vec2b"===s){let e=new Uint32Array(this.buffer,r,2);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1]):(e[0]=t[0],e[1]=t[1]))}if("vec3b"===s){let e=new Uint32Array(this.buffer,r,3);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2]))}if("vec4b"===s){let e=new Uint32Array(this.buffer,r,4);return void(t instanceof cE?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("mat2x2f"===s||"mat2x2h"===s){let e=new Float32Array(this.buffer,r,4);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]))}if("mat2x3f"===s||"mat2x3h"===s){let e=new Float32Array(this.buffer,r,6);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5]))}if("mat2x4f"===s||"mat2x4h"===s){let e=new Float32Array(this.buffer,r,8);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7]))}if("mat3x2f"===s||"mat3x2h"===s){let e=new Float32Array(this.buffer,r,6);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5]))}if("mat3x3f"===s||"mat3x3h"===s){let e=new Float32Array(this.buffer,r,9);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8]))}if("mat3x4f"===s||"mat3x4h"===s){let e=new Float32Array(this.buffer,r,12);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11]))}if("mat4x2f"===s||"mat4x2h"===s){let e=new Float32Array(this.buffer,r,8);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7]))}if("mat4x3f"===s||"mat4x3h"===s){let e=new Float32Array(this.buffer,r,12);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11]))}if("mat4x4f"===s||"mat4x4h"===s){let e=new Float32Array(this.buffer,r,16);return void(t instanceof cC?(e[0]=t.data[0],e[1]=t.data[1],e[2]=t.data[2],e[3]=t.data[3],e[4]=t.data[4],e[5]=t.data[5],e[6]=t.data[6],e[7]=t.data[7],e[8]=t.data[8],e[9]=t.data[9],e[10]=t.data[10],e[11]=t.data[11],e[12]=t.data[12],e[13]=t.data[13],e[14]=t.data[14],e[15]=t.data[15]):(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}if(t instanceof cI){if(i===t.typeInfo)return void new Uint8Array(this.buffer,r,t.buffer.byteLength).set(new Uint8Array(t.buffer));console.error("SetDataValue: Type mismatch",s,t.typeInfo.getTypeName())}else console.error(`SetData: Unknown type ${s}`)}else t instanceof cP&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof cP&&(new Uint32Array(this.buffer,r,1)[0]=t.value);else t instanceof cP&&(new Int32Array(this.buffer,r,1)[0]=t.value);else t instanceof cP&&(new Float32Array(this.buffer,r,1)[0]=t.value)}getSubData(e,t,i){var r,n,s;if(null===t)return this;let o=this.offset,a=this.typeInfo;for(;t;){if(t instanceof ch){let r=t.index,n=r instanceof cr?e.evalExpression(r,i):r,s=0;if(n instanceof cP?s=n.value:"number"==typeof n?s=n:console.error("GetDataValue: Invalid index type",r),a instanceof ud)o+=s*a.stride,a=a.format;else{let t=a.getTypeName();"mat4x4"===t||"mat4x4f"===t||"mat4x4h"===t?(o+=16*s,a=e.getTypeInfo("vec4f")):console.error(`getDataValue: Type ${a.getTypeName()} is not an array`)}}else{if(!(t instanceof cn))return console.error("GetDataValue: Unknown postfix type",t),null;{let i=t.value;if(a instanceof uh){let e=!1;for(let t of a.members)if(t.name===i){o+=t.offset,a=t.type,e=!0;break}if(!e)return console.error(`GetDataValue: Member ${i} not found`),null}else if(a instanceof uu){let t=a.getTypeName();if("vec2f"===t||"vec3f"===t||"vec4f"===t||"vec2i"===t||"vec3i"===t||"vec4i"===t||"vec2u"===t||"vec3u"===t||"vec4u"===t||"vec2b"===t||"vec3b"===t||"vec4b"===t||"vec2h"===t||"vec3h"===t||"vec4h"===t||"vec2"===t||"vec3"===t||"vec4"===t){if(i.length>0&&i.length<5){let r="f",n=[];for(let s=0;s<i.length;++s){let a=i[s].toLowerCase(),l=0;if("x"===a||"r"===a)l=0;else if("y"===a||"g"===a)l=1;else if("z"===a||"b"===a)l=2;else{if("w"!==a&&"a"!==a)return console.error(`Unknown member ${i}`),null;l=3}if(1===i.length){if(t.endsWith("f"))return this.buffer.byteLength<o+4*l+4?(console.log("Insufficient buffer data"),null):new cP(new Float32Array(this.buffer,o+4*l,1),e.getTypeInfo("f32"),this);if(t.endsWith("h"))return new cP(new Float32Array(this.buffer,o+4*l,1),e.getTypeInfo("f16"),this);if(t.endsWith("i"))return new cP(new Int32Array(this.buffer,o+4*l,1),e.getTypeInfo("i32"),this);if(t.endsWith("b"))return new cP(new Int32Array(this.buffer,o+4*l,1),e.getTypeInfo("bool"),this);if(t.endsWith("u"))return new cP(new Uint32Array(this.buffer,o+4*l,1),e.getTypeInfo("i32"),this)}if("vec2f"===t)n.push(new Float32Array(this.buffer,o,2)[l]);else if("vec3f"===t){if(o+12>=this.buffer.byteLength)return console.log("Insufficient buffer data"),null;let e=new Float32Array(this.buffer,o,3);n.push(e[l])}else if("vec4f"===t)n.push(new Float32Array(this.buffer,o,4)[l]);else if("vec2i"===t)r="i",n.push(new Int32Array(this.buffer,o,2)[l]);else if("vec3i"===t)r="i",n.push(new Int32Array(this.buffer,o,3)[l]);else if("vec4i"===t)r="i",n.push(new Int32Array(this.buffer,o,4)[l]);else if("vec2u"===t){r="u";let e=new Uint32Array(this.buffer,o,2);n.push(e[l])}else"vec3u"===t?(r="u",n.push(new Uint32Array(this.buffer,o,3)[l])):"vec4u"===t&&(r="u",n.push(new Uint32Array(this.buffer,o,4)[l]))}return 2===n.length?a=e.getTypeInfo(`vec2${r}`):3===n.length?a=e.getTypeInfo(`vec3${r}`):4===n.length?a=e.getTypeInfo(`vec4${r}`):console.error(`GetDataValue: Invalid vector length ${n.length}`),new cE(n,a,null)}return console.error(`GetDataValue: Unknown member ${i}`),null}return console.error(`GetDataValue: Type ${t} is not a struct`),null}}}t=t.postfix}let l=a.getTypeName();return"f32"===l?new cP(new Float32Array(this.buffer,o,1),a,this):"i32"===l?new cP(new Int32Array(this.buffer,o,1),a,this):"u32"===l?new cP(new Uint32Array(this.buffer,o,1),a,this):"vec2f"===l?new cE(new Float32Array(this.buffer,o,2),a,this):"vec3f"===l?new cE(new Float32Array(this.buffer,o,3),a,this):"vec4f"===l?new cE(new Float32Array(this.buffer,o,4),a,this):"vec2i"===l?new cE(new Int32Array(this.buffer,o,2),a,this):"vec3i"===l?new cE(new Int32Array(this.buffer,o,3),a,this):"vec4i"===l?new cE(new Int32Array(this.buffer,o,4),a,this):"vec2u"===l?new cE(new Uint32Array(this.buffer,o,2),a,this):"vec3u"===l?new cE(new Uint32Array(this.buffer,o,3),a,this):"vec4u"===l?new cE(new Uint32Array(this.buffer,o,4),a,this):a instanceof up&&"atomic"===a.name?"u32"===(null==(r=a.format)?void 0:r.name)?new cP(new Uint32Array(this.buffer,o,1)[0],a.format,this):"i32"===(null==(n=a.format)?void 0:n.name)?new cP(new Int32Array(this.buffer,o,1)[0],a.format,this):(console.error(`GetDataValue: Invalid atomic format ${null==(s=a.format)?void 0:s.name}`),null):new cI(this.buffer,a,o,this)}toString(){let e="";if(this.typeInfo instanceof ud)if("f32"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if("i32"===this.typeInfo.format.name){let t=new Int32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if("u32"===this.typeInfo.format.name){let t=new Uint32Array(this.buffer,this.offset);e=`[${t[0]}`;for(let i=1;i<t.length;++i)e+=`, ${t[i]}`}else if("vec2f"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}]`;for(let i=1;i<t.length/2;++i)e+=`, [${t[2*i]}, ${t[2*i+1]}]`}else if("vec3f"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}]`;for(let i=4;i<t.length;i+=4)e+=`, [${t[i]}, ${t[i+1]}, ${t[i+2]}]`}else if("vec4f"===this.typeInfo.format.name){let t=new Float32Array(this.buffer,this.offset);e=`[${t[0]}, ${t[1]}, ${t[2]}, ${t[3]}]`;for(let i=4;i<t.length;i+=4)e+=`, [${t[i]}, ${t[i+1]}, ${t[i+2]}, ${t[i+3]}]`}else e="[...]";else this.typeInfo instanceof uh?e+="{...}":e="[...]";return e}}class cA extends ck{constructor(e,t,i,r){super(t,null),this.data=e,this.descriptor=i,this.view=r}clone(){return new cA(this.data,this.typeInfo,this.descriptor,this.view)}get width(){var e,t;let i=this.descriptor.size;return i instanceof Array&&i.length>0?null!=(e=i[0])?e:0:i instanceof Object&&null!=(t=i.width)?t:0}get height(){var e,t;let i=this.descriptor.size;return i instanceof Array&&i.length>1?null!=(e=i[1])?e:0:i instanceof Object&&null!=(t=i.height)?t:0}get depthOrArrayLayers(){var e,t;let i=this.descriptor.size;return i instanceof Array&&i.length>2?null!=(e=i[2])?e:0:i instanceof Object&&null!=(t=i.depthOrArrayLayers)?t:0}get format(){var e;return this.descriptor&&null!=(e=this.descriptor.format)?e:"rgba8unorm"}get sampleCount(){var e;return this.descriptor&&null!=(e=this.descriptor.sampleCount)?e:1}get mipLevelCount(){var e;return this.descriptor&&null!=(e=this.descriptor.mipLevelCount)?e:1}get dimension(){var e;return this.descriptor&&null!=(e=this.descriptor.dimension)?e:"2d"}getMipLevelSize(e){if(e>=this.mipLevelCount)return[0,0,0];let t=[this.width,this.height,this.depthOrArrayLayers];for(let i=0;i<t.length;++i)t[i]=Math.max(1,t[i]>>e);return t}get texelByteSize(){let e=uM[this.format];return e?e.isDepthStencil?4:e.bytesPerBlock:0}get bytesPerRow(){return this.width*this.texelByteSize}get isDepthStencil(){let e=uM[this.format];return!!e&&e.isDepthStencil}getGpuSize(){let e=this.format,t=uM[e],i=this.width;if(!e||i<=0||!t)return -1;let r=this.height,n=this.depthOrArrayLayers,s=this.dimension;return i/t.blockWidth*("1d"===s?1:r/t.blockHeight)*t.bytesPerBlock*n}getPixel(e,t,i=0,r=0){let n=this.texelByteSize,s=this.bytesPerRow,o=this.height;return function(e,t,i,r,n,s,o,a,l){let u=r*(o>>=n)*(s>>=n)+i*o+t*a;switch(l){case"r8unorm":return[uI(e,u,"8unorm",1)[0]];case"r8snorm":return[uI(e,u,"8snorm",1)[0]];case"r8uint":return[uI(e,u,"8uint",1)[0]];case"r8sint":return[uI(e,u,"8sint",1)[0]];case"rg8unorm":{let t=uI(e,u,"8unorm",2);return[t[0],t[1]]}case"rg8snorm":{let t=uI(e,u,"8snorm",2);return[t[0],t[1]]}case"rg8uint":{let t=uI(e,u,"8uint",2);return[t[0],t[1]]}case"rg8sint":{let t=uI(e,u,"8sint",2);return[t[0],t[1]]}case"rgba8unorm-srgb":case"rgba8unorm":{let t=uI(e,u,"8unorm",4);return[t[0],t[1],t[2],t[3]]}case"rgba8snorm":{let t=uI(e,u,"8snorm",4);return[t[0],t[1],t[2],t[3]]}case"rgba8uint":{let t=uI(e,u,"8uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba8sint":{let t=uI(e,u,"8sint",4);return[t[0],t[1],t[2],t[3]]}case"bgra8unorm-srgb":case"bgra8unorm":{let t=uI(e,u,"8unorm",4);return[t[2],t[1],t[0],t[3]]}case"r16uint":return[uI(e,u,"16uint",1)[0]];case"r16sint":return[uI(e,u,"16sint",1)[0]];case"r16float":return[uI(e,u,"16float",1)[0]];case"rg16uint":{let t=uI(e,u,"16uint",2);return[t[0],t[1]]}case"rg16sint":{let t=uI(e,u,"16sint",2);return[t[0],t[1]]}case"rg16float":{let t=uI(e,u,"16float",2);return[t[0],t[1]]}case"rgba16uint":{let t=uI(e,u,"16uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba16sint":{let t=uI(e,u,"16sint",4);return[t[0],t[1],t[2],t[3]]}case"rgba16float":{let t=uI(e,u,"16float",4);return[t[0],t[1],t[2],t[3]]}case"r32uint":return[uI(e,u,"32uint",1)[0]];case"r32sint":return[uI(e,u,"32sint",1)[0]];case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return[uI(e,u,"32float",1)[0]];case"rg32uint":{let t=uI(e,u,"32uint",2);return[t[0],t[1]]}case"rg32sint":{let t=uI(e,u,"32sint",2);return[t[0],t[1]]}case"rg32float":{let t=uI(e,u,"32float",2);return[t[0],t[1]]}case"rgba32uint":{let t=uI(e,u,"32uint",4);return[t[0],t[1],t[2],t[3]]}case"rgba32sint":{let t=uI(e,u,"32sint",4);return[t[0],t[1],t[2],t[3]]}case"rgba32float":{let t=uI(e,u,"32float",4);return[t[0],t[1],t[2],t[3]]}case"rg11b10ufloat":{var c;let t=new Uint32Array(e.buffer,u,1)[0];return[uC(2047&t),uC((4192256&t)>>11),(c=(0xffc00000&t)>>22,uP[0]=112+(c>>5&31)<<23|(31&c)<<18,uE[0]),1]}}return null}(new Uint8Array(this.data[r]),e,t,i,r,o,s,n,this.format)}setPixel(e,t,i,r,n){let s=this.texelByteSize,o=this.bytesPerRow,a=this.height;!function(e,t,i,r,n,s,o,a,l,u){let c=r*(o>>=n)*(s>>=n)+i*o+t*a;switch(l){case"r8unorm":return uA(e,c,"8unorm",1,u);case"r8snorm":return uA(e,c,"8snorm",1,u);case"r8uint":return uA(e,c,"8uint",1,u);case"r8sint":return uA(e,c,"8sint",1,u);case"rg8unorm":return uA(e,c,"8unorm",2,u);case"rg8snorm":return uA(e,c,"8snorm",2,u);case"rg8uint":return uA(e,c,"8uint",2,u);case"rg8sint":return uA(e,c,"8sint",2,u);case"rgba8unorm-srgb":case"rgba8unorm":case"bgra8unorm-srgb":case"bgra8unorm":return uA(e,c,"8unorm",4,u);case"rgba8snorm":return uA(e,c,"8snorm",4,u);case"rgba8uint":return uA(e,c,"8uint",4,u);case"rgba8sint":return uA(e,c,"8sint",4,u);case"r16uint":return uA(e,c,"16uint",1,u);case"r16sint":return uA(e,c,"16sint",1,u);case"r16float":return uA(e,c,"16float",1,u);case"rg16uint":return uA(e,c,"16uint",2,u);case"rg16sint":return uA(e,c,"16sint",2,u);case"rg16float":return uA(e,c,"16float",2,u);case"rgba16uint":return uA(e,c,"16uint",4,u);case"rgba16sint":return uA(e,c,"16sint",4,u);case"rgba16float":return uA(e,c,"16float",4,u);case"r32uint":return uA(e,c,"32uint",1,u);case"r32sint":return uA(e,c,"32sint",1,u);case"depth16unorm":case"depth24plus":case"depth24plus-stencil8":case"depth32float":case"depth32float-stencil8":case"r32float":return uA(e,c,"32float",1,u);case"rg32uint":return uA(e,c,"32uint",2,u);case"rg32sint":return uA(e,c,"32sint",2,u);case"rg32float":return uA(e,c,"32float",2,u);case"rgba32uint":return uA(e,c,"32uint",4,u);case"rgba32sint":return uA(e,c,"32sint",4,u);case"rgba32float":return uA(e,c,"32float",4,u);case"rg11b10ufloat":console.error("TODO: rg11b10ufloat not supported for writing")}}(new Uint8Array(this.data[r]),e,t,i,r,a,o,s,this.format,n)}}(_=E||(E={}))[_.token=0]="token",_[_.keyword=1]="keyword",_[_.reserved=2]="reserved";class cM{constructor(e,t,i){this.name=e,this.type=t,this.rule=i}toString(){return this.name}}class cL{}cL.none=new cM("",E.reserved,""),cL.eof=new cM("EOF",E.token,""),cL.reserved={asm:new cM("asm",E.reserved,"asm"),bf16:new cM("bf16",E.reserved,"bf16"),do:new cM("do",E.reserved,"do"),enum:new cM("enum",E.reserved,"enum"),f16:new cM("f16",E.reserved,"f16"),f64:new cM("f64",E.reserved,"f64"),handle:new cM("handle",E.reserved,"handle"),i8:new cM("i8",E.reserved,"i8"),i16:new cM("i16",E.reserved,"i16"),i64:new cM("i64",E.reserved,"i64"),mat:new cM("mat",E.reserved,"mat"),premerge:new cM("premerge",E.reserved,"premerge"),regardless:new cM("regardless",E.reserved,"regardless"),typedef:new cM("typedef",E.reserved,"typedef"),u8:new cM("u8",E.reserved,"u8"),u16:new cM("u16",E.reserved,"u16"),u64:new cM("u64",E.reserved,"u64"),unless:new cM("unless",E.reserved,"unless"),using:new cM("using",E.reserved,"using"),vec:new cM("vec",E.reserved,"vec"),void:new cM("void",E.reserved,"void")},cL.keywords={array:new cM("array",E.keyword,"array"),atomic:new cM("atomic",E.keyword,"atomic"),bool:new cM("bool",E.keyword,"bool"),f32:new cM("f32",E.keyword,"f32"),i32:new cM("i32",E.keyword,"i32"),mat2x2:new cM("mat2x2",E.keyword,"mat2x2"),mat2x3:new cM("mat2x3",E.keyword,"mat2x3"),mat2x4:new cM("mat2x4",E.keyword,"mat2x4"),mat3x2:new cM("mat3x2",E.keyword,"mat3x2"),mat3x3:new cM("mat3x3",E.keyword,"mat3x3"),mat3x4:new cM("mat3x4",E.keyword,"mat3x4"),mat4x2:new cM("mat4x2",E.keyword,"mat4x2"),mat4x3:new cM("mat4x3",E.keyword,"mat4x3"),mat4x4:new cM("mat4x4",E.keyword,"mat4x4"),ptr:new cM("ptr",E.keyword,"ptr"),sampler:new cM("sampler",E.keyword,"sampler"),sampler_comparison:new cM("sampler_comparison",E.keyword,"sampler_comparison"),struct:new cM("struct",E.keyword,"struct"),texture_1d:new cM("texture_1d",E.keyword,"texture_1d"),texture_2d:new cM("texture_2d",E.keyword,"texture_2d"),texture_2d_array:new cM("texture_2d_array",E.keyword,"texture_2d_array"),texture_3d:new cM("texture_3d",E.keyword,"texture_3d"),texture_cube:new cM("texture_cube",E.keyword,"texture_cube"),texture_cube_array:new cM("texture_cube_array",E.keyword,"texture_cube_array"),texture_multisampled_2d:new cM("texture_multisampled_2d",E.keyword,"texture_multisampled_2d"),texture_storage_1d:new cM("texture_storage_1d",E.keyword,"texture_storage_1d"),texture_storage_2d:new cM("texture_storage_2d",E.keyword,"texture_storage_2d"),texture_storage_2d_array:new cM("texture_storage_2d_array",E.keyword,"texture_storage_2d_array"),texture_storage_3d:new cM("texture_storage_3d",E.keyword,"texture_storage_3d"),texture_depth_2d:new cM("texture_depth_2d",E.keyword,"texture_depth_2d"),texture_depth_2d_array:new cM("texture_depth_2d_array",E.keyword,"texture_depth_2d_array"),texture_depth_cube:new cM("texture_depth_cube",E.keyword,"texture_depth_cube"),texture_depth_cube_array:new cM("texture_depth_cube_array",E.keyword,"texture_depth_cube_array"),texture_depth_multisampled_2d:new cM("texture_depth_multisampled_2d",E.keyword,"texture_depth_multisampled_2d"),texture_external:new cM("texture_external",E.keyword,"texture_external"),u32:new cM("u32",E.keyword,"u32"),vec2:new cM("vec2",E.keyword,"vec2"),vec3:new cM("vec3",E.keyword,"vec3"),vec4:new cM("vec4",E.keyword,"vec4"),bitcast:new cM("bitcast",E.keyword,"bitcast"),block:new cM("block",E.keyword,"block"),break:new cM("break",E.keyword,"break"),case:new cM("case",E.keyword,"case"),continue:new cM("continue",E.keyword,"continue"),continuing:new cM("continuing",E.keyword,"continuing"),default:new cM("default",E.keyword,"default"),diagnostic:new cM("diagnostic",E.keyword,"diagnostic"),discard:new cM("discard",E.keyword,"discard"),else:new cM("else",E.keyword,"else"),enable:new cM("enable",E.keyword,"enable"),fallthrough:new cM("fallthrough",E.keyword,"fallthrough"),false:new cM("false",E.keyword,"false"),fn:new cM("fn",E.keyword,"fn"),for:new cM("for",E.keyword,"for"),function:new cM("function",E.keyword,"function"),if:new cM("if",E.keyword,"if"),let:new cM("let",E.keyword,"let"),const:new cM("const",E.keyword,"const"),loop:new cM("loop",E.keyword,"loop"),while:new cM("while",E.keyword,"while"),private:new cM("private",E.keyword,"private"),read:new cM("read",E.keyword,"read"),read_write:new cM("read_write",E.keyword,"read_write"),return:new cM("return",E.keyword,"return"),requires:new cM("requires",E.keyword,"requires"),storage:new cM("storage",E.keyword,"storage"),switch:new cM("switch",E.keyword,"switch"),true:new cM("true",E.keyword,"true"),alias:new cM("alias",E.keyword,"alias"),type:new cM("type",E.keyword,"type"),uniform:new cM("uniform",E.keyword,"uniform"),var:new cM("var",E.keyword,"var"),override:new cM("override",E.keyword,"override"),workgroup:new cM("workgroup",E.keyword,"workgroup"),write:new cM("write",E.keyword,"write"),r8unorm:new cM("r8unorm",E.keyword,"r8unorm"),r8snorm:new cM("r8snorm",E.keyword,"r8snorm"),r8uint:new cM("r8uint",E.keyword,"r8uint"),r8sint:new cM("r8sint",E.keyword,"r8sint"),r16uint:new cM("r16uint",E.keyword,"r16uint"),r16sint:new cM("r16sint",E.keyword,"r16sint"),r16float:new cM("r16float",E.keyword,"r16float"),rg8unorm:new cM("rg8unorm",E.keyword,"rg8unorm"),rg8snorm:new cM("rg8snorm",E.keyword,"rg8snorm"),rg8uint:new cM("rg8uint",E.keyword,"rg8uint"),rg8sint:new cM("rg8sint",E.keyword,"rg8sint"),r32uint:new cM("r32uint",E.keyword,"r32uint"),r32sint:new cM("r32sint",E.keyword,"r32sint"),r32float:new cM("r32float",E.keyword,"r32float"),rg16uint:new cM("rg16uint",E.keyword,"rg16uint"),rg16sint:new cM("rg16sint",E.keyword,"rg16sint"),rg16float:new cM("rg16float",E.keyword,"rg16float"),rgba8unorm:new cM("rgba8unorm",E.keyword,"rgba8unorm"),rgba8unorm_srgb:new cM("rgba8unorm_srgb",E.keyword,"rgba8unorm_srgb"),rgba8snorm:new cM("rgba8snorm",E.keyword,"rgba8snorm"),rgba8uint:new cM("rgba8uint",E.keyword,"rgba8uint"),rgba8sint:new cM("rgba8sint",E.keyword,"rgba8sint"),bgra8unorm:new cM("bgra8unorm",E.keyword,"bgra8unorm"),bgra8unorm_srgb:new cM("bgra8unorm_srgb",E.keyword,"bgra8unorm_srgb"),rgb10a2unorm:new cM("rgb10a2unorm",E.keyword,"rgb10a2unorm"),rg11b10float:new cM("rg11b10float",E.keyword,"rg11b10float"),rg32uint:new cM("rg32uint",E.keyword,"rg32uint"),rg32sint:new cM("rg32sint",E.keyword,"rg32sint"),rg32float:new cM("rg32float",E.keyword,"rg32float"),rgba16uint:new cM("rgba16uint",E.keyword,"rgba16uint"),rgba16sint:new cM("rgba16sint",E.keyword,"rgba16sint"),rgba16float:new cM("rgba16float",E.keyword,"rgba16float"),rgba32uint:new cM("rgba32uint",E.keyword,"rgba32uint"),rgba32sint:new cM("rgba32sint",E.keyword,"rgba32sint"),rgba32float:new cM("rgba32float",E.keyword,"rgba32float"),static_assert:new cM("static_assert",E.keyword,"static_assert")},cL.tokens={decimal_float_literal:new cM("decimal_float_literal",E.token,/((-?[0-9]*\.[0-9]+|-?[0-9]+\.[0-9]*)((e|E)(\+|-)?[0-9]+)?[fh]?)|(-?[0-9]+(e|E)(\+|-)?[0-9]+[fh]?)|(-?[0-9]+[fh])/),hex_float_literal:new cM("hex_float_literal",E.token,/-?0x((([0-9a-fA-F]*\.[0-9a-fA-F]+|[0-9a-fA-F]+\.[0-9a-fA-F]*)((p|P)(\+|-)?[0-9]+[fh]?)?)|([0-9a-fA-F]+(p|P)(\+|-)?[0-9]+[fh]?))/),int_literal:new cM("int_literal",E.token,/-?0x[0-9a-fA-F]+|0i?|-?[1-9][0-9]*i?/),uint_literal:new cM("uint_literal",E.token,/0x[0-9a-fA-F]+u|0u|[1-9][0-9]*u/),name:new cM("name",E.token,/([_\p{XID_Start}][\p{XID_Continue}]+)|([\p{XID_Start}])/u),ident:new cM("ident",E.token,/[_a-zA-Z][0-9a-zA-Z_]*/),and:new cM("and",E.token,"&"),and_and:new cM("and_and",E.token,"&&"),arrow:new cM("arrow ",E.token,"->"),attr:new cM("attr",E.token,"@"),forward_slash:new cM("forward_slash",E.token,"/"),bang:new cM("bang",E.token,"!"),bracket_left:new cM("bracket_left",E.token,"["),bracket_right:new cM("bracket_right",E.token,"]"),brace_left:new cM("brace_left",E.token,"{"),brace_right:new cM("brace_right",E.token,"}"),colon:new cM("colon",E.token,":"),comma:new cM("comma",E.token,","),equal:new cM("equal",E.token,"="),equal_equal:new cM("equal_equal",E.token,"=="),not_equal:new cM("not_equal",E.token,"!="),greater_than:new cM("greater_than",E.token,">"),greater_than_equal:new cM("greater_than_equal",E.token,">="),shift_right:new cM("shift_right",E.token,">>"),less_than:new cM("less_than",E.token,"<"),less_than_equal:new cM("less_than_equal",E.token,"<="),shift_left:new cM("shift_left",E.token,"<<"),modulo:new cM("modulo",E.token,"%"),minus:new cM("minus",E.token,"-"),minus_minus:new cM("minus_minus",E.token,"--"),period:new cM("period",E.token,"."),plus:new cM("plus",E.token,"+"),plus_plus:new cM("plus_plus",E.token,"++"),or:new cM("or",E.token,"|"),or_or:new cM("or_or",E.token,"||"),paren_left:new cM("paren_left",E.token,"("),paren_right:new cM("paren_right",E.token,")"),semicolon:new cM("semicolon",E.token,";"),star:new cM("star",E.token,"*"),tilde:new cM("tilde",E.token,"~"),underscore:new cM("underscore",E.token,"_"),xor:new cM("xor",E.token,"^"),plus_equal:new cM("plus_equal",E.token,"+="),minus_equal:new cM("minus_equal",E.token,"-="),times_equal:new cM("times_equal",E.token,"*="),division_equal:new cM("division_equal",E.token,"/="),modulo_equal:new cM("modulo_equal",E.token,"%="),and_equal:new cM("and_equal",E.token,"&="),or_equal:new cM("or_equal",E.token,"|="),xor_equal:new cM("xor_equal",E.token,"^="),shift_right_equal:new cM("shift_right_equal",E.token,">>="),shift_left_equal:new cM("shift_left_equal",E.token,"<<=")},cL.simpleTokens={"@":cL.tokens.attr,"{":cL.tokens.brace_left,"}":cL.tokens.brace_right,":":cL.tokens.colon,",":cL.tokens.comma,"(":cL.tokens.paren_left,")":cL.tokens.paren_right,";":cL.tokens.semicolon},cL.literalTokens={"&":cL.tokens.and,"&&":cL.tokens.and_and,"->":cL.tokens.arrow,"/":cL.tokens.forward_slash,"!":cL.tokens.bang,"[":cL.tokens.bracket_left,"]":cL.tokens.bracket_right,"=":cL.tokens.equal,"==":cL.tokens.equal_equal,"!=":cL.tokens.not_equal,">":cL.tokens.greater_than,">=":cL.tokens.greater_than_equal,">>":cL.tokens.shift_right,"<":cL.tokens.less_than,"<=":cL.tokens.less_than_equal,"<<":cL.tokens.shift_left,"%":cL.tokens.modulo,"-":cL.tokens.minus,"--":cL.tokens.minus_minus,".":cL.tokens.period,"+":cL.tokens.plus,"++":cL.tokens.plus_plus,"|":cL.tokens.or,"||":cL.tokens.or_or,"*":cL.tokens.star,"~":cL.tokens.tilde,_:cL.tokens.underscore,"^":cL.tokens.xor,"+=":cL.tokens.plus_equal,"-=":cL.tokens.minus_equal,"*=":cL.tokens.times_equal,"/=":cL.tokens.division_equal,"%=":cL.tokens.modulo_equal,"&=":cL.tokens.and_equal,"|=":cL.tokens.or_equal,"^=":cL.tokens.xor_equal,">>=":cL.tokens.shift_right_equal,"<<=":cL.tokens.shift_left_equal},cL.regexTokens={decimal_float_literal:cL.tokens.decimal_float_literal,hex_float_literal:cL.tokens.hex_float_literal,int_literal:cL.tokens.int_literal,uint_literal:cL.tokens.uint_literal,ident:cL.tokens.ident},cL.storage_class=[cL.keywords.function,cL.keywords.private,cL.keywords.workgroup,cL.keywords.uniform,cL.keywords.storage],cL.access_mode=[cL.keywords.read,cL.keywords.write,cL.keywords.read_write],cL.sampler_type=[cL.keywords.sampler,cL.keywords.sampler_comparison],cL.sampled_texture_type=[cL.keywords.texture_1d,cL.keywords.texture_2d,cL.keywords.texture_2d_array,cL.keywords.texture_3d,cL.keywords.texture_cube,cL.keywords.texture_cube_array],cL.multisampled_texture_type=[cL.keywords.texture_multisampled_2d],cL.storage_texture_type=[cL.keywords.texture_storage_1d,cL.keywords.texture_storage_2d,cL.keywords.texture_storage_2d_array,cL.keywords.texture_storage_3d],cL.depth_texture_type=[cL.keywords.texture_depth_2d,cL.keywords.texture_depth_2d_array,cL.keywords.texture_depth_cube,cL.keywords.texture_depth_cube_array,cL.keywords.texture_depth_multisampled_2d],cL.texture_external_type=[cL.keywords.texture_external],cL.any_texture_type=[...cL.sampled_texture_type,...cL.multisampled_texture_type,...cL.storage_texture_type,...cL.depth_texture_type,...cL.texture_external_type],cL.texel_format=[cL.keywords.r8unorm,cL.keywords.r8snorm,cL.keywords.r8uint,cL.keywords.r8sint,cL.keywords.r16uint,cL.keywords.r16sint,cL.keywords.r16float,cL.keywords.rg8unorm,cL.keywords.rg8snorm,cL.keywords.rg8uint,cL.keywords.rg8sint,cL.keywords.r32uint,cL.keywords.r32sint,cL.keywords.r32float,cL.keywords.rg16uint,cL.keywords.rg16sint,cL.keywords.rg16float,cL.keywords.rgba8unorm,cL.keywords.rgba8unorm_srgb,cL.keywords.rgba8snorm,cL.keywords.rgba8uint,cL.keywords.rgba8sint,cL.keywords.bgra8unorm,cL.keywords.bgra8unorm_srgb,cL.keywords.rgb10a2unorm,cL.keywords.rg11b10float,cL.keywords.rg32uint,cL.keywords.rg32sint,cL.keywords.rg32float,cL.keywords.rgba16uint,cL.keywords.rgba16sint,cL.keywords.rgba16float,cL.keywords.rgba32uint,cL.keywords.rgba32sint,cL.keywords.rgba32float],cL.const_literal=[cL.tokens.int_literal,cL.tokens.uint_literal,cL.tokens.decimal_float_literal,cL.tokens.hex_float_literal,cL.keywords.true,cL.keywords.false],cL.literal_or_ident=[cL.tokens.ident,cL.tokens.int_literal,cL.tokens.uint_literal,cL.tokens.decimal_float_literal,cL.tokens.hex_float_literal,cL.tokens.name],cL.element_count_expression=[cL.tokens.int_literal,cL.tokens.uint_literal,cL.tokens.ident],cL.template_types=[cL.keywords.vec2,cL.keywords.vec3,cL.keywords.vec4,cL.keywords.mat2x2,cL.keywords.mat2x3,cL.keywords.mat2x4,cL.keywords.mat3x2,cL.keywords.mat3x3,cL.keywords.mat3x4,cL.keywords.mat4x2,cL.keywords.mat4x3,cL.keywords.mat4x4,cL.keywords.atomic,cL.keywords.bitcast,...cL.any_texture_type],cL.attribute_name=[cL.tokens.ident,cL.keywords.block,cL.keywords.diagnostic],cL.assignment_operators=[cL.tokens.equal,cL.tokens.plus_equal,cL.tokens.minus_equal,cL.tokens.times_equal,cL.tokens.division_equal,cL.tokens.modulo_equal,cL.tokens.and_equal,cL.tokens.or_equal,cL.tokens.xor_equal,cL.tokens.shift_right_equal,cL.tokens.shift_left_equal],cL.increment_operators=[cL.tokens.plus_plus,cL.tokens.minus_minus];class cO{constructor(e,t,i,r,n){this.type=e,this.lexeme=t,this.line=i,this.start=r,this.end=n}toString(){return this.lexeme}isTemplateType(){return -1!=cL.template_types.indexOf(this.type)}isArrayType(){return this.type==cL.keywords.array}isArrayOrTemplateType(){return this.isArrayType()||this.isTemplateType()}}class cR{constructor(e){this._tokens=[],this._start=0,this._current=0,this._line=1,this._source=null!=e?e:""}scanTokens(){for(;!this._isAtEnd();)if(this._start=this._current,!this.scanToken())throw`Invalid syntax at line ${this._line}`;return this._tokens.push(new cO(cL.eof,"",this._line,this._current,this._current)),this._tokens}scanToken(){let e=this._advance();if("\n"==e)return this._line++,!0;if(this._isWhitespace(e))return!0;if("/"==e){if("/"==this._peekAhead()){for(;"\n"!=e;){if(this._isAtEnd())return!0;e=this._advance()}return this._line++,!0}if("*"==this._peekAhead()){this._advance();let t=1;for(;t>0&&!this._isAtEnd();)if("\n"==(e=this._advance()))this._line++;else if("*"==e){if("/"==this._peekAhead()&&(this._advance(),0==--t))break}else"/"==e&&"*"==this._peekAhead()&&(this._advance(),t++);return!0}}let t=cL.simpleTokens[e];if(t)return this._addToken(t),!0;let i=cL.none,r=this._isAlpha(e),n="_"===e;if(this._isAlphaNumeric(e)){let t=this._peekAhead();for(;this._isAlphaNumeric(t);)e+=this._advance(),t=this._peekAhead()}if(r){let t=cL.keywords[e];if(t)return this._addToken(t),!0}if(r||n)return this._addToken(cL.tokens.ident),!0;for(;;){let t=this._findType(e),r=this._peekAhead();if("-"==e&&this._tokens.length>0){if("="==r)return this._current++,e+=r,this._addToken(cL.tokens.minus_equal),!0;if("-"==r)return this._current++,e+=r,this._addToken(cL.tokens.minus_minus),!0;let i=this._tokens.length-1;if((-1!=cL.literal_or_ident.indexOf(this._tokens[i].type)||this._tokens[i].type==cL.tokens.paren_right)&&">"!=r)return this._addToken(t),!0}if(">"==e&&(">"==r||"="==r)){let e=!1,i=this._tokens.length-1;for(let t=0;t<5&&i>=0&&-1===cL.assignment_operators.indexOf(this._tokens[i].type);++t,--i)if(this._tokens[i].type===cL.tokens.less_than){i>0&&this._tokens[i-1].isArrayOrTemplateType()&&(e=!0);break}if(e)return this._addToken(t),!0}if(t===cL.none){let r=e,n=0;for(let e=0;e<2;++e)if(r+=this._peekAhead(e),(t=this._findType(r))!==cL.none){n=e;break}if(t===cL.none)return i!==cL.none&&(this._current--,this._addToken(i),!0);e=r,this._current+=n+1}if(i=t,this._isAtEnd())break;e+=this._advance()}return i!==cL.none&&(this._addToken(i),!0)}_findType(e){for(let t in cL.regexTokens){let i=cL.regexTokens[t];if(this._match(e,i.rule))return i}return cL.literalTokens[e]||cL.none}_match(e,t){let i=t.exec(e);return i&&0==i.index&&i[0]==e}_isAtEnd(){return this._current>=this._source.length}_isAlpha(e){return!this._isNumeric(e)&&!this._isWhitespace(e)&&"_"!==e&&"."!==e&&"("!==e&&")"!==e&&"["!==e&&"]"!==e&&"{"!==e&&"}"!==e&&","!==e&&";"!==e&&":"!==e&&"="!==e&&"!"!==e&&"<"!==e&&">"!==e&&"+"!==e&&"-"!==e&&"*"!==e&&"/"!==e&&"%"!==e&&"&"!==e&&"|"!==e&&"^"!==e&&"~"!==e&&"@"!==e&&"#"!==e&&"?"!==e&&"'"!==e&&"`"!==e&&'"'!==e&&"\\"!==e&&"\n"!==e&&"\r"!==e&&"	"!==e&&"\0"!==e}_isNumeric(e){return e>="0"&&e<="9"}_isAlphaNumeric(e){return this._isAlpha(e)||this._isNumeric(e)||"_"===e}_isWhitespace(e){return" "==e||"	"==e||"\r"==e}_advance(e=0){let t=this._source[this._current];return e=e||0,e++,this._current+=e,t}_peekAhead(e=0){return e=e||0,this._current+e>=this._source.length?"\0":this._source[this._current+e]}_addToken(e){let t=this._source.substring(this._start,this._current);this._tokens.push(new cO(e,t,this._line,this._start,this._current))}}function cD(e){return Array.isArray(e)||(null==e?void 0:e.buffer)instanceof ArrayBuffer}let cF=new Float32Array(1),cN=new Uint32Array(cF.buffer),cj=new Uint32Array(cF.buffer),cz=new Int32Array(1),cU=new Float32Array(cz.buffer),cB=new Uint32Array(cz.buffer),c$=new Uint32Array(1),cV=new Float32Array(c$.buffer),cW=new Int32Array(c$.buffer);function cG(e,t,i){if(t===i)return e;if("f32"===t){if("i32"===i||"x32"===i)return cF[0]=e,cN[0];if("u32"===i)return cF[0]=e,cj[0]}else if("i32"===t||"x32"===t){if("f32"===i)return cz[0]=e,cU[0];if("u32"===i)return cz[0]=e,cB[0]}else if("u32"===t){if("f32"===i)return c$[0]=e,cV[0];if("i32"===i||"x32"===i)return c$[0]=e,cW[0]}return console.error(`Unsupported cast from ${t} to ${i}`),e}class cq{constructor(e){this.resources=null,this.inUse=!1,this.info=null,this.node=e}}class cH{constructor(e,t){this.align=e,this.size=t}}class cY{constructor(){this.uniforms=[],this.storage=[],this.textures=[],this.samplers=[],this.aliases=[],this.overrides=[],this.structs=[],this.entry=new uw,this.functions=[],this._types=new Map,this._functions=new Map}_isStorageTexture(e){return"texture_storage_1d"==e.name||"texture_storage_2d"==e.name||"texture_storage_2d_array"==e.name||"texture_storage_3d"==e.name}updateAST(e){for(let t of e)t instanceof uN&&this._functions.set(t.name,new cq(t));for(let t of e)if(t instanceof u9){let e=this.getTypeInfo(t,null);e instanceof uh&&this.structs.push(e)}for(let t of e)if(t instanceof u2)this.aliases.push(this._getAliasInfo(t));else{if(t instanceof uV){let e=this._getAttributeNum(t.attributes,"id",0),i=null!=t.type?this.getTypeInfo(t.type,t.attributes):null;this.overrides.push(new uv(t.name,i,t.attributes,e));continue}if(this._isUniformVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),n=new ug(t.name,r,e,i,t.attributes,T.Uniform,t.access);n.access||(n.access="read"),this.uniforms.push(n);continue}if(this._isStorageVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),n=this._isStorageTexture(r),s=new ug(t.name,r,e,i,t.attributes,n?T.StorageTexture:T.Storage,t.access);s.access||(s.access="read"),this.storage.push(s);continue}if(this._isTextureVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),n=this._isStorageTexture(r),s=new ug(t.name,r,e,i,t.attributes,n?T.StorageTexture:T.Texture,t.access);s.access||(s.access="read"),n?this.storage.push(s):this.textures.push(s);continue}if(this._isSamplerVar(t)){let e=this._getAttributeNum(t.attributes,"group",0),i=this._getAttributeNum(t.attributes,"binding",0),r=this.getTypeInfo(t.type,t.attributes),n=new ug(t.name,r,e,i,t.attributes,T.Sampler,t.access);this.samplers.push(n);continue}}for(let t of e)if(t instanceof uN){let e=this._getAttribute(t,"vertex"),i=this._getAttribute(t,"fragment"),r=this._getAttribute(t,"compute"),n=e||i||r,s=new ux(t.name,null==n?void 0:n.name,t.attributes);s.attributes=t.attributes,s.startLine=t.startLine,s.endLine=t.endLine,this.functions.push(s),this._functions.get(t.name).info=s,n&&(this._functions.get(t.name).inUse=!0,s.inUse=!0,s.resources=this._findResources(t,!!n),s.inputs=this._getInputs(t.args),s.outputs=this._getOutputs(t.returnType),this.entry[n.name].push(s)),s.arguments=t.args.map(e=>new ub(e.name,this.getTypeInfo(e.type,e.attributes),e.attributes)),s.returnType=t.returnType?this.getTypeInfo(t.returnType,t.attributes):null;continue}for(let e of this._functions.values())e.info&&(e.info.inUse=e.inUse,this._addCalls(e.node,e.info.calls));for(let e of this._functions.values())e.node.search(t=>{var i,r,n;if(t instanceof cw){if(t.value)if(cD(t.value))for(let r of t.value)for(let t of this.overrides)r===t.name&&(null==(i=e.info)||i.overrides.push(t));else for(let i of this.overrides)t.value===i.name&&(null==(r=e.info)||r.overrides.push(i))}else if(t instanceof ca)for(let i of this.overrides)t.name===i.name&&(null==(n=e.info)||n.overrides.push(i))});for(let e of this.uniforms)this._markStructsInUse(e.type);for(let e of this.storage)this._markStructsInUse(e.type)}getFunctionInfo(e){for(let t of this.functions)if(t.name==e)return t;return null}getStructInfo(e){for(let t of this.structs)if(t.name==e)return t;return null}getOverrideInfo(e){for(let t of this.overrides)if(t.name==e)return t;return null}_markStructsInUse(e){if(e)if(e.isStruct){if(e.inUse=!0,e.members)for(let t of e.members)this._markStructsInUse(t.type)}else if(e.isArray)this._markStructsInUse(e.format);else if(e.isTemplate)e.format&&this._markStructsInUse(e.format);else{let t=this._getAlias(e.name);t&&this._markStructsInUse(t)}}_addCalls(e,t){var i;for(let r of e.calls){let e=null==(i=this._functions.get(r.name))?void 0:i.info;e&&t.add(e)}}findResource(e,t,i){if(i){for(let r of this.entry.compute)if(r.name===i){for(let i of r.resources)if(i.group==e&&i.binding==t)return i}for(let r of this.entry.vertex)if(r.name===i){for(let i of r.resources)if(i.group==e&&i.binding==t)return i}for(let r of this.entry.fragment)if(r.name===i){for(let i of r.resources)if(i.group==e&&i.binding==t)return i}}for(let i of this.uniforms)if(i.group==e&&i.binding==t)return i;for(let i of this.storage)if(i.group==e&&i.binding==t)return i;for(let i of this.textures)if(i.group==e&&i.binding==t)return i;for(let i of this.samplers)if(i.group==e&&i.binding==t)return i;return null}_findResource(e){for(let t of this.uniforms)if(t.name==e)return t;for(let t of this.storage)if(t.name==e)return t;for(let t of this.textures)if(t.name==e)return t;for(let t of this.samplers)if(t.name==e)return t;return null}_markStructsFromAST(e){let t=this.getTypeInfo(e,null);this._markStructsInUse(t)}_findResources(e,t){let i=[],r=this,n=[];return e.search(s=>{if(s instanceof uO)n.push({});else if(s instanceof uR)n.pop();else if(s instanceof u$)t&&null!==s.type&&this._markStructsFromAST(s.type),n.length>0&&(n[n.length-1][s.name]=s);else if(s instanceof cs)t&&null!==s.type&&this._markStructsFromAST(s.type);else if(s instanceof uW)t&&null!==s.type&&this._markStructsFromAST(s.type),n.length>0&&(n[n.length-1][s.name]=s);else if(s instanceof ca){if(n.length>0&&n[n.length-1][s.name])return;let e=r._findResource(s.name);e&&i.push(e)}else if(s instanceof co){let n=r._functions.get(s.name);n&&(t&&(n.inUse=!0),e.calls.add(n.node),null===n.resources&&(n.resources=r._findResources(n.node,t)),i.push(...n.resources))}else if(s instanceof uY){let n=r._functions.get(s.name);n&&(t&&(n.inUse=!0),e.calls.add(n.node),null===n.resources&&(n.resources=r._findResources(n.node,t)),i.push(...n.resources))}}),[...new Map(i.map(e=>[e.name,e])).values()]}getBindGroups(){let e=[];function t(t,i){t>=e.length&&(e.length=t+1),void 0===e[t]&&(e[t]=[]),i>=e[t].length&&(e[t].length=i+1)}for(let i of this.uniforms)t(i.group,i.binding),e[i.group][i.binding]=i;for(let i of this.storage)t(i.group,i.binding),e[i.group][i.binding]=i;for(let i of this.textures)t(i.group,i.binding),e[i.group][i.binding]=i;for(let i of this.samplers)t(i.group,i.binding),e[i.group][i.binding]=i;return e}_getOutputs(e,t){if(void 0===t&&(t=[]),e instanceof u9)this._getStructOutputs(e,t);else{let i=this._getOutputInfo(e);null!==i&&t.push(i)}return t}_getStructOutputs(e,t){for(let i of e.members)if(i.type instanceof u9)this._getStructOutputs(i.type,t);else{let e=this._getAttribute(i,"location")||this._getAttribute(i,"builtin");if(null!==e){let r=this.getTypeInfo(i.type,i.type.attributes),n=this._parseInt(e.value),s=new u_(i.name,r,e.name,n);t.push(s)}}}_getOutputInfo(e){let t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){let i=this.getTypeInfo(e,e.attributes),r=this._parseInt(t.value);return new u_("",i,t.name,r)}return null}_getInputs(e,t){for(let i of(void 0===t&&(t=[]),e))if(i.type instanceof u9)this._getStructInputs(i.type,t);else{let e=this._getInputInfo(i);null!==e&&t.push(e)}return t}_getStructInputs(e,t){for(let i of e.members)if(i.type instanceof u9)this._getStructInputs(i.type,t);else{let e=this._getInputInfo(i);null!==e&&t.push(e)}}_getInputInfo(e){let t=this._getAttribute(e,"location")||this._getAttribute(e,"builtin");if(null!==t){let i=this._getAttribute(e,"interpolation"),r=this.getTypeInfo(e.type,e.attributes),n=this._parseInt(t.value),s=new uy(e.name,r,t.name,n);return null!==i&&(s.interpolation=this._parseString(i.value)),s}return null}_parseString(e){return e instanceof Array&&(e=e[0]),e}_parseInt(e){e instanceof Array&&(e=e[0]);let t=parseInt(e);return isNaN(t)?e:t}_getAlias(e){for(let t of this.aliases)if(t.name==e)return t.type;return null}_getAliasInfo(e){return new um(e.name,this.getTypeInfo(e.type,null))}getTypeInfoByName(e){for(let t of this.structs)if(t.name==e)return t;for(let t of this.aliases)if(t.name==e)return t.type;return null}getTypeInfo(e,t=null){if(this._types.has(e))return this._types.get(e);if(e instanceof ce){let i=e.type?this.getTypeInfo(e.type,e.attributes):null,r=new uf(e.name,i,t);return this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof ct){let i=e.format?this.getTypeInfo(e.format,e.attributes):null,r=new ud(e.name,t);return r.format=i,r.count=e.count,this._types.set(e,r),this._updateTypeInfo(r),r}if(e instanceof u9){let i=new uh(e.name,t);for(let t of(i.startLine=e.startLine,i.endLine=e.endLine,e.members)){let e=this.getTypeInfo(t.type,t.attributes);i.members.push(new uc(t.name,e,t.attributes))}return this._types.set(e,i),this._updateTypeInfo(i),i}if(e instanceof ci){let i=e.format instanceof u5,r=e.format?i?this.getTypeInfo(e.format,null):new uu(e.format,null):null,n=new up(e.name,r,t,e.access);return this._types.set(e,n),this._updateTypeInfo(n),n}if(e instanceof u7){let i=e.format?this.getTypeInfo(e.format,null):null,r=new up(e.name,i,t,e.access);return this._types.set(e,r),this._updateTypeInfo(r),r}let i=new uu(e.name,t);return this._types.set(e,i),this._updateTypeInfo(i),i}_updateTypeInfo(e){var t,i,r;let n=this._getTypeSize(e);if(e.size=null!=(t=null==n?void 0:n.size)?t:0,e instanceof ud&&e.format){let t=this._getTypeSize(e.format);e.stride=Math.max(null!=(i=null==t?void 0:t.size)?i:0,null!=(r=null==t?void 0:t.align)?r:0),this._updateTypeInfo(e.format)}e instanceof uf&&this._updateTypeInfo(e.format),e instanceof uh&&this._updateStructInfo(e)}_updateStructInfo(e){let t=0,i=0,r=0,n=0;for(let s=0,o=e.members.length;s<o;++s){let o=e.members[s],a=this._getTypeSize(o);if(!a)continue;null!=this._getAlias(o.type.name)||o.type;let l=a.align,u=a.size;t=this._roundUp(l,t+i),i=u,r=t,n=Math.max(n,l),o.offset=t,o.size=u,this._updateTypeInfo(o.type)}e.size=this._roundUp(n,r+i),e.align=n}_getTypeSize(e){var t,i;if(null==e)return null;let r=this._getAttributeNum(e.attributes,"size",0),n=this._getAttributeNum(e.attributes,"align",0);if(e instanceof uc&&(e=e.type),e instanceof uu){let t=this._getAlias(e.name);null!==t&&(e=t)}{let i=cY._typeInfo[e.name];if(void 0!==i){let s="f16"===(null==(t=e.format)?void 0:t.name)?2:1;return new cH(Math.max(n,i.align/s),Math.max(r,i.size/s))}}{let t=cY._typeInfo[e.name.substring(0,e.name.length-1)];if(t){let i="h"===e.name[e.name.length-1]?2:1;return new cH(Math.max(n,t.align/i),Math.max(r,t.size/i))}}if(e instanceof ud){let t=e,s=8,o=8,a=this._getTypeSize(t.format);return null!==a&&(o=a.size,s=a.align),o=t.count*this._getAttributeNum(null!=(i=null==e?void 0:e.attributes)?i:null,"stride",this._roundUp(s,o)),r&&(o=r),new cH(Math.max(n,s),Math.max(r,o))}if(e instanceof uh){let t=0,i=0,s=0,o=0,a=0;for(let i of e.members){let e=this._getTypeSize(i.type);null!==e&&(t=Math.max(e.align,t),s=this._roundUp(e.align,s+o),o=e.size,a=s)}return i=this._roundUp(t,a+o),new cH(Math.max(n,t),Math.max(r,i))}return null}_isUniformVar(e){return e instanceof u$&&"uniform"==e.storage}_isStorageVar(e){return e instanceof u$&&"storage"==e.storage}_isTextureVar(e){return e instanceof u$&&null!==e.type&&-1!=cY._textureTypes.indexOf(e.type.name)}_isSamplerVar(e){return e instanceof u$&&null!==e.type&&-1!=cY._samplerTypes.indexOf(e.type.name)}_getAttribute(e,t){if(!e||!e.attributes)return null;for(let i of e.attributes)if(i.name==t)return i;return null}_getAttributeNum(e,t,i){if(null===e)return i;for(let r of e)if(r.name==t){let e=null!==r&&null!==r.value?r.value:i;return e instanceof Array&&(e=e[0]),"number"==typeof e?e:"string"==typeof e?parseInt(e):i}return i}_roundUp(e,t){return Math.ceil(t/e)*e}}cY._typeInfo={f16:{align:2,size:2},i32:{align:4,size:4},u32:{align:4,size:4},f32:{align:4,size:4},atomic:{align:4,size:4},vec2:{align:8,size:8},vec3:{align:16,size:12},vec4:{align:16,size:16},mat2x2:{align:8,size:16},mat3x2:{align:8,size:24},mat4x2:{align:8,size:32},mat2x3:{align:16,size:32},mat3x3:{align:16,size:48},mat4x3:{align:16,size:64},mat2x4:{align:16,size:32},mat3x4:{align:16,size:48},mat4x4:{align:16,size:64}},cY._textureTypes=cL.any_texture_type.map(e=>e.name),cY._samplerTypes=cL.sampler_type.map(e=>e.name);let cX=0;class cZ{constructor(e,t,i){this.id=cX++,this.name=e,this.value=t,this.node=i}clone(){return new cZ(this.name,this.value,this.node)}}class cK{constructor(e){this.id=cX++,this.name=e.name,this.node=e}clone(){return new cK(this.node)}}class cJ{constructor(e){this.parent=null,this.variables=new Map,this.functions=new Map,this.currentFunctionName="",this.id=cX++,e&&(this.parent=e,this.currentFunctionName=e.currentFunctionName)}getVariable(e){var t;return this.variables.has(e)?null!=(t=this.variables.get(e))?t:null:this.parent?this.parent.getVariable(e):null}getFunction(e){var t;return this.functions.has(e)?null!=(t=this.functions.get(e))?t:null:this.parent?this.parent.getFunction(e):null}createVariable(e,t,i){this.variables.set(e,new cZ(e,t,null!=i?i:null))}setVariable(e,t,i){let r=this.getVariable(e);null!==r?r.value=t:this.createVariable(e,t,i)}getVariableValue(e){var t;let i=this.getVariable(e);return null!=(t=null==i?void 0:i.value)?t:null}clone(){return new cJ(this)}}class cQ{evalExpression(e,t){return null}getTypeInfo(e){return null}getVariableName(e,t){return""}}class c0{constructor(e){this.exec=e}getTypeInfo(e){return this.exec.getTypeInfo(e)}All(e,t){let i=this.exec.evalExpression(e.args[0],t),r=!0;if(i instanceof cE)return i.data.forEach(e=>{e||(r=!1)}),new cP(+!!r,this.getTypeInfo("bool"));throw Error(`All() expects a vector argument. Line ${e.line}`)}Any(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof cE)return new cP(+!!i.data.some(e=>e),this.getTypeInfo("bool"));throw Error(`Any() expects a vector argument. Line ${e.line}`)}Select(e,t){let i=this.exec.evalExpression(e.args[2],t);if(!(i instanceof cP))throw Error(`Select() expects a bool condition. Line ${e.line}`);return i.value?this.exec.evalExpression(e.args[1],t):this.exec.evalExpression(e.args[0],t)}ArrayLength(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.evalExpression(i,t);if(r instanceof cI&&0===r.typeInfo.size){let e=r.typeInfo;return new cP(r.buffer.byteLength/e.stride,this.getTypeInfo("u32"))}return new cP(r.typeInfo.size,this.getTypeInfo("u32"))}Abs(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.abs(e)),i.typeInfo):new cP(Math.abs(i.value),i.typeInfo)}Acos(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.acos(e)),i.typeInfo):new cP(Math.acos(i.value),i.typeInfo)}Acosh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.acosh(e)),i.typeInfo):new cP(Math.acosh(i.value),i.typeInfo)}Asin(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.asin(e)),i.typeInfo):new cP(Math.asin(i.value),i.typeInfo)}Asinh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.asinh(e)),i.typeInfo):new cP(Math.asinh(i.value),i.typeInfo)}Atan(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.atan(e)),i.typeInfo):new cP(Math.atan(i.value),i.typeInfo)}Atanh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.atanh(e)),i.typeInfo):new cP(Math.atanh(i.value),i.typeInfo)}Atan2(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof cE&&r instanceof cE?new cE(i.data.map((e,t)=>Math.atan2(e,r.data[t])),i.typeInfo):new cP(Math.atan2(i.value,r.value),i.typeInfo)}Ceil(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.ceil(e)),i.typeInfo):new cP(Math.ceil(i.value),i.typeInfo)}_clamp(e,t,i){return Math.min(Math.max(e,t),i)}Clamp(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t);return i instanceof cE&&r instanceof cE&&n instanceof cE?new cE(i.data.map((e,t)=>this._clamp(e,r.data[t],n.data[t])),i.typeInfo):new cP(this._clamp(i.value,r.value,n.value),i.typeInfo)}Cos(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.cos(e)),i.typeInfo):new cP(Math.cos(i.value),i.typeInfo)}Cosh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.cosh(e)),i.typeInfo):new cP(Math.cos(i.value),i.typeInfo)}CountLeadingZeros(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.clz32(e)),i.typeInfo):new cP(Math.clz32(i.value),i.typeInfo)}_countOneBits(e){let t=0;for(;0!==e;)1&e&&t++,e>>=1;return t}CountOneBits(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>this._countOneBits(e)),i.typeInfo):new cP(this._countOneBits(i.value),i.typeInfo)}_countTrailingZeros(e){if(0===e)return 32;let t=0;for(;!(1&e);)e>>=1,t++;return t}CountTrailingZeros(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>this._countTrailingZeros(e)),i.typeInfo):new cP(this._countTrailingZeros(i.value),i.typeInfo)}Cross(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof cE&&r instanceof cE){if(3!==i.data.length||3!==r.data.length)return console.error(`Cross() expects 3D vectors. Line ${e.line}`),null;let t=i.data,n=r.data;return new cE([t[1]*n[2]-n[1]*t[2],t[2]*n[0]-n[2]*t[0],t[0]*n[1]-n[0]*t[1]],i.typeInfo)}return console.error(`Cross() expects vector arguments. Line ${e.line}`),null}Degrees(e,t){let i=this.exec.evalExpression(e.args[0],t),r=180/Math.PI;return i instanceof cE?new cE(i.data.map(e=>e*r),i.typeInfo):new cP(i.value*r,this.getTypeInfo("f32"))}Determinant(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof cC){let e=i.data,t=i.typeInfo.getTypeName(),r=t.endsWith("h")?this.getTypeInfo("f16"):this.getTypeInfo("f32");if("mat2x2"===t||"mat2x2f"===t||"mat2x2h"===t)return new cP(e[0]*e[3]-e[1]*e[2],r);if("mat2x3"===t||"mat2x3f"===t||"mat2x3h"===t)return new cP(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);if("mat2x4"===t||"mat2x4f"===t||"mat2x4h"===t)console.error(`TODO: Determinant for ${t}`);else if("mat3x2"===t||"mat3x2f"===t||"mat3x2h"===t)console.error(`TODO: Determinant for ${t}`);else{if("mat3x3"===t||"mat3x3f"===t||"mat3x3h"===t)return new cP(e[0]*(e[4]*e[8]-e[5]*e[7])-e[1]*(e[3]*e[8]-e[5]*e[6])+e[2]*(e[3]*e[7]-e[4]*e[6]),r);"mat3x4"===t||"mat3x4f"===t||"mat3x4h"===t||"mat4x2"===t||"mat4x2f"===t||"mat4x2h"===t||"mat4x3"===t||"mat4x3f"===t||"mat4x3h"===t?console.error(`TODO: Determinant for ${t}`):"mat4x4"!==t&&"mat4x4f"!==t&&"mat4x4h"!==t||console.error(`TODO: Determinant for ${t}`)}}return console.error(`Determinant expects a matrix argument. Line ${e.line}`),null}Distance(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof cE&&r instanceof cE){let e=0;for(let t=0;t<i.data.length;++t)e+=(i.data[t]-r.data[t])*(i.data[t]-r.data[t]);return new cP(Math.sqrt(e),this.getTypeInfo("f32"))}return new cP(Math.abs(i.value-r.value),i.typeInfo)}_dot(e,t){let i=0;for(let r=0;r<e.length;++r)i+=t[r]*e[r];return i}Dot(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof cE&&r instanceof cE?new cP(this._dot(i.data,r.data),this.getTypeInfo("f32")):(console.error(`Dot() expects vector arguments. Line ${e.line}`),null)}Dot4U8Packed(e,t){return console.error(`TODO: dot4U8Packed. Line ${e.line}`),null}Dot4I8Packed(e,t){return console.error(`TODO: dot4I8Packed. Line ${e.line}`),null}Exp(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.exp(e)),i.typeInfo):new cP(Math.exp(i.value),i.typeInfo)}Exp2(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.pow(2,e)),i.typeInfo):new cP(Math.pow(2,i.value),i.typeInfo)}ExtractBits(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t);if("u32"!==r.typeInfo.name&&"x32"!==r.typeInfo.name)return console.error(`ExtractBits() expects an i32 offset argument. Line ${e.line}`),null;if("u32"!==n.typeInfo.name&&"x32"!==n.typeInfo.name)return console.error(`ExtractBits() expects an i32 count argument. Line ${e.line}`),null;let s=r.value,o=n.value;return i instanceof cE?new cE(i.data.map(e=>e>>s&(1<<o)-1),i.typeInfo):"i32"!==i.typeInfo.name&&"x32"!==i.typeInfo.name?(console.error(`ExtractBits() expects an i32 argument. Line ${e.line}`),null):new cP(i.value>>s&(1<<o)-1,this.getTypeInfo("i32"))}FaceForward(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t);return i instanceof cE&&r instanceof cE&&n instanceof cE?new cE(0>this._dot(r.data,n.data)?Array.from(i.data):i.data.map(e=>-e),i.typeInfo):(console.error(`FaceForward() expects vector arguments. Line ${e.line}`),null)}_firstLeadingBit(e){return 0===e?-1:31-Math.clz32(e)}FirstLeadingBit(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>this._firstLeadingBit(e)),i.typeInfo):new cP(this._firstLeadingBit(i.value),i.typeInfo)}_firstTrailingBit(e){return 0===e?-1:Math.log2(e&-e)}FirstTrailingBit(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>this._firstTrailingBit(e)),i.typeInfo):new cP(this._firstTrailingBit(i.value),i.typeInfo)}Floor(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.floor(e)),i.typeInfo):new cP(Math.floor(i.value),i.typeInfo)}Fma(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t);return i instanceof cE&&r instanceof cE&&n instanceof cE?i.data.length!==r.data.length||i.data.length!==n.data.length?(console.error(`Fma() expects vectors of the same length. Line ${e.line}`),null):new cE(i.data.map((e,t)=>e*r.data[t]+n.data[t]),i.typeInfo):new cP(i.value*r.value+n.value,i.typeInfo)}Fract(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>e-Math.floor(e)),i.typeInfo):new cP(i.value-Math.floor(i.value),i.typeInfo)}Frexp(e,t){return console.error(`TODO: frexp. Line ${e.line}`),null}InsertBits(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t),s=this.exec.evalExpression(e.args[3],t);if("u32"!==n.typeInfo.name&&"x32"!==n.typeInfo.name)return console.error(`InsertBits() expects an i32 offset argument. Line ${e.line}`),null;let o=n.value,a=(1<<s.value)-1<<o,l=~a;return i instanceof cE&&r instanceof cE?new cE(i.data.map((e,t)=>e&l|r.data[t]<<o&a),i.typeInfo):new cP(i.value&l|r.value<<o&a,i.typeInfo)}InverseSqrt(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>1/Math.sqrt(e)),i.typeInfo):new cP(1/Math.sqrt(i.value),i.typeInfo)}Ldexp(e,t){return console.error(`TODO: ldexp. Line ${e.line}`),null}Length(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof cE){let e=0;return i.data.forEach(t=>{e+=t*t}),new cP(Math.sqrt(e),this.getTypeInfo("f32"))}return new cP(Math.abs(i.value),i.typeInfo)}Log(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.log(e)),i.typeInfo):new cP(Math.log(i.value),i.typeInfo)}Log2(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.log2(e)),i.typeInfo):new cP(Math.log2(i.value),i.typeInfo)}Max(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof cE&&r instanceof cE?new cE(i.data.map((e,t)=>Math.max(e,r.data[t])),i.typeInfo):new cP(Math.max(i.value,r.value),i.typeInfo)}Min(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof cE&&r instanceof cE?new cE(i.data.map((e,t)=>Math.min(e,r.data[t])),i.typeInfo):new cP(Math.min(i.value,r.value),i.typeInfo)}Mix(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t);return i instanceof cE&&r instanceof cE&&n instanceof cE?new cE(i.data.map((e,t)=>i.data[t]*(1-n.data[t])+r.data[t]*n.data[t]),i.typeInfo):new cP(i.value*(1-n.value)+r.value*n.value,i.typeInfo)}Modf(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof cE&&r instanceof cE?new cE(i.data.map((e,t)=>e%r.data[t]),i.typeInfo):new cP(i.value%r.value,i.typeInfo)}Normalize(e,t){let i=this.exec.evalExpression(e.args[0],t);if(i instanceof cE){let r=this.Length(e,t).value;return new cE(i.data.map(e=>e/r),i.typeInfo)}return console.error(`Normalize() expects a vector argument. Line ${e.line}`),null}Pow(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return i instanceof cE&&r instanceof cE?new cE(i.data.map((e,t)=>Math.pow(e,r.data[t])),i.typeInfo):new cP(Math.pow(i.value,r.value),i.typeInfo)}QuantizeToF16(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>e),i.typeInfo):new cP(i.value,i.typeInfo)}Radians(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>e*Math.PI/180),i.typeInfo):new cP(i.value*Math.PI/180,this.getTypeInfo("f32"))}Reflect(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);if(i instanceof cE&&r instanceof cE){let e=this._dot(i.data,r.data);return new cE(i.data.map((t,i)=>t-2*e*r.data[i]),i.typeInfo)}return console.error(`Reflect() expects vector arguments. Line ${e.line}`),null}Refract(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t);if(i instanceof cE&&r instanceof cE&&n instanceof cP){let e=this._dot(r.data,i.data);return new cE(i.data.map((t,i)=>{let s=1-n.value*n.value*(1-e*e);if(s<0)return 0;let o=Math.sqrt(s);return n.value*t-(n.value*e+o)*r.data[i]}),i.typeInfo)}return console.error(`Refract() expects vector arguments and a scalar argument. Line ${e.line}`),null}ReverseBits(e,t){return console.error(`TODO: reverseBits. Line ${e.line}`),null}Round(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.round(e)),i.typeInfo):new cP(Math.round(i.value),i.typeInfo)}Saturate(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.min(Math.max(e,0),1)),i.typeInfo):new cP(Math.min(Math.max(i.value,0),1),i.typeInfo)}Sign(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.sign(e)),i.typeInfo):new cP(Math.sign(i.value),i.typeInfo)}Sin(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.sin(e)),i.typeInfo):new cP(Math.sin(i.value),i.typeInfo)}Sinh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.sinh(e)),i.typeInfo):new cP(Math.sinh(i.value),i.typeInfo)}_smoothstep(e,t,i){let r=Math.min(Math.max((i-e)/(t-e),0),1);return r*r*(3-2*r)}SmoothStep(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t),n=this.exec.evalExpression(e.args[2],t);return n instanceof cE&&i instanceof cE&&r instanceof cE?new cE(n.data.map((e,t)=>this._smoothstep(i.data[t],r.data[t],e)),n.typeInfo):new cP(this._smoothstep(i.value,r.value,n.value),n.typeInfo)}Sqrt(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.sqrt(e)),i.typeInfo):new cP(Math.sqrt(i.value),i.typeInfo)}Step(e,t){let i=this.exec.evalExpression(e.args[0],t),r=this.exec.evalExpression(e.args[1],t);return r instanceof cE&&i instanceof cE?new cE(r.data.map((e,t)=>e<i.data[t]?0:1),r.typeInfo):new cP(r.value<i.value?0:1,i.typeInfo)}Tan(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.tan(e)),i.typeInfo):new cP(Math.tan(i.value),i.typeInfo)}Tanh(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.tanh(e)),i.typeInfo):new cP(Math.tanh(i.value),i.typeInfo)}_getTransposeType(e){let t=e.getTypeName();return"mat2x2f"===t||"mat2x2h"===t?e:"mat2x3f"===t?this.getTypeInfo("mat3x2f"):"mat2x3h"===t?this.getTypeInfo("mat3x2h"):"mat2x4f"===t?this.getTypeInfo("mat4x2f"):"mat2x4h"===t?this.getTypeInfo("mat4x2h"):"mat3x2f"===t?this.getTypeInfo("mat2x3f"):"mat3x2h"===t?this.getTypeInfo("mat2x3h"):"mat3x3f"===t||"mat3x3h"===t?e:"mat3x4f"===t?this.getTypeInfo("mat4x3f"):"mat3x4h"===t?this.getTypeInfo("mat4x3h"):"mat4x2f"===t?this.getTypeInfo("mat2x4f"):"mat4x2h"===t?this.getTypeInfo("mat2x4h"):"mat4x3f"===t?this.getTypeInfo("mat3x4f"):"mat4x3h"===t?this.getTypeInfo("mat3x4h"):("mat4x4f"===t||"mat4x4h"===t||console.error(`Invalid matrix type ${t}`),e)}Transpose(e,t){let i=this.exec.evalExpression(e.args[0],t);if(!(i instanceof cC))return console.error(`Transpose() expects a matrix argument. Line ${e.line}`),null;let r=this._getTransposeType(i.typeInfo);if("mat2x2"===i.typeInfo.name||"mat2x2f"===i.typeInfo.name||"mat2x2h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[2],e[1],e[3]],r)}if("mat2x3"===i.typeInfo.name||"mat2x3f"===i.typeInfo.name||"mat2x3h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[3],e[6],e[1],e[4],e[7]],r)}if("mat2x4"===i.typeInfo.name||"mat2x4f"===i.typeInfo.name||"mat2x4h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13]],r)}if("mat3x2"===i.typeInfo.name||"mat3x2f"===i.typeInfo.name||"mat3x2h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[3],e[1],e[4],e[2],e[5]],r)}if("mat3x3"===i.typeInfo.name||"mat3x3f"===i.typeInfo.name||"mat3x3h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]],r)}if("mat3x4"===i.typeInfo.name||"mat3x4f"===i.typeInfo.name||"mat3x4h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14]],r)}if("mat4x2"===i.typeInfo.name||"mat4x2f"===i.typeInfo.name||"mat4x2h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[4],e[1],e[5],e[2],e[6]],r)}if("mat4x3"===i.typeInfo.name||"mat4x3f"===i.typeInfo.name||"mat4x3h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]],r)}if("mat4x4"===i.typeInfo.name||"mat4x4f"===i.typeInfo.name||"mat4x4h"===i.typeInfo.name){let e=i.data;return new cC([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]],r)}return console.error(`Invalid matrix type ${i.typeInfo.name}`),null}Trunc(e,t){let i=this.exec.evalExpression(e.args[0],t);return i instanceof cE?new cE(i.data.map(e=>Math.trunc(e)),i.typeInfo):new cP(Math.trunc(i.value),i.typeInfo)}Dpdx(e,t){return console.error(`TODO: dpdx. Line ${e.line}`),null}DpdxCoarse(e,t){return console.error(`TODO: dpdxCoarse. Line ${e.line}`),null}DpdxFine(e,t){return console.error("TODO: dpdxFine"),null}Dpdy(e,t){return console.error("TODO: dpdy"),null}DpdyCoarse(e,t){return console.error("TODO: dpdyCoarse"),null}DpdyFine(e,t){return console.error("TODO: dpdyFine"),null}Fwidth(e,t){return console.error("TODO: fwidth"),null}FwidthCoarse(e,t){return console.error("TODO: fwidthCoarse"),null}FwidthFine(e,t){return console.error("TODO: fwidthFine"),null}TextureDimensions(e,t){let i=e.args[0],r=e.args.length>1?this.exec.evalExpression(e.args[1],t).value:0;if(i instanceof ca){let n=i.name,s=t.getVariableValue(n);if(s instanceof cA){if(r<0||r>=s.mipLevelCount)return console.error(`Invalid mip level for textureDimensions. Line ${e.line}`),null;let t=s.getMipLevelSize(r),i=s.dimension;return"1d"===i?new cP(t[0],this.getTypeInfo("u32")):"3d"===i?new cE(t,this.getTypeInfo("vec3u")):"2d"===i?new cE(t.slice(0,2),this.getTypeInfo("vec2u")):(console.error(`Invalid texture dimension ${i} not found. Line ${e.line}`),null)}return console.error(`Texture ${n} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureDimensions. Line ${e.line}`),null}TextureGather(e,t){return console.error("TODO: textureGather"),null}TextureGatherCompare(e,t){return console.error("TODO: textureGatherCompare"),null}TextureLoad(e,t){let i=e.args[0],r=this.exec.evalExpression(e.args[1],t),n=e.args.length>2?this.exec.evalExpression(e.args[2],t).value:0;if(!(r instanceof cE)||2!==r.data.length)return console.error(`Invalid UV argument for textureLoad. Line ${e.line}`),null;if(i instanceof ca){let s=i.name,o=t.getVariableValue(s);if(o instanceof cA){let t=Math.floor(r.data[0]),i=Math.floor(r.data[1]);if(t<0||t>=o.width||i<0||i>=o.height)return console.error(`Texture ${s} out of bounds. Line ${e.line}`),null;let a=o.getPixel(t,i,0,n);return null===a?(console.error(`Invalid texture format for textureLoad. Line ${e.line}`),null):new cE(a,this.getTypeInfo("vec4f"))}return console.error(`Texture ${s} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureLoad. Line ${e.line}`),null}TextureNumLayers(e,t){let i=e.args[0];if(i instanceof ca){let r=i.name,n=t.getVariableValue(r);return n instanceof cA?new cP(n.depthOrArrayLayers,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLayers. Line ${e.line}`),null}TextureNumLevels(e,t){let i=e.args[0];if(i instanceof ca){let r=i.name,n=t.getVariableValue(r);return n instanceof cA?new cP(n.mipLevelCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumLevels. Line ${e.line}`),null}TextureNumSamples(e,t){let i=e.args[0];if(i instanceof ca){let r=i.name,n=t.getVariableValue(r);return n instanceof cA?new cP(n.sampleCount,this.getTypeInfo("u32")):(console.error(`Texture ${r} not found. Line ${e.line}`),null)}return console.error(`Invalid texture argument for textureNumSamples. Line ${e.line}`),null}TextureSample(e,t){return console.error("TODO: textureSample"),null}TextureSampleBias(e,t){return console.error("TODO: textureSampleBias"),null}TextureSampleCompare(e,t){return console.error("TODO: textureSampleCompare"),null}TextureSampleCompareLevel(e,t){return console.error("TODO: textureSampleCompareLevel"),null}TextureSampleGrad(e,t){return console.error("TODO: textureSampleGrad"),null}TextureSampleLevel(e,t){return console.error("TODO: textureSampleLevel"),null}TextureSampleBaseClampToEdge(e,t){return console.error("TODO: textureSampleBaseClampToEdge"),null}TextureStore(e,t){let i=e.args[0],r=this.exec.evalExpression(e.args[1],t),n=4===e.args.length?this.exec.evalExpression(e.args[2],t).value:0,s=4===e.args.length?this.exec.evalExpression(e.args[3],t).data:this.exec.evalExpression(e.args[2],t).data;if(4!==s.length)return console.error(`Invalid value argument for textureStore. Line ${e.line}`),null;if(!(r instanceof cE)||2!==r.data.length)return console.error(`Invalid UV argument for textureStore. Line ${e.line}`),null;if(i instanceof ca){let o=i.name,a=t.getVariableValue(o);if(a instanceof cA){let t=a.getMipLevelSize(0),i=Math.floor(r.data[0]),l=Math.floor(r.data[1]);return i<0||i>=t[0]||l<0||l>=t[1]?console.error(`Texture ${o} out of bounds. Line ${e.line}`):a.setPixel(i,l,0,n,Array.from(s)),null}return console.error(`Texture ${o} not found. Line ${e.line}`),null}return console.error(`Invalid texture argument for textureStore. Line ${e.line}`),null}AtomicLoad(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t);return t.getVariable(r).value.getSubData(this.exec,i.postfix,t)}AtomicStore(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t);return a instanceof cP&&o instanceof cP&&(a.value=o.value),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),null}AtomicAdd(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value+=o.value),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicSub(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value-=o.value),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicMax(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value=Math.max(a.value,o.value)),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicMin(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value=Math.min(a.value,o.value)),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicAnd(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value=a.value&o.value),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicOr(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value=a.value|o.value),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicXor(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value=a.value^o.value),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicExchange(e,t){let i=e.args[0];i instanceof cf&&(i=i.right);let r=this.exec.getVariableName(i,t),n=t.getVariable(r),s=e.args[1],o=this.exec.evalExpression(s,t),a=n.value.getSubData(this.exec,i.postfix,t),l=new cP(a.value,a.typeInfo);return a instanceof cP&&o instanceof cP&&(a.value=o.value),n.value instanceof cI&&n.value.setDataValue(this.exec,a,i.postfix,t),l}AtomicCompareExchangeWeak(e,t){return console.error("TODO: atomicCompareExchangeWeak"),null}Pack4x8snorm(e,t){return console.error("TODO: pack4x8snorm"),null}Pack4x8unorm(e,t){return console.error("TODO: pack4x8unorm"),null}Pack4xI8(e,t){return console.error("TODO: pack4xI8"),null}Pack4xU8(e,t){return console.error("TODO: pack4xU8"),null}Pack4x8Clamp(e,t){return console.error("TODO: pack4x8Clamp"),null}Pack4xU8Clamp(e,t){return console.error("TODO: pack4xU8Clamp"),null}Pack2x16snorm(e,t){return console.error("TODO: pack2x16snorm"),null}Pack2x16unorm(e,t){return console.error("TODO: pack2x16unorm"),null}Pack2x16float(e,t){return console.error("TODO: pack2x16float"),null}Unpack4x8snorm(e,t){return console.error("TODO: unpack4x8snorm"),null}Unpack4x8unorm(e,t){return console.error("TODO: unpack4x8unorm"),null}Unpack4xI8(e,t){return console.error("TODO: unpack4xI8"),null}Unpack4xU8(e,t){return console.error("TODO: unpack4xU8"),null}Unpack2x16snorm(e,t){return console.error("TODO: unpack2x16snorm"),null}Unpack2x16unorm(e,t){return console.error("TODO: unpack2x16unorm"),null}Unpack2x16float(e,t){return console.error("TODO: unpack2x16float"),null}StorageBarrier(e,t){return null}TextureBarrier(e,t){return null}WorkgroupBarrier(e,t){return null}WorkgroupUniformLoad(e,t){return null}SubgroupAdd(e,t){return console.error("TODO: subgroupAdd"),null}SubgroupExclusiveAdd(e,t){return console.error("TODO: subgroupExclusiveAdd"),null}SubgroupInclusiveAdd(e,t){return console.error("TODO: subgroupInclusiveAdd"),null}SubgroupAll(e,t){return console.error("TODO: subgroupAll"),null}SubgroupAnd(e,t){return console.error("TODO: subgroupAnd"),null}SubgroupAny(e,t){return console.error("TODO: subgroupAny"),null}SubgroupBallot(e,t){return console.error("TODO: subgroupBallot"),null}SubgroupBroadcast(e,t){return console.error("TODO: subgroupBroadcast"),null}SubgroupBroadcastFirst(e,t){return console.error("TODO: subgroupBroadcastFirst"),null}SubgroupElect(e,t){return console.error("TODO: subgroupElect"),null}SubgroupMax(e,t){return console.error("TODO: subgroupMax"),null}SubgroupMin(e,t){return console.error("TODO: subgroupMin"),null}SubgroupMul(e,t){return console.error("TODO: subgroupMul"),null}SubgroupExclusiveMul(e,t){return console.error("TODO: subgroupExclusiveMul"),null}SubgroupInclusiveMul(e,t){return console.error("TODO: subgroupInclusiveMul"),null}SubgroupOr(e,t){return console.error("TODO: subgroupOr"),null}SubgroupShuffle(e,t){return console.error("TODO: subgroupShuffle"),null}SubgroupShuffleDown(e,t){return console.error("TODO: subgroupShuffleDown"),null}SubgroupShuffleUp(e,t){return console.error("TODO: subgroupShuffleUp"),null}SubgroupShuffleXor(e,t){return console.error("TODO: subgroupShuffleXor"),null}SubgroupXor(e,t){return console.error("TODO: subgroupXor"),null}QuadBroadcast(e,t){return console.error("TODO: quadBroadcast"),null}QuadSwapDiagonal(e,t){return console.error("TODO: quadSwapDiagonal"),null}QuadSwapX(e,t){return console.error("TODO: quadSwapX"),null}QuadSwapY(e,t){return console.error("TODO: quadSwapY"),null}}let c1={vec2:2,vec2f:2,vec2i:2,vec2u:2,vec2b:2,vec2h:2,vec3:3,vec3f:3,vec3i:3,vec3u:3,vec3b:3,vec3h:3,vec4:4,vec4f:4,vec4i:4,vec4u:4,vec4b:4,vec4h:4},c2={mat2x2:[2,2,4],mat2x2f:[2,2,4],mat2x2h:[2,2,4],mat2x3:[2,3,6],mat2x3f:[2,3,6],mat2x3h:[2,3,6],mat2x4:[2,4,8],mat2x4f:[2,4,8],mat2x4h:[2,4,8],mat3x2:[3,2,6],mat3x2f:[3,2,6],mat3x2h:[3,2,6],mat3x3:[3,3,9],mat3x3f:[3,3,9],mat3x3h:[3,3,9],mat3x4:[3,4,12],mat3x4f:[3,4,12],mat3x4h:[3,4,12],mat4x2:[4,2,8],mat4x2f:[4,2,8],mat4x2h:[4,2,8],mat4x3:[4,3,12],mat4x3f:[4,3,12],mat4x3h:[4,3,12],mat4x4:[4,4,16],mat4x4f:[4,4,16],mat4x4h:[4,4,16]};class c3 extends cQ{constructor(e,t){var i;super(),this.ast=null!=e?e:[],this.reflection=new cY,this.reflection.updateAST(this.ast),this.context=null!=(i=null==t?void 0:t.clone())?i:new cJ,this.builtins=new c0(this),this.typeInfo={bool:this.getTypeInfo(u5.bool),i32:this.getTypeInfo(u5.i32),u32:this.getTypeInfo(u5.u32),f32:this.getTypeInfo(u5.f32),f16:this.getTypeInfo(u5.f16),vec2f:this.getTypeInfo(u7.vec2f),vec2u:this.getTypeInfo(u7.vec2u),vec2i:this.getTypeInfo(u7.vec2i),vec2h:this.getTypeInfo(u7.vec2h),vec3f:this.getTypeInfo(u7.vec3f),vec3u:this.getTypeInfo(u7.vec3u),vec3i:this.getTypeInfo(u7.vec3i),vec3h:this.getTypeInfo(u7.vec3h),vec4f:this.getTypeInfo(u7.vec4f),vec4u:this.getTypeInfo(u7.vec4u),vec4i:this.getTypeInfo(u7.vec4i),vec4h:this.getTypeInfo(u7.vec4h),mat2x2f:this.getTypeInfo(u7.mat2x2f),mat2x3f:this.getTypeInfo(u7.mat2x3f),mat2x4f:this.getTypeInfo(u7.mat2x4f),mat3x2f:this.getTypeInfo(u7.mat3x2f),mat3x3f:this.getTypeInfo(u7.mat3x3f),mat3x4f:this.getTypeInfo(u7.mat3x4f),mat4x2f:this.getTypeInfo(u7.mat4x2f),mat4x3f:this.getTypeInfo(u7.mat4x3f),mat4x4f:this.getTypeInfo(u7.mat4x4f)}}getVariableValue(e){var t,i;let r=null!=(i=null==(t=this.context.getVariable(e))?void 0:t.value)?i:null;if(null===r)return null;if(r instanceof cP)return r.value;if(r instanceof cE||r instanceof cC)return Array.from(r.data);if(r instanceof cI&&r.typeInfo instanceof ud){if("u32"===r.typeInfo.format.name)return Array.from(new Uint32Array(r.buffer,r.offset,r.typeInfo.count));if("i32"===r.typeInfo.format.name)return Array.from(new Int32Array(r.buffer,r.offset,r.typeInfo.count));if("f32"===r.typeInfo.format.name)return Array.from(new Float32Array(r.buffer,r.offset,r.typeInfo.count))}return console.error(`Unsupported return variable type ${r.typeInfo.name}`),null}execute(e){(e=null!=e?e:{}).constants&&this._setOverrides(e.constants,this.context),this._execStatements(this.ast,this.context)}dispatchWorkgroups(e,t,i,r){let n=this.context.clone();(r=null!=r?r:{}).constants&&this._setOverrides(r.constants,n),this._execStatements(this.ast,n);let s=n.getFunction(e);if(!s)return void console.error(`Function ${e} not found`);if("number"==typeof t)t=[t,1,1];else{if(0===t.length)return void console.error("Invalid dispatch count");1===t.length?t=[t[0],1,1]:2===t.length?t=[t[0],t[1],1]:t.length>3&&(t=[t[0],t[1],t[2]])}let o=t[0],a=t[1],l=t[2],u=this.getTypeInfo("vec3u");n.setVariable("@num_workgroups",new cE(t,u));let c=this.reflection.getFunctionInfo(e);for(let t in null===c&&console.error(`Function ${e} not found in reflection data`),i)for(let e in i[t]){let r=i[t][e];n.variables.forEach(i=>{var n;let s=i.node;if(null==s?void 0:s.attributes){let o=null,a=null;for(let e of s.attributes)"binding"===e.name?o=e.value:"group"===e.name&&(a=e.value);if(e==o&&t==a){let o=!1;for(let r of c.resources)if(r.name===i.name&&r.group===parseInt(t)&&r.binding===parseInt(e)){o=!0;break}o&&(void 0!==r.texture&&void 0!==r.descriptor?i.value=new cA(r.texture,this.getTypeInfo(s.type),r.descriptor,null!=(n=r.texture.view)?n:null):void 0!==r.uniform?i.value=new cI(r.uniform,this.getTypeInfo(s.type)):i.value=new cI(r,this.getTypeInfo(s.type)))}}})}for(let e=0;e<l;++e)for(let t=0;t<a;++t)for(let i=0;i<o;++i)n.setVariable("@workgroup_id",new cE([i,t,e],this.getTypeInfo("vec3u"))),this._dispatchWorkgroup(s,[i,t,e],n)}execStatement(e,t){if(e instanceof uJ)return this.evalExpression(e.value,t);if(e instanceof u4){if(e.condition){let i=this.evalExpression(e.condition,t);if(!(i instanceof cP))throw Error("Invalid break-if condition");if(!i.value)return null}return c3._breakObj}if(e instanceof u6)return c3._continueObj;if(e instanceof uW)this._let(e,t);else if(e instanceof u$)this._var(e,t);else if(e instanceof uG)this._const(e,t);else if(e instanceof uN)this._function(e,t);else{if(e instanceof uK)return this._if(e,t);if(e instanceof uZ)return this._switch(e,t);if(e instanceof uB)return this._for(e,t);if(e instanceof uz)return this._while(e,t);if(e instanceof uX)return this._loop(e,t);if(e instanceof uU){let i=t.clone();return i.currentFunctionName=t.currentFunctionName,this._execStatements(e.body,i)}if(e instanceof uH)this._assign(e,t);else if(e instanceof uq)this._increment(e,t);else{if(e instanceof u9)return null;if(e instanceof uV){let i=e.name;null===t.getVariable(i)&&t.setVariable(i,new cP(0,this.getTypeInfo("u32")))}else if(e instanceof uY)this._call(e,t);else{if(e instanceof u1||e instanceof u2)return null;console.error("Invalid statement type.",e,`Line ${e.line}`)}}}return null}evalExpression(e,t){return e instanceof cp?this._evalBinaryOp(e,t):e instanceof cu?this._evalLiteral(e,t):e instanceof ca?this._evalVariable(e,t):e instanceof co?this._evalCall(e,t):e instanceof cs?this._evalCreate(e,t):e instanceof cl?this._evalConst(e,t):e instanceof cc?this._evalBitcast(e,t):e instanceof cf?this._evalUnaryOp(e,t):(console.error("Invalid expression type",e,`Line ${e.line}`),null)}getTypeInfo(e){var t;if(e instanceof u5){let t=this.reflection.getTypeInfo(e);if(null!==t)return t}let i=null!=(t=this.typeInfo[e])?t:null;return null!==i||(i=this.reflection.getTypeInfoByName(e)),i}_setOverrides(e,t){for(let i in e){let r=e[i],n=this.reflection.getOverrideInfo(i);null!==n?(null===n.type&&(n.type=this.getTypeInfo("u32")),"u32"===n.type.name||"i32"===n.type.name||"f32"===n.type.name||"f16"===n.type.name?t.setVariable(i,new cP(r,n.type)):"bool"===n.type.name?t.setVariable(i,new cP(+!!r,n.type)):"vec2"===n.type.name||"vec3"===n.type.name||"vec4"===n.type.name||"vec2f"===n.type.name||"vec3f"===n.type.name||"vec4f"===n.type.name||"vec2i"===n.type.name||"vec3i"===n.type.name||"vec4i"===n.type.name||"vec2u"===n.type.name||"vec3u"===n.type.name||"vec4u"===n.type.name||"vec2h"===n.type.name||"vec3h"===n.type.name||"vec4h"===n.type.name?t.setVariable(i,new cE(r,n.type)):console.error(`Invalid constant type for ${i}`)):console.error(`Override ${i} does not exist in the shader.`)}}_dispatchWorkgroup(e,t,i){let r=[1,1,1];for(let t of e.node.attributes)if("workgroup_size"===t.name){if(t.value.length>0){let e=i.getVariableValue(t.value[0]);r[0]=e instanceof cP?e.value:parseInt(t.value[0])}if(t.value.length>1){let e=i.getVariableValue(t.value[1]);r[1]=e instanceof cP?e.value:parseInt(t.value[1])}if(t.value.length>2){let e=i.getVariableValue(t.value[2]);r[2]=e instanceof cP?e.value:parseInt(t.value[2])}}let n=this.getTypeInfo("vec3u"),s=this.getTypeInfo("u32");i.setVariable("@workgroup_size",new cE(r,n));let o=r[0],a=r[1],l=r[2];for(let u=0,c=0;u<l;++u)for(let l=0;l<a;++l)for(let a=0;a<o;++a,++c){let o=[a,l,u],h=[a+t[0]*r[0],l+t[1]*r[1],u+t[2]*r[2]];i.setVariable("@local_invocation_id",new cE(o,n)),i.setVariable("@global_invocation_id",new cE(h,n)),i.setVariable("@local_invocation_index",new cP(c,s)),this._dispatchExec(e,i)}}_dispatchExec(e,t){for(let i of e.node.args)for(let e of i.attributes)if("builtin"===e.name){let r=`@${e.value}`,n=t.getVariable(r);void 0!==n&&t.variables.set(i.name,n)}this._execStatements(e.node.body,t)}getVariableName(e,t){for(;e instanceof cf;)e=e.right;return e instanceof ca?e.name:(console.error("Unknown variable type",e,"Line",e.line),null)}_execStatements(e,t){for(let i of e){if(i instanceof Array){let e=t.clone(),r=this._execStatements(i,e);if(r)return r;continue}let e=this.execStatement(i,t);if(e)return e}return null}_call(e,t){let i=t.clone();i.currentFunctionName=e.name;let r=t.getFunction(e.name);if(r){for(let t=0;t<r.node.args.length;++t){let n=r.node.args[t],s=this.evalExpression(e.args[t],i);i.setVariable(n.name,s,n)}this._execStatements(r.node.body,i)}else e.isBuiltin?this._callBuiltinFunction(e,i):this.getTypeInfo(e.name)&&this._evalCreate(e,t)}_increment(e,t){let i=this.getVariableName(e.variable,t),r=t.getVariable(i);r?"++"===e.operator?r.value instanceof cP?r.value.value++:console.error(`Variable ${i} is not a scalar. Line ${e.line}`):"--"===e.operator?r.value instanceof cP?r.value.value--:console.error(`Variable ${i} is not a scalar. Line ${e.line}`):console.error(`Unknown increment operator ${e.operator}. Line ${e.line}`):console.error(`Variable ${i} not found. Line ${e.line}`)}_getVariableData(e,t){if(e instanceof ca){let i=this.getVariableName(e,t),r=t.getVariable(i);return null===r?(console.error(`Variable ${i} not found. Line ${e.line}`),null):r.value.getSubData(this,e.postfix,t)}if(e instanceof cf){if("*"===e.operator){let i=this._getVariableData(e.right,t);return i instanceof cS?i.reference.getSubData(this,e.postfix,t):(console.error(`Variable ${e.right} is not a pointer. Line ${e.line}`),null)}if("&"===e.operator)return new cS(this._getVariableData(e.right,t))}return null}_assign(e,t){let i=null,r="<var>",n=null;if(e.variable instanceof cf){let i=this._getVariableData(e.variable,t),r=this.evalExpression(e.value,t),n=e.operator;if("="===n){if(i instanceof cP||i instanceof cE||i instanceof cC){if(r instanceof cP||r instanceof cE||r instanceof cC&&i.data.length===r.data.length)return void i.data.set(r.data);console.error(`Invalid assignment. Line ${e.line}`)}else if(i instanceof cI&&r instanceof cI&&i.buffer.byteLength-i.offset>=r.buffer.byteLength-r.offset)return void(i.buffer.byteLength%4==0?new Uint32Array(i.buffer,i.offset,i.typeInfo.size/4).set(new Uint32Array(r.buffer,r.offset,r.typeInfo.size/4)):new Uint8Array(i.buffer,i.offset,i.typeInfo.size).set(new Uint8Array(r.buffer,r.offset,r.typeInfo.size)));return console.error(`Invalid assignment. Line ${e.line}`),null}if("+="===n)return i instanceof cP||i instanceof cE||i instanceof cC?r instanceof cP||r instanceof cE||r instanceof cC?void i.data.set(r.data.map((e,t)=>i.data[t]+e)):void console.error(`Invalid assignment . Line ${e.line}`):void console.error(`Invalid assignment. Line ${e.line}`);if("-="===n)return(i instanceof cP||i instanceof cE||i instanceof cC)&&(r instanceof cP||r instanceof cE||r instanceof cC)?void i.data.set(r.data.map((e,t)=>i.data[t]-e)):void console.error(`Invalid assignment. Line ${e.line}`)}if(e.variable instanceof cf){if("*"===e.variable.operator){r=this.getVariableName(e.variable.right,t);let n=t.getVariable(r);if(!(n&&n.value instanceof cS))return void console.error(`Variable ${r} is not a pointer. Line ${e.line}`);i=n.value.reference;let s=e.variable.postfix;if(!s){let t=e.variable.right;for(;t instanceof cf;){if(t.postfix){s=t.postfix;break}t=t.right}}s&&(i=i.getSubData(this,s,t))}}else{n=e.variable.postfix,r=this.getVariableName(e.variable,t);let s=t.getVariable(r);if(null===s)return void console.error(`Variable ${r} not found. Line ${e.line}`);i=s.value}if(i instanceof cS&&(i=i.reference),null===i)return void console.error(`Variable ${r} not found. Line ${e.line}`);let s=this.evalExpression(e.value,t),o=e.operator;if("="!==o){let r=i.getSubData(this,n,t);if(r instanceof cE&&s instanceof cP){let t=r.data,i=s.value;if("+="===o)for(let e=0;e<t.length;++e)t[e]+=i;else if("-="===o)for(let e=0;e<t.length;++e)t[e]-=i;else if("*="===o)for(let e=0;e<t.length;++e)t[e]*=i;else if("/="===o)for(let e=0;e<t.length;++e)t[e]/=i;else if("%="===o)for(let e=0;e<t.length;++e)t[e]%=i;else if("&="===o)for(let e=0;e<t.length;++e)t[e]&=i;else if("|="===o)for(let e=0;e<t.length;++e)t[e]|=i;else if("^="===o)for(let e=0;e<t.length;++e)t[e]^=i;else if("<<="===o)for(let e=0;e<t.length;++e)t[e]<<=i;else if(">>="===o)for(let e=0;e<t.length;++e)t[e]>>=i;else console.error(`Invalid operator ${o}. Line ${e.line}`)}else if(r instanceof cE&&s instanceof cE){let t=r.data,i=s.data;if(t.length!==i.length)return void console.error(`Vector length mismatch. Line ${e.line}`);if("+="===o)for(let e=0;e<t.length;++e)t[e]+=i[e];else if("-="===o)for(let e=0;e<t.length;++e)t[e]-=i[e];else if("*="===o)for(let e=0;e<t.length;++e)t[e]*=i[e];else if("/="===o)for(let e=0;e<t.length;++e)t[e]/=i[e];else if("%="===o)for(let e=0;e<t.length;++e)t[e]%=i[e];else if("&="===o)for(let e=0;e<t.length;++e)t[e]&=i[e];else if("|="===o)for(let e=0;e<t.length;++e)t[e]|=i[e];else if("^="===o)for(let e=0;e<t.length;++e)t[e]^=i[e];else if("<<="===o)for(let e=0;e<t.length;++e)t[e]<<=i[e];else if(">>="===o)for(let e=0;e<t.length;++e)t[e]>>=i[e];else console.error(`Invalid operator ${o}. Line ${e.line}`)}else{if(!(r instanceof cP&&s instanceof cP))return void console.error(`Invalid type for ${e.operator} operator. Line ${e.line}`);"+="===o?r.value+=s.value:"-="===o?r.value-=s.value:"*="===o?r.value*=s.value:"/="===o?r.value/=s.value:"%="===o?r.value%=s.value:"&="===o?r.value&=s.value:"|="===o?r.value|=s.value:"^="===o?r.value^=s.value:"<<="===o?r.value<<=s.value:">>="===o?r.value>>=s.value:console.error(`Invalid operator ${o}. Line ${e.line}`)}return void(i instanceof cI&&i.setDataValue(this,r,n,t))}if(i instanceof cI)i.setDataValue(this,s,n,t);else if(n){if(!(i instanceof cE||i instanceof cC))return void console.error(`Variable ${r} is not a vector or matrix. Line ${e.line}`);if(n instanceof ch){let o=this.evalExpression(n.index,t).value;if(i instanceof cE){if(!(s instanceof cP))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[o]=s.value}else{if(!(i instanceof cC))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let o=this.evalExpression(n.index,t).value;if(o<0||!(s instanceof cE))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);{let t=i.typeInfo.getTypeName();if("mat2x2"===t||"mat2x2f"===t||"mat2x2h"===t){if(!(o<2&&2===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*o]=s.data[0],i.data[2*o+1]=s.data[1]}else if("mat2x3"===t||"mat2x3f"===t||"mat2x3h"===t){if(!(o<2&&3===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*o]=s.data[0],i.data[3*o+1]=s.data[1],i.data[3*o+2]=s.data[2]}else if("mat2x4"===t||"mat2x4f"===t||"mat2x4h"===t){if(!(o<2&&4===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*o]=s.data[0],i.data[4*o+1]=s.data[1],i.data[4*o+2]=s.data[2],i.data[4*o+3]=s.data[3]}else if("mat3x2"===t||"mat3x2f"===t||"mat3x2h"===t){if(!(o<3&&2===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*o]=s.data[0],i.data[2*o+1]=s.data[1]}else if("mat3x3"===t||"mat3x3f"===t||"mat3x3h"===t){if(!(o<3&&3===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*o]=s.data[0],i.data[3*o+1]=s.data[1],i.data[3*o+2]=s.data[2]}else if("mat3x4"===t||"mat3x4f"===t||"mat3x4h"===t){if(!(o<3&&4===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*o]=s.data[0],i.data[4*o+1]=s.data[1],i.data[4*o+2]=s.data[2],i.data[4*o+3]=s.data[3]}else if("mat4x2"===t||"mat4x2f"===t||"mat4x2h"===t){if(!(o<4&&2===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[2*o]=s.data[0],i.data[2*o+1]=s.data[1]}else if("mat4x3"===t||"mat4x3f"===t||"mat4x3h"===t){if(!(o<4&&3===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[3*o]=s.data[0],i.data[3*o+1]=s.data[1],i.data[3*o+2]=s.data[2]}else{if("mat4x4"!==t&&"mat4x4f"!==t&&"mat4x4h"!==t||!(o<4&&4===s.data.length))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);i.data[4*o]=s.data[0],i.data[4*o+1]=s.data[1],i.data[4*o+2]=s.data[2],i.data[4*o+3]=s.data[3]}}}}}else if(n instanceof cn){let t=n.value;if(!(i instanceof cE))return void console.error(`Invalid assignment to ${t}. Variable ${r} is not a vector. Line ${e.line}`);if(s instanceof cP){if(t.length>1)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);if("x"===t)i.data[0]=s.value;else if("y"===t){if(i.data.length<2)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);i.data[1]=s.value}else if("z"===t){if(i.data.length<3)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);i.data[2]=s.value}else if("w"===t){if(i.data.length<4)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);i.data[3]=s.value}}else{if(!(s instanceof cE))return void console.error(`Invalid assignment to ${r}. Line ${e.line}`);if(t.length!==s.data.length)return void console.error(`Invalid assignment to ${t} for variable ${r}. Line ${e.line}`);for(let n=0;n<t.length;++n){let o=t[n];if("x"===o||"r"===o)i.data[0]=s.data[n];else if("y"===o||"g"===o){if(s.data.length<2)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);i.data[1]=s.data[n]}else if("z"===o||"b"===o){if(s.data.length<3)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);i.data[2]=s.data[n]}else{if("w"!==o&&"a"!==o||s.data.length<4)return void console.error(`Invalid assignment to ${o} for variable ${r}. Line ${e.line}`);i.data[3]=s.data[n]}}}}}else i instanceof cP&&s instanceof cP?i.value=s.value:i instanceof cE&&s instanceof cE||i instanceof cC&&s instanceof cC?i.data.set(s.data):console.error(`Invalid assignment to ${r}. Line ${e.line}`)}_function(e,t){let i=new cK(e);t.functions.set(e.name,i)}_const(e,t){let i=null;null!==e.value&&(i=this.evalExpression(e.value,t)),t.createVariable(e.name,i,e)}_let(e,t){let i=null;if(null!==e.value){if(null===(i=this.evalExpression(e.value,t)))return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof cf||(i=i.clone())}else{let r=e.type.name;if("f32"===r||"i32"===r||"u32"===r||"bool"===r||"f16"===r||"vec2"===r||"vec3"===r||"vec4"===r||"vec2f"===r||"vec3f"===r||"vec4f"===r||"vec2i"===r||"vec3i"===r||"vec4i"===r||"vec2u"===r||"vec3u"===r||"vec4u"===r||"vec2h"===r||"vec3h"===r||"vec4h"===r||"vec2b"===r||"vec3b"===r||"vec4b"===r||"mat2x2"===r||"mat2x3"===r||"mat2x4"===r||"mat3x2"===r||"mat3x3"===r||"mat3x4"===r||"mat4x2"===r||"mat4x3"===r||"mat4x4"===r||"mat2x2f"===r||"mat2x3f"===r||"mat2x4f"===r||"mat3x2f"===r||"mat3x3f"===r||"mat3x4f"===r||"mat4x2f"===r||"mat4x3f"===r||"mat4x4f"===r||"mat2x2h"===r||"mat2x3h"===r||"mat2x4h"===r||"mat3x2h"===r||"mat3x3h"===r||"mat3x4h"===r||"mat4x2h"===r||"mat4x3h"===r||"mat4x4h"===r||"array"===r){let r=new cs(e.type,[]);i=this._evalCreate(r,t)}}t.createVariable(e.name,i,e)}_var(e,t){let i=null;if(null!==e.value){if(null===(i=this.evalExpression(e.value,t)))return void console.error(`Invalid value for variable ${e.name}. Line ${e.line}`);e.value instanceof cf||(i=i.clone())}else{if(null===e.type)return void console.error(`Variable ${e.name} has no type. Line ${e.line}`);let r=e.type.name;if("f32"===r||"i32"===r||"u32"===r||"bool"===r||"f16"===r||"vec2"===r||"vec3"===r||"vec4"===r||"vec2f"===r||"vec3f"===r||"vec4f"===r||"vec2i"===r||"vec3i"===r||"vec4i"===r||"vec2u"===r||"vec3u"===r||"vec4u"===r||"vec2h"===r||"vec3h"===r||"vec4h"===r||"vec2b"===r||"vec3b"===r||"vec4b"===r||"mat2x2"===r||"mat2x3"===r||"mat2x4"===r||"mat3x2"===r||"mat3x3"===r||"mat3x4"===r||"mat4x2"===r||"mat4x3"===r||"mat4x4"===r||"mat2x2f"===r||"mat2x3f"===r||"mat2x4f"===r||"mat3x2f"===r||"mat3x3f"===r||"mat3x4f"===r||"mat4x2f"===r||"mat4x3f"===r||"mat4x4f"===r||"mat2x2h"===r||"mat2x3h"===r||"mat2x4h"===r||"mat3x2h"===r||"mat3x3h"===r||"mat3x4h"===r||"mat4x2h"===r||"mat4x3h"===r||"mat4x4h"===r||e.type instanceof ct||e.type instanceof u9||e.type instanceof u7){let r=new cs(e.type,[]);i=this._evalCreate(r,t)}}t.createVariable(e.name,i,e)}_switch(e,t){t=t.clone();let i=this.evalExpression(e.condition,t);if(!(i instanceof cP))return console.error(`Invalid if condition. Line ${e.line}`),null;let r=null;for(let n of e.cases)if(n instanceof cy)for(let s of n.selectors){if(s instanceof cm){r=n;continue}let o=this.evalExpression(s,t);if(!(o instanceof cP))return console.error(`Invalid case selector. Line ${e.line}`),null;if(o.value===i.value)return this._execStatements(n.body,t)}else n instanceof c_&&(r=n);return r?this._execStatements(r.body,t):null}_if(e,t){t=t.clone();let i=this.evalExpression(e.condition,t);if(!(i instanceof cP))return console.error(`Invalid if condition. Line ${e.line}`),null;if(i.value)return this._execStatements(e.body,t);for(let i of e.elseif){let r=this.evalExpression(i.condition,t);if(!(r instanceof cP))return console.error(`Invalid if condition. Line ${e.line}`),null;if(r.value)return this._execStatements(i.body,t)}return e.else?this._execStatements(e.else,t):null}_getScalarValue(e){return e instanceof cP?e.value:(console.error("Expected scalar value.",e),0)}_for(e,t){for(t=t.clone(),this.execStatement(e.init,t);this._getScalarValue(this.evalExpression(e.condition,t));){let i=this._execStatements(e.body,t);if(i===c3._breakObj)break;if(null!==i&&i!==c3._continueObj)return i;this.execStatement(e.increment,t)}return null}_loop(e,t){for(t=t.clone();;){let i=this._execStatements(e.body,t);if(i===c3._breakObj)break;if(i===c3._continueObj){if(e.continuing&&this._execStatements(e.continuing.body,t)===c3._breakObj)break}else if(null!==i)return i}return null}_while(e,t){for(t=t.clone();this._getScalarValue(this.evalExpression(e.condition,t));){let i=this._execStatements(e.body,t);if(i===c3._breakObj)break;if(i!==c3._continueObj&&null!==i)return i}return null}_evalBitcast(e,t){let i=this.evalExpression(e.value,t),r=e.type;if(i instanceof cP)return new cP(cG(i.value,i.typeInfo.name,r.name),this.getTypeInfo(r));if(i instanceof cE){let t=i.typeInfo.getTypeName(),n="";if(t.endsWith("f"))n="f32";else if(t.endsWith("i"))n="i32";else if(t.endsWith("u"))n="u32";else if(t.endsWith("b"))n="bool";else{if(!t.endsWith("h"))return console.error(`Unknown vector type ${t}. Line ${e.line}`),null;n="f16"}let s=r.getTypeName(),o="";if(s.endsWith("f"))o="f32";else if(s.endsWith("i"))o="i32";else if(s.endsWith("u"))o="u32";else if(s.endsWith("b"))o="bool";else{if(!s.endsWith("h"))return console.error(`Unknown vector type ${o}. Line ${e.line}`),null;o="f16"}return new cE(function(e,t,i){if(t===i)return e;let r=Array(e.length);for(let n=0;n<e.length;n++)r[n]=cG(e[n],t,i);return r}(Array.from(i.data),n,o),this.getTypeInfo(r))}return console.error(`TODO: bitcast for ${i.typeInfo.name}. Line ${e.line}`),null}_evalConst(e,t){return t.getVariableValue(e.name).clone().getSubData(this,e.postfix,t)}_evalCreate(e,t){var i;if(e instanceof cs){if(null===e.type)return cT.void;switch(e.type.getTypeName()){case"bool":case"i32":case"u32":case"f32":case"f16":return this._callConstructorValue(e,t);case"vec2":case"vec3":case"vec4":case"vec2f":case"vec3f":case"vec4f":case"vec2h":case"vec3h":case"vec4h":case"vec2i":case"vec3i":case"vec4i":case"vec2u":case"vec3u":case"vec4u":case"vec2b":case"vec3b":case"vec4b":return this._callConstructorVec(e,t);case"mat2x2":case"mat2x2f":case"mat2x2h":case"mat2x3":case"mat2x3f":case"mat2x3h":case"mat2x4":case"mat2x4f":case"mat2x4h":case"mat3x2":case"mat3x2f":case"mat3x2h":case"mat3x3":case"mat3x3f":case"mat3x3h":case"mat3x4":case"mat3x4f":case"mat3x4h":case"mat4x2":case"mat4x2f":case"mat4x2h":case"mat4x3":case"mat4x3f":case"mat4x3h":case"mat4x4":case"mat4x4f":case"mat4x4h":return this._callConstructorMatrix(e,t)}}let r=e instanceof cs?e.type.name:e.name,n=e instanceof cs?this.getTypeInfo(e.type):this.getTypeInfo(e.name);if(null===n)return console.error(`Unknown type ${r}. Line ${e.line}`),null;if(0===n.size)return null;let s=new cI(new ArrayBuffer(n.size),n,0);if(n instanceof uh){if(e.args)for(let i=0;i<e.args.length;++i){let r=n.members[i],o=e.args[i],a=this.evalExpression(o,t);s.setData(this,a,r.type,r.offset,t)}}else if(n instanceof ud){let r=0;if(e.args)for(let o=0;o<e.args.length;++o){let a=e.args[o],l=this.evalExpression(a,t);null===n.format&&("x32"===(null==(i=l.typeInfo)?void 0:i.name)?n.format=this.getTypeInfo("i32"):n.format=l.typeInfo),s.setData(this,l,n.format,r,t),r+=n.stride}}else console.error(`Unknown type "${r}". Line ${e.line}`);return e instanceof cs?s.getSubData(this,e.postfix,t):s}_evalLiteral(e,t){let i=this.getTypeInfo(e.type),r=i.name;return"x32"===r||"u32"===r||"f32"===r||"f16"===r||"i32"===r||"bool"===r?new cP(e.scalarValue,i):"vec2"===r||"vec3"===r||"vec4"===r||"vec2f"===r||"vec3f"===r||"vec4f"===r||"vec2h"===r||"vec3h"===r||"vec4h"===r||"vec2i"===r||"vec3i"===r||"vec4i"===r||"vec2u"===r||"vec3u"===r||"vec4u"===r?this._callConstructorVec(e,t):"mat2x2"===r||"mat2x3"===r||"mat2x4"===r||"mat3x2"===r||"mat3x3"===r||"mat3x4"===r||"mat4x2"===r||"mat4x3"===r||"mat4x4"===r||"mat2x2f"===r||"mat2x3f"===r||"mat2x4f"===r||"mat3x2f"===r||"mat3x3f"===r||"mat3x4f"===r||"mat4x2f"===r||"mat4x3f"===r||"mat4x4f"===r||"mat2x2h"===r||"mat2x3h"===r||"mat2x4h"===r||"mat3x2h"===r||"mat3x3h"===r||"mat3x4h"===r||"mat4x2h"===r||"mat4x3h"===r||"mat4x4h"===r?this._callConstructorMatrix(e,t):e.value}_evalVariable(e,t){let i=t.getVariableValue(e.name);return null===i?i:i.getSubData(this,e.postfix,t)}_maxFormatTypeInfo(e){let t=e[0];if("f32"===t.name)return t;for(let i=1;i<e.length;++i){let r=c3._priority.get(t.name);c3._priority.get(e[i].name)<r&&(t=e[i])}return"x32"===t.name?this.getTypeInfo("i32"):t}_evalUnaryOp(e,t){let i=this.evalExpression(e.right,t);if("&"===e.operator)return new cS(i);if("*"===e.operator)return i instanceof cS?i.reference.getSubData(this,e.postfix,t):(console.error(`Invalid dereference. Line ${e.line}`),null);let r=i instanceof cP?i.value:i instanceof cE?Array.from(i.data):null;switch(e.operator){case"+":if(cD(r))return new cE(r.map((e,t)=>+e),i.typeInfo);return new cP(+r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]));case"-":if(cD(r))return new cE(r.map((e,t)=>-e),i.typeInfo);return new cP(-r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]));case"!":if(cD(r))return new cE(r.map((e,t)=>+!e),i.typeInfo);return new cP(+!r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]));case"~":if(cD(r))return new cE(r.map((e,t)=>~e),i.typeInfo);return new cP(~r,this._maxFormatTypeInfo([i.typeInfo,i.typeInfo]))}return console.error(`Invalid unary operator ${e.operator}. Line ${e.line}`),null}_evalBinaryOp(e,t){let i=this.evalExpression(e.left,t),r=this.evalExpression(e.right,t),n=i instanceof cP?i.value:i instanceof cE||i instanceof cC?Array.from(i.data):null,s=r instanceof cP?r.value:r instanceof cE||r instanceof cC?Array.from(r.data):null;switch(e.operator){case"+":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e+s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e+s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n+e),r.typeInfo);return new cP(n+s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"-":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e-s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e-s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n-e),r.typeInfo);return new cP(n-s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"*":if(cD(n)&&cD(s)){if(i instanceof cC&&r instanceof cC){let t=function(e,t,i,r){if(void 0===c2[t.name]||void 0===c2[r.name])return null;let n=c2[t.name][0],s=c2[t.name][1],o=c2[r.name][0];if(n!==c2[r.name][1])return null;let a=Array(o*s);for(let t=0;t<s;t++)for(let r=0;r<o;r++){let l=0;for(let o=0;o<n;o++)l+=e[o*s+t]*i[r*n+o];a[t*o+r]=l}return a}(n,i.typeInfo,s,r.typeInfo);if(null===t)return console.error(`Matrix multiplication failed. Line ${e.line}.`),null;let o=c2[r.typeInfo.name][0],a=c2[i.typeInfo.name][1];return new cC(t,this.getTypeInfo(`mat${o}x${a}f`))}if(i instanceof cC&&r instanceof cE){let t=function(e,t,i,r){if(void 0===c2[t.name]||void 0===c1[r.name])return null;let n=c2[t.name][0],s=c2[t.name][1];if(n!==i.length)return null;let o=Array(s);for(let t=0;t<s;t++){let r=0;for(let o=0;o<n;o++)r+=e[o*s+t]*i[o];o[t]=r}return o}(n,i.typeInfo,s,r.typeInfo);return null===t?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new cE(t,r.typeInfo)}if(i instanceof cE&&r instanceof cC){let t=function(e,t,i,r){if(void 0===c1[t.name]||void 0===c2[r.name])return null;let n=c2[r.name][0],s=c2[r.name][1];if(s!==e.length)return null;let o=[];for(let t=0;t<n;t++){let r=0;for(let o=0;o<s;o++)r+=e[o]*i[o*n+t];o[t]=r}return o}(n,i.typeInfo,s,r.typeInfo);return null===t?(console.error(`Matrix vector multiplication failed. Line ${e.line}.`),null):new cE(t,i.typeInfo)}if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e*s[t]),i.typeInfo)}if(cD(n)){let e=n.map((e,t)=>e*s);return i instanceof cC?new cC(e,i.typeInfo):new cE(e,i.typeInfo)}if(cD(s)){let e=s.map((e,t)=>n*e);return r instanceof cC?new cC(e,r.typeInfo):new cE(e,r.typeInfo)}return new cP(n*s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"%":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e%s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e%s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n%e),r.typeInfo);return new cP(n%s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"/":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e/s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e/s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n/e),r.typeInfo);return new cP(n/s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"&":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e&s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e&s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n&e),r.typeInfo);return new cP(n&s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"|":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e|s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e|s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n|e),r.typeInfo);return new cP(n|s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"^":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e^s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e^s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n^e),r.typeInfo);return new cP(n^s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case"<<":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e<<s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e<<s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n<<e),r.typeInfo);return new cP(n<<s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case">>":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e>>s[t]),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e>>s),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n>>e),r.typeInfo);return new cP(n>>s,this._maxFormatTypeInfo([i.typeInfo,r.typeInfo]));case">":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>+(e>s[t])),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>+(e>s)),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>+(n>e)),r.typeInfo);return new cP(+(n>s),this.getTypeInfo("bool"));case"<":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>+(e<s[t])),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>+(e<s)),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>+(n<e)),r.typeInfo);return new cP(+(n<s),this.getTypeInfo("bool"));case"==":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>+(e===s[t])),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>+(e==s)),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>+(n==e)),r.typeInfo);return new cP(+(n===s),this.getTypeInfo("bool"));case"!=":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>+(e!==s[t])),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>+(e!==s)),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>+(n!==e)),r.typeInfo);return new cP(+(n!==s),this.getTypeInfo("bool"));case">=":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>+(e>=s[t])),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>+(e>=s)),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>+(n>=e)),r.typeInfo);return new cP(+(n>=s),this.getTypeInfo("bool"));case"<=":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>+(e<=s[t])),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>+(e<=s)),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>+(n<=e)),r.typeInfo);return new cP(+(n<=s),this.getTypeInfo("bool"));case"&&":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e&&s[t]?1:0),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e&&s?1:0),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n&&e?1:0),r.typeInfo);return new cP(n&&s?1:0,this.getTypeInfo("bool"));case"||":if(cD(n)&&cD(s)){if(n.length!==s.length)return console.error(`Vector length mismatch. Line ${e.line}.`),null;return new cE(n.map((e,t)=>e||s[t]?1:0),i.typeInfo)}if(cD(n))return new cE(n.map((e,t)=>e||s?1:0),i.typeInfo);if(cD(s))return new cE(s.map((e,t)=>n||e?1:0),r.typeInfo);return new cP(n||s?1:0,this.getTypeInfo("bool"))}return console.error(`Unknown operator ${e.operator}. Line ${e.line}`),null}_evalCall(e,t){if(null!==e.cachedReturnValue)return e.cachedReturnValue;let i=t.clone();i.currentFunctionName=e.name;let r=t.getFunction(e.name);if(!r)return e.isBuiltin?this._callBuiltinFunction(e,i):this.getTypeInfo(e.name)?this._evalCreate(e,t):(console.error(`Unknown function "${e.name}". Line ${e.line}`),null);for(let t=0;t<r.node.args.length;++t){let n=r.node.args[t],s=this.evalExpression(e.args[t],i);i.createVariable(n.name,s,n)}return this._execStatements(r.node.body,i)}_callBuiltinFunction(e,t){switch(e.name){case"all":return this.builtins.All(e,t);case"any":return this.builtins.Any(e,t);case"select":return this.builtins.Select(e,t);case"arrayLength":return this.builtins.ArrayLength(e,t);case"abs":return this.builtins.Abs(e,t);case"acos":return this.builtins.Acos(e,t);case"acosh":return this.builtins.Acosh(e,t);case"asin":return this.builtins.Asin(e,t);case"asinh":return this.builtins.Asinh(e,t);case"atan":return this.builtins.Atan(e,t);case"atanh":return this.builtins.Atanh(e,t);case"atan2":return this.builtins.Atan2(e,t);case"ceil":return this.builtins.Ceil(e,t);case"clamp":return this.builtins.Clamp(e,t);case"cos":return this.builtins.Cos(e,t);case"cosh":return this.builtins.Cosh(e,t);case"countLeadingZeros":return this.builtins.CountLeadingZeros(e,t);case"countOneBits":return this.builtins.CountOneBits(e,t);case"countTrailingZeros":return this.builtins.CountTrailingZeros(e,t);case"cross":return this.builtins.Cross(e,t);case"degrees":return this.builtins.Degrees(e,t);case"determinant":return this.builtins.Determinant(e,t);case"distance":return this.builtins.Distance(e,t);case"dot":return this.builtins.Dot(e,t);case"dot4U8Packed":return this.builtins.Dot4U8Packed(e,t);case"dot4I8Packed":return this.builtins.Dot4I8Packed(e,t);case"exp":return this.builtins.Exp(e,t);case"exp2":return this.builtins.Exp2(e,t);case"extractBits":return this.builtins.ExtractBits(e,t);case"faceForward":return this.builtins.FaceForward(e,t);case"firstLeadingBit":return this.builtins.FirstLeadingBit(e,t);case"firstTrailingBit":return this.builtins.FirstTrailingBit(e,t);case"floor":return this.builtins.Floor(e,t);case"fma":return this.builtins.Fma(e,t);case"fract":return this.builtins.Fract(e,t);case"frexp":return this.builtins.Frexp(e,t);case"insertBits":return this.builtins.InsertBits(e,t);case"inverseSqrt":return this.builtins.InverseSqrt(e,t);case"ldexp":return this.builtins.Ldexp(e,t);case"length":return this.builtins.Length(e,t);case"log":return this.builtins.Log(e,t);case"log2":return this.builtins.Log2(e,t);case"max":return this.builtins.Max(e,t);case"min":return this.builtins.Min(e,t);case"mix":return this.builtins.Mix(e,t);case"modf":return this.builtins.Modf(e,t);case"normalize":return this.builtins.Normalize(e,t);case"pow":return this.builtins.Pow(e,t);case"quantizeToF16":return this.builtins.QuantizeToF16(e,t);case"radians":return this.builtins.Radians(e,t);case"reflect":return this.builtins.Reflect(e,t);case"refract":return this.builtins.Refract(e,t);case"reverseBits":return this.builtins.ReverseBits(e,t);case"round":return this.builtins.Round(e,t);case"saturate":return this.builtins.Saturate(e,t);case"sign":return this.builtins.Sign(e,t);case"sin":return this.builtins.Sin(e,t);case"sinh":return this.builtins.Sinh(e,t);case"smoothstep":return this.builtins.SmoothStep(e,t);case"sqrt":return this.builtins.Sqrt(e,t);case"step":return this.builtins.Step(e,t);case"tan":return this.builtins.Tan(e,t);case"tanh":return this.builtins.Tanh(e,t);case"transpose":return this.builtins.Transpose(e,t);case"trunc":return this.builtins.Trunc(e,t);case"dpdx":return this.builtins.Dpdx(e,t);case"dpdxCoarse":return this.builtins.DpdxCoarse(e,t);case"dpdxFine":return this.builtins.DpdxFine(e,t);case"dpdy":return this.builtins.Dpdy(e,t);case"dpdyCoarse":return this.builtins.DpdyCoarse(e,t);case"dpdyFine":return this.builtins.DpdyFine(e,t);case"fwidth":return this.builtins.Fwidth(e,t);case"fwidthCoarse":return this.builtins.FwidthCoarse(e,t);case"fwidthFine":return this.builtins.FwidthFine(e,t);case"textureDimensions":return this.builtins.TextureDimensions(e,t);case"textureGather":return this.builtins.TextureGather(e,t);case"textureGatherCompare":return this.builtins.TextureGatherCompare(e,t);case"textureLoad":return this.builtins.TextureLoad(e,t);case"textureNumLayers":return this.builtins.TextureNumLayers(e,t);case"textureNumLevels":return this.builtins.TextureNumLevels(e,t);case"textureNumSamples":return this.builtins.TextureNumSamples(e,t);case"textureSample":return this.builtins.TextureSample(e,t);case"textureSampleBias":return this.builtins.TextureSampleBias(e,t);case"textureSampleCompare":return this.builtins.TextureSampleCompare(e,t);case"textureSampleCompareLevel":return this.builtins.TextureSampleCompareLevel(e,t);case"textureSampleGrad":return this.builtins.TextureSampleGrad(e,t);case"textureSampleLevel":return this.builtins.TextureSampleLevel(e,t);case"textureSampleBaseClampToEdge":return this.builtins.TextureSampleBaseClampToEdge(e,t);case"textureStore":return this.builtins.TextureStore(e,t);case"atomicLoad":return this.builtins.AtomicLoad(e,t);case"atomicStore":return this.builtins.AtomicStore(e,t);case"atomicAdd":return this.builtins.AtomicAdd(e,t);case"atomicSub":return this.builtins.AtomicSub(e,t);case"atomicMax":return this.builtins.AtomicMax(e,t);case"atomicMin":return this.builtins.AtomicMin(e,t);case"atomicAnd":return this.builtins.AtomicAnd(e,t);case"atomicOr":return this.builtins.AtomicOr(e,t);case"atomicXor":return this.builtins.AtomicXor(e,t);case"atomicExchange":return this.builtins.AtomicExchange(e,t);case"atomicCompareExchangeWeak":return this.builtins.AtomicCompareExchangeWeak(e,t);case"pack4x8snorm":return this.builtins.Pack4x8snorm(e,t);case"pack4x8unorm":return this.builtins.Pack4x8unorm(e,t);case"pack4xI8":return this.builtins.Pack4xI8(e,t);case"pack4xU8":return this.builtins.Pack4xU8(e,t);case"pack4x8Clamp":return this.builtins.Pack4x8Clamp(e,t);case"pack4xU8Clamp":return this.builtins.Pack4xU8Clamp(e,t);case"pack2x16snorm":return this.builtins.Pack2x16snorm(e,t);case"pack2x16unorm":return this.builtins.Pack2x16unorm(e,t);case"pack2x16float":return this.builtins.Pack2x16float(e,t);case"unpack4x8snorm":return this.builtins.Unpack4x8snorm(e,t);case"unpack4x8unorm":return this.builtins.Unpack4x8unorm(e,t);case"unpack4xI8":return this.builtins.Unpack4xI8(e,t);case"unpack4xU8":return this.builtins.Unpack4xU8(e,t);case"unpack2x16snorm":return this.builtins.Unpack2x16snorm(e,t);case"unpack2x16unorm":return this.builtins.Unpack2x16unorm(e,t);case"unpack2x16float":return this.builtins.Unpack2x16float(e,t);case"storageBarrier":return this.builtins.StorageBarrier(e,t);case"textureBarrier":return this.builtins.TextureBarrier(e,t);case"workgroupBarrier":return this.builtins.WorkgroupBarrier(e,t);case"workgroupUniformLoad":return this.builtins.WorkgroupUniformLoad(e,t);case"subgroupAdd":return this.builtins.SubgroupAdd(e,t);case"subgroupExclusiveAdd":return this.builtins.SubgroupExclusiveAdd(e,t);case"subgroupInclusiveAdd":return this.builtins.SubgroupInclusiveAdd(e,t);case"subgroupAll":return this.builtins.SubgroupAll(e,t);case"subgroupAnd":return this.builtins.SubgroupAnd(e,t);case"subgroupAny":return this.builtins.SubgroupAny(e,t);case"subgroupBallot":return this.builtins.SubgroupBallot(e,t);case"subgroupBroadcast":return this.builtins.SubgroupBroadcast(e,t);case"subgroupBroadcastFirst":return this.builtins.SubgroupBroadcastFirst(e,t);case"subgroupElect":return this.builtins.SubgroupElect(e,t);case"subgroupMax":return this.builtins.SubgroupMax(e,t);case"subgroupMin":return this.builtins.SubgroupMin(e,t);case"subgroupMul":return this.builtins.SubgroupMul(e,t);case"subgroupExclusiveMul":return this.builtins.SubgroupExclusiveMul(e,t);case"subgroupInclusiveMul":return this.builtins.SubgroupInclusiveMul(e,t);case"subgroupOr":return this.builtins.SubgroupOr(e,t);case"subgroupShuffle":return this.builtins.SubgroupShuffle(e,t);case"subgroupShuffleDown":return this.builtins.SubgroupShuffleDown(e,t);case"subgroupShuffleUp":return this.builtins.SubgroupShuffleUp(e,t);case"subgroupShuffleXor":return this.builtins.SubgroupShuffleXor(e,t);case"subgroupXor":return this.builtins.SubgroupXor(e,t);case"quadBroadcast":return this.builtins.QuadBroadcast(e,t);case"quadSwapDiagonal":return this.builtins.QuadSwapDiagonal(e,t);case"quadSwapX":return this.builtins.QuadSwapX(e,t);case"quadSwapY":return this.builtins.QuadSwapY(e,t)}let i=t.getFunction(e.name);if(i){let r=t.clone();for(let t=0;t<i.node.args.length;++t){let n=i.node.args[t],s=this.evalExpression(e.args[t],r);r.setVariable(n.name,s,n)}return this._execStatements(i.node.body,r)}return null}_callConstructorValue(e,t){if(!e.args||0===e.args.length)return new cP(0,this.getTypeInfo(e.type));let i=this.evalExpression(e.args[0],t);return i.typeInfo=this.getTypeInfo(e.type),i.getSubData(this,e.postfix,t).clone()}_callConstructorVec(e,t){let i=this.getTypeInfo(e.type),r=e.type.getTypeName(),n=c1[r];if(void 0===n)return console.error(`Invalid vec constructor ${r}. Line ${e.line}`),null;let s=[];if(e instanceof cu)if(e.isVector)for(let t of e.vectorValue)s.push(t);else s.push(e.scalarValue);else if(e.args)for(let i of e.args){let e=this.evalExpression(i,t);if(e instanceof cE){let t=e.data;for(let e=0;e<t.length;++e){let i=t[e];s.push(i)}}else if(e instanceof cP){let t=e.value;s.push(t)}}if(e.type instanceof u7&&null===e.type.format&&(e.type.format=u7.f32),0===s.length)return new cE(Array(n).fill(0),i).getSubData(this,e.postfix,t);if(1===s.length)for(;s.length<n;)s.push(s[0]);return s.length<n?(console.error(`Invalid vec constructor. Line ${e.line}`),null):new cE(s.length>n?s.slice(0,n):s,i).getSubData(this,e.postfix,t)}_callConstructorMatrix(e,t){let i=this.getTypeInfo(e.type),r=e.type.getTypeName(),n=c2[r];if(void 0===n)return console.error(`Invalid matrix constructor ${r}. Line ${e.line}`),null;let s=[];if(e instanceof cu)if(e.isVector)for(let t of e.vectorValue)s.push(t);else s.push(e.scalarValue);else if(e.args)for(let i of e.args){let e=this.evalExpression(i,t);e instanceof cE?s.push(...e.data):e instanceof cP?s.push(e.value):e instanceof cC&&s.push(...e.data)}return(i instanceof up&&null===i.format&&(i.format=this.getTypeInfo("f32")),0===s.length)?new cC(Array(n[2]).fill(0),i).getSubData(this,e.postfix,t):s.length!==n[2]?(console.error(`Invalid matrix constructor. Line ${e.line}`),null):new cC(s,i).getSubData(this,e.postfix,t)}}c3._breakObj=new ck(new uu("BREAK",null),null),c3._continueObj=new ck(new uu("CONTINUE",null),null),c3._priority=new Map([["f32",0],["f16",1],["u32",2],["i32",3],["x32",3]]);class c4{constructor(){this.constants=new Map,this.aliases=new Map,this.structs=new Map}}class c6{constructor(){this._tokens=[],this._current=0,this._currentLine=1,this._deferArrayCountEval=[],this._currentLoop=[],this._context=new c4,this._exec=new c3,this._forwardTypeCount=0}parse(e){this._initialize(e),this._deferArrayCountEval.length=0;let t=[];for(;!this._isAtEnd();){let e=this._global_decl_or_directive();if(!e)break;t.push(e)}if(this._deferArrayCountEval.length>0){for(let e of this._deferArrayCountEval){let t=e.arrayType,i=e.countNode;if(i instanceof ca){let e=i.name,r=this._context.constants.get(e);if(r)try{t.count=r.constEvaluate(this._exec)}catch(e){}}}this._deferArrayCountEval.length=0}if(this._forwardTypeCount>0)for(let e of t)e.search(e=>{e instanceof cx||e instanceof ce?e.type=this._forwardType(e.type):e instanceof ct?e.format=this._forwardType(e.format):e instanceof u$||e instanceof uW||e instanceof uG?e.type=this._forwardType(e.type):e instanceof uN?e.returnType=this._forwardType(e.returnType):e instanceof cv&&(e.type=this._forwardType(e.type))});return t}_forwardType(e){if(e instanceof u8){let t=this._getType(e.name);if(t)return t}else e instanceof ce?e.type=this._forwardType(e.type):e instanceof ct&&(e.format=this._forwardType(e.format));return e}_initialize(e){if(e)if("string"==typeof e){let t=new cR(e);this._tokens=t.scanTokens()}else this._tokens=e;else this._tokens=[];this._current=0}_updateNode(e,t){return e.line=null!=t?t:this._currentLine,e}_error(e,t){return{token:e,message:t,toString:()=>`${t}`}}_isAtEnd(){return this._current>=this._tokens.length||this._peek().type==cL.eof}_match(e){if(e instanceof cM)return!!this._check(e)&&(this._advance(),!0);for(let t=0,i=e.length;t<i;++t){let i=e[t];if(this._check(i))return this._advance(),!0}return!1}_consume(e,t){if(this._check(e))return this._advance();throw this._error(this._peek(),`${t}. Line:${this._currentLine}`)}_check(e){if(this._isAtEnd())return!1;let t=this._peek();if(e instanceof Array){let i=t.type,r=!1;for(let t of e){if(i===t)return!0;t===cL.tokens.name&&(r=!0)}if(r){let e=cL.tokens.name.rule.exec(t.lexeme);if(e&&0==e.index&&e[0]==t.lexeme)return!0}return!1}if(t.type===e)return!0;if(e===cL.tokens.name){let e=cL.tokens.name.rule.exec(t.lexeme);return e&&0==e.index&&e[0]==t.lexeme}return!1}_advance(){var e,t;return this._currentLine=null!=(t=null==(e=this._peek())?void 0:e.line)?t:-1,this._isAtEnd()||this._current++,this._previous()}_peek(){return this._tokens[this._current]}_previous(){return this._tokens[this._current-1]}_global_decl_or_directive(){for(;this._match(cL.tokens.semicolon)&&!this._isAtEnd(););if(this._match(cL.keywords.alias)){let e=this._type_alias();return this._consume(cL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(cL.keywords.diagnostic)){let e=this._diagnostic();return this._consume(cL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(cL.keywords.requires)){let e=this._requires_directive();return this._consume(cL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}if(this._match(cL.keywords.enable)){let e=this._enable_directive();return this._consume(cL.tokens.semicolon,"Expected ';'"),this._exec.reflection.updateAST([e]),e}let e=this._attribute();if(this._check(cL.keywords.var)){let t=this._global_variable_decl();return null!=t&&(t.attributes=e),this._consume(cL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(cL.keywords.override)){let t=this._override_variable_decl();return null!=t&&(t.attributes=e),this._consume(cL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(cL.keywords.let)){let t=this._global_let_decl();return null!=t&&(t.attributes=e),this._consume(cL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(cL.keywords.const)){let t=this._global_const_decl();return null!=t&&(t.attributes=e),this._consume(cL.tokens.semicolon,"Expected ';'."),this._exec.reflection.updateAST([t]),t}if(this._check(cL.keywords.struct)){let t=this._struct_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}if(this._check(cL.keywords.fn)){let t=this._function_decl();return null!=t&&(t.attributes=e),this._exec.reflection.updateAST([t]),t}return null}_function_decl(){if(!this._match(cL.keywords.fn))return null;let e=this._currentLine,t=this._consume(cL.tokens.ident,"Expected function name.").toString();this._consume(cL.tokens.paren_left,"Expected '(' for function arguments.");let i=[];if(!this._check(cL.tokens.paren_right))do{if(this._check(cL.tokens.paren_right))break;let e=this._attribute(),t=this._consume(cL.tokens.name,"Expected argument name.").toString();this._consume(cL.tokens.colon,"Expected ':' for argument type.");let r=this._attribute(),n=this._type_decl();null!=n&&(n.attributes=r,i.push(this._updateNode(new cv(t,n,e))))}while(this._match(cL.tokens.comma))this._consume(cL.tokens.paren_right,"Expected ')' after function arguments.");let r=null;if(this._match(cL.tokens.arrow)){let e=this._attribute();null!=(r=this._type_decl())&&(r.attributes=e)}let n=this._compound_statement(),s=this._currentLine;return this._updateNode(new uN(t,i,r,n,e,s),e)}_compound_statement(){let e=[];for(this._consume(cL.tokens.brace_left,"Expected '{' for block.");!this._check(cL.tokens.brace_right);){let t=this._statement();null!==t&&e.push(t)}return this._consume(cL.tokens.brace_right,"Expected '}' for block."),e}_statement(){for(;this._match(cL.tokens.semicolon)&&!this._isAtEnd(););if(this._check(cL.tokens.attr)&&this._attribute(),this._check(cL.keywords.if))return this._if_statement();if(this._check(cL.keywords.switch))return this._switch_statement();if(this._check(cL.keywords.loop))return this._loop_statement();if(this._check(cL.keywords.for))return this._for_statement();if(this._check(cL.keywords.while))return this._while_statement();if(this._check(cL.keywords.continuing))return this._continuing_statement();if(this._check(cL.keywords.static_assert))return this._static_assert_statement();if(this._check(cL.tokens.brace_left))return this._compound_statement();let e=null;if(this._check(cL.keywords.return))e=this._return_statement();else if(this._check([cL.keywords.var,cL.keywords.let,cL.keywords.const]))e=this._variable_statement();else if(this._match(cL.keywords.discard))e=this._updateNode(new u3);else if(this._match(cL.keywords.break)){let t=this._updateNode(new u4);this._currentLoop.length>0&&(t.loopId=this._currentLoop[this._currentLoop.length-1].id),e=t,this._check(cL.keywords.if)&&(this._advance(),t.condition=this._optional_paren_expression())}else if(this._match(cL.keywords.continue)){let t=this._updateNode(new u6);if(!(this._currentLoop.length>0))throw this._error(this._peek(),`Continue statement must be inside a loop. Line: ${t.line}`);t.loopId=this._currentLoop[this._currentLoop.length-1].id,e=t}else e=this._increment_decrement_statement()||this._func_call_statement()||this._assignment_statement();return null!=e&&this._consume(cL.tokens.semicolon,"Expected ';' after statement."),e}_static_assert_statement(){if(!this._match(cL.keywords.static_assert))return null;let e=this._currentLine,t=this._optional_paren_expression();return this._updateNode(new uj(t),e)}_while_statement(){if(!this._match(cL.keywords.while))return null;let e=this._updateNode(new uz(null,null));return this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(cL.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_continuing_statement(){let e=this._currentLoop.length>0?this._currentLoop[this._currentLoop.length-1].id:-1;if(!this._match(cL.keywords.continuing))return null;let t=this._currentLine,i=this._compound_statement();return this._updateNode(new uU(i,e),t)}_for_statement(){if(!this._match(cL.keywords.for))return null;this._consume(cL.tokens.paren_left,"Expected '('.");let e=this._updateNode(new uB(null,null,null,null));return this._currentLoop.push(e),e.init=this._check(cL.tokens.semicolon)?null:this._for_init(),this._consume(cL.tokens.semicolon,"Expected ';'."),e.condition=this._check(cL.tokens.semicolon)?null:this._short_circuit_or_expression(),this._consume(cL.tokens.semicolon,"Expected ';'."),e.increment=this._check(cL.tokens.paren_right)?null:this._for_increment(),this._consume(cL.tokens.paren_right,"Expected ')'."),this._check(cL.tokens.attr)&&this._attribute(),e.body=this._compound_statement(),this._currentLoop.pop(),e}_for_init(){return this._variable_statement()||this._func_call_statement()||this._assignment_statement()}_for_increment(){return this._func_call_statement()||this._increment_decrement_statement()||this._assignment_statement()}_variable_statement(){if(this._check(cL.keywords.var)){let e=this._variable_decl();if(null===e)throw this._error(this._peek(),"Variable declaration expected.");let t=null;return this._match(cL.tokens.equal)&&(t=this._short_circuit_or_expression()),this._updateNode(new u$(e.name,e.type,e.storage,e.access,t),e.line)}if(this._match(cL.keywords.let)){let e=this._currentLine,t=this._consume(cL.tokens.name,"Expected name for let.").toString(),i=null;if(this._match(cL.tokens.colon)){let e=this._attribute();null!=(i=this._type_decl())&&(i.attributes=e)}this._consume(cL.tokens.equal,"Expected '=' for let.");let r=this._short_circuit_or_expression();return this._updateNode(new uW(t,i,null,null,r),e)}if(this._match(cL.keywords.const)){let e=this._currentLine,t=this._consume(cL.tokens.name,"Expected name for const.").toString(),i=null;if(this._match(cL.tokens.colon)){let e=this._attribute();null!=(i=this._type_decl())&&(i.attributes=e)}this._consume(cL.tokens.equal,"Expected '=' for const.");let r=this._short_circuit_or_expression();return null===i&&r instanceof cu&&(i=r.type),this._updateNode(new uG(t,i,null,null,r),e)}return null}_increment_decrement_statement(){let e=this._current,t=this._unary_expression();if(null==t)return null;if(!this._check(cL.increment_operators))return this._current=e,null;let i=this._consume(cL.increment_operators,"Expected increment operator");return this._updateNode(new uq(i.type===cL.tokens.plus_plus?S.increment:S.decrement,t))}_assignment_statement(){let e=null,t=this._currentLine;if(this._check(cL.tokens.brace_right))return null;let i=this._match(cL.tokens.underscore);if(i||(e=this._unary_expression()),!i&&null==e)return null;let r=this._consume(cL.assignment_operators,"Expected assignment operator."),n=this._short_circuit_or_expression();return this._updateNode(new uH(P.parse(r.lexeme),e,n),t)}_func_call_statement(){if(!this._check(cL.tokens.ident))return null;let e=this._currentLine,t=this._current,i=this._consume(cL.tokens.ident,"Expected function name."),r=this._argument_expression_list();return null===r?(this._current=t,null):this._updateNode(new uY(i.lexeme,r),e)}_loop_statement(){if(!this._match(cL.keywords.loop))return null;this._check(cL.tokens.attr)&&this._attribute(),this._consume(cL.tokens.brace_left,"Expected '{' for loop.");let e=this._updateNode(new uX([],null));this._currentLoop.push(e);let t=this._statement();for(;null!==t;){if(Array.isArray(t))for(let i of t)e.body.push(i);else e.body.push(t);if(t instanceof uU){e.continuing=t;break}t=this._statement()}return this._currentLoop.pop(),this._consume(cL.tokens.brace_right,"Expected '}' for loop."),e}_switch_statement(){if(!this._match(cL.keywords.switch))return null;let e=this._updateNode(new uZ(null,[]));if(this._currentLoop.push(e),e.condition=this._optional_paren_expression(),this._check(cL.tokens.attr)&&this._attribute(),this._consume(cL.tokens.brace_left,"Expected '{' for switch."),e.cases=this._switch_body(),null==e.cases||0==e.cases.length)throw this._error(this._previous(),"Expected 'case' or 'default'.");return this._consume(cL.tokens.brace_right,"Expected '}' for switch."),this._currentLoop.pop(),e}_switch_body(){let e=[],t=!1;for(;this._check([cL.keywords.default,cL.keywords.case]);){if(this._match(cL.keywords.case)){let i=this._case_selectors();for(let e of i)if(e instanceof cm){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");t=!0;break}this._match(cL.tokens.colon),this._check(cL.tokens.attr)&&this._attribute(),this._consume(cL.tokens.brace_left,"Exected '{' for switch case.");let r=this._case_body();this._consume(cL.tokens.brace_right,"Exected '}' for switch case."),e.push(this._updateNode(new cy(i,r)))}if(this._match(cL.keywords.default)){if(t)throw this._error(this._previous(),"Multiple default cases in switch statement.");this._match(cL.tokens.colon),this._check(cL.tokens.attr)&&this._attribute(),this._consume(cL.tokens.brace_left,"Exected '{' for switch default.");let i=this._case_body();this._consume(cL.tokens.brace_right,"Exected '}' for switch default."),e.push(this._updateNode(new c_(i)))}}return e}_case_selectors(){let e=[];for(this._match(cL.keywords.default)?e.push(this._updateNode(new cm)):e.push(this._shift_expression());this._match(cL.tokens.comma);)this._match(cL.keywords.default)?e.push(this._updateNode(new cm)):e.push(this._shift_expression());return e}_case_body(){if(this._match(cL.keywords.fallthrough))return this._consume(cL.tokens.semicolon,"Expected ';'"),[];let e=this._statement();if(null==e)return[];e instanceof Array||(e=[e]);let t=this._case_body();return 0==t.length?e:[...e,t[0]]}_if_statement(){if(!this._match(cL.keywords.if))return null;let e=this._currentLine,t=this._optional_paren_expression();this._check(cL.tokens.attr)&&this._attribute();let i=this._compound_statement(),r=[];this._match_elseif()&&(this._check(cL.tokens.attr)&&this._attribute(),r=this._elseif_statement(r));let n=null;return this._match(cL.keywords.else)&&(this._check(cL.tokens.attr)&&this._attribute(),n=this._compound_statement()),this._updateNode(new uK(t,i,r,n),e)}_match_elseif(){return this._tokens[this._current].type===cL.keywords.else&&this._tokens[this._current+1].type===cL.keywords.if&&(this._advance(),this._advance(),!0)}_elseif_statement(e=[]){let t=this._optional_paren_expression(),i=this._compound_statement();return e.push(this._updateNode(new cb(t,i))),this._match_elseif()&&(this._check(cL.tokens.attr)&&this._attribute(),this._elseif_statement(e)),e}_return_statement(){if(!this._match(cL.keywords.return))return null;let e=this._short_circuit_or_expression();return this._updateNode(new uJ(e))}_short_circuit_or_expression(){let e=this._short_circuit_and_expr();for(;this._match(cL.tokens.or_or);)e=this._updateNode(new cp(this._previous().toString(),e,this._short_circuit_and_expr()));return e}_short_circuit_and_expr(){let e=this._inclusive_or_expression();for(;this._match(cL.tokens.and_and);)e=this._updateNode(new cp(this._previous().toString(),e,this._inclusive_or_expression()));return e}_inclusive_or_expression(){let e=this._exclusive_or_expression();for(;this._match(cL.tokens.or);)e=this._updateNode(new cp(this._previous().toString(),e,this._exclusive_or_expression()));return e}_exclusive_or_expression(){let e=this._and_expression();for(;this._match(cL.tokens.xor);)e=this._updateNode(new cp(this._previous().toString(),e,this._and_expression()));return e}_and_expression(){let e=this._equality_expression();for(;this._match(cL.tokens.and);)e=this._updateNode(new cp(this._previous().toString(),e,this._equality_expression()));return e}_equality_expression(){let e=this._relational_expression();return this._match([cL.tokens.equal_equal,cL.tokens.not_equal])?this._updateNode(new cp(this._previous().toString(),e,this._relational_expression())):e}_relational_expression(){let e=this._shift_expression();for(;this._match([cL.tokens.less_than,cL.tokens.greater_than,cL.tokens.less_than_equal,cL.tokens.greater_than_equal]);)e=this._updateNode(new cp(this._previous().toString(),e,this._shift_expression()));return e}_shift_expression(){let e=this._additive_expression();for(;this._match([cL.tokens.shift_left,cL.tokens.shift_right]);)e=this._updateNode(new cp(this._previous().toString(),e,this._additive_expression()));return e}_additive_expression(){let e=this._multiplicative_expression();for(;this._match([cL.tokens.plus,cL.tokens.minus]);)e=this._updateNode(new cp(this._previous().toString(),e,this._multiplicative_expression()));return e}_multiplicative_expression(){let e=this._unary_expression();for(;this._match([cL.tokens.star,cL.tokens.forward_slash,cL.tokens.modulo]);)e=this._updateNode(new cp(this._previous().toString(),e,this._unary_expression()));return e}_unary_expression(){return this._match([cL.tokens.minus,cL.tokens.bang,cL.tokens.tilde,cL.tokens.star,cL.tokens.and])?this._updateNode(new cf(this._previous().toString(),this._unary_expression())):this._singular_expression()}_singular_expression(){let e=this._primary_expression(),t=this._postfix_expression();return t&&(e.postfix=t),e}_postfix_expression(){if(this._match(cL.tokens.bracket_left)){let e=this._short_circuit_or_expression();this._consume(cL.tokens.bracket_right,"Expected ']'.");let t=this._updateNode(new ch(e)),i=this._postfix_expression();return i&&(t.postfix=i),t}if(this._match(cL.tokens.period)){let e=this._consume(cL.tokens.name,"Expected member name."),t=this._postfix_expression(),i=this._updateNode(new cn(e.lexeme));return t&&(i.postfix=t),i}return null}_getStruct(e){return this._context.aliases.has(e)?this._context.aliases.get(e).type:this._context.structs.has(e)?this._context.structs.get(e):null}_getType(e){let t=this._getStruct(e);if(null!==t)return t;switch(e){case"void":return u5.void;case"bool":return u5.bool;case"i32":return u5.i32;case"u32":return u5.u32;case"f32":return u5.f32;case"f16":return u5.f16;case"vec2f":return u7.vec2f;case"vec3f":return u7.vec3f;case"vec4f":return u7.vec4f;case"vec2i":return u7.vec2i;case"vec3i":return u7.vec3i;case"vec4i":return u7.vec4i;case"vec2u":return u7.vec2u;case"vec3u":return u7.vec3u;case"vec4u":return u7.vec4u;case"vec2h":return u7.vec2h;case"vec3h":return u7.vec3h;case"vec4h":return u7.vec4h;case"mat2x2f":return u7.mat2x2f;case"mat2x3f":return u7.mat2x3f;case"mat2x4f":return u7.mat2x4f;case"mat3x2f":return u7.mat3x2f;case"mat3x3f":return u7.mat3x3f;case"mat3x4f":return u7.mat3x4f;case"mat4x2f":return u7.mat4x2f;case"mat4x3f":return u7.mat4x3f;case"mat4x4f":return u7.mat4x4f;case"mat2x2h":return u7.mat2x2h;case"mat2x3h":return u7.mat2x3h;case"mat2x4h":return u7.mat2x4h;case"mat3x2h":return u7.mat3x2h;case"mat3x3h":return u7.mat3x3h;case"mat3x4h":return u7.mat3x4h;case"mat4x2h":return u7.mat4x2h;case"mat4x3h":return u7.mat4x3h;case"mat4x4h":return u7.mat4x4h;case"mat2x2i":return u7.mat2x2i;case"mat2x3i":return u7.mat2x3i;case"mat2x4i":return u7.mat2x4i;case"mat3x2i":return u7.mat3x2i;case"mat3x3i":return u7.mat3x3i;case"mat3x4i":return u7.mat3x4i;case"mat4x2i":return u7.mat4x2i;case"mat4x3i":return u7.mat4x3i;case"mat4x4i":return u7.mat4x4i;case"mat2x2u":return u7.mat2x2u;case"mat2x3u":return u7.mat2x3u;case"mat2x4u":return u7.mat2x4u;case"mat3x2u":return u7.mat3x2u;case"mat3x3u":return u7.mat3x3u;case"mat3x4u":return u7.mat3x4u;case"mat4x2u":return u7.mat4x2u;case"mat4x3u":return u7.mat4x3u;case"mat4x4u":return u7.mat4x4u}return null}_validateTypeRange(e,t){if("i32"===t.name){if(e<-0x80000000||e>0x7fffffff)throw this._error(this._previous(),`Value out of range for i32: ${e}. Line: ${this._currentLine}.`)}else if("u32"===t.name&&(e<0||e>0xffffffff))throw this._error(this._previous(),`Value out of range for u32: ${e}. Line: ${this._currentLine}.`)}_primary_expression(){if(this._match(cL.tokens.ident)){let e=this._previous().toString();if(this._check(cL.tokens.paren_left)){let t=this._argument_expression_list(),i=this._getType(e);return null!==i?this._updateNode(new cs(i,t)):this._updateNode(new co(e,t))}if(this._context.constants.has(e)){let t=this._context.constants.get(e);return this._updateNode(new cl(e,t.value))}return this._updateNode(new ca(e))}if(this._match(cL.tokens.int_literal)){let e=this._previous().toString(),t=e.endsWith("i")||e.endsWith("i")?u5.i32:e.endsWith("u")||e.endsWith("U")?u5.u32:u5.x32,i=parseInt(e);return this._validateTypeRange(i,t),this._updateNode(new cu(new cP(i,this._exec.getTypeInfo(t)),t))}if(this._match(cL.tokens.uint_literal)){let e=parseInt(this._previous().toString());return this._validateTypeRange(e,u5.u32),this._updateNode(new cu(new cP(e,this._exec.getTypeInfo(u5.u32)),u5.u32))}if(this._match([cL.tokens.decimal_float_literal,cL.tokens.hex_float_literal])){let e=this._previous().toString(),t=e.endsWith("h");t&&(e=e.substring(0,e.length-1));let i=parseFloat(e);this._validateTypeRange(i,t?u5.f16:u5.f32);let r=t?u5.f16:u5.f32;return this._updateNode(new cu(new cP(i,this._exec.getTypeInfo(r)),r))}if(this._match([cL.keywords.true,cL.keywords.false])){let e=this._previous().toString()===cL.keywords.true.rule;return this._updateNode(new cu(new cP(+!!e,this._exec.getTypeInfo(u5.bool)),u5.bool))}if(this._check(cL.tokens.paren_left))return this._paren_expression();if(this._match(cL.keywords.bitcast)){this._consume(cL.tokens.less_than,"Expected '<'.");let e=this._type_decl();this._consume(cL.tokens.greater_than,"Expected '>'.");let t=this._paren_expression();return this._updateNode(new cc(e,t))}let e=this._type_decl(),t=this._argument_expression_list();return this._updateNode(new cs(e,t))}_argument_expression_list(){if(!this._match(cL.tokens.paren_left))return null;let e=[];do{if(this._check(cL.tokens.paren_right))break;let t=this._short_circuit_or_expression();e.push(t)}while(this._match(cL.tokens.comma))return this._consume(cL.tokens.paren_right,"Expected ')' for agument list"),e}_optional_paren_expression(){this._match(cL.tokens.paren_left);let e=this._short_circuit_or_expression();return this._match(cL.tokens.paren_right),e}_paren_expression(){this._consume(cL.tokens.paren_left,"Expected '('.");let e=this._short_circuit_or_expression();return this._consume(cL.tokens.paren_right,"Expected ')'."),e}_struct_decl(){if(!this._match(cL.keywords.struct))return null;let e=this._currentLine,t=this._consume(cL.tokens.ident,"Expected name for struct.").toString();this._consume(cL.tokens.brace_left,"Expected '{' for struct body.");let i=[];for(;!this._check(cL.tokens.brace_right);){let e=this._attribute(),t=this._consume(cL.tokens.name,"Expected variable name.").toString();this._consume(cL.tokens.colon,"Expected ':' for struct member type.");let r=this._attribute(),n=this._type_decl();null!=n&&(n.attributes=r),this._check(cL.tokens.brace_right)?this._match(cL.tokens.comma):this._consume(cL.tokens.comma,"Expected ',' for struct member."),i.push(this._updateNode(new cx(t,n,e)))}this._consume(cL.tokens.brace_right,"Expected '}' after struct body.");let r=this._currentLine,n=this._updateNode(new u9(t,i,e,r),e);return this._context.structs.set(t,n),n}_global_variable_decl(){let e=this._variable_decl();if(!e)return null;if(this._match(cL.tokens.equal)&&(e.value=this._const_expression()),null!==e.type&&e.value instanceof cu){if("x32"!==e.value.type.name&&e.type.getTypeName()!==e.value.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${e.value.type.name} to ${e.type.name}. Line:${this._currentLine}`);e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type),e.value.type=e.type}else null===e.type&&e.value instanceof cu&&(e.type="x32"===e.value.type.name?u5.i32:e.value.type,e.value.isScalar&&this._validateTypeRange(e.value.scalarValue,e.type));return e}_override_variable_decl(){let e=this._override_decl();return e&&this._match(cL.tokens.equal)&&(e.value=this._const_expression()),e}_global_const_decl(){var e;if(!this._match(cL.keywords.const))return null;let t=this._consume(cL.tokens.name,"Expected variable name"),i=this._currentLine,r=null;if(this._match(cL.tokens.colon)){let e=this._attribute();null!=(r=this._type_decl())&&(r.attributes=e)}let n=null;this._consume(cL.tokens.equal,"const declarations require an assignment");let s=this._short_circuit_or_expression();try{let e=[u5.f32],i=s.constEvaluate(this._exec,e);i instanceof cP&&this._validateTypeRange(i.value,e[0]),e[0]instanceof u7&&null===e[0].format&&i.typeInfo instanceof up&&null!==i.typeInfo.format&&("f16"===i.typeInfo.format.name?e[0].format=u5.f16:"f32"===i.typeInfo.format.name?e[0].format=u5.f32:"i32"===i.typeInfo.format.name?e[0].format=u5.i32:"u32"===i.typeInfo.format.name?e[0].format=u5.u32:"bool"===i.typeInfo.format.name?e[0].format=u5.bool:console.error(`TODO: impelement template format type ${i.typeInfo.format.name}`)),n=this._updateNode(new cu(i,e[0])),this._exec.context.setVariable(t.toString(),i)}catch(e){n=s}if(null!==r&&n instanceof cu){if("x32"!==n.type.name&&r.getTypeName()!==n.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${n.type.name} to ${r.name}. Line:${this._currentLine}`);n.type=r,n.isScalar&&this._validateTypeRange(n.scalarValue,n.type)}else null===r&&n instanceof cu&&(r=null!=(e=null==n?void 0:n.type)?e:u5.f32)===u5.x32&&(r=u5.i32);let o=this._updateNode(new uG(t.toString(),r,"","",n),i);return this._context.constants.set(o.name,o),o}_global_let_decl(){if(!this._match(cL.keywords.let))return null;let e=this._currentLine,t=this._consume(cL.tokens.name,"Expected variable name"),i=null;if(this._match(cL.tokens.colon)){let e=this._attribute();null!=(i=this._type_decl())&&(i.attributes=e)}let r=null;if(this._match(cL.tokens.equal)&&(r=this._const_expression()),null!==i&&r instanceof cu){if("x32"!==r.type.name&&i.getTypeName()!==r.type.getTypeName())throw this._error(this._peek(),`Invalid cast from ${r.type.name} to ${i.name}. Line:${this._currentLine}`);r.type=i}else null===i&&r instanceof cu&&(i="x32"===r.type.name?u5.i32:r.type);return r instanceof cu&&r.isScalar&&this._validateTypeRange(r.scalarValue,i),this._updateNode(new uW(t.toString(),i,"","",r),e)}_const_expression(){return this._short_circuit_or_expression()}_variable_decl(){if(!this._match(cL.keywords.var))return null;let e=this._currentLine,t="",i="";this._match(cL.tokens.less_than)&&(t=this._consume(cL.storage_class,"Expected storage_class.").toString(),this._match(cL.tokens.comma)&&(i=this._consume(cL.access_mode,"Expected access_mode.").toString()),this._consume(cL.tokens.greater_than,"Expected '>'."));let r=this._consume(cL.tokens.name,"Expected variable name"),n=null;if(this._match(cL.tokens.colon)){let e=this._attribute();null!=(n=this._type_decl())&&(n.attributes=e)}return this._updateNode(new u$(r.toString(),n,t,i,null),e)}_override_decl(){if(!this._match(cL.keywords.override))return null;let e=this._consume(cL.tokens.name,"Expected variable name"),t=null;if(this._match(cL.tokens.colon)){let e=this._attribute();null!=(t=this._type_decl())&&(t.attributes=e)}return this._updateNode(new uV(e.toString(),t,null))}_diagnostic(){this._consume(cL.tokens.paren_left,"Expected '('");let e=this._consume(cL.tokens.ident,"Expected severity control name.");this._consume(cL.tokens.comma,"Expected ','");let t=this._consume(cL.tokens.ident,"Expected diagnostic rule name.").toString();return this._match(cL.tokens.period)&&(t+=`.${this._consume(cL.tokens.ident,"Expected diagnostic message.").toString()}`),this._consume(cL.tokens.paren_right,"Expected ')'"),this._updateNode(new u1(e.toString(),t))}_enable_directive(){let e=this._consume(cL.tokens.ident,"identity expected.");return this._updateNode(new uQ(e.toString()))}_requires_directive(){let e=[this._consume(cL.tokens.ident,"identity expected.").toString()];for(;this._match(cL.tokens.comma);){let t=this._consume(cL.tokens.ident,"identity expected.");e.push(t.toString())}return this._updateNode(new u0(e))}_type_alias(){let e=this._consume(cL.tokens.ident,"identity expected.");this._consume(cL.tokens.equal,"Expected '=' for type alias.");let t=this._type_decl();if(null===t)throw this._error(this._peek(),"Expected Type for Alias.");this._context.aliases.has(t.name)&&(t=this._context.aliases.get(t.name).type);let i=this._updateNode(new u2(e.toString(),t));return this._context.aliases.set(i.name,i),i}_type_decl(){if(this._check([cL.tokens.ident,...cL.texel_format,cL.keywords.bool,cL.keywords.f32,cL.keywords.i32,cL.keywords.u32])){let e=this._advance().toString();if(this._context.structs.has(e))return this._context.structs.get(e);if(this._context.aliases.has(e))return this._context.aliases.get(e).type;if(!this._getType(e)){let t=this._updateNode(new u8(e));return this._forwardTypeCount++,t}return this._updateNode(new u5(e))}let e=this._texture_sampler_types();if(e)return e;if(this._check(cL.template_types)){let e=this._advance().toString(),t=null,i=null;return this._match(cL.tokens.less_than)&&(t=this._type_decl(),i=null,this._match(cL.tokens.comma)&&(i=this._consume(cL.access_mode,"Expected access_mode for pointer").toString()),this._consume(cL.tokens.greater_than,"Expected '>' for type.")),this._updateNode(new u7(e,t,i))}if(this._match(cL.keywords.ptr)){let e=this._previous().toString();this._consume(cL.tokens.less_than,"Expected '<' for pointer.");let t=this._consume(cL.storage_class,"Expected storage_class for pointer");this._consume(cL.tokens.comma,"Expected ',' for pointer.");let i=this._type_decl(),r=null;return this._match(cL.tokens.comma)&&(r=this._consume(cL.access_mode,"Expected access_mode for pointer").toString()),this._consume(cL.tokens.greater_than,"Expected '>' for pointer."),this._updateNode(new ce(e,t.toString(),i,r))}let t=this._attribute();if(this._match(cL.keywords.array)){let e=null,i=-1,r=this._previous(),n=null;if(this._match(cL.tokens.less_than)){e=this._type_decl(),this._context.aliases.has(e.name)&&(e=this._context.aliases.get(e.name).type);let t="";if(this._match(cL.tokens.comma)){n=this._shift_expression();try{t=n.constEvaluate(this._exec).toString(),n=null}catch(e){t="1"}}this._consume(cL.tokens.greater_than,"Expected '>' for array."),i=t?parseInt(t):0}let s=this._updateNode(new ct(r.toString(),t,e,i));return n&&this._deferArrayCountEval.push({arrayType:s,countNode:n}),s}return null}_texture_sampler_types(){if(this._match(cL.sampler_type)||this._match(cL.depth_texture_type))return this._updateNode(new ci(this._previous().toString(),null,null));if(this._match(cL.sampled_texture_type)||this._match(cL.multisampled_texture_type)){let e=this._previous();this._consume(cL.tokens.less_than,"Expected '<' for sampler type.");let t=this._type_decl();return this._consume(cL.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new ci(e.toString(),t,null))}if(this._match(cL.storage_texture_type)){let e=this._previous();this._consume(cL.tokens.less_than,"Expected '<' for sampler type.");let t=this._consume(cL.texel_format,"Invalid texel format.").toString();this._consume(cL.tokens.comma,"Expected ',' after texel format.");let i=this._consume(cL.access_mode,"Expected access mode for storage texture type.").toString();return this._consume(cL.tokens.greater_than,"Expected '>' for sampler type."),this._updateNode(new ci(e.toString(),t,i))}return null}_attribute(){let e=[];for(;this._match(cL.tokens.attr);){let t=this._consume(cL.attribute_name,"Expected attribute name"),i=this._updateNode(new cw(t.toString(),null));if(this._match(cL.tokens.paren_left)){if(i.value=this._consume(cL.literal_or_ident,"Expected attribute value").toString(),this._check(cL.tokens.comma)){this._advance();do{let e=this._consume(cL.literal_or_ident,"Expected attribute value").toString();i.value instanceof Array||(i.value=[i.value]),i.value.push(e)}while(this._match(cL.tokens.comma))}this._consume(cL.tokens.paren_right,"Expected ')'")}e.push(i)}return 0==e.length?null:e}}class c5 extends cY{constructor(e){super(),e&&this.update(e)}update(e){let t=(new c6).parse(e);this.updateAST(t)}}function c8(e){return e?.format?`${e.name}<${e.format.name}>`:e.name}var c9=e.i(36932);let c7={};function he(e="id"){c7[e]=c7[e]||1;let t=c7[e]++;return`${e}-${t}`}class ht{id;userData={};topology;bufferLayout=[];vertexCount;indices;attributes;constructor(e){if(this.id=e.id||he("geometry"),this.topology=e.topology,this.indices=e.indices||null,this.attributes=e.attributes,this.vertexCount=e.vertexCount,this.bufferLayout=e.bufferLayout||[],this.indices&&!(this.indices.usage&lV.Buffer.INDEX))throw Error("Index buffer must have INDEX usage")}destroy(){for(let e of(this.indices?.destroy(),Object.values(this.attributes)))e.destroy()}getVertexCount(){return this.vertexCount}getAttributes(){return this.attributes}getIndexes(){return this.indices||null}_calculateVertexCount(e){return e.byteLength/12}}var hi=e.i(81905);class hr extends hi.Resource{get[Symbol.toStringTag](){return"ComputePipeline"}hash="";shaderLayout;constructor(e,t){super(e,t,hr.defaultProps),this.shaderLayout=t.shaderLayout}static defaultProps={...hi.Resource.defaultProps,shader:void 0,entryPoint:void 0,constants:{},shaderLayout:void 0}}class hn{static defaultProps={...ut.RenderPipeline.defaultProps};static getDefaultPipelineFactory(e){return e._lumaData.defaultPipelineFactory=e._lumaData.defaultPipelineFactory||new hn(e),e._lumaData.defaultPipelineFactory}device;cachingEnabled;destroyPolicy;debug;_hashCounter=0;_hashes={};_renderPipelineCache={};_computePipelineCache={};get[Symbol.toStringTag](){return"PipelineFactory"}toString(){return`PipelineFactory(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cachePipelines,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=e.props.debugFactories}createRenderPipeline(e){if(!this.cachingEnabled)return this.device.createRenderPipeline(e);let t={...ut.RenderPipeline.defaultProps,...e},i=this._renderPipelineCache,r=this._hashRenderPipeline(t),n=i[r]?.pipeline;return n?(i[r].useCount++,this.debug&&eA.log.log(3,`${this}: ${i[r].pipeline} reused, count=${i[r].useCount}, (id=${e.id})`)()):((n=this.device.createRenderPipeline({...t,id:t.id?`${t.id}-cached`:he("unnamed-cached")})).hash=r,i[r]={pipeline:n,useCount:1},this.debug&&eA.log.log(3,`${this}: ${n} created, count=${i[r].useCount}`)()),n}createComputePipeline(e){if(!this.cachingEnabled)return this.device.createComputePipeline(e);let t={...hr.defaultProps,...e},i=this._computePipelineCache,r=this._hashComputePipeline(t),n=i[r]?.pipeline;return n?(i[r].useCount++,this.debug&&eA.log.log(3,`${this}: ${i[r].pipeline} reused, count=${i[r].useCount}, (id=${e.id})`)()):((n=this.device.createComputePipeline({...t,id:t.id?`${t.id}-cached`:void 0})).hash=r,i[r]={pipeline:n,useCount:1},this.debug&&eA.log.log(3,`${this}: ${n} created, count=${i[r].useCount}`)()),n}release(e){if(!this.cachingEnabled)return void e.destroy();let t=this._getCache(e),i=e.hash;t[i].useCount--,0===t[i].useCount?(this._destroyPipeline(e),this.debug&&eA.log.log(3,`${this}: ${e} released and destroyed`)()):t[i].useCount<0?(eA.log.error(`${this}: ${e} released, useCount < 0, resetting`)(),t[i].useCount=0):this.debug&&eA.log.log(3,`${this}: ${e} released, count=${t[i].useCount}`)()}_destroyPipeline(e){let t=this._getCache(e);switch(this.destroyPolicy){case"never":return!1;case"unused":return delete t[e.hash],e.destroy(),!0}}_getCache(e){let t;if(e instanceof hr&&(t=this._computePipelineCache),e instanceof ut.RenderPipeline&&(t=this._renderPipelineCache),!t)throw Error(`${this}`);if(!t[e.hash])throw Error(`${this}: ${e} matched incorrect entry`);return t}_hashComputePipeline(e){let{type:t}=this.device,i=this._getHash(e.shader.source);return`${t}/C/${i}`}_hashRenderPipeline(e){let t=e.vs?this._getHash(e.vs.source):0,i=e.fs?this._getHash(e.fs.source):0,r=this._getHash(JSON.stringify(e.bufferLayout)),{type:n}=this.device;if("webgl"===n)return`${n}/R/${t}/${i}V-BL${r}`;{let s=this._getHash(JSON.stringify(e.parameters));return`${n}/R/${t}/${i}V-T${e.topology}P${s}BL${r}`}}_getHash(e){return void 0===this._hashes[e]&&(this._hashes[e]=this._hashCounter++),this._hashes[e]}}var hs=e.i(45453);class ho{static defaultProps={...hs.Shader.defaultProps};static getDefaultShaderFactory(e){return e._lumaData.defaultShaderFactory||=new ho(e),e._lumaData.defaultShaderFactory}device;cachingEnabled;destroyPolicy;debug;_cache={};get[Symbol.toStringTag](){return"ShaderFactory"}toString(){return`${this[Symbol.toStringTag]}(${this.device.id})`}constructor(e){this.device=e,this.cachingEnabled=e.props._cacheShaders,this.destroyPolicy=e.props._cacheDestroyPolicy,this.debug=!0}createShader(e){if(!this.cachingEnabled)return this.device.createShader(e);let t=this._hashShader(e),i=this._cache[t];if(i)i.useCount++,this.debug&&eA.log.log(3,`${this}: Reusing shader ${i.shader.id} count=${i.useCount}`)();else{let r=this.device.createShader({...e,id:e.id?`${e.id}-cached`:void 0});this._cache[t]=i={shader:r,useCount:1},this.debug&&eA.log.log(3,`${this}: Created new shader ${r.id}`)()}return i.shader}release(e){if(!this.cachingEnabled)return void e.destroy();let t=this._hashShader(e),i=this._cache[t];if(i)if(i.useCount--,0===i.useCount)"unused"===this.destroyPolicy&&(delete this._cache[t],i.shader.destroy(),this.debug&&eA.log.log(3,`${this}: Releasing shader ${e.id}, destroyed`)());else if(i.useCount<0)throw Error(`ShaderFactory: Shader ${e.id} released too many times`);else this.debug&&eA.log.log(3,`${this}: Releasing shader ${e.id} count=${i.useCount}`)()}_hashShader(e){return`${e.stage}:${e.source}`}}let ha=null,hl=null;class hu{bufferLayouts;constructor(e){this.bufferLayouts=e}getBufferLayout(e){return this.bufferLayouts.find(t=>t.name===e)||null}getAttributeNamesForBuffer(e){return e.attributes?e.attributes?.map(e=>e.attribute):[e.name]}mergeBufferLayouts(e,t){let i=[...e];for(let e of t){let t=i.findIndex(t=>t.name===e.name);t<0?i.push(e):i[t]=e}return i}getBufferIndex(e){let t=this.bufferLayouts.findIndex(t=>t.name===e);return -1===t&&eA.log.warn(`BufferLayout: Missing buffer for "${e}".`)(),t}}class hc{options={disableWarnings:!1};modules;moduleUniforms;moduleBindings;constructor(e,t){for(const i of(Object.assign(this.options,t),ef(Object.values(e).filter(e=>e.dependencies))))e[i.name]=i;for(const[t,i]of(eA.log.log(1,"Creating ShaderInputs with modules",Object.keys(e))(),this.modules=e,this.moduleUniforms={},this.moduleBindings={},Object.entries(e)))this._addModule(i),i.name&&t!==i.name&&!this.options.disableWarnings&&eA.log.warn(`Module name: ${t} vs ${i.name}`)()}destroy(){}setProps(e){for(let t of Object.keys(e)){let i=e[t]||{},r=this.modules[t];if(!r){this.options.disableWarnings||eA.log.warn(`Module ${t} not found`)();continue}let n=this.moduleUniforms[t],s=this.moduleBindings[t],{uniforms:o,bindings:a}=function(e){let t={bindings:{},uniforms:{}};return Object.keys(e).forEach(i=>{let r=e[i];(!ArrayBuffer.isView(r)||r instanceof DataView)&&(Array.isArray(r)?0!==r.length&&"number"!=typeof r[0]:1)&&"number"!=typeof r&&"boolean"!=typeof r?t.bindings[i]=r:t.uniforms[i]=r}),t}(r.getUniforms?.(i,n)||i);this.moduleUniforms[t]={...n,...o},this.moduleBindings[t]={...s,...a}}}getModules(){return Object.values(this.modules)}getUniformValues(){return this.moduleUniforms}getBindingValues(){let e={};for(let t of Object.values(this.moduleBindings))Object.assign(e,t);return e}getDebugTable(){let e={};for(let[t,i]of Object.entries(this.moduleUniforms))for(let[r,n]of Object.entries(i))e[`${t}.${r}`]={type:this.modules[t].uniformTypes?.[r],value:String(n)};return e}_addModule(e){let t=e.name;this.moduleUniforms[t]=e.defaultUniforms||{},this.moduleBindings[t]={}}}async function hh(e,t){let i=new Image;return i.crossOrigin=t?.crossOrigin||"anonymous",i.src=e.startsWith("http")?e:""+e,await i.decode(),t?await createImageBitmap(i,t):await createImageBitmap(i)}let hd=["+X","-X","+Y","-Y","+Z","-Z"],hf=["+X","-X","+Y","-Y","+Z","-Z"];class hp{device;id;props;texture;sampler;view;ready;isReady=!1;destroyed=!1;resolveReady=()=>{};rejectReady=()=>{};get[Symbol.toStringTag](){return"AsyncTexture"}toString(){return`AsyncTexture:"${this.id}"(${this.isReady?"ready":"loading"})`}constructor(e,t){this.device=e;const i=he("async-texture");this.props={...hp.defaultProps,id:i,...t},this.id=this.props.id,t={...t},"string"==typeof t?.data&&"2d"===t.dimension&&(t.data=hh(t.data)),t.mipmaps&&(t.mipLevels="auto"),this.ready=new Promise((e,t)=>{this.resolveReady=()=>{this.isReady=!0,e()},this.rejectReady=t}),this.initAsync(t)}async initAsync(e){let t=e.data,i=await hg(t).then(void 0,this.rejectReady);if(this.destroyed)return;let r=this.props.width&&this.props.height?{width:this.props.width,height:this.props.height}:this.getTextureDataSize(i);if(!r)throw Error("Texture size could not be determined");let n={...r,...e,data:void 0,mipLevels:1},s=this.device.getMipLevelCount(n.width,n.height);if(n.mipLevels="auto"===this.props.mipLevels?s:Math.min(s,this.props.mipLevels),this.texture=this.device.createTexture(n),this.sampler=this.texture.sampler,this.view=this.texture.view,e.data)switch(this.props.dimension){case"1d":this._setTexture1DData(this.texture,i);break;case"2d":this._setTexture2DData(i);break;case"3d":this._setTexture3DData(this.texture,i);break;case"2d-array":this._setTextureArrayData(this.texture,i);break;case"cube":this._setTextureCubeData(this.texture,i);break;case"cube-array":this._setTextureCubeArrayData(this.texture,i)}this.props.mipmaps&&this.generateMipmaps(),eA.log.info(1,`${this} loaded`),this.resolveReady()}destroy(){this.texture&&(this.texture.destroy(),this.texture=null),this.destroyed=!0}generateMipmaps(){this.texture.generateMipmapsWebGL()}setSampler(e={}){this.texture.setSampler(e instanceof ue.Sampler?e:this.device.createSampler(e))}resize(e){if(!this.isReady)throw Error("Cannot resize texture before it is ready");if(e.width===this.texture.width&&e.height===this.texture.height)return!1;if(this.texture){let t=this.texture;this.texture=t.clone(e),t.destroy()}return!0}isTextureLevelData(e){return ArrayBuffer.isView(e?.data)}getTextureDataSize(e){if(!e||ArrayBuffer.isView(e))return null;if(Array.isArray(e))return this.getTextureDataSize(e[0]);if(this.device.isExternalImage(e))return this.device.getExternalImageSize(e);if(e&&"object"==typeof e&&e.constructor===Object){let t=Object.values(e)[0];return{width:t.width,height:t.height}}throw Error("texture size deduction failed")}getCubeFaceDepth(e){switch(e){case"+X":return 0;case"-X":return 1;case"+Y":return 2;case"-Y":return 3;case"+Z":return 4;case"-Z":return 5;default:throw Error(e)}}setTextureData(e){}_setTexture1DData(e,t){throw Error("setTexture1DData not supported in WebGL.")}_setTexture2DData(e,t=0){if(!this.texture)throw Error("Texture not initialized");let i=this._normalizeTextureData(e);i.length>1&&!1!==this.props.mipmaps&&eA.log.warn(`Texture ${this.id} mipmap and multiple LODs.`)();for(let e=0;e<i.length;e++){let r=i[e];this.device.isExternalImage(r)?this.texture.copyExternalImage({image:r,depth:t,mipLevel:e,flipY:!0}):this.texture.copyImageData({data:r.data,mipLevel:e})}}_setTexture3DData(e,t){if(this.texture?.props.dimension!=="3d")throw Error(this.id);for(let e=0;e<t.length;e++)this._setTexture2DData(t[e],e)}_setTextureCubeData(e,t){if(this.texture?.props.dimension!=="cube")throw Error(this.id);for(let[e,i]of Object.entries(t)){let t=hf.indexOf(e);this._setTexture2DData(i,t)}}_setTextureArrayData(e,t){if(this.texture?.props.dimension!=="2d-array")throw Error(this.id);for(let e=0;e<t.length;e++)this._setTexture2DData(t[e],e)}_setTextureCubeArrayData(e,t){throw Error("setTextureCubeArrayData not supported in WebGL2.")}_setTextureCubeFaceData(e,t,i,r=0){Array.isArray(t)&&t.length>1&&!1!==this.props.mipmaps&&eA.log.warn(`${this.id} has mipmap and multiple LODs.`)();let n=hd.indexOf(i);this._setTexture2DData(t,n)}_normalizeTextureData(e){let t=this.texture;return ArrayBuffer.isView(e)?[{data:e,width:t.width,height:t.height}]:Array.isArray(e)?e:[e]}static defaultProps={...l9.Texture.defaultProps,data:null,mipmaps:!1}}async function hg(e){if(Array.isArray(e=await e))return await Promise.all(e.map(hg));if(e&&"object"==typeof e&&e.constructor===Object){let t=e,i=await Promise.all(Object.values(t)),r=Object.keys(t),n={};for(let e=0;e<r.length;e++)n[r[e]]=i[e];return n}return e}class hm{static defaultProps={...ut.RenderPipeline.defaultProps,source:void 0,vs:null,fs:null,id:"unnamed",handle:void 0,userData:{},defines:{},modules:[],geometry:null,indexBuffer:null,attributes:{},constantAttributes:{},varyings:[],isInstanced:void 0,instanceCount:0,vertexCount:0,shaderInputs:void 0,pipelineFactory:void 0,shaderFactory:void 0,transformFeedback:void 0,shaderAssembler:eI.getDefaultShaderAssembler(),debugShaders:void 0,disableWarnings:void 0};device;id;source;vs;fs;pipelineFactory;shaderFactory;userData={};parameters;topology;bufferLayout;isInstanced=void 0;instanceCount=0;vertexCount;indexBuffer=null;bufferAttributes={};constantAttributes={};bindings={};vertexArray;transformFeedback=null;pipeline;shaderInputs;_uniformStore;_attributeInfos={};_gpuGeometry=null;props;_pipelineNeedsUpdate="newly created";_needsRedraw="initializing";_destroyed=!1;_lastDrawTimestamp=-1;get[Symbol.toStringTag](){return"Model"}toString(){return`Model(${this.id})`}constructor(e,t){this.props={...hm.defaultProps,...t},t=this.props,this.id=t.id||he("model"),this.device=e,Object.assign(this.userData,t.userData);const i=Object.fromEntries(this.props.modules?.map(e=>[e.name,e])||[]),r=t.shaderInputs||new hc(i,{disableWarnings:this.props.disableWarnings});this.setShaderInputs(r);const n=function(e){return{type:e.type,shaderLanguage:e.info.shadingLanguage,shaderLanguageVersion:e.info.shadingLanguageVersion,gpu:e.info.gpu,features:e.features}}(e),s=(this.props.modules?.length>0?this.props.modules:this.shaderInputs?.getModules())||[];if("webgpu"===this.device.type&&this.props.source){const{source:e,getUniforms:t}=this.props.shaderAssembler.assembleWGSLShader({platformInfo:n,...this.props,modules:s});this.source=e,this._getModuleUniforms=t,this.props.shaderLayout||=function(e){let t,i={attributes:[],bindings:[]};try{t=function(e){try{return new c5(e)}catch(t){if(t instanceof Error)throw t;let e="WGSL parse error";throw"object"==typeof t&&t?.message&&(e+=`: ${t.message} `),"object"==typeof t&&t?.token&&(e+=t.token.line||""),Error(e,{cause:t})}}(e)}catch(e){return eA.log.error(e.message)(),i}for(let e of t.uniforms){let t=[];for(let i of e.type?.members||[])t.push({name:i.name,type:c8(i.type)});i.bindings.push({type:"uniform",name:e.name,group:e.group,location:e.binding,members:t})}for(let e of t.textures)i.bindings.push({type:"texture",name:e.name,group:e.group,location:e.binding});for(let e of t.samplers)i.bindings.push({type:"sampler",name:e.name,group:e.group,location:e.binding});let r=t.entry.vertex[0],n=r?.inputs.length||0;for(let e=0;e<n;e++){let t=r.inputs[e];if("location"===t.locationType){let e=c8(t.type);i.attributes.push({name:t.name,location:Number(t.location),type:e})}}return i}(this.source)}else{const{vs:e,fs:t,getUniforms:i}=this.props.shaderAssembler.assembleGLSLShaderPair({platformInfo:n,...this.props,modules:s});this.vs=e,this.fs=t,this._getModuleUniforms=i}this.vertexCount=this.props.vertexCount,this.instanceCount=this.props.instanceCount,this.topology=this.props.topology,this.bufferLayout=this.props.bufferLayout,this.parameters=this.props.parameters,t.geometry&&this.setGeometry(t.geometry),this.pipelineFactory=t.pipelineFactory||hn.getDefaultPipelineFactory(this.device),this.shaderFactory=t.shaderFactory||ho.getDefaultShaderFactory(this.device),this.pipeline=this._updatePipeline(),this.vertexArray=e.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry),"isInstanced"in t&&(this.isInstanced=t.isInstanced),t.instanceCount&&this.setInstanceCount(t.instanceCount),t.vertexCount&&this.setVertexCount(t.vertexCount),t.indexBuffer&&this.setIndexBuffer(t.indexBuffer),t.attributes&&this.setAttributes(t.attributes),t.constantAttributes&&this.setConstantAttributes(t.constantAttributes),t.bindings&&this.setBindings(t.bindings),t.transformFeedback&&(this.transformFeedback=t.transformFeedback),Object.seal(this)}destroy(){this._destroyed||(this.pipelineFactory.release(this.pipeline),this.shaderFactory.release(this.pipeline.vs),this.pipeline.fs&&this.shaderFactory.release(this.pipeline.fs),this._uniformStore.destroy(),this._gpuGeometry?.destroy(),this._destroyed=!0)}needsRedraw(){this._getBindingsUpdateTimestamp()>this._lastDrawTimestamp&&this.setNeedsRedraw("contents of bound textures or buffers updated");let e=this._needsRedraw;return this._needsRedraw=!1,e}setNeedsRedraw(e){this._needsRedraw||=e}predraw(){this.updateShaderInputs(),this.pipeline=this._updatePipeline()}draw(e){let t,i=this._areBindingsLoading();if(i)return eA.log.info(2,`>>> DRAWING ABORTED ${this.id}: ${i} not loaded`)(),!1;try{e.pushDebugGroup(`${this}.predraw(${e})`),this.predraw()}finally{e.popDebugGroup()}try{e.pushDebugGroup(`${this}.draw(${e})`),this._logDrawCallStart(),this.pipeline=this._updatePipeline();let i=this._getBindings();this.pipeline.setBindings(i,{disableWarnings:this.props.disableWarnings});let{indexBuffer:r}=this.vertexArray,n=r?r.byteLength/("uint32"===r.indexType?4:2):void 0;t=this.pipeline.draw({renderPass:e,vertexArray:this.vertexArray,isInstanced:this.isInstanced,vertexCount:this.vertexCount,instanceCount:this.instanceCount,indexCount:n,transformFeedback:this.transformFeedback||void 0,parameters:this.parameters,topology:this.topology})}finally{e.popDebugGroup(),this._logDrawCallEnd()}return this._logFramebuffer(e),t?(this._lastDrawTimestamp=this.device.timestamp,this._needsRedraw=!1):this._needsRedraw="waiting for resource initialization",t}setGeometry(e){this._gpuGeometry?.destroy();let t=e&&function(e,t){if(t instanceof ht)return t;let i=function(e,t){if(!t.indices)return;let i=t.indices.value;return e.createBuffer({usage:lV.Buffer.INDEX,data:i})}(e,t),{attributes:r,bufferLayout:n}=function(e,t){let i=[],r={};for(let[n,s]of Object.entries(t.attributes)){let t=n;switch(n){case"POSITION":t="positions";break;case"NORMAL":t="normals";break;case"TEXCOORD_0":t="texCoords";break;case"COLOR_0":t="colors"}if(s){r[t]=e.createBuffer({data:s.value,id:`${n}-buffer`});let{value:o,size:a,normalized:l}=s;i.push({name:t,format:(0,c9.getVertexFormatFromAttribute)(o,a,l)})}}return{attributes:r,bufferLayout:i,vertexCount:t._calculateVertexCount(t.attributes,t.indices)}}(e,t);return new ht({topology:t.topology||"triangle-list",bufferLayout:n,vertexCount:t.vertexCount,indices:i,attributes:r})}(this.device,e);if(t){this.setTopology(t.topology||"triangle-list");let e=new hu(this.bufferLayout);this.bufferLayout=e.mergeBufferLayouts(t.bufferLayout,this.bufferLayout),this.vertexArray&&this._setGeometryAttributes(t)}this._gpuGeometry=t}setTopology(e){e!==this.topology&&(this.topology=e,this._setPipelineNeedsUpdate("topology"))}setBufferLayout(e){let t=new hu(this.bufferLayout);this.bufferLayout=this._gpuGeometry?t.mergeBufferLayouts(e,this._gpuGeometry.bufferLayout):e,this._setPipelineNeedsUpdate("bufferLayout"),this.pipeline=this._updatePipeline(),this.vertexArray=this.device.createVertexArray({shaderLayout:this.pipeline.shaderLayout,bufferLayout:this.pipeline.bufferLayout}),this._gpuGeometry&&this._setGeometryAttributes(this._gpuGeometry)}setParameters(e){!function e(t,i,r){if(t===i)return!0;if(!r||!t||!i)return!1;if(Array.isArray(t)){if(!Array.isArray(i)||t.length!==i.length)return!1;for(let n=0;n<t.length;n++)if(!e(t[n],i[n],r-1))return!1;return!0}if(Array.isArray(i))return!1;if("object"==typeof t&&"object"==typeof i){let n=Object.keys(t),s=Object.keys(i);if(n.length!==s.length)return!1;for(let s of n)if(!i.hasOwnProperty(s)||!e(t[s],i[s],r-1))return!1;return!0}return!1}(e,this.parameters,2)&&(this.parameters=e,this._setPipelineNeedsUpdate("parameters"))}setInstanceCount(e){this.instanceCount=e,void 0===this.isInstanced&&e>0&&(this.isInstanced=!0),this.setNeedsRedraw("instanceCount")}setVertexCount(e){this.vertexCount=e,this.setNeedsRedraw("vertexCount")}setShaderInputs(e){for(let[i,r]of(this.shaderInputs=e,this._uniformStore=new ua(this.shaderInputs.modules),Object.entries(this.shaderInputs.modules))){var t;if((t=r).uniformTypes&&!function(e){for(let t in e)return!1;return!0}(t.uniformTypes)){let e=this._uniformStore.getManagedUniformBuffer(this.device,i);this.bindings[`${i}Uniforms`]=e}}this.setNeedsRedraw("shaderInputs")}updateShaderInputs(){this._uniformStore.setUniforms(this.shaderInputs.getUniformValues()),this.setBindings(this.shaderInputs.getBindingValues()),this.setNeedsRedraw("shaderInputs")}setBindings(e){Object.assign(this.bindings,e),this.setNeedsRedraw("bindings")}setTransformFeedback(e){this.transformFeedback=e,this.setNeedsRedraw("transformFeedback")}setIndexBuffer(e){this.vertexArray.setIndexBuffer(e),this.setNeedsRedraw("indexBuffer")}setAttributes(e,t){var i,r;let n,s,o=t?.disableWarnings??this.props.disableWarnings;e.indices&&eA.log.warn(`Model:${this.id} setAttributes() - indexBuffer should be set using setIndexBuffer()`)(),this.bufferLayout=(i=this.pipeline.shaderLayout,r=this.bufferLayout,n=Object.fromEntries(i.attributes.map(e=>[e.name,e.location])),(s=r.slice()).sort((e,t)=>{let i=e.attributes?e.attributes.map(e=>e.attribute):[e.name],r=t.attributes?t.attributes.map(e=>e.attribute):[t.name];return Math.min(...i.map(e=>n[e]))-Math.min(...r.map(e=>n[e]))}),s);let a=new hu(this.bufferLayout);for(let[t,i]of Object.entries(e)){let e=a.getBufferLayout(t);if(!e){o||eA.log.warn(`Model(${this.id}): Missing layout for buffer "${t}".`)();continue}let r=a.getAttributeNamesForBuffer(e),n=!1;for(let e of r){let t=this._attributeInfos[e];if(t){let e="webgpu"===this.device.type?a.getBufferIndex(t.bufferName):t.location;this.vertexArray.setBuffer(e,i),n=!0}}n||o||eA.log.warn(`Model(${this.id}): Ignoring buffer "${i.id}" for unknown attribute "${t}"`)()}this.setNeedsRedraw("attributes")}setConstantAttributes(e,t){for(let[i,r]of Object.entries(e)){let e=this._attributeInfos[i];e?this.vertexArray.setConstantWebGL(e.location,r):(t?.disableWarnings??this.props.disableWarnings)||eA.log.warn(`Model "${this.id}: Ignoring constant supplied for unknown attribute "${i}"`)()}this.setNeedsRedraw("constants")}_areBindingsLoading(){for(let e of Object.values(this.bindings))if(e instanceof hp&&!e.isReady)return e.id;return!1}_getBindings(){let e={};for(let[t,i]of Object.entries(this.bindings))i instanceof hp?i.isReady&&(e[t]=i.texture):e[t]=i;return e}_getBindingsUpdateTimestamp(){let e=0;for(let t of Object.values(this.bindings))t instanceof l7.TextureView?e=Math.max(e,t.texture.updateTimestamp):t instanceof lV.Buffer||t instanceof l9.Texture?e=Math.max(e,t.updateTimestamp):t instanceof hp?e=t.texture?Math.max(e,t.texture.updateTimestamp):1/0:t instanceof ue.Sampler||(e=Math.max(e,t.buffer.updateTimestamp));return e}_setGeometryAttributes(e){let t={...e.attributes};for(let[e]of Object.entries(t))this.pipeline.shaderLayout.attributes.find(t=>t.name===e)||"positions"===e||delete t[e];this.vertexCount=e.vertexCount,this.setIndexBuffer(e.indices||null),this.setAttributes(e.attributes,{disableWarnings:!0}),this.setAttributes(t,{disableWarnings:this.props.disableWarnings}),this.setNeedsRedraw("geometry attributes")}_setPipelineNeedsUpdate(e){this._pipelineNeedsUpdate||=e,this.setNeedsRedraw(e)}_updatePipeline(){if(this._pipelineNeedsUpdate){let e=null,t=null;this.pipeline&&(eA.log.log(1,`Model ${this.id}: Recreating pipeline because "${this._pipelineNeedsUpdate}".`)(),e=this.pipeline.vs,t=this.pipeline.fs),this._pipelineNeedsUpdate=!1;let i=this.shaderFactory.createShader({id:`${this.id}-vertex`,stage:"vertex",source:this.source||this.vs,debugShaders:this.props.debugShaders}),r=null;this.source?r=i:this.fs&&(r=this.shaderFactory.createShader({id:`${this.id}-fragment`,stage:"fragment",source:this.source||this.fs,debugShaders:this.props.debugShaders})),this.pipeline=this.pipelineFactory.createRenderPipeline({...this.props,bufferLayout:this.bufferLayout,topology:this.topology,parameters:this.parameters,bindings:this._getBindings(),vs:i,fs:r}),this._attributeInfos=(0,ul.getAttributeInfosFromLayouts)(this.pipeline.shaderLayout,this.bufferLayout),e&&this.shaderFactory.release(e),t&&this.shaderFactory.release(t)}return this.pipeline}_lastLogTime=0;_logOpen=!1;_logDrawCallStart(){let e=eA.log.level>3?0:1e4;eA.log.level<2||Date.now()-this._lastLogTime<e||(this._lastLogTime=Date.now(),this._logOpen=!0,eA.log.group(2,`>>> DRAWING MODEL ${this.id}`,{collapsed:eA.log.level<=2})())}_logDrawCallEnd(){if(this._logOpen){let e=function(e,t){let i={},r="Values";if(0===e.attributes.length&&!e.varyings?.length)return{"No attributes or varyings":{[r]:"N/A"}};for(let t of e.attributes)if(t){let e=`${t.location} ${t.name}: ${t.type}`;i[`in ${e}`]={[r]:t.stepMode||"vertex"}}for(let t of e.varyings||[]){let e=`${t.location} ${t.name}`;i[`out ${e}`]={[r]:JSON.stringify(t)}}return i}(this.pipeline.shaderLayout,this.id);eA.log.table(2,e)();let t=this.shaderInputs.getDebugTable();eA.log.table(2,t)();let i=this._getAttributeDebugTable();eA.log.table(2,this._attributeInfos)(),eA.log.table(2,i)(),eA.log.groupEnd(2)(),this._logOpen=!1}}_drawCount=0;_logFramebuffer(e){let t=this.device.props.debugFramebuffers;if(this._drawCount++,!t)return;let i=e.props.framebuffer;i&&function(e,{id:t,minimap:i,opaque:r,top:n="0",left:s="0",rgbaScale:o=1}){ha||((ha=document.createElement("canvas")).id=t,ha.title=t,ha.style.zIndex="100",ha.style.position="absolute",ha.style.top=n,ha.style.left=s,ha.style.border="blue 5px solid",ha.style.transform="scaleY(-1)",document.body.appendChild(ha),hl=ha.getContext("2d")),(ha.width!==e.width||ha.height!==e.height)&&(ha.width=e.width/2,ha.height=e.height/2,ha.style.width="400px",ha.style.height="400px");let a=e.device.readPixelsToArrayWebGL(e),l=hl?.createImageData(e.width,e.height);if(l){for(let e=0;e<a.length;e+=4)l.data[0+e+0]=a[e+0]*o,l.data[0+e+1]=a[e+1]*o,l.data[0+e+2]=a[e+2]*o,l.data[0+e+3]=r?255:a[e+3]*o;hl?.putImageData(l,0,0)}}(i,{id:i.id,minimap:!0})}_getAttributeDebugTable(){let e={};for(let[t,i]of Object.entries(this._attributeInfos)){let r=this.vertexArray.attributes[i.location];e[i.location]={name:t,type:i.shaderType,values:r?this._getBufferOrConstantValues(r,i.bufferDataType):"null"}}if(this.vertexArray.indexBuffer){let{indexBuffer:t}=this.vertexArray,i="uint32"===t.indexType?new Uint32Array(t.debugData):new Uint16Array(t.debugData);e.indices={name:"indices",type:t.indexType,values:i.toString()}}return e}_getBufferOrConstantValues(e,t){let i=(0,lG.getTypedArrayConstructor)(t);return(e instanceof lV.Buffer?new i(e.debugData):e).toString()}}class hy{device;model;transformFeedback;static defaultProps={...hm.defaultProps,outputs:void 0,feedbackBuffers:void 0};static isSupported(e){return e?.info?.type==="webgl"}constructor(e,t=hy.defaultProps){if(!hy.isSupported(e))throw Error("BufferTransform not yet implemented on WebGPU");this.device=e,this.model=new hm(this.device,{id:t.id||"buffer-transform-model",fs:t.fs||function(e){let{input:t,inputChannels:i,output:r}={};if(!t)return l8;if(!i)throw Error("inputChannels");let n=function(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw Error(`invalid channels: ${e}`)}}(i),s=function(e,t){switch(t){case 1:return`vec4(${e}, 0.0, 0.0, 1.0)`;case 2:return`vec4(${e}, 0.0, 1.0)`;case 3:return`vec4(${e}, 1.0)`;case 4:return e;default:throw Error(`invalid channels: ${t}`)}}(t,i);return`\
#version 300 es
in ${n} ${t};
out vec4 ${r};
void main() {
  ${r} = ${s};
}`}(),topology:t.topology||"point-list",varyings:t.outputs||t.varyings,...t}),this.transformFeedback=this.device.createTransformFeedback({layout:this.model.pipeline.shaderLayout,buffers:t.feedbackBuffers}),this.model.setTransformFeedback(this.transformFeedback),Object.seal(this)}destroy(){this.model&&this.model.destroy()}delete(){this.destroy()}run(e){e?.inputBuffers&&this.model.setAttributes(e.inputBuffers),e?.outputBuffers&&this.transformFeedback.setBuffers(e.outputBuffers);let t=this.device.beginRenderPass(e);this.model.draw(t),t.end()}getBuffer(e){return this.transformFeedback.getBuffer(e)}readAsync(e){let t=this.getBuffer(e);if(!t)throw Error("BufferTransform#getBuffer");if(t instanceof lV.Buffer)return t.readAsync();let{buffer:i,byteOffset:r=0,byteLength:n=i.byteLength}=t;return i.readAsync(r,n)}}function h_(e,t=[],i=0){let r=Math.fround(e),n=e-r;return t[i]=r,t[i+1]=n,t}let hv={name:"fp64arithmetic",vs:`\

uniform fp64arithmeticUniforms {
  uniform float ONE;
} fp64;

/*
About LUMA_FP64_CODE_ELIMINATION_WORKAROUND

The purpose of this workaround is to prevent shader compilers from
optimizing away necessary arithmetic operations by swapping their sequences
or transform the equation to some 'equivalent' form.

The method is to multiply an artifical variable, ONE, which will be known to
the compiler to be 1 only at runtime. The whole expression is then represented
as a polynomial with respective to ONE. In the coefficients of all terms, only one a
and one b should appear

err = (a + b) * ONE^6 - a * ONE^5 - (a + b) * ONE^4 + a * ONE^3 - b - (a + b) * ONE^2 + a * ONE
*/

// Divide float number to high and low floats to extend fraction bits
vec2 split(float a) {
  const float SPLIT = 4097.0;
  float t = a * SPLIT;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float a_hi = t * fp64.ONE - (t - a);
  float a_lo = a * fp64.ONE - a_hi;
#else
  float a_hi = t - (t - a);
  float a_lo = a - a_hi;
#endif
  return vec2(a_hi, a_lo);
}

// Divide float number again when high float uses too many fraction bits
vec2 split2(vec2 a) {
  vec2 b = split(a.x);
  b.y += a.y;
  return b;
}

// Special sum operation when a > b
vec2 quickTwoSum(float a, float b) {
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float sum = (a + b) * fp64.ONE;
  float err = b - (sum - a) * fp64.ONE;
#else
  float sum = a + b;
  float err = b - (sum - a);
#endif
  return vec2(sum, err);
}

// General sum operation
vec2 twoSum(float a, float b) {
  float s = (a + b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE + (b - v);
#else
  float v = s - a;
  float err = (a - (s - v)) + (b - v);
#endif
  return vec2(s, err);
}

vec2 twoSub(float a, float b) {
  float s = (a - b);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float v = (s * fp64.ONE - a) * fp64.ONE;
  float err = (a - (s - v) * fp64.ONE) * fp64.ONE * fp64.ONE * fp64.ONE - (b + v);
#else
  float v = s - a;
  float err = (a - (s - v)) - (b + v);
#endif
  return vec2(s, err);
}

vec2 twoSqr(float a) {
  float prod = a * a;
  vec2 a_fp64 = split(a);
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  float err = ((a_fp64.x * a_fp64.x - prod) * fp64.ONE + 2.0 * a_fp64.x *
    a_fp64.y * fp64.ONE * fp64.ONE) + a_fp64.y * a_fp64.y * fp64.ONE * fp64.ONE * fp64.ONE;
#else
  float err = ((a_fp64.x * a_fp64.x - prod) + 2.0 * a_fp64.x * a_fp64.y) + a_fp64.y * a_fp64.y;
#endif
  return vec2(prod, err);
}

vec2 twoProd(float a, float b) {
  float prod = a * b;
  vec2 a_fp64 = split(a);
  vec2 b_fp64 = split(b);
  float err = ((a_fp64.x * b_fp64.x - prod) + a_fp64.x * b_fp64.y +
    a_fp64.y * b_fp64.x) + a_fp64.y * b_fp64.y;
  return vec2(prod, err);
}

vec2 sum_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSum(a.x, b.x);
  t = twoSum(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 sub_fp64(vec2 a, vec2 b) {
  vec2 s, t;
  s = twoSub(a.x, b.x);
  t = twoSub(a.y, b.y);
  s.y += t.x;
  s = quickTwoSum(s.x, s.y);
  s.y += t.y;
  s = quickTwoSum(s.x, s.y);
  return s;
}

vec2 mul_fp64(vec2 a, vec2 b) {
  vec2 prod = twoProd(a.x, b.x);
  // y component is for the error
  prod.y += a.x * b.y;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  prod.y += a.y * b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  prod = split2(prod);
#endif
  prod = quickTwoSum(prod.x, prod.y);
  return prod;
}

vec2 div_fp64(vec2 a, vec2 b) {
  float xn = 1.0 / b.x;
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  vec2 yn = mul_fp64(a, vec2(xn, 0));
#else
  vec2 yn = a * xn;
#endif
  float diff = (sub_fp64(a, mul_fp64(b, yn))).x;
  vec2 prod = twoProd(xn, diff);
  return sum_fp64(yn, prod);
}

vec2 sqrt_fp64(vec2 a) {
  if (a.x == 0.0 && a.y == 0.0) return vec2(0.0, 0.0);
  if (a.x < 0.0) return vec2(0.0 / 0.0, 0.0 / 0.0);

  float x = 1.0 / sqrt(a.x);
  float yn = a.x * x;
#if defined(LUMA_FP64_CODE_ELIMINATION_WORKAROUND)
  vec2 yn_sqr = twoSqr(yn) * fp64.ONE;
#else
  vec2 yn_sqr = twoSqr(yn);
#endif
  float diff = sub_fp64(a, yn_sqr).x;
  vec2 prod = twoProd(x * 0.5, diff);
#if defined(LUMA_FP64_HIGH_BITS_OVERFLOW_WORKAROUND)
  return sum_fp64(split(yn), prod);
#else
  return sum_fp64(vec2(yn, 0.0), prod);
#endif
}
`,defaultUniforms:{ONE:1},uniformTypes:{ONE:"f32"},fp64ify:h_,fp64LowPart:function(e){return e-Math.fround(e)},fp64ifyMatrix4:function(e){let t=new Float32Array(32);for(let i=0;i<4;++i)for(let r=0;r<4;++r){let n=4*i+r;h_(e[4*r+i],t,2*n)}return t}};function hb(e){let{source:t,target:i,start:r=0,size:n,getData:s}=e,o=e.end||i.length,a=t.length,l=o-r;if(a>l)return void i.set(t.subarray(0,l),r);if(i.set(t,r),!s)return;let u=a;for(;u<l;){let e=s(u,t);for(let t=0;t<n;t++)i[r+u]=e[t]||0,u++}}function hx(e){switch(e){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4";default:throw Error(`No defined attribute type for size "${e}"`)}}function hw(e){switch(e){case 1:return"float32";case 2:return"float32x2";case 3:return"float32x3";case 4:return"float32x4";default:throw Error("invalid type size")}}function hk(e){e.push(e.shift())}function hT({device:e,source:t,target:i}){return(!i||i.byteLength<t.byteLength)&&(i?.destroy(),i=e.createBuffer({byteLength:t.byteLength,usage:t.usage})),i}function hS({device:e,buffer:t,attribute:i,fromLength:r,toLength:n,fromStartIndices:s,getData:o=e=>e}){let a=i.doublePrecision&&i.value instanceof Float64Array?2:1,l=i.size*a,u=i.byteOffset,c=i.settings.bytesPerElement<4?u/i.settings.bytesPerElement*4:u,h=i.startIndices,d=s&&h,f=i.isConstant;if(!d&&t&&r>=n)return t;let p=i.value instanceof Float64Array?Float32Array:i.value.constructor,g=f?i.value:new p(i.getBuffer().readSyncWebGL(u,n*p.BYTES_PER_ELEMENT).buffer);if(i.settings.normalized&&!f){let e=o;o=(t,r)=>i.normalizeConstant(e(t,r))}let m=f?(e,t)=>o(g,t):(e,t)=>o(g.subarray(e+u,e+u+l),t),y=new Float32Array(t?t.readSyncWebGL(c,4*r).buffer:0),_=new Float32Array(n);return!function({source:e,target:t,size:i,getData:r,sourceStartIndices:n,targetStartIndices:s}){if(!n||!s)return hb({source:e,target:t,size:i,getData:r});let o=0,a=0,l=r&&((e,t)=>r(e+a,t)),u=Math.min(n.length,s.length);for(let r=1;r<u;r++){let u=n[r]*i,c=s[r]*i;hb({source:e.subarray(o,u),target:t,start:a,end:c,size:i,getData:l}),o=u,a=c}a<t.length&&hb({source:[],target:t,start:a,size:i,getData:l})}({source:y,target:_,sourceStartIndices:s,targetStartIndices:h,size:l,getData:m}),(!t||t.byteLength<_.byteLength+c)&&(t?.destroy(),t=e.createBuffer({byteLength:_.byteLength+c,usage:35050})),t.write(_,c),t}class hP{constructor({device:e,attribute:t,timeline:i}){this.buffers=[],this.currentLength=0,this.device=e,this.transition=new al(i),this.attribute=t,this.attributeInTransition=function(e){let{device:t,settings:i,value:r}=e,n=new l6(t,i);return n.setData({value:r instanceof Float64Array?new Float64Array(0):new Float32Array(0),normalized:i.normalized}),n}(t),this.currentStartIndices=t.startIndices}get inProgress(){return this.transition.inProgress}start(e,t,i=1/0){this.settings=e,this.currentStartIndices=this.attribute.startIndices,this.currentLength=function(e,t){let{doublePrecision:i,settings:r,value:n,size:s}=e,o=i&&n instanceof Float64Array?2:1,a=0,{shaderAttributes:l}=e.settings;if(l)for(let e of Object.values(l))a=Math.max(a,e.vertexOffset??0);return(r.noAlloc?n.length:(t+a)*s)*o}(this.attribute,t),this.transition.start({...e,duration:i})}update(){let e=this.transition.update();return e&&this.onUpdate(),e}setBuffer(e){this.attributeInTransition.setData({buffer:e,normalized:this.attribute.settings.normalized,value:this.attributeInTransition.value})}cancel(){this.transition.cancel()}delete(){for(let e of(this.cancel(),this.buffers))e.destroy();this.buffers.length=0}}let hE={name:"interpolation",vs:`\
uniform interpolationUniforms {
  float time;
} interpolation;
`,uniformTypes:{time:"f32"}},hC=`\
#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vCurrent;

void main(void) {
  vCurrent = mix(aFrom, aTo, interpolation.time);
  gl_Position = vec4(0.0);
}
`,hI=`\
#version 300 es
#define SHADER_NAME interpolation-transition-vertex-shader

in ATTRIBUTE_TYPE aFrom;
in ATTRIBUTE_TYPE aFrom64Low;
in ATTRIBUTE_TYPE aTo;
in ATTRIBUTE_TYPE aTo64Low;
out ATTRIBUTE_TYPE vCurrent;
out ATTRIBUTE_TYPE vCurrent64Low;

vec2 mix_fp64(vec2 a, vec2 b, float x) {
  vec2 range = sub_fp64(b, a);
  return sum_fp64(a, mul_fp64(range, vec2(x, 0.0)));
}

void main(void) {
  for (int i=0; i<ATTRIBUTE_SIZE; i++) {
    vec2 value = mix_fp64(vec2(aFrom[i], aFrom64Low[i]), vec2(aTo[i], aTo64Low[i]), interpolation.time);
    vCurrent[i] = value.x;
    vCurrent64Low[i] = value.y;
  }
  gl_Position = vec4(0.0);
}
`;function hA(e){return e.doublePrecision&&e.value instanceof Float64Array}let hM={name:"spring",vs:`\
uniform springUniforms {
  float damping;
  float stiffness;
} spring;
`,uniformTypes:{damping:"f32",stiffness:"f32"}},hL=`\
#version 300 es
#define SHADER_NAME spring-transition-vertex-shader

#define EPSILON 0.00001

in ATTRIBUTE_TYPE aPrev;
in ATTRIBUTE_TYPE aCur;
in ATTRIBUTE_TYPE aTo;
out ATTRIBUTE_TYPE vNext;
out float vIsTransitioningFlag;

ATTRIBUTE_TYPE getNextValue(ATTRIBUTE_TYPE cur, ATTRIBUTE_TYPE prev, ATTRIBUTE_TYPE dest) {
  ATTRIBUTE_TYPE velocity = cur - prev;
  ATTRIBUTE_TYPE delta = dest - cur;
  ATTRIBUTE_TYPE force = delta * spring.stiffness;
  ATTRIBUTE_TYPE resistance = velocity * spring.damping;
  return force - resistance + velocity + cur;
}

void main(void) {
  bool isTransitioning = length(aCur - aPrev) > EPSILON || length(aTo - aCur) > EPSILON;
  vIsTransitioningFlag = isTransitioning ? 1.0 : 0.0;

  vNext = getNextValue(aCur, aPrev, aTo);
  gl_Position = vec4(0, 0, 0, 1);
  gl_PointSize = 100.0;
}
`,hO=`\
#version 300 es
#define SHADER_NAME spring-transition-is-transitioning-fragment-shader

in float vIsTransitioningFlag;

out vec4 fragColor;

void main(void) {
  if (vIsTransitioningFlag == 0.0) {
    discard;
  }
  fragColor = vec4(1.0);
}`,hR={interpolation:class extends hP{constructor({device:e,attribute:t,timeline:i}){super({device:e,attribute:t,timeline:i}),this.type="interpolation",this.transform=function(e,t){let i=t.size,r=hx(i),n=hw(i),s=t.getBufferLayout();return hA(t)?new hy(e,{vs:hI,bufferLayout:[{name:"aFrom",byteStride:8*i,attributes:[{attribute:"aFrom",format:n,byteOffset:0},{attribute:"aFrom64Low",format:n,byteOffset:4*i}]},{name:"aTo",byteStride:8*i,attributes:[{attribute:"aTo",format:n,byteOffset:0},{attribute:"aTo64Low",format:n,byteOffset:4*i}]}],modules:[hv,hE],defines:{ATTRIBUTE_TYPE:r,ATTRIBUTE_SIZE:i},moduleSettings:{},varyings:["vCurrent","vCurrent64Low"],bufferMode:35980,disableWarnings:!0}):new hy(e,{vs:hC,bufferLayout:[{name:"aFrom",format:n},{name:"aTo",format:s.attributes[0].format}],modules:[hE],defines:{ATTRIBUTE_TYPE:r},varyings:["vCurrent"],disableWarnings:!0})}(e,t)}start(e,t){let i=this.currentLength,r=this.currentStartIndices;if(super.start(e,t,e.duration),e.duration<=0)return void this.transition.cancel();let{buffers:n,attribute:s}=this;hk(n),n[0]=hS({device:this.device,buffer:n[0],attribute:s,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter}),n[1]=hT({device:this.device,source:n[0],target:n[1]}),this.setBuffer(n[1]);let{transform:o}=this,a=o.model,l=Math.floor(this.currentLength/s.size);hA(s)&&(l/=2),a.setVertexCount(l),s.isConstant?(a.setAttributes({aFrom:n[0]}),a.setConstantAttributes({aTo:s.value})):a.setAttributes({aFrom:n[0],aTo:s.getBuffer()}),o.transformFeedback.setBuffers({vCurrent:n[1]})}onUpdate(){let{duration:e,easing:t}=this.settings,{time:i}=this.transition,r=i/e;t&&(r=t(r));let{model:n}=this.transform,s={time:r};n.shaderInputs.setProps({interpolation:s}),this.transform.run({discard:!0})}delete(){super.delete(),this.transform.destroy()}},spring:class extends hP{constructor({device:e,attribute:t,timeline:i}){var r,n;super({device:e,attribute:t,timeline:i}),this.type="spring",this.texture=e.createTexture({data:new Uint8Array(4),format:"rgba8unorm",width:1,height:1}),this.framebuffer=(r=e,n=this.texture,r.createFramebuffer({id:"spring-transition-is-transitioning-framebuffer",width:1,height:1,colorAttachments:[n]})),this.transform=function(e,t){let i=hx(t.size),r=hw(t.size);return new hy(e,{vs:hL,fs:hO,bufferLayout:[{name:"aPrev",format:r},{name:"aCur",format:r},{name:"aTo",format:t.getBufferLayout().attributes[0].format}],varyings:["vNext"],modules:[hM],defines:{ATTRIBUTE_TYPE:i},parameters:{depthCompare:"always",blendColorOperation:"max",blendColorSrcFactor:"one",blendColorDstFactor:"one",blendAlphaOperation:"max",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one"}})}(e,t)}start(e,t){let i=this.currentLength,r=this.currentStartIndices;super.start(e,t);let{buffers:n,attribute:s}=this;for(let t=0;t<2;t++)n[t]=hS({device:this.device,buffer:n[t],attribute:s,fromLength:i,toLength:this.currentLength,fromStartIndices:r,getData:e.enter});n[2]=hT({device:this.device,source:n[0],target:n[2]}),this.setBuffer(n[1]);let{model:o}=this.transform;o.setVertexCount(Math.floor(this.currentLength/s.size)),s.isConstant?o.setConstantAttributes({aTo:s.value}):o.setAttributes({aTo:s.getBuffer()})}onUpdate(){let{buffers:e,transform:t,framebuffer:i,transition:r}=this,n=this.settings;t.model.setAttributes({aPrev:e[0],aCur:e[1]}),t.transformFeedback.setBuffers({vNext:e[2]});let s={stiffness:n.stiffness,damping:n.damping};t.model.shaderInputs.setProps({spring:s}),t.run({framebuffer:i,discard:!1,parameters:{viewport:[0,0,1,1]},clearColor:[0,0,0,0]}),hk(e),this.setBuffer(e[1]),this.device.readPixelsToArrayWebGL(i)[0]>0||r.end()}delete(){super.delete(),this.transform.destroy(),this.texture.destroy(),this.framebuffer.destroy()}}};class hD{constructor(e,{id:t,timeline:i}){if(!e)throw Error("AttributeTransitionManager is constructed without device");this.id=t,this.device=e,this.timeline=i,this.transitions={},this.needsRedraw=!1,this.numInstances=1}finalize(){for(let e in this.transitions)this._removeTransition(e)}update({attributes:e,transitions:t,numInstances:i}){for(let r in this.numInstances=i||1,e){let i=e[r],n=i.getTransitionSetting(t);n&&this._updateAttribute(r,i,n)}for(let i in this.transitions){let r=e[i];r&&r.getTransitionSetting(t)||this._removeTransition(i)}}hasAttribute(e){let t=this.transitions[e];return t&&t.inProgress}getAttributes(){let e={};for(let t in this.transitions){let i=this.transitions[t];i.inProgress&&(e[t]=i.attributeInTransition)}return e}run(){if(0===this.numInstances)return!1;for(let e in this.transitions)this.transitions[e].update()&&(this.needsRedraw=!0);let e=this.needsRedraw;return this.needsRedraw=!1,e}_removeTransition(e){this.transitions[e].delete(),delete this.transitions[e]}_updateAttribute(e,t,i){let r=this.transitions[e],n=!r||r.type!==i.type;if(n){r&&this._removeTransition(e);let s=hR[i.type];s?this.transitions[e]=new s({attribute:t,timeline:this.timeline,device:this.device}):(ia.error(`unsupported transition type '${i.type}'`)(),n=!1)}(n||t.needsRedraw())&&(this.needsRedraw=!0,this.transitions[e].start(i,this.numInstances))}}let hF="attributeManager.invalidate";class hN{constructor(e,{id:t="attribute-manager",stats:i,timeline:r}={}){this.mergeBoundsMemoized=i3(o3),this.id=t,this.device=e,this.attributes={},this.updateTriggers={},this.needsRedraw=!0,this.userData={},this.stats=i,this.attributeTransitionManager=new hD(e,{id:`${t}-transitions`,timeline:r}),Object.seal(this)}finalize(){for(let e in this.attributes)this.attributes[e].delete();this.attributeTransitionManager.finalize()}getNeedsRedraw(e={clearRedrawFlags:!1}){let t=this.needsRedraw;return this.needsRedraw=this.needsRedraw&&!e.clearRedrawFlags,t&&this.id}setNeedsRedraw(){this.needsRedraw=!0}add(e){this._add(e)}addInstanced(e){this._add(e,{stepMode:"instance"})}remove(e){for(let t of e)void 0!==this.attributes[t]&&(this.attributes[t].delete(),delete this.attributes[t])}invalidate(e,t){let i=this._invalidateTrigger(e,t);sC(hF,this,e,i)}invalidateAll(e){for(let t in this.attributes)this.attributes[t].setNeedsUpdate(t,e);sC(hF,this,"all")}update({data:e,numInstances:t,startIndices:i=null,transitions:r,props:n={},buffers:s={},context:o={}}){let a=!1;for(let r in sC("attributeManager.updateStart",this),this.stats&&this.stats.get("Update Attributes").timeStart(),this.attributes){let l=this.attributes[r],u=l.settings.accessor;l.startIndices=i,l.numInstances=t,n[r]&&ia.removed(`props.${r}`,`data.attributes.${r}`)(),l.setExternalBuffer(s[r])||l.setBinaryValue("string"==typeof u?s[u]:void 0,e.startIndices)||"string"==typeof u&&!s[u]&&l.setConstantValue(o,n[u])||l.needsUpdate()&&(a=!0,this._updateAttribute({attribute:l,numInstances:t,data:e,props:n,context:o})),this.needsRedraw=this.needsRedraw||l.needsRedraw()}a&&sC("attributeManager.updateEnd",this,t),this.stats&&this.stats.get("Update Attributes").timeEnd(),this.attributeTransitionManager.update({attributes:this.attributes,numInstances:t,transitions:r})}updateTransition(){let{attributeTransitionManager:e}=this,t=e.run();return this.needsRedraw=this.needsRedraw||t,t}getAttributes(){return{...this.attributes,...this.attributeTransitionManager.getAttributes()}}getBounds(e){let t=e.map(e=>this.attributes[e]?.getBounds());return this.mergeBoundsMemoized(t)}getChangedAttributes(e={clearChangedFlags:!1}){let{attributes:t,attributeTransitionManager:i}=this,r={...i.getAttributes()};for(let n in t){let s=t[n];s.needsRedraw(e)&&!i.hasAttribute(n)&&(r[n]=s)}return r}getBufferLayouts(e){return Object.values(this.getAttributes()).map(t=>t.getBufferLayout(e))}_add(e,t){for(let i in e){let r=e[i],n={...r,id:i,size:r.isIndexed&&1||r.size||1,...t};this.attributes[i]=new l6(this.device,n)}this._mapUpdateTriggersToAttributes()}_mapUpdateTriggersToAttributes(){let e={};for(let t in this.attributes)this.attributes[t].getUpdateTriggers().forEach(i=>{e[i]||(e[i]=[]),e[i].push(t)});this.updateTriggers=e}_invalidateTrigger(e,t){let{attributes:i,updateTriggers:r}=this,n=r[e];return n&&n.forEach(e=>{let r=i[e];r&&r.setNeedsUpdate(r.id,t)}),n}_updateAttribute(e){let{attribute:t,numInstances:i}=e;(sC("attribute.updateStart",t),t.constant)?t.setConstantValue(e.context,t.value):(t.allocate(i)&&sC("attribute.allocate",t,i),t.updateBuffer(e)&&(this.needsRedraw=!0,sC("attribute.updateEnd",t,i)))}}function hj(e,t,i,r,n){let s=t-e;return(i-t)*n+-s*r+s+t}function hz(e,t){if(Array.isArray(e)){let i=0;for(let r=0;r<e.length;r++){let n=e[r]-t[r];i+=n*n}return Math.sqrt(i)}return Math.abs(e-t)}let hU={interpolation:class extends al{get value(){return this._value}_onUpdate(){let{time:e,settings:{fromValue:t,toValue:i,duration:r,easing:n}}=this,s=n(e/r);this._value=rg(t,i,s)}},spring:class extends al{get value(){return this._currValue}_onUpdate(){let{fromValue:e,toValue:t,damping:i,stiffness:r}=this.settings,{_prevValue:n=e,_currValue:s=e}=this,o=function(e,t,i,r,n){if(Array.isArray(i)){let s=[];for(let o=0;o<i.length;o++)s[o]=hj(e[o],t[o],i[o],r,n);return s}return hj(e,t,i,r,n)}(n,s,t,i,r),a=hz(o,t),l=hz(o,s);a<1e-5&&l<1e-5&&(o=t,this.end()),this._prevValue=s,this._currValue=o}}};class hB{constructor(e){this.transitions=new Map,this.timeline=e}get active(){return this.transitions.size>0}add(e,t,i,r){let{transitions:n}=this;if(n.has(e)){let i=n.get(e),{value:r=i.settings.fromValue}=i;t=r,this.remove(e)}if(!(r=l4(r)))return;let s=hU[r.type];if(!s)return void ia.error(`unsupported transition type '${r.type}'`)();let o=new s(this.timeline);o.start({...r,fromValue:t,toValue:i}),n.set(e,o)}remove(e){let{transitions:t}=this;t.has(e)&&(t.get(e).cancel(),t.delete(e))}update(){let e={};for(let[t,i]of this.transitions)i.update(),e[t]=i.value,i.inProgress||this.remove(t);return e}clear(){for(let e of this.transitions.keys())this.remove(e)}}function h$({newProps:e,oldProps:t,ignoreProps:i={},propTypes:r={},triggerName:n="props"}){if(t===e)return!1;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return`${n} changed shallowly`;for(let s of Object.keys(e))if(!(s in i)){if(!(s in t))return`${n}.${s} added`;let i=hV(e[s],t[s],r[s]);if(i)return`${n}.${s} ${i}`}for(let s of Object.keys(t))if(!(s in i)){if(!(s in e))return`${n}.${s} dropped`;if(!Object.hasOwnProperty.call(e,s)){let i=hV(e[s],t[s],r[s]);if(i)return`${n}.${s} ${i}`}}return!1}function hV(e,t,i){let r=i&&i.equal;return r&&!r(e,t,i)||!r&&(r=e&&t&&e.equals)&&!r.call(e,t)?"changed deeply":r||t===e?null:"changed shallowly"}function hW(e,t,i){let r=e.updateTriggers[i];r=null==r?{}:r;let n=t.updateTriggers[i];return h$({oldProps:n=null==n?{}:n,newProps:r,triggerName:i})}function hG(e,t){if(!t)return e;let i={...e,...t};if("defines"in t&&(i.defines={...e.defines,...t.defines}),"modules"in t&&(i.modules=(e.modules||[]).concat(t.modules),t.modules.some(e=>"project64"===e.name))){let e=i.modules.findIndex(e=>"project32"===e.name);e>=0&&i.modules.splice(e,1)}if("inject"in t)if(e.inject){let r={...e.inject};for(let e in t.inject)r[e]=(r[e]||"")+t.inject[e];i.inject=r}else i.inject=t.inject;return i}var nK=nK,is=is;let hq=[0,0,0];function hH(e,t,i=!1){let r=t.projectPosition(e);if(i&&t instanceof aa){let[i,n,s=0]=e,o=t.getDistanceScales([i,n]);r[2]=s*o.unitsPerMeter[2]}return r}function hY(e,{viewport:t,modelMatrix:i,coordinateSystem:r,coordinateOrigin:n,offsetMode:s}){let[o,a,l=0]=e;switch(i&&([o,a,l]=is.transformMat4([],[o,a,l,1],i)),r){case iJ.LNGLAT:return hH([o,a,l],t,s);case iJ.LNGLAT_OFFSETS:return hH([o+n[0],a+n[1],l+(n[2]||0)],t,s);case iJ.METER_OFFSETS:return hH(n8(n,[o,a,l]),t,s);case iJ.CARTESIAN:default:return t.isGeospatial?[o+n[0],a+n[1],l+n[2]]:t.projectPosition([o,a,l])}}let hX={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},hZ={},hK={boolean:{validate:(e,t)=>!0,equal:(e,t,i)=>!!e==!!t},number:{validate:(e,t)=>Number.isFinite(e)&&(!("max"in t)||e<=t.max)&&(!("min"in t)||e>=t.min)},color:{validate:(e,t)=>t.optional&&!e||hQ(e)&&(3===e.length||4===e.length),equal:(e,t,i)=>at(e,t,1)},accessor:{validate(e,t){let i=h0(e);return"function"===i||i===h0(t.value)},equal:(e,t,i)=>"function"==typeof t||at(e,t,1)},array:{validate:(e,t)=>t.optional&&!e||hQ(e),equal(e,t,i){let{compare:r}=i,n=Number.isInteger(r)?r:+!!r;return r?at(e,t,n):e===t}},object:{equal(e,t,i){if(i.ignore)return!0;let{compare:r}=i,n=Number.isInteger(r)?r:+!!r;return r?at(e,t,n):e===t}},function:{validate:(e,t)=>t.optional&&!e||"function"==typeof e,equal:(e,t,i)=>!i.compare&&!1!==i.ignore||e===t},data:{transform:(e,t,i)=>{if(!e)return e;let{dataTransform:r}=i.props;return r?r(e):"string"==typeof e.shape&&e.shape.endsWith("-table")&&Array.isArray(e.data)?e.data:e}},image:{transform:(e,t,i)=>{let r=i.context;return r&&r.device?function(e,t,i,r){if(i instanceof l9.Texture)return i;i.constructor&&"Object"!==i.constructor.name&&(i={data:i});let n=null;i.compressed&&(n={minFilter:"linear",mipmapFilter:i.data.length>1?"nearest":"linear"});let{width:s,height:o}=i.data,a=t.createTexture({...i,sampler:{...hX,...n,...r},mipLevels:t.getMipLevelCount(s,o)});return a.generateMipmapsWebGL(),hZ[a.id]=e,a}(i.id,r.device,e,{...t.parameters,...i.props.textureParameters}):null},release:(e,t,i)=>{var r;r=i.id,e&&e instanceof l9.Texture&&hZ[e.id]===r&&(e.delete(),delete hZ[e.id])}}};function hJ(e,t){return"type"in t?{name:e,...hK[t.type],...t}:"value"in t?{name:e,type:h0(t.value),...t}:{name:e,type:"object",value:t}}function hQ(e){return Array.isArray(e)||ArrayBuffer.isView(e)}function h0(e){return hQ(e)?"array":null===e?"null":typeof e}function h1(e,t){return Object.prototype.hasOwnProperty.call(e,t)}let h2=0;class h3{constructor(...e){this.props=function(e,t){let i;for(let e=t.length-1;e>=0;e--){let r=t[e];"extensions"in r&&(i=r.extensions)}let r=Object.create(function e(t,i){var r,n;if(!(t instanceof h4.constructor))return{};let s="_mergedDefaultProps";if(i)for(let e of i){let t=e.constructor;t&&(s+=`:${t.extensionName||t.name}`)}let o=h1(r=t,n=s)&&r[n];return o||(t[s]=function(t,i){var r;let n;if(!t.prototype)return null;let s=e(Object.getPrototypeOf(t)),o=function(e){let t={},i={},r={};for(let[n,s]of Object.entries(e)){let e=s?.deprecatedFor;if(e)r[n]=Array.isArray(e)?e:[e];else{let e=function(e,t){switch(h0(t)){case"object":return hJ(e,t);case"array":return hJ(e,{type:"array",value:t,compare:!1});case"boolean":return hJ(e,{type:"boolean",value:t});case"number":return hJ(e,{type:"number",value:t});case"function":return hJ(e,{type:"function",value:t,compare:!0});default:return{name:e,type:"unknown",value:t}}}(n,s);t[n]=e,i[n]=e.value}}return{propTypes:t,defaultProps:i,deprecatedProps:r}}(function(e,t){return h1(e,t)&&e[t]}(t,"defaultProps")||{}),a=Object.assign(Object.create(null),s,o.defaultProps),l=Object.assign(Object.create(null),s?.[sb],o.propTypes),u=Object.assign(Object.create(null),s?.[sx],o.deprecatedProps);for(let t of i){let i=e(t.constructor);i&&(Object.assign(a,i),Object.assign(l,i[sb]),Object.assign(u,i[sx]))}return Object.defineProperties(a,{id:{writable:!0,value:((n=(r=t).componentName)||ia.warn(`${r.name}.componentName not specified`)(),n||r.name)}}),function(e,t){let i={},r={};for(let e in t){let n=t[e],{name:s,value:o}=n;n.async&&(i[s]=o,r[s]=function(e){return{enumerable:!0,set(t){"string"==typeof t||t instanceof Promise||l0(t)?this[sk][e]=t:this[sT][e]=t},get(){if(this[sT]){if(e in this[sT])return this[sT][e]||this[sw][e];if(e in this[sk]){let t=this[sv]&&this[sv].internalState;if(t&&t.hasAsyncProp(e))return t.getAsyncProp(e)||this[sw][e]}}return this[sw][e]}}}(s))}e[sw]=i,e[sk]={},Object.defineProperties(e,r)}(a,l),function(e,t){for(let i in t)Object.defineProperty(e,i,{enumerable:!1,set(e){let r=`${this.id}: ${i}`;for(let r of t[i])h1(this,r)||(this[r]=e);ia.deprecated(r,t[i].join("/"))()}})}(a,u),a[sb]=l,a[sx]=u,0!==i.length||h1(t,"_propTypes")||(t._propTypes=l),a}(t,i||[]))}(e.constructor,i));r[sv]=e,r[sk]={},r[sT]={};for(let e=0;e<t.length;++e){let i=t[e];for(let e in i)r[e]=i[e]}return Object.freeze(r),r}(this,e),this.id=this.props.id,this.count=h2++}clone(e){let{props:t}=this,i={};for(let e in t[sw])e in t[sT]?i[e]=t[sT][e]:e in t[sk]&&(i[e]=t[sk][e]);return new this.constructor({...t,...i,...e})}}h3.componentName="Component",h3.defaultProps={};let h4=h3,h6=Object.freeze({});class h5{constructor(e){this.component=e,this.asyncProps={},this.onAsyncPropUpdated=()=>{},this.oldProps=null,this.oldAsyncProps=null}finalize(){for(let e in this.asyncProps){let t=this.asyncProps[e];t&&t.type&&t.type.release&&t.type.release(t.resolvedValue,t.type,this.component)}this.asyncProps={},this.component=null,this.resetOldProps()}getOldProps(){return this.oldAsyncProps||this.oldProps||h6}resetOldProps(){this.oldAsyncProps=null,this.oldProps=this.component?this.component.props:null}hasAsyncProp(e){return e in this.asyncProps}getAsyncProp(e){let t=this.asyncProps[e];return t&&t.resolvedValue}isAsyncPropLoading(e){if(e){let t=this.asyncProps[e];return!!(t&&t.pendingLoadCount>0&&t.pendingLoadCount!==t.resolvedLoadCount)}for(let e in this.asyncProps)if(this.isAsyncPropLoading(e))return!0;return!1}reloadAsyncProp(e,t){this._watchPromise(e,Promise.resolve(t))}setAsyncProps(e){this.component=e[sv]||this.component;let t=e[sT]||{},i=e[sk]||e,r=e[sw]||{};for(let e in t){let i=t[e];this._createAsyncPropData(e,r[e]),this._updateAsyncProp(e,i),t[e]=this.getAsyncProp(e)}for(let e in i){let t=i[e];this._createAsyncPropData(e,r[e]),this._updateAsyncProp(e,t)}}_fetch(e,t){return null}_onResolve(e,t){}_onError(e,t){}_updateAsyncProp(e,t){if(this._didAsyncInputValueChange(e,t)){if("string"==typeof t&&(t=this._fetch(e,t)),t instanceof Promise)return void this._watchPromise(e,t);if(l0(t))return void this._resolveAsyncIterable(e,t);this._setPropValue(e,t)}}_freezeAsyncOldProps(){if(!this.oldAsyncProps&&this.oldProps)for(let e in this.oldAsyncProps=Object.create(this.oldProps),this.asyncProps)Object.defineProperty(this.oldAsyncProps,e,{enumerable:!0,value:this.oldProps[e]})}_didAsyncInputValueChange(e,t){let i=this.asyncProps[e];return t!==i.resolvedValue&&t!==i.lastValue&&(i.lastValue=t,!0)}_setPropValue(e,t){this._freezeAsyncOldProps();let i=this.asyncProps[e];i&&(t=this._postProcessValue(i,t),i.resolvedValue=t,i.pendingLoadCount++,i.resolvedLoadCount=i.pendingLoadCount)}_setAsyncPropValue(e,t,i){let r=this.asyncProps[e];r&&i>=r.resolvedLoadCount&&void 0!==t&&(this._freezeAsyncOldProps(),r.resolvedValue=t,r.resolvedLoadCount=i,this.onAsyncPropUpdated(e,t))}_watchPromise(e,t){let i=this.asyncProps[e];if(i){i.pendingLoadCount++;let r=i.pendingLoadCount;t.then(t=>{this.component&&(t=this._postProcessValue(i,t),this._setAsyncPropValue(e,t,r),this._onResolve(e,t))}).catch(t=>{this._onError(e,t)})}}async _resolveAsyncIterable(e,t){if("data"!==e)return void this._setPropValue(e,t);let i=this.asyncProps[e];if(!i)return;i.pendingLoadCount++;let r=i.pendingLoadCount,n=[],s=0;for await(let i of t){if(!this.component)return;let{dataTransform:t}=this.component.props;Object.defineProperty(n=t?t(i,n):n.concat(i),"__diff",{enumerable:!1,value:[{startRow:s,endRow:n.length}]}),s=n.length,this._setAsyncPropValue(e,n,r)}this._onResolve(e,n)}_postProcessValue(e,t){let i=e.type;return i&&this.component&&(i.release&&i.release(e.resolvedValue,i,this.component),i.transform)?i.transform(t,i,this.component):t}_createAsyncPropData(e,t){if(!this.asyncProps[e]){let i=this.component&&this.component.props[sb];this.asyncProps[e]={type:i&&i[e],lastValue:null,resolvedValue:t,pendingLoadCount:0,resolvedLoadCount:0}}}}class h8 extends h5{constructor({attributeManager:e,layer:t}){super(t),this.attributeManager=e,this.needsRedraw=!0,this.needsUpdate=!0,this.subLayers=null,this.usesPickingColorCache=!1}get layer(){return this.component}_fetch(e,t){let i=this.layer,r=i?.props.fetch;return r?r(t,{propName:e,layer:i}):super._fetch(e,t)}_onResolve(e,t){let i=this.layer;if(i){let r=i.props.onDataLoad;"data"===e&&r&&r(t,{propName:e,layer:i})}}_onError(e,t){let i=this.layer;i&&i.raiseError(t,`loading ${e} of ${this.layer}`)}}let h9=Object.freeze([]),h7=i3(({oldViewport:e,viewport:t})=>e.equals(t)),de=new Uint8ClampedArray(0),dt={data:{type:"data",value:h9,async:!0},dataComparator:{type:"function",value:null,optional:!0},_dataDiff:{type:"function",value:e=>e&&e.__diff,optional:!0},dataTransform:{type:"function",value:null,optional:!0},onDataLoad:{type:"function",value:null,optional:!0},onError:{type:"function",value:null,optional:!0},fetch:{type:"function",value:(e,{propName:t,layer:i,loaders:r,loadOptions:n,signal:s})=>{let{resourceManager:o}=i.context;n=n||i.getLoadOptions(),r=r||i.props.loaders,s&&(n={...n,fetch:{...n?.fetch,signal:s}});let a=o.contains(e);return(a||n||(o.add({resourceId:e,data:oX(e,r),persistent:!1}),a=!0),a)?o.subscribe({resourceId:e,onChange:e=>i.internalState?.reloadAsyncProp(t,e),consumerId:i.id,requestId:t}):oX(e,r,n)}},updateTriggers:{},visible:!0,pickable:!1,opacity:{type:"number",min:0,max:1,value:1},operation:"draw",onHover:{type:"function",value:null,optional:!0},onClick:{type:"function",value:null,optional:!0},onDragStart:{type:"function",value:null,optional:!0},onDrag:{type:"function",value:null,optional:!0},onDragEnd:{type:"function",value:null,optional:!0},coordinateSystem:iJ.DEFAULT,coordinateOrigin:{type:"array",value:[0,0,0],compare:!0},modelMatrix:{type:"array",value:null,compare:!0,optional:!0},wrapLongitude:!1,positionFormat:"XYZ",colorFormat:"RGBA",parameters:{type:"object",value:{},optional:!0,compare:2},loadOptions:{type:"object",value:null,optional:!0,ignore:!0},transitions:null,extensions:[],loaders:{type:"array",value:[],optional:!0,ignore:!0},getPolygonOffset:{type:"function",value:({layerIndex:e})=>[0,-(100*e)]},highlightedObjectIndex:null,autoHighlight:!1,highlightColor:{type:"accessor",value:[0,0,128,128]}};class di extends h4{constructor(){super(...arguments),this.internalState=null,this.lifecycle="Awaiting state",this.parent=null}static get componentName(){return Object.prototype.hasOwnProperty.call(this,"layerName")?this.layerName:""}get root(){let e=this;for(;e.parent;)e=e.parent;return e}toString(){let e=this.constructor.layerName||this.constructor.name;return`${e}({id: '${this.props.id}'})`}project(e){ad(this.internalState);let t=this.internalState.viewport||this.context.viewport,[i,r,n]=se(hY(e,{viewport:t,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem}),t.pixelProjectionMatrix);return 2===e.length?[i,r]:[i,r,n]}unproject(e){return ad(this.internalState),(this.internalState.viewport||this.context.viewport).unproject(e)}projectPosition(e,t){return ad(this.internalState),function(e,t){let{viewport:i,coordinateSystem:r,coordinateOrigin:n,modelMatrix:s,fromCoordinateSystem:o,fromCoordinateOrigin:a}=function(e){let{viewport:t,modelMatrix:i,coordinateOrigin:r}=e,{coordinateSystem:n,fromCoordinateSystem:s,fromCoordinateOrigin:o}=e;return n===iJ.DEFAULT&&(n=t.isGeospatial?iJ.LNGLAT:iJ.CARTESIAN),void 0===s&&(s=n),void 0===o&&(o=r),{viewport:t,coordinateSystem:n,coordinateOrigin:r,modelMatrix:i,fromCoordinateSystem:s,fromCoordinateOrigin:o}}(t),{autoOffset:l=!0}=t,{geospatialOrigin:u=hq,shaderCoordinateOrigin:c=hq,offsetMode:h=!1}=l?re(i,r,n):{},d=hY(e,{viewport:i,modelMatrix:s,coordinateSystem:o,coordinateOrigin:a,offsetMode:h});if(h){let e=i.projectPosition(u||c);nK.sub(d,d,e)}return d}(e,{viewport:this.internalState.viewport||this.context.viewport,modelMatrix:this.props.modelMatrix,coordinateOrigin:this.props.coordinateOrigin,coordinateSystem:this.props.coordinateSystem,...t})}get isComposite(){return!1}get isDrawable(){return!0}setState(e){this.setChangeFlags({stateChanged:!0}),Object.assign(this.state,e),this.setNeedsRedraw()}setNeedsRedraw(){this.internalState&&(this.internalState.needsRedraw=!0)}setNeedsUpdate(){this.internalState&&(this.context.layerManager.setNeedsUpdate(String(this)),this.internalState.needsUpdate=!0)}get isLoaded(){return!!this.internalState&&!this.internalState.isAsyncPropLoading()}get wrapLongitude(){return this.props.wrapLongitude}isPickable(){return this.props.pickable&&this.props.visible}getModels(){let e=this.state;return e&&(e.models||e.model&&[e.model])||[]}setShaderModuleProps(...e){for(let t of this.getModels())t.shaderInputs.setProps(...e)}getAttributeManager(){return this.internalState&&this.internalState.attributeManager}getCurrentLayer(){return this.internalState&&this.internalState.layer}getLoadOptions(){return this.props.loadOptions}use64bitPositions(){let{coordinateSystem:e}=this.props;return e===iJ.DEFAULT||e===iJ.LNGLAT||e===iJ.CARTESIAN}onHover(e,t){return!!this.props.onHover&&(this.props.onHover(e,t)||!1)}onClick(e,t){return!!this.props.onClick&&(this.props.onClick(e,t)||!1)}nullPickingColor(){return[0,0,0]}encodePickingColor(e,t=[]){return t[0]=e+1&255,t[1]=e+1>>8&255,t[2]=e+1>>8>>8&255,t}decodePickingColor(e){ad(e instanceof Uint8Array);let[t,i,r]=e;return t+256*i+65536*r-1}getNumInstances(){if(Number.isFinite(this.props.numInstances))return this.props.numInstances;if(this.state&&void 0!==this.state.numInstances)return this.state.numInstances;var e,t,i=this.props.data;if(null===(e=i)||"object"!=typeof e)throw Error("count(): argument not an object");if("function"==typeof i.count)return i.count();if(Number.isFinite(i.size))return i.size;if(Number.isFinite(i.length))return i.length;if(null!==(t=i)&&"object"==typeof t&&t.constructor===Object)return Object.keys(i).length;throw Error("count(): argument not a container")}getStartIndices(){return this.props.startIndices?this.props.startIndices:this.state&&this.state.startIndices?this.state.startIndices:null}getBounds(){return this.getAttributeManager()?.getBounds(["positions","instancePositions"])}getShaders(e){for(let t of(e=hG(e,{disableWarnings:!0,modules:this.context.defaultShaderModules}),this.props.extensions))e=hG(e,t.getShaders.call(this,t));return e}shouldUpdateState(e){return e.changeFlags.propsOrDataChanged}updateState(e){let t=this.getAttributeManager(),{dataChanged:i}=e.changeFlags;if(i&&t)if(Array.isArray(i))for(let e of i)t.invalidateAll(e);else t.invalidateAll();if(t){let{props:i}=e,r=this.internalState.hasPickingBuffer,n=Number.isInteger(i.highlightedObjectIndex)||i.pickable||i.extensions.some(e=>e.getNeedsPickingBuffer.call(this,e));if(r!==n){this.internalState.hasPickingBuffer=n;let{pickingColors:e,instancePickingColors:i}=t.attributes,r=e||i;r&&(n&&r.constant&&(r.constant=!1,t.invalidate(r.id)),r.value||n||(r.constant=!0,r.value=[0,0,0]))}}}finalizeState(e){for(let e of this.getModels())e.destroy();let t=this.getAttributeManager();t&&t.finalize(),this.context&&this.context.resourceManager.unsubscribe({consumerId:this.id}),this.internalState&&(this.internalState.uniformTransitions.clear(),this.internalState.finalize())}draw(e){for(let t of this.getModels())t.draw(e.renderPass)}getPickingInfo({info:e,mode:t,sourceLayer:i}){let{index:r}=e;return r>=0&&Array.isArray(this.props.data)&&(e.object=this.props.data[r]),e}raiseError(e,t){t&&(e=Error(`${t}: ${e.message}`,{cause:e})),this.props.onError?.(e)||this.context?.onError?.(e,this)}getNeedsRedraw(e={clearRedrawFlags:!1}){return this._getNeedsRedraw(e)}needsUpdate(){return!!this.internalState&&(this.internalState.needsUpdate||this.hasUniformTransition()||this.shouldUpdateState(this._getUpdateParams()))}hasUniformTransition(){return this.internalState?.uniformTransitions.active||!1}activateViewport(e){if(!this.internalState)return;let t=this.internalState.viewport;this.internalState.viewport=e,t&&h7({oldViewport:t,viewport:e})||(this.setChangeFlags({viewportChanged:!0}),this.isComposite?this.needsUpdate()&&this.setNeedsUpdate():this._update())}invalidateAttribute(e="all"){let t=this.getAttributeManager();t&&("all"===e?t.invalidateAll():t.invalidate(e))}updateAttributes(e){let t=!1;for(let i in e)e[i].layoutChanged()&&(t=!0);for(let i of this.getModels())this._setModelAttributes(i,e,t)}_updateAttributes(){let e=this.getAttributeManager();if(!e)return;let t=this.props,i=this.getNumInstances(),r=this.getStartIndices();e.update({data:t.data,numInstances:i,startIndices:r,props:t,transitions:t.transitions,buffers:t.data.attributes,context:this});let n=e.getChangedAttributes({clearChangedFlags:!0});this.updateAttributes(n)}_updateAttributeTransition(){let e=this.getAttributeManager();e&&e.updateTransition()}_updateUniformTransition(){let{uniformTransitions:e}=this.internalState;if(e.active){let t=e.update(),i=Object.create(this.props);for(let e in t)Object.defineProperty(i,e,{value:t[e]});return i}return this.props}calculateInstancePickingColors(e,{numInstances:t}){if(e.constant)return;let i=Math.floor(de.length/4);if(this.internalState.usesPickingColorCache=!0,i<t){t>0xffffff&&ia.warn("Layer has too many data objects. Picking might not be able to distinguish all objects.")();let e=Math.floor((de=oJ.allocate(de,t,{size:4,copy:!0,maxCount:Math.max(t,0xffffff)})).length/4),r=[0,0,0];for(let t=i;t<e;t++)this.encodePickingColor(t,r),de[4*t+0]=r[0],de[4*t+1]=r[1],de[4*t+2]=r[2],de[4*t+3]=0}e.value=de.subarray(0,4*t)}_setModelAttributes(e,t,i=!1){if(!Object.keys(t).length)return;if(i){let i=this.getAttributeManager();e.setBufferLayout(i.getBufferLayouts(e)),t=i.getAttributes()}let r=e.userData?.excludeAttributes||{},n={},s={};for(let i in t){if(r[i])continue;let o=t[i].getValue();for(let r in o){let a=o[r];a instanceof lV.Buffer?t[i].settings.isIndexed?e.setIndexBuffer(a):n[r]=a:a&&(s[r]=a)}}e.setAttributes(n),e.setConstantAttributes(s)}disablePickingIndex(e){let t=this.props.data;if(!("attributes"in t))return void this._disablePickingIndex(e);let{pickingColors:i,instancePickingColors:r}=this.getAttributeManager().attributes,n=i||r,s=n&&t.attributes&&t.attributes[n.id];if(s&&s.value){let i=s.value,r=this.encodePickingColor(e);for(let e=0;e<t.length;e++){let t=n.getVertexOffset(e);i[t]===r[0]&&i[t+1]===r[1]&&i[t+2]===r[2]&&this._disablePickingIndex(e)}}else this._disablePickingIndex(e)}_disablePickingIndex(e){let{pickingColors:t,instancePickingColors:i}=this.getAttributeManager().attributes,r=t||i;if(!r)return;let n=r.getVertexOffset(e),s=r.getVertexOffset(e+1);r.buffer.write(new Uint8Array(s-n),n)}restorePickingColors(){let{pickingColors:e,instancePickingColors:t}=this.getAttributeManager().attributes,i=e||t;i&&(this.internalState.usesPickingColorCache&&i.value.buffer!==de.buffer&&(i.value=de.subarray(0,i.value.length)),i.updateSubBuffer({startOffset:0}))}_initialize(){ad(!this.internalState),ad(Number.isFinite(this.props.coordinateSystem)),sC("layer.initialize",this);let e=this._getAttributeManager();for(let t of(e&&e.addInstanced({instancePickingColors:{type:"uint8",size:4,noAlloc:!0,update:this.calculateInstancePickingColors}}),this.internalState=new h8({attributeManager:e,layer:this}),this._clearChangeFlags(),this.state={},Object.defineProperty(this.state,"attributeManager",{get:()=>(ia.deprecated("layer.state.attributeManager","layer.getAttributeManager()")(),e)}),this.internalState.uniformTransitions=new hB(this.context.timeline),this.internalState.onAsyncPropUpdated=this._onAsyncPropUpdated.bind(this),this.internalState.setAsyncProps(this.props),this.initializeState(this.context),this.props.extensions))t.initializeState.call(this,this.context,t);this.setChangeFlags({dataChanged:"init",propsChanged:"init",viewportChanged:!0,extensionsChanged:!0}),this._update()}_transferState(e){sC("layer.matched",this,this===e);let{state:t,internalState:i}=e;this!==e&&(this.internalState=i,this.state=t,this.internalState.setAsyncProps(this.props),this._diffProps(this.props,this.internalState.getOldProps()))}_update(){let e=this.needsUpdate();if(sC("layer.update",this,e),!e)return;let t=this.props,i=this.context,r=this.internalState,n=i.viewport,s=this._updateUniformTransition();r.propsInTransition=s,i.viewport=r.viewport||n,this.props=s;try{let e=this._getUpdateParams(),t=this.getModels();if(i.device)this.updateState(e);else try{this.updateState(e)}catch(e){}for(let t of this.props.extensions)t.updateState.call(this,e,t);this.setNeedsRedraw(),this._updateAttributes();let r=this.getModels()[0]!==t[0];this._postUpdate(e,r)}finally{i.viewport=n,this.props=t,this._clearChangeFlags(),r.needsUpdate=!1,r.resetOldProps()}}_finalize(){for(let e of(sC("layer.finalize",this),this.finalizeState(this.context),this.props.extensions))e.finalizeState.call(this,this.context,e)}_drawLayer({renderPass:e,shaderModuleProps:t=null,uniforms:i={},parameters:r={}}){this._updateAttributeTransition();let n=this.props,s=this.context;this.props=this.internalState.propsInTransition||n;try{t&&this.setShaderModuleProps(t);let{getPolygonOffset:n}=this.props,o=n&&n(i)||[0,0];for(let e of(s.device instanceof lW.WebGLDevice&&s.device.setParametersWebGL({polygonOffset:o}),this.getModels()))"webgpu"===e.device.type?e.setParameters({...e.parameters,...r}):e.setParameters(r);if(s.device instanceof lW.WebGLDevice)s.device.withParametersWebGL(r,()=>{let n={renderPass:e,shaderModuleProps:t,uniforms:i,parameters:r,context:s};for(let e of this.props.extensions)e.draw.call(this,n,e);this.draw(n)});else{let n={renderPass:e,shaderModuleProps:t,uniforms:i,parameters:r,context:s};for(let e of this.props.extensions)e.draw.call(this,n,e);this.draw(n)}}finally{this.props=n}}getChangeFlags(){return this.internalState?.changeFlags}setChangeFlags(e){if(!this.internalState)return;let{changeFlags:t}=this.internalState;for(let i in e)if(e[i]){let r=!1;if("dataChanged"===i){let n=e[i],s=t[i];n&&Array.isArray(s)&&(t.dataChanged=Array.isArray(n)?s.concat(n):n,r=!0)}t[i]||(t[i]=e[i],r=!0),r&&sC("layer.changeFlag",this,i,e)}let i=!!(t.dataChanged||t.updateTriggersChanged||t.propsChanged||t.extensionsChanged);t.propsOrDataChanged=i,t.somethingChanged=i||t.viewportChanged||t.stateChanged}_clearChangeFlags(){this.internalState.changeFlags={dataChanged:!1,propsChanged:!1,updateTriggersChanged:!1,viewportChanged:!1,stateChanged:!1,extensionsChanged:!1,propsOrDataChanged:!1,somethingChanged:!1}}_diffProps(e,t){let i,r,n,s=(i=h$({newProps:e,oldProps:t,propTypes:e[sb],ignoreProps:{data:null,updateTriggers:null,extensions:null,transitions:null}}),r=function(e,t){if(null===t)return"oldProps is null, initial diff";let i=!1,{dataComparator:r,_dataDiff:n}=e;return r?r(e.data,t.data)||(i="Data comparator detected a change"):e.data!==t.data&&(i="A new data container was supplied"),i&&n&&(i=n(e.data,t.data)||i),i}(e,t),n=!1,r||(n=function(e,t){if(null===t||"all"in e.updateTriggers&&hW(e,t,"all"))return{all:!0};let i={},r=!1;for(let n in e.updateTriggers)"all"!==n&&hW(e,t,n)&&(i[n]=!0,r=!0);return!!r&&i}(e,t)),{dataChanged:r,propsChanged:i,updateTriggersChanged:n,extensionsChanged:function(e,t){if(null===t)return!0;let i=t.extensions,{extensions:r}=e;if(r===i)return!1;if(!i||!r||r.length!==i.length)return!0;for(let e=0;e<r.length;e++)if(!r[e].equals(i[e]))return!0;return!1}(e,t),transitionsChanged:function(e,t){if(!e.transitions)return!1;let i={},r=e[sb],n=!1;for(let s in e.transitions){let o=r[s],a=o&&o.type;("number"===a||"color"===a||"array"===a)&&hV(e[s],t[s],o)&&(i[s]=!0,n=!0)}return!!n&&i}(e,t)});if(s.updateTriggersChanged)for(let e in s.updateTriggersChanged)s.updateTriggersChanged[e]&&this.invalidateAttribute(e);if(s.transitionsChanged)for(let i in s.transitionsChanged)this.internalState.uniformTransitions.add(i,t[i],e[i],e.transitions?.[i]);return this.setChangeFlags(s)}validateProps(){!function(e){let t=e[sb];for(let i in t){let r=t[i],{validate:n}=r;if(n&&!n(e[i],r))throw Error(`Invalid prop ${i}: ${e[i]}`)}}(this.props)}updateAutoHighlight(e){this.props.autoHighlight&&!Number.isInteger(this.props.highlightedObjectIndex)&&this._updateAutoHighlight(e)}_updateAutoHighlight(e){let t={highlightedObjectColor:e.picked?e.color:null},{highlightColor:i}=this.props;e.picked&&"function"==typeof i&&(t.highlightColor=i(e)),this.setShaderModuleProps({picking:t}),this.setNeedsRedraw()}_getAttributeManager(){let e=this.context;return new hN(e.device,{id:this.props.id,stats:e.stats,timeline:e.timeline})}_postUpdate(e,t){let{props:i,oldProps:r}=e,n=this.state.model;n?.isInstanced&&n.setInstanceCount(this.getNumInstances());let{autoHighlight:s,highlightedObjectIndex:o,highlightColor:a}=i;if(t||r.autoHighlight!==s||r.highlightedObjectIndex!==o||r.highlightColor!==a){let e={};Array.isArray(a)&&(e.highlightColor=a),(t||r.autoHighlight!==s||o!==r.highlightedObjectIndex)&&(e.highlightedObjectColor=Number.isFinite(o)&&o>=0?this.encodePickingColor(o):null),this.setShaderModuleProps({picking:e})}}_getUpdateParams(){return{props:this.props,oldProps:this.internalState.getOldProps(),context:this.context,changeFlags:this.internalState.changeFlags}}_getNeedsRedraw(e){if(!this.internalState)return!1;let t=!1;t=this.internalState.needsRedraw&&this.id;let i=this.getAttributeManager(),r=!!i&&i.getNeedsRedraw(e);if(t=t||r)for(let e of this.props.extensions)e.onNeedsRedraw.call(this,e);return this.internalState.needsRedraw=this.internalState.needsRedraw&&!e.clearRedrawFlags,t}_onAsyncPropUpdated(){this._diffProps(this.props,this.internalState.getOldProps()),this.setNeedsUpdate()}}di.defaultProps=dt,di.layerName="Layer";let dr=di,dn={position:"absolute",zIndex:-1};function ds(e){return e&&"object"==typeof e&&"type"in e||!1}let da=(0,C.createContext)(),dl={mixBlendMode:null};function du(e){e.redrawReason&&(e.deck._drawLayers(e.redrawReason),e.redrawReason=null)}let dc=C.forwardRef(function(e,t){let[i,r]=(0,C.useState)(0),n=(0,C.useRef)({control:null,version:i,forceUpdate:()=>r(e=>e+1)}).current,s=(0,C.useRef)(null),o=(0,C.useRef)(null),a=(0,C.useMemo)(()=>(function({children:e,layers:t=[],views:i=null}){let r=[],n=[],s={};return C.Children.forEach(function e(t){if("function"==typeof t)return(0,C.createElement)(ao,{},t);if(Array.isArray(t))return t.map(e);if(ds(t)){if(t.type===C.Fragment)return e(t.props.children);l$(t.type,ao)}return t}(e),e=>{if(ds(e)){let t=e.type;if(l$(t,dr)){let i=function(e,t){let i={},r=e.defaultProps||{};for(let e in t)r[e]!==t[e]&&(i[e]=t[e]);return new e(i)}(t,e.props);n.push(i)}else r.push(e);if(l$(t,ao)&&t!==ao&&e.props.id){let i=new t(e.props);s[i.id]=i}}else e&&r.push(e)}),Object.keys(s).length>0&&(Array.isArray(i)?i.forEach(e=>{s[e.id]=e}):i&&(s[i.id]=i),i=Object.values(s)),{layers:t=n.length>0?[...n,...t]:t,children:r,views:i}})(e),[e.layers,e.views,e.children]),l=!0,u=t=>l&&e.viewState?(n.viewStateUpdateRequested=t,null):(n.viewStateUpdateRequested=null,e.onViewStateChange?.(t)),c=t=>{l?n.interactionStateUpdateRequested=t:(n.interactionStateUpdateRequested=null,e.onInteractionStateChange?.(t))},h=(0,C.useMemo)(()=>{let t={widgets:[],...e,style:null,width:"100%",height:"100%",parent:s.current,canvas:o.current,layers:a.layers,views:a.views,onViewStateChange:u,onInteractionStateChange:c};return delete t._customRender,n.deck&&n.deck.setProps(t),t},[e]);(0,C.useEffect)(()=>{var t;let i;return i=new(e.Deck||lU)({...t={...h,parent:s.current,canvas:o.current},_customRender:t.deviceProps?.adapters?.[0]?.type==="webgpu"?void 0:e=>{n.redrawReason=e;let t=i.getViewports();n.lastRenderedViewports!==t?n.forceUpdate():du(n)}}),n.deck=i,()=>n.deck?.finalize()},[]),lB(()=>{du(n);let{viewStateUpdateRequested:e,interactionStateUpdateRequested:t}=n;e&&u(e),t&&c(t),n.deck?.isInitialized&&n.deck.redraw("Initial render")}),(0,C.useImperativeHandle)(t,()=>({get deck(){return n.deck},pickObject:e=>n.deck.pickObject(e),pickMultipleObjects:e=>n.deck.pickMultipleObjects(e),pickObjects:e=>n.deck.pickObjects(e)}),[]);let d=n.deck&&n.deck.isInitialized?n.deck.getViewports():void 0,{ContextProvider:f,width:p="100%",height:g="100%",id:m,style:y}=e,{containerStyle:_,canvasStyle:v}=(0,C.useMemo)(()=>(function({width:e,height:t,style:i}){let r={position:"absolute",zIndex:0,left:0,top:0,width:e,height:t},n={left:0,top:0};if(i)for(let e in i)e in dl?n[e]=i[e]:r[e]=i[e];return{containerStyle:r,canvasStyle:n}})({width:p,height:g,style:y}),[p,g,y]);if(!n.viewStateUpdateRequested&&n.lastRenderedViewports===d||n.version!==i){n.lastRenderedViewports=d,n.version=i;let e=function({children:e,deck:t,ContextProvider:i=da.Provider}){let{viewManager:r}=t||{};if(!r||!r.views.length)return[];let n={},s=r.views[0].id;for(let t of e){let e=s,i=t;ds(t)&&l$(t.type,ao)&&(e=t.props.id||s,i=t.props.children);let o=r.getViewport(e),a=r.getViewState(e);if(o){a.padding=o.padding;let{x:t,y:r,width:s,height:l}=o;i=function e(t,i){if("function"==typeof t)return t(i);if(Array.isArray(t))return t.map(t=>e(t,i));if(ds(t)){var r;if(r=t,r.props?.mapStyle)return i.style=dn,(0,C.cloneElement)(t,i);if(function(e){let t=e.type;return t&&t.deckGLViewProps}(t))return(0,C.cloneElement)(t,i)}return t}(i,{x:t,y:r,width:s,height:l,viewport:o,viewState:a}),n[e]||(n[e]={viewport:o,children:[]}),n[e].children.push(i)}}return Object.keys(n).map(e=>{let{viewport:r,children:s}=n[e],{x:o,y:a,width:l,height:u}=r,c=`view-${e}`,h=(0,C.createElement)("div",{key:c,id:c,style:{position:"absolute",left:o,top:a,width:l,height:u}},...s),d={deck:t,viewport:r,container:t.canvas.offsetParent,eventManager:t.eventManager,onViewStateChange:i=>{i.viewId=e,t._onViewStateChange(i)},widgets:[]},f=`view-${e}-context`;return(0,C.createElement)(i,{key:f,value:d},h)})}({children:a.children,deck:n.deck,ContextProvider:f}),t=(0,C.createElement)("canvas",{key:"canvas",id:m||"deckgl-overlay",ref:o,style:v});n.control=(0,C.createElement)("div",{id:`${m||"deckgl"}-wrapper`,ref:s,style:_},[t,e])}return l=!1,n.control});e.s(["DeckGL",0,dc],98677);class dh{id;topology;vertexCount;indices;attributes;userData={};constructor(e){const{attributes:t={},indices:i=null,vertexCount:r=null}=e;for(const[r,n]of(this.id=e.id||he("geometry"),this.topology=e.topology,i&&(this.indices=ArrayBuffer.isView(i)?{value:i,size:1}:i),this.attributes={},Object.entries(t))){const e=ArrayBuffer.isView(n)?{value:n}:n;if(!ArrayBuffer.isView(e.value))throw Error(`${this._print(r)}: must be typed array or object with value as typed array`);if("POSITION"!==r&&"positions"!==r||e.size||(e.size=3),"indices"===r){if(this.indices)throw Error("Multiple indices detected");this.indices=e}else this.attributes[r]=e}this.indices&&void 0!==this.indices.isIndexed&&(this.indices=Object.assign({},this.indices),delete this.indices.isIndexed),this.vertexCount=r||this._calculateVertexCount(this.attributes,this.indices)}getVertexCount(){return this.vertexCount}getAttributes(){return this.indices?{indices:this.indices,...this.attributes}:this.attributes}_print(e){return`Geometry ${this.id} attribute ${e}`}_setAttributes(e,t){return this}_calculateVertexCount(e,t){if(t)return t.value.length;let i=1/0;for(let t of Object.values(e)){let{value:e,size:r,constant:n}=t;!n&&e&&void 0!==r&&r>=1&&(i=Math.min(i,e.length/r))}return i}}let dd=`\
uniform scatterplotUniforms {
  float radiusScale;
  float radiusMinPixels;
  float radiusMaxPixels;
  float lineWidthScale;
  float lineWidthMinPixels;
  float lineWidthMaxPixels;
  float stroked;
  float filled;
  bool antialiasing;
  bool billboard;
  highp int radiusUnits;
  highp int lineWidthUnits;
} scatterplot;
`,df={name:"scatterplot",vs:dd,fs:dd,source:"",uniformTypes:{radiusScale:"f32",radiusMinPixels:"f32",radiusMaxPixels:"f32",lineWidthScale:"f32",lineWidthMinPixels:"f32",lineWidthMaxPixels:"f32",stroked:"f32",filled:"f32",antialiasing:"f32",billboard:"f32",radiusUnits:"i32",lineWidthUnits:"i32"}},dp=`\
#version 300 es
#define SHADER_NAME scatterplot-layer-vertex-shader
in vec3 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceRadius;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out vec2 unitPosition;
out float innerUnitRadius;
out float outerRadiusPixels;
void main(void) {
geometry.worldPosition = instancePositions;
outerRadiusPixels = clamp(
project_size_to_pixel(scatterplot.radiusScale * instanceRadius, scatterplot.radiusUnits),
scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
);
float lineWidthPixels = clamp(
project_size_to_pixel(scatterplot.lineWidthScale * instanceLineWidths, scatterplot.lineWidthUnits),
scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
);
outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
float edgePadding = scatterplot.antialiasing ? (outerRadiusPixels + SMOOTH_EDGE_RADIUS) / outerRadiusPixels : 1.0;
unitPosition = edgePadding * positions.xy;
geometry.uv = unitPosition;
geometry.pickingColor = instancePickingColors;
innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / outerRadiusPixels;
if (scatterplot.billboard) {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = edgePadding * positions * outerRadiusPixels;
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset = edgePadding * positions * project_pixel_size(outerRadiusPixels);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,dg=`\
#version 300 es
#define SHADER_NAME scatterplot-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in vec2 unitPosition;
in float innerUnitRadius;
in float outerRadiusPixels;
out vec4 fragColor;
void main(void) {
geometry.uv = unitPosition;
float distToCenter = length(unitPosition) * outerRadiusPixels;
float inCircle = scatterplot.antialiasing ?
smoothedge(distToCenter, outerRadiusPixels) :
step(distToCenter, outerRadiusPixels);
if (inCircle == 0.0) {
discard;
}
if (scatterplot.stroked > 0.5) {
float isLine = scatterplot.antialiasing ?
smoothedge(innerUnitRadius * outerRadiusPixels, distToCenter) :
step(innerUnitRadius * outerRadiusPixels, distToCenter);
if (scatterplot.filled > 0.5) {
fragColor = mix(vFillColor, vLineColor, isLine);
} else {
if (isLine == 0.0) {
discard;
}
fragColor = vec4(vLineColor.rgb, vLineColor.a * isLine);
}
} else if (scatterplot.filled < 0.5) {
discard;
} else {
fragColor = vFillColor;
}
fragColor.a *= inCircle;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,dm=`\
// Main shaders

struct ScatterplotUniforms {
  radiusScale: f32,
  radiusMinPixels: f32,
  radiusMaxPixels: f32,
  lineWidthScale: f32,
  lineWidthMinPixels: f32,
  lineWidthMaxPixels: f32,
  stroked: f32,
  filled: i32,
  antialiasing: i32,
  billboard: i32,
  radiusUnits: i32,
  lineWidthUnits: i32,
};

struct ConstantAttributeUniforms {
 instancePositions: vec3<f32>,
 instancePositions64Low: vec3<f32>,
 instanceRadius: f32,
 instanceLineWidths: f32,
 instanceFillColors: vec4<f32>,
 instanceLineColors: vec4<f32>,
 instancePickingColors: vec3<f32>,

 instancePositionsConstant: i32,
 instancePositions64LowConstant: i32,
 instanceRadiusConstant: i32,
 instanceLineWidthsConstant: i32,
 instanceFillColorsConstant: i32,
 instanceLineColorsConstant: i32,
 instancePickingColorsConstant: i32
};

@group(0) @binding(2) var<uniform> scatterplot: ScatterplotUniforms;

struct ConstantAttributes {
  instancePositions: vec3<f32>,
  instancePositions64Low: vec3<f32>,
  instanceRadius: f32,
  instanceLineWidths: f32,
  instanceFillColors: vec4<f32>,
  instanceLineColors: vec4<f32>,
  instancePickingColors: vec3<f32>
};

const constants = ConstantAttributes(
  vec3<f32>(0.0),
  vec3<f32>(0.0),
  0.0,
  0.0,
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec4<f32>(0.0, 0.0, 0.0, 1.0),
  vec3<f32>(0.0)
);

struct Attributes {
  @builtin(instance_index) instanceIndex : u32,
  @builtin(vertex_index) vertexIndex : u32,
  @location(0) positions: vec3<f32>,
  @location(1) instancePositions: vec3<f32>,
  @location(2) instancePositions64Low: vec3<f32>,
  @location(3) instanceRadius: f32,
  @location(4) instanceLineWidths: f32,
  @location(5) instanceFillColors: vec4<f32>,
  @location(6) instanceLineColors: vec4<f32>,
  @location(7) instancePickingColors: vec3<f32>
};

struct Varyings {
  @builtin(position) position: vec4<f32>,
  @location(0) vFillColor: vec4<f32>,
  @location(1) vLineColor: vec4<f32>,
  @location(2) unitPosition: vec2<f32>,
  @location(3) innerUnitRadius: f32,
  @location(4) outerRadiusPixels: f32,
};

@vertex
fn vertexMain(attributes: Attributes) -> Varyings {
  var varyings: Varyings;

  // Draw an inline geometry constant array clip space triangle to verify that rendering works.
  // var positions = array<vec2<f32>, 3>(vec2(0.0, 0.5), vec2(-0.5, -0.5), vec2(0.5, -0.5));
  // if (attributes.instanceIndex == 0) {
  //   varyings.position = vec4<f32>(positions[attributes.vertexIndex], 0.0, 1.0);
  //   return varyings;
  // }

  // var geometry: Geometry;
  // geometry.worldPosition = instancePositions;

  // Multiply out radius and clamp to limits
  varyings.outerRadiusPixels = clamp(
    project_unit_size_to_pixel(scatterplot.radiusScale * attributes.instanceRadius, scatterplot.radiusUnits),
    scatterplot.radiusMinPixels, scatterplot.radiusMaxPixels
  );

  // Multiply out line width and clamp to limits
  let lineWidthPixels = clamp(
    project_unit_size_to_pixel(scatterplot.lineWidthScale * attributes.instanceLineWidths, scatterplot.lineWidthUnits),
    scatterplot.lineWidthMinPixels, scatterplot.lineWidthMaxPixels
  );

  // outer radius needs to offset by half stroke width
  varyings.outerRadiusPixels += scatterplot.stroked * lineWidthPixels / 2.0;
  // Expand geometry to accommodate edge smoothing
  let edgePadding = select(
    (varyings.outerRadiusPixels + SMOOTH_EDGE_RADIUS) / varyings.outerRadiusPixels,
    1.0,
    scatterplot.antialiasing != 0
  );

  // position on the containing square in [-1, 1] space
  varyings.unitPosition = edgePadding * attributes.positions.xy;
  geometry.uv = varyings.unitPosition;
  geometry.pickingColor = attributes.instancePickingColors;

  varyings.innerUnitRadius = 1.0 - scatterplot.stroked * lineWidthPixels / varyings.outerRadiusPixels;

  if (scatterplot.billboard != 0) {
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, vec3<f32>(0.0)); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
    let offset = attributes.positions; // * edgePadding * varyings.outerRadiusPixels;
    // DECKGL_FILTER_SIZE(offset, geometry);
    let clipPixels = project_pixel_size_to_clipspace(offset.xy);
    varyings.position.x = clipPixels.x;
    varyings.position.y = clipPixels.y;
  } else {
    let offset = edgePadding * attributes.positions * project_pixel_size_float(varyings.outerRadiusPixels);
    // DECKGL_FILTER_SIZE(offset, geometry);
    varyings.position = project_position_to_clipspace(attributes.instancePositions, attributes.instancePositions64Low, offset); // TODO , geometry.position);
    // DECKGL_FILTER_GL_POSITION(varyings.position, geometry);
  }

  // Apply opacity to instance color, or return instance picking color
  varyings.vFillColor = vec4<f32>(attributes.instanceFillColors.rgb, attributes.instanceFillColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vFillColor, geometry);
  varyings.vLineColor = vec4<f32>(attributes.instanceLineColors.rgb, attributes.instanceLineColors.a * color.opacity);
  // DECKGL_FILTER_COLOR(varyings.vLineColor, geometry);

  return varyings;
}

@fragment
fn fragmentMain(varyings: Varyings) -> @location(0) vec4<f32> {
  // var geometry: Geometry;
  // geometry.uv = unitPosition;

  let distToCenter = length(varyings.unitPosition) * varyings.outerRadiusPixels;
  let inCircle = select(
    smoothedge(distToCenter, varyings.outerRadiusPixels),
    step(distToCenter, varyings.outerRadiusPixels),
    scatterplot.antialiasing != 0
  );

  if (inCircle == 0.0) {
    discard;
  }

  var fragColor: vec4<f32>;

  if (scatterplot.stroked != 0) {
    let isLine = select(
      smoothedge(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      step(varyings.innerUnitRadius * varyings.outerRadiusPixels, distToCenter),
      scatterplot.antialiasing != 0
    );

    if (scatterplot.filled != 0) {
      fragColor = mix(varyings.vFillColor, varyings.vLineColor, isLine);
    } else {
      if (isLine == 0.0) {
        discard;
      }
      fragColor = vec4<f32>(varyings.vLineColor.rgb, varyings.vLineColor.a * isLine);
    }
  } else if (scatterplot.filled == 0) {
    discard;
  } else {
    fragColor = varyings.vFillColor;
  }

  fragColor.a *= inCircle;
  // DECKGL_FILTER_COLOR(fragColor, geometry);

  // Apply premultiplied alpha as required by transparent canvas
  fragColor = deckgl_premultiplied_alpha(fragColor);

  return fragColor;
  // return vec4<f32>(0, 0, 1, 1);
}
`,dy=[0,0,0,255],d_={radiusUnits:"meters",radiusScale:{type:"number",min:0,value:1},radiusMinPixels:{type:"number",min:0,value:0},radiusMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},lineWidthUnits:"meters",lineWidthScale:{type:"number",min:0,value:1},lineWidthMinPixels:{type:"number",min:0,value:0},lineWidthMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},stroked:!1,filled:!0,billboard:!1,antialiasing:!0,getPosition:{type:"accessor",value:e=>e.position},getRadius:{type:"accessor",value:1},getFillColor:{type:"accessor",value:dy},getLineColor:{type:"accessor",value:dy},getLineWidth:{type:"accessor",value:1},strokeWidth:{deprecatedFor:"getLineWidth"},outline:{deprecatedFor:"stroked"},getColor:{deprecatedFor:["getFillColor","getLineColor"]}};class dv extends dr{getShaders(){return super.getShaders({vs:dp,fs:dg,source:dm,modules:[rh,e$,sg,df]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceRadius:{size:1,transition:!0,accessor:"getRadius",defaultValue:1},instanceFillColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:this.props.colorFormat.length,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e),e.changeFlags.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){let{radiusUnits:t,radiusScale:i,radiusMinPixels:r,radiusMaxPixels:n,stroked:s,filled:o,billboard:a,antialiasing:l,lineWidthUnits:u,lineWidthScale:c,lineWidthMinPixels:h,lineWidthMaxPixels:d}=this.props,f={stroked:s,filled:o,billboard:a,antialiasing:l,radiusUnits:i0[t],radiusScale:i,radiusMinPixels:r,radiusMaxPixels:n,lineWidthUnits:i0[u],lineWidthScale:c,lineWidthMinPixels:h,lineWidthMaxPixels:d},p=this.state.model;p.shaderInputs.setProps({scatterplot:f}),"webgpu"===this.context.device.type&&(p.instanceCount=this.props.data.length),p.draw(this.context.renderPass)}_getModel(){let e="webgpu"===this.context.device.type?{depthWriteEnabled:!0,depthCompare:"less-equal"}:void 0;return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new dh({topology:"triangle-strip",attributes:{positions:{size:3,value:new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0])}}}),isInstanced:!0,parameters:e})}}dv.defaultProps=d_,dv.layerName="ScatterplotLayer",e.s(["ScatterplotLayer",0,dv],45015);let db=`\
uniform arcUniforms {
  bool greatCircle;
  bool useShortestPath;
  float numSegments;
  float widthScale;
  float widthMinPixels;
  float widthMaxPixels;
  highp int widthUnits;
} arc;
`,dx={name:"arc",vs:db,fs:db,uniformTypes:{greatCircle:"f32",useShortestPath:"f32",numSegments:"f32",widthScale:"f32",widthMinPixels:"f32",widthMaxPixels:"f32",widthUnits:"i32"}},dw=`\
#version 300 es
#define SHADER_NAME arc-layer-vertex-shader
in vec4 instanceSourceColors;
in vec4 instanceTargetColors;
in vec3 instanceSourcePositions;
in vec3 instanceSourcePositions64Low;
in vec3 instanceTargetPositions;
in vec3 instanceTargetPositions64Low;
in vec3 instancePickingColors;
in float instanceWidths;
in float instanceHeights;
in float instanceTilts;
out vec4 vColor;
out vec2 uv;
out float isValid;
float paraboloid(float distance, float sourceZ, float targetZ, float ratio) {
float deltaZ = targetZ - sourceZ;
float dh = distance * instanceHeights;
if (dh == 0.0) {
return sourceZ + deltaZ * ratio;
}
float unitZ = deltaZ / dh;
float p2 = unitZ * unitZ + 1.0;
float dir = step(deltaZ, 0.0);
float z0 = mix(sourceZ, targetZ, dir);
float r = mix(ratio, 1.0 - ratio, dir);
return sqrt(r * (p2 - r)) * dh + z0;
}
vec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction, float width) {
vec2 dir_screenspace = normalize(line_clipspace * project.viewportSize);
dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);
return dir_screenspace * offset_direction * width / 2.0;
}
float getSegmentRatio(float index) {
return smoothstep(0.0, 1.0, index / (arc.numSegments - 1.0));
}
vec3 interpolateFlat(vec3 source, vec3 target, float segmentRatio) {
float distance = length(source.xy - target.xy);
float z = paraboloid(distance, source.z, target.z, segmentRatio);
float tiltAngle = radians(instanceTilts);
vec2 tiltDirection = normalize(target.xy - source.xy);
vec2 tilt = vec2(-tiltDirection.y, tiltDirection.x) * z * sin(tiltAngle);
return vec3(
mix(source.xy, target.xy, segmentRatio) + tilt,
z * cos(tiltAngle)
);
}
float getAngularDist (vec2 source, vec2 target) {
vec2 sourceRadians = radians(source);
vec2 targetRadians = radians(target);
vec2 sin_half_delta = sin((sourceRadians - targetRadians) / 2.0);
vec2 shd_sq = sin_half_delta * sin_half_delta;
float a = shd_sq.y + cos(sourceRadians.y) * cos(targetRadians.y) * shd_sq.x;
return 2.0 * asin(sqrt(a));
}
vec3 interpolateGreatCircle(vec3 source, vec3 target, vec3 source3D, vec3 target3D, float angularDist, float t) {
vec2 lngLat;
if(abs(angularDist - PI) < 0.001) {
lngLat = (1.0 - t) * source.xy + t * target.xy;
} else {
float a = sin((1.0 - t) * angularDist);
float b = sin(t * angularDist);
vec3 p = source3D.yxz * a + target3D.yxz * b;
lngLat = degrees(vec2(atan(p.y, -p.x), atan(p.z, length(p.xy))));
}
float z = paraboloid(angularDist * EARTH_RADIUS, source.z, target.z, t);
return vec3(lngLat, z);
}
void main(void) {
geometry.worldPosition = instanceSourcePositions;
geometry.worldPositionAlt = instanceTargetPositions;
float segmentIndex = float(gl_VertexID / 2);
float segmentSide = mod(float(gl_VertexID), 2.) == 0. ? -1. : 1.;
float segmentRatio = getSegmentRatio(segmentIndex);
float prevSegmentRatio = getSegmentRatio(max(0.0, segmentIndex - 1.0));
float nextSegmentRatio = getSegmentRatio(min(arc.numSegments - 1.0, segmentIndex + 1.0));
float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));
isValid = 1.0;
uv = vec2(segmentRatio, segmentSide);
geometry.uv = uv;
geometry.pickingColor = instancePickingColors;
vec4 curr;
vec4 next;
vec3 source;
vec3 target;
if ((arc.greatCircle || project.projectionMode == PROJECTION_MODE_GLOBE) && project.coordinateSystem == COORDINATE_SYSTEM_LNGLAT) {
source = project_globe_(vec3(instanceSourcePositions.xy, 0.0));
target = project_globe_(vec3(instanceTargetPositions.xy, 0.0));
float angularDist = getAngularDist(instanceSourcePositions.xy, instanceTargetPositions.xy);
vec3 prevPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, prevSegmentRatio);
vec3 currPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, segmentRatio);
vec3 nextPos = interpolateGreatCircle(instanceSourcePositions, instanceTargetPositions, source, target, angularDist, nextSegmentRatio);
if (abs(currPos.x - prevPos.x) > 180.0) {
indexDir = -1.0;
isValid = 0.0;
} else if (abs(currPos.x - nextPos.x) > 180.0) {
indexDir = 1.0;
isValid = 0.0;
}
nextPos = indexDir < 0.0 ? prevPos : nextPos;
nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;
if (isValid == 0.0) {
nextPos.x += nextPos.x > 0.0 ? -360.0 : 360.0;
float t = ((currPos.x > 0.0 ? 180.0 : -180.0) - currPos.x) / (nextPos.x - currPos.x);
currPos = mix(currPos, nextPos, t);
segmentRatio = mix(segmentRatio, nextSegmentRatio, t);
}
vec3 currPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, segmentRatio);
vec3 nextPos64Low = mix(instanceSourcePositions64Low, instanceTargetPositions64Low, nextSegmentRatio);
curr = project_position_to_clipspace(currPos, currPos64Low, vec3(0.0), geometry.position);
next = project_position_to_clipspace(nextPos, nextPos64Low, vec3(0.0));
} else {
vec3 source_world = instanceSourcePositions;
vec3 target_world = instanceTargetPositions;
if (arc.useShortestPath) {
source_world.x = mod(source_world.x + 180., 360.0) - 180.;
target_world.x = mod(target_world.x + 180., 360.0) - 180.;
float deltaLng = target_world.x - source_world.x;
if (deltaLng > 180.) target_world.x -= 360.;
if (deltaLng < -180.) source_world.x -= 360.;
}
source = project_position(source_world, instanceSourcePositions64Low);
target = project_position(target_world, instanceTargetPositions64Low);
float antiMeridianX = 0.0;
if (arc.useShortestPath) {
if (project.projectionMode == PROJECTION_MODE_WEB_MERCATOR_AUTO_OFFSET) {
antiMeridianX = -(project.coordinateOrigin.x + 180.) / 360. * TILE_SIZE;
}
float thresholdRatio = (antiMeridianX - source.x) / (target.x - source.x);
if (prevSegmentRatio <= thresholdRatio && nextSegmentRatio > thresholdRatio) {
isValid = 0.0;
indexDir = sign(segmentRatio - thresholdRatio);
segmentRatio = thresholdRatio;
}
}
nextSegmentRatio = indexDir < 0.0 ? prevSegmentRatio : nextSegmentRatio;
vec3 currPos = interpolateFlat(source, target, segmentRatio);
vec3 nextPos = interpolateFlat(source, target, nextSegmentRatio);
if (arc.useShortestPath) {
if (nextPos.x < antiMeridianX) {
currPos.x += TILE_SIZE;
nextPos.x += TILE_SIZE;
}
}
curr = project_common_position_to_clipspace(vec4(currPos, 1.0));
next = project_common_position_to_clipspace(vec4(nextPos, 1.0));
geometry.position = vec4(currPos, 1.0);
}
float widthPixels = clamp(
project_size_to_pixel(instanceWidths * arc.widthScale, arc.widthUnits),
arc.widthMinPixels, arc.widthMaxPixels
);
vec3 offset = vec3(
getExtrusionOffset((next.xy - curr.xy) * indexDir, segmentSide, widthPixels),
0.0);
DECKGL_FILTER_SIZE(offset, geometry);
DECKGL_FILTER_GL_POSITION(curr, geometry);
gl_Position = curr + vec4(project_pixel_size_to_clipspace(offset.xy), 0.0, 0.0);
vec4 color = mix(instanceSourceColors, instanceTargetColors, segmentRatio);
vColor = vec4(color.rgb, color.a * layer.opacity);
DECKGL_FILTER_COLOR(vColor, geometry);
}
`,dk=`\
#version 300 es
#define SHADER_NAME arc-layer-fragment-shader
precision highp float;
in vec4 vColor;
in vec2 uv;
in float isValid;
out vec4 fragColor;
void main(void) {
if (isValid == 0.0) {
discard;
}
fragColor = vColor;
geometry.uv = uv;
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,dT=[0,0,0,255],dS={getSourcePosition:{type:"accessor",value:e=>e.sourcePosition},getTargetPosition:{type:"accessor",value:e=>e.targetPosition},getSourceColor:{type:"accessor",value:dT},getTargetColor:{type:"accessor",value:dT},getWidth:{type:"accessor",value:1},getHeight:{type:"accessor",value:1},getTilt:{type:"accessor",value:0},greatCircle:!1,numSegments:{type:"number",value:50,min:1},widthUnits:"pixels",widthScale:{type:"number",value:1,min:0},widthMinPixels:{type:"number",value:0,min:0},widthMaxPixels:{type:"number",value:Number.MAX_SAFE_INTEGER,min:0}};class dP extends dr{getBounds(){return this.getAttributeManager()?.getBounds(["instanceSourcePositions","instanceTargetPositions"])}getShaders(){return super.getShaders({vs:dw,fs:dk,modules:[rh,sg,dx]})}get wrapLongitude(){return!1}initializeState(){this.getAttributeManager().addInstanced({instanceSourcePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getSourcePosition"},instanceTargetPositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getTargetPosition"},instanceSourceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getSourceColor",defaultValue:dT},instanceTargetColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getTargetColor",defaultValue:dT},instanceWidths:{size:1,transition:!0,accessor:"getWidth",defaultValue:1},instanceHeights:{size:1,transition:!0,accessor:"getHeight",defaultValue:1},instanceTilts:{size:1,transition:!0,accessor:"getTilt",defaultValue:0}})}updateState(e){super.updateState(e),e.changeFlags.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){let{widthUnits:t,widthScale:i,widthMinPixels:r,widthMaxPixels:n,greatCircle:s,wrapLongitude:o,numSegments:a}=this.props,l={numSegments:a,widthUnits:i0[t],widthScale:i,widthMinPixels:r,widthMaxPixels:n,greatCircle:s,useShortestPath:o},u=this.state.model;u.shaderInputs.setProps({arc:l}),u.setVertexCount(2*a),u.draw(this.context.renderPass)}_getModel(){return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),topology:"triangle-strip",isInstanced:!0})}}dP.layerName="ArcLayer",dP.defaultProps=dS,e.s(["ArcLayer",0,dP],90459);class dE extends dr{get isComposite(){return!0}get isDrawable(){return!1}get isLoaded(){return super.isLoaded&&this.getSubLayers().every(e=>e.isLoaded)}getSubLayers(){return this.internalState&&this.internalState.subLayers||[]}initializeState(e){}setState(e){super.setState(e),this.setNeedsUpdate()}getPickingInfo({info:e}){let{object:t}=e;return t&&t.__source&&t.__source.parent&&t.__source.parent.id===this.id&&(e.object=t.__source.object,e.index=t.__source.index),e}filterSubLayer(e){return!0}shouldRenderSubLayer(e,t){return t&&t.length}getSubLayerClass(e,t){let{_subLayerProps:i}=this.props;return i&&i[e]&&i[e].type||t}getSubLayerRow(e,t,i){return e.__source={parent:this,object:t,index:i},e}getSubLayerAccessor(e){if("function"==typeof e){let t={index:-1,data:this.props.data,target:[]};return(i,r)=>i&&i.__source?(t.index=i.__source.index,e(i.__source.object,t)):e(i,r)}return e}getSubLayerProps(e={}){let{opacity:t,pickable:i,visible:r,parameters:n,getPolygonOffset:s,highlightedObjectIndex:o,autoHighlight:a,highlightColor:l,coordinateSystem:u,coordinateOrigin:c,wrapLongitude:h,positionFormat:d,modelMatrix:f,extensions:p,fetch:g,operation:m,_subLayerProps:y}=this.props,_={id:"",updateTriggers:{},opacity:t,pickable:i,visible:r,parameters:n,getPolygonOffset:s,highlightedObjectIndex:o,autoHighlight:a,highlightColor:l,coordinateSystem:u,coordinateOrigin:c,wrapLongitude:h,positionFormat:d,modelMatrix:f,extensions:p,fetch:g,operation:m},v=y&&e.id&&y[e.id],b=v&&v.updateTriggers,x=e.id||"sublayer";if(v){let t=this.props[sb],i=e.type?e.type._propTypes:{};for(let e in v){let r=i[e]||t[e];r&&"accessor"===r.type&&(v[e]=this.getSubLayerAccessor(v[e]))}}for(let t of(Object.assign(_,e,v),_.id=`${this.props.id}-${x}`,_.updateTriggers={all:this.props.updateTriggers?.all,...e.updateTriggers,...b},p)){let e=t.getSubLayerProps.call(this,t);e&&Object.assign(_,e,{updateTriggers:Object.assign(_.updateTriggers,e.updateTriggers)})}return _}_updateAutoHighlight(e){for(let t of this.getSubLayers())t.updateAutoHighlight(e)}_getAttributeManager(){return null}_postUpdate(e,t){let i=this.internalState.subLayers,r=!i||this.needsUpdate();for(let e of(r&&(i=sI(this.renderLayers(),Boolean),this.internalState.subLayers=i),sC("compositeLayer.renderLayers",this,r,i),i))e.parent=this}}dE.layerName="CompositeLayer";let dC=dE,dI=`\
uniform iconUniforms {
  float sizeScale;
  vec2 iconsTextureDim;
  float sizeBasis;
  float sizeMinPixels;
  float sizeMaxPixels;
  bool billboard;
  highp int sizeUnits;
  float alphaCutoff;
} icon;
`,dA={name:"icon",vs:dI,fs:dI,uniformTypes:{sizeScale:"f32",iconsTextureDim:"vec2<f32>",sizeBasis:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",billboard:"f32",sizeUnits:"i32",alphaCutoff:"f32"}},dM=`\
#version 300 es
#define SHADER_NAME icon-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in float instanceSizes;
in float instanceAngles;
in vec4 instanceColors;
in vec3 instancePickingColors;
in vec4 instanceIconFrames;
in float instanceColorModes;
in vec2 instanceOffsets;
in vec2 instancePixelOffset;
out float vColorMode;
out vec4 vColor;
out vec2 vTextureCoords;
out vec2 uv;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = angle * PI / 180.0;
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vec2 iconSize = instanceIconFrames.zw;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * icon.sizeScale, icon.sizeUnits),
icon.sizeMinPixels, icon.sizeMaxPixels
);
float iconConstraint = icon.sizeBasis == 0.0 ? iconSize.x : iconSize.y;
float instanceScale = iconConstraint == 0.0 ? 0.0 : sizePixels / iconConstraint;
vec2 pixelOffset = positions / 2.0 * iconSize + instanceOffsets;
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles) * instanceScale;
pixelOffset += instancePixelOffset;
pixelOffset.y *= -1.0;
if (icon.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vTextureCoords = mix(
instanceIconFrames.xy,
instanceIconFrames.xy + iconSize,
(positions.xy + 1.0) / 2.0
) / icon.iconsTextureDim;
vColor = instanceColors;
DECKGL_FILTER_COLOR(vColor, geometry);
vColorMode = instanceColorModes;
}
`,dL=`\
#version 300 es
#define SHADER_NAME icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in float vColorMode;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
vec4 texColor = texture(iconsTexture, vTextureCoords);
vec3 color = mix(texColor.rgb, vColor.rgb, vColorMode);
float a = texColor.a * layer.opacity * vColor.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color, a);
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,dO=()=>{},dR={minFilter:"linear",mipmapFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},dD={x:0,y:0,width:0,height:0};function dF(e){return e&&(e.id||e.url)}function dN(e,t,i){for(let r=0;r<t.length;r++){let{icon:n,xOffset:s}=t[r];e[dF(n)]={...n,x:s,y:i}}}class dj{constructor(e,{onUpdate:t=dO,onError:i=dO}){this._loadOptions=null,this._texture=null,this._externalTexture=null,this._mapping={},this._samplerParameters=null,this._pendingCount=0,this._autoPacking=!1,this._xOffset=0,this._yOffset=0,this._rowHeight=0,this._buffer=4,this._canvasWidth=1024,this._canvasHeight=0,this._canvas=null,this.device=e,this.onUpdate=t,this.onError=i}finalize(){this._texture?.delete()}getTexture(){return this._texture||this._externalTexture}getIconMapping(e){let t=this._autoPacking?dF(e):e;return this._mapping[t]||dD}setProps({loadOptions:e,autoPacking:t,iconAtlas:i,iconMapping:r,textureParameters:n}){e&&(this._loadOptions=e),void 0!==t&&(this._autoPacking=t),r&&(this._mapping=r),i&&(this._texture?.delete(),this._texture=null,this._externalTexture=i),n&&(this._samplerParameters=n)}get isLoaded(){return 0===this._pendingCount}packIcons(e,t){if(!this._autoPacking||"undefined"==typeof document)return;let i=Object.values(function(e,t,i){if(!e||!t)return null;i=i||{};let r={},{iterable:n,objectInfo:s}=lQ(e);for(let e of n){s.index++;let n=t(e,s),o=dF(n);if(!n)throw Error("Icon is missing.");if(!n.url)throw Error("Icon url is missing.");r[o]||i[o]&&n.url===i[o].url||(r[o]={...n,source:e,sourceIndex:s.index})}return r}(e,t,this._mapping)||{});if(i.length>0){let{mapping:e,xOffset:t,yOffset:r,rowHeight:n,canvasHeight:s}=function({icons:e,buffer:t,mapping:i={},xOffset:r=0,yOffset:n=0,rowHeight:s=0,canvasWidth:o}){let a=[];for(let l=0;l<e.length;l++){let u=e[l];if(!i[dF(u)]){let{height:e,width:l}=u;r+l+t>o&&(dN(i,a,n),r=0,n=s+n+t,s=0,a=[]),a.push({icon:u,xOffset:r}),r=r+l+t,s=Math.max(s,e)}}return a.length>0&&dN(i,a,n),{mapping:i,rowHeight:s,xOffset:r,yOffset:n,canvasWidth:o,canvasHeight:Math.pow(2,Math.ceil(Math.log2(s+n+t)))}}({icons:i,buffer:this._buffer,canvasWidth:this._canvasWidth,mapping:this._mapping,rowHeight:this._rowHeight,xOffset:this._xOffset,yOffset:this._yOffset});this._rowHeight=n,this._mapping=e,this._xOffset=t,this._yOffset=r,this._canvasHeight=s,this._texture||(this._texture=this.device.createTexture({format:"rgba8unorm",data:null,width:this._canvasWidth,height:this._canvasHeight,sampler:this._samplerParameters||dR,mipLevels:this.device.getMipLevelCount(this._canvasWidth,this._canvasHeight)})),this._texture.height!==this._canvasHeight&&(this._texture=function(e,t,i,r){let{width:n,height:s,device:o}=e,a=o.createTexture({format:"rgba8unorm",width:t,height:i,sampler:r,mipLevels:o.getMipLevelCount(t,i)}),l=o.createCommandEncoder();return l.copyTextureToTexture({sourceTexture:e,destinationTexture:a,width:n,height:s}),l.finish(),a.generateMipmapsWebGL(),e.destroy(),a}(this._texture,this._canvasWidth,this._canvasHeight,this._samplerParameters||dR)),this.onUpdate(),this._canvas=this._canvas||document.createElement("canvas"),this._loadIcons(i),this._texture?.generateMipmapsWebGL()}}_loadIcons(e){let t=this._canvas.getContext("2d",{willReadFrequently:!0});for(let i of e)this._pendingCount++,oX(i.url,this._loadOptions).then(e=>{let r=dF(i),n=this._mapping[r],{x:s,y:o,width:a,height:l}=n,{image:u,width:c,height:h}=function(e,t,i,r){let n=Math.min(i/t.width,r/t.height),s=Math.floor(t.width*n),o=Math.floor(t.height*n);return 1===n?{image:t,width:s,height:o}:(e.canvas.height=o,e.canvas.width=s,e.clearRect(0,0,s,o),e.drawImage(t,0,0,t.width,t.height,0,0,s,o),{image:e.canvas,width:s,height:o})}(t,e,a,l);this._texture?.copyExternalImage({image:u,x:s+(a-c)/2,y:o+(l-h)/2,width:c,height:h}),n.width=c,n.height=h,this._texture?.generateMipmapsWebGL(),this.onUpdate()}).catch(e=>{this.onError({url:i.url,source:i.source,sourceIndex:i.sourceIndex,loadOptions:this._loadOptions,error:e})}).finally(()=>{this._pendingCount--})}}let dz=[0,0,0,255],dU={iconAtlas:{type:"image",value:null,async:!0},iconMapping:{type:"object",value:{},async:!0},sizeScale:{type:"number",value:1,min:0},billboard:!0,sizeUnits:"pixels",sizeBasis:"height",sizeMinPixels:{type:"number",min:0,value:0},sizeMaxPixels:{type:"number",min:0,value:Number.MAX_SAFE_INTEGER},alphaCutoff:{type:"number",value:.05,min:0,max:1},getPosition:{type:"accessor",value:e=>e.position},getIcon:{type:"accessor",value:e=>e.icon},getColor:{type:"accessor",value:dz},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},onIconError:{type:"function",value:null,optional:!0},textureParameters:{type:"object",ignore:!0,value:null}};class dB extends dr{getShaders(){return super.getShaders({vs:dM,fs:dL,modules:[rh,sg,dA]})}initializeState(){this.state={iconManager:new dj(this.context.device,{onUpdate:this._onUpdate.bind(this),onError:this._onError.bind(this)})},this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceOffsets:{size:2,accessor:"getIcon",transform:this.getInstanceOffset},instanceIconFrames:{size:4,accessor:"getIcon",transform:this.getInstanceIconFrame},instanceColorModes:{size:1,type:"uint8",accessor:"getIcon",transform:this.getInstanceColorMode},instanceColors:{size:this.props.colorFormat.length,type:"unorm8",transition:!0,accessor:"getColor",defaultValue:dz},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instancePixelOffset:{size:2,transition:!0,accessor:"getPixelOffset"}})}updateState(e){super.updateState(e);let{props:t,oldProps:i,changeFlags:r}=e,n=this.getAttributeManager(),{iconAtlas:s,iconMapping:o,data:a,getIcon:l,textureParameters:u}=t,{iconManager:c}=this.state;if("string"==typeof s)return;let h=s||this.internalState.isAsyncPropLoading("iconAtlas");c.setProps({loadOptions:t.loadOptions,autoPacking:!h,iconAtlas:s,iconMapping:h?o:null,textureParameters:u}),h?i.iconMapping!==t.iconMapping&&n.invalidate("getIcon"):(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getIcon))&&c.packIcons(a,l),r.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),n.invalidateAll())}get isLoaded(){return super.isLoaded&&this.state.iconManager.isLoaded}finalizeState(e){super.finalizeState(e),this.state.iconManager.finalize()}draw({uniforms:e}){let{sizeScale:t,sizeBasis:i,sizeMinPixels:r,sizeMaxPixels:n,sizeUnits:s,billboard:o,alphaCutoff:a}=this.props,{iconManager:l}=this.state,u=l.getTexture();if(u){let e=this.state.model,l={iconsTexture:u,iconsTextureDim:[u.width,u.height],sizeUnits:i0[s],sizeScale:t,sizeBasis:+("height"===i),sizeMinPixels:r,sizeMaxPixels:n,billboard:o,alphaCutoff:a};e.shaderInputs.setProps({icon:l}),e.draw(this.context.renderPass)}}_getModel(){return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new dh({topology:"triangle-strip",attributes:{positions:{size:2,value:new Float32Array([-1,-1,1,-1,-1,1,1,1])}}}),isInstanced:!0})}_onUpdate(){this.setNeedsRedraw()}_onError(e){let t=this.getCurrentLayer()?.props.onIconError;t?t(e):ia.error(e.error.message)()}getInstanceOffset(e){let{width:t,height:i,anchorX:r=t/2,anchorY:n=i/2}=this.state.iconManager.getIconMapping(e);return[t/2-r,i/2-n]}getInstanceColorMode(e){return+!!this.state.iconManager.getIconMapping(e).mask}getInstanceIconFrame(e){let{x:t,y:i,width:r,height:n}=this.state.iconManager.getIconMapping(e);return[t,i,r,n]}}dB.defaultProps=dU,dB.layerName="IconLayer";let d$=dB,dV=`\
uniform sdfUniforms {
  float gamma;
  bool enabled;
  float buffer;
  float outlineBuffer;
  vec4 outlineColor;
} sdf;
`,dW={name:"sdf",vs:dV,fs:dV,uniformTypes:{gamma:"f32",enabled:"f32",buffer:"f32",outlineBuffer:"f32",outlineColor:"vec4<f32>"}},dG=`\
#version 300 es
#define SHADER_NAME multi-icon-layer-fragment-shader
precision highp float;
uniform sampler2D iconsTexture;
in vec4 vColor;
in vec2 vTextureCoords;
in vec2 uv;
out vec4 fragColor;
void main(void) {
geometry.uv = uv;
if (!bool(picking.isActive)) {
float alpha = texture(iconsTexture, vTextureCoords).a;
vec4 color = vColor;
if (sdf.enabled) {
float distance = alpha;
alpha = smoothstep(sdf.buffer - sdf.gamma, sdf.buffer + sdf.gamma, distance);
if (sdf.outlineBuffer > 0.0) {
float inFill = alpha;
float inBorder = smoothstep(sdf.outlineBuffer - sdf.gamma, sdf.outlineBuffer + sdf.gamma, distance);
color = mix(sdf.outlineColor, vColor, inFill);
alpha = inBorder;
}
}
float a = alpha * color.a;
if (a < icon.alphaCutoff) {
discard;
}
fragColor = vec4(color.rgb, a * layer.opacity);
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,dq=[];class dH extends d${getShaders(){let e=super.getShaders();return{...e,modules:[...e.modules,dW],fs:dG}}initializeState(){super.initializeState(),this.getAttributeManager().addInstanced({instanceOffsets:{size:2,accessor:"getIconOffsets"},instancePickingColors:{type:"uint8",size:3,accessor:(e,{index:t,target:i})=>this.encodePickingColor(t,i)}})}updateState(e){super.updateState(e);let{props:t,oldProps:i}=e,{outlineColor:r}=t;r!==i.outlineColor&&((r=r.map(e=>e/255))[3]=Number.isFinite(r[3])?r[3]:1,this.setState({outlineColor:r})),!t.sdf&&t.outlineWidth&&ia.warn(`${this.id}: fontSettings.sdf is required to render outline`)()}draw(e){let{sdf:t,smoothing:i,outlineWidth:r}=this.props,{outlineColor:n}=this.state,s=r?Math.max(i,.75*(1-r)):-1,o=this.state.model,a={buffer:.75,outlineBuffer:s,gamma:i,enabled:!!t,outlineColor:n};if(o.shaderInputs.setProps({sdf:a}),super.draw(e),t&&r){let{iconManager:e}=this.state;e.getTexture()&&(o.shaderInputs.setProps({sdf:{...a,outlineBuffer:.75}}),o.draw(this.context.renderPass))}}getInstanceOffset(e){return e?Array.from(e).flatMap(e=>super.getInstanceOffset(e)):dq}getInstanceColorMode(e){return 1}getInstanceIconFrame(e){return e?Array.from(e).flatMap(e=>super.getInstanceIconFrame(e)):dq}}dH.defaultProps={getIconOffsets:{type:"accessor",value:e=>e.offsets},alphaCutoff:.001,smoothing:.1,outlineWidth:0,outlineColor:{type:"color",value:[0,0,0,255]}},dH.layerName="MultiIconLayer";class dY{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:r=.25,fontFamily:n="sans-serif",fontWeight:s="normal",fontStyle:o="normal",lang:a=null}={}){this.buffer=t,this.cutoff=r,this.radius=i,this.lang=a;const l=this.size=e+4*t,u=this._createCanvas(l),c=this.ctx=u.getContext("2d",{willReadFrequently:!0});c.font=`${o} ${s} ${e}px ${n}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(l*l),this.gridInner=new Float64Array(l*l),this.f=new Float64Array(l),this.z=new Float64Array(l+1),this.v=new Uint16Array(l)}_createCanvas(e){let t=document.createElement("canvas");return t.width=t.height=e,t}draw(e){let{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:r,actualBoundingBoxLeft:n,actualBoundingBoxRight:s}=this.ctx.measureText(e),o=Math.ceil(i),a=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(s-n))),l=Math.min(this.size-this.buffer,o+Math.ceil(r)),u=a+2*this.buffer,c=l+2*this.buffer,h=Math.max(u*c,0),d=new Uint8ClampedArray(h),f={data:d,width:u,height:c,glyphWidth:a,glyphHeight:l,glyphTop:o,glyphLeft:0,glyphAdvance:t};if(0===a||0===l)return f;let{ctx:p,buffer:g,gridInner:m,gridOuter:y}=this;this.lang&&(p.lang=this.lang),p.clearRect(g,g,a,l),p.fillText(e,g,g+o);let _=p.getImageData(g,g,a,l);y.fill(1e20,0,h),m.fill(0,0,h);for(let e=0;e<l;e++)for(let t=0;t<a;t++){let i=_.data[4*(e*a+t)+3]/255;if(0===i)continue;let r=(e+g)*u+t+g;if(1===i)y[r]=0,m[r]=1e20;else{let e=.5-i;y[r]=e>0?e*e:0,m[r]=e<0?e*e:0}}dX(y,0,0,u,c,u,this.f,this.v,this.z),dX(m,g,g,a,l,u,this.f,this.v,this.z);for(let e=0;e<h;e++){let t=Math.sqrt(y[e])-Math.sqrt(m[e]);d[e]=Math.round(255-255*(t/this.radius+this.cutoff))}return f}}function dX(e,t,i,r,n,s,o,a,l){for(let u=t;u<t+r;u++)dZ(e,i*s+u,s,n,o,a,l);for(let u=i;u<i+n;u++)dZ(e,u*s+t,1,r,o,a,l)}function dZ(e,t,i,r,n,s,o){s[0]=0,o[0]=-1e20,o[1]=1e20,n[0]=e[t];for(let a=1,l=0,u=0;a<r;a++){n[a]=e[t+a*i];let r=a*a;do{let e=s[l];u=(n[a]-n[e]+r-e*e)/(a-e)/2}while(u<=o[l]&&--l>-1)s[++l]=a,o[l]=u,o[l+1]=1e20}for(let a=0,l=0;a<r;a++){for(;o[l+1]<a;)l++;let r=s[l],u=a-r;e[t+a*i]=n[r]+u*u}}let dK=[];function dJ(e,t,i,r){let n=0;for(let s=t;s<i;s++){let t=e[s];n+=r[t]?.layoutWidth||0}return n}function dQ(e,t,i,r,n,s){let o=t,a=0;for(let l=t;l<i;l++){let t=dJ(e,l,l+1,n);a+t>r&&(o<l&&s.push(l),o=l,a=0),a+=t}return a}class d0{constructor(e=5){this._cache={},this._order=[],this.limit=e}get(e){let t=this._cache[e];return t&&(this._deleteOrder(e),this._appendOrder(e)),t}set(e,t){this._cache[e]?this.delete(e):Object.keys(this._cache).length===this.limit&&this.delete(this._order[0]),this._cache[e]=t,this._appendOrder(e)}delete(e){this._cache[e]&&(delete this._cache[e],this._deleteOrder(e))}_deleteOrder(e){let t=this._order.indexOf(e);t>=0&&this._order.splice(t,1)}_appendOrder(e){this._order.push(e)}}let d1={fontFamily:"Monaco, monospace",fontWeight:"normal",characterSet:function(){let e=[];for(let t=32;t<128;t++)e.push(String.fromCharCode(t));return e}(),fontSize:64,buffer:4,sdf:!1,cutoff:.25,radius:12,smoothing:.1},d2=new d0(3);function d3(e,t,i,r){e.font=`${r} ${i}px ${t}`,e.fillStyle="#000",e.textBaseline="alphabetic",e.textAlign="left"}class d4{constructor(){this.props={...d1}}get atlas(){return this._atlas}get mapping(){return this._atlas&&this._atlas.mapping}get scale(){let{fontSize:e,buffer:t}=this.props;return(1.2*e+2*t)/e}setProps(e={}){Object.assign(this.props,e),this._key=this._getKey();let t=function(e,t){let i;i=new Set("string"==typeof t?Array.from(t):t);let r=d2.get(e);if(!r)return i;for(let e in r.mapping)i.has(e)&&i.delete(e);return i}(this._key,this.props.characterSet),i=d2.get(this._key);if(i&&0===t.size){this._atlas!==i&&(this._atlas=i);return}let r=this._generateFontAtlas(t,i);this._atlas=r,d2.set(this._key,r)}_generateFontAtlas(e,t){let{fontFamily:i,fontWeight:r,fontSize:n,buffer:s,sdf:o,radius:a,cutoff:l}=this.props,u=t&&t.data;u||((u=document.createElement("canvas")).width=1024);let c=u.getContext("2d",{willReadFrequently:!0});d3(c,i,n,r);let{mapping:h,canvasHeight:d,xOffset:f,yOffset:p}=function({characterSet:e,getFontWidth:t,fontHeight:i,buffer:r,maxCanvasWidth:n,mapping:s={},xOffset:o=0,yOffset:a=0}){let l=0,u=o,c=i+2*r;for(let o of e)if(!s[o]){let e=t(o);u+e+2*r>n&&(u=0,l++),s[o]={x:u+r,y:a+l*c+r,width:e,height:c,layoutWidth:e,layoutHeight:i},u+=e+2*r}return{mapping:s,xOffset:u,yOffset:a+l*c,canvasHeight:Math.pow(2,Math.ceil(Math.log2(a+(l+1)*c)))}}({getFontWidth:e=>c.measureText(e).width,fontHeight:1.2*n,buffer:s,characterSet:e,maxCanvasWidth:1024,...t&&{mapping:t.mapping,xOffset:t.xOffset,yOffset:t.yOffset}});if(u.height!==d){let e=c.getImageData(0,0,u.width,u.height);u.height=d,c.putImageData(e,0,0)}if(d3(c,i,n,r),o){let t=new dY({fontSize:n,buffer:s,radius:a,cutoff:l,fontFamily:i,fontWeight:`${r}`});for(let i of e){let{data:e,width:r,height:s,glyphTop:o}=t.draw(i);h[i].width=r,h[i].layoutOffsetY=.9*n-o;let a=c.createImageData(r,s);for(let t=0;t<e.length;t++)a.data[4*t+3]=e[t];c.putImageData(a,h[i].x,h[i].y)}}else for(let t of e)c.fillText(t,h[t].x,h[t].y+s+.9*n);return{xOffset:f,yOffset:p,mapping:h,data:u,width:u.width,height:u.height}}_getKey(){let{fontFamily:e,fontWeight:t,fontSize:i,buffer:r,sdf:n,radius:s,cutoff:o}=this.props;return n?`${e} ${t} ${i} ${r} ${s} ${o}`:`${e} ${t} ${i} ${r}`}}let d6=`\
uniform textBackgroundUniforms {
  bool billboard;
  float sizeScale;
  float sizeMinPixels;
  float sizeMaxPixels;
  vec4 borderRadius;
  vec4 padding;
  highp int sizeUnits;
  bool stroked;
} textBackground;
`,d5={name:"textBackground",vs:d6,fs:d6,uniformTypes:{billboard:"f32",sizeScale:"f32",sizeMinPixels:"f32",sizeMaxPixels:"f32",borderRadius:"vec4<f32>",padding:"vec4<f32>",sizeUnits:"i32",stroked:"f32"}},d8=`\
#version 300 es
#define SHADER_NAME text-background-layer-vertex-shader
in vec2 positions;
in vec3 instancePositions;
in vec3 instancePositions64Low;
in vec4 instanceRects;
in float instanceSizes;
in float instanceAngles;
in vec2 instancePixelOffsets;
in float instanceLineWidths;
in vec4 instanceFillColors;
in vec4 instanceLineColors;
in vec3 instancePickingColors;
out vec4 vFillColor;
out vec4 vLineColor;
out float vLineWidth;
out vec2 uv;
out vec2 dimensions;
vec2 rotate_by_angle(vec2 vertex, float angle) {
float angle_radian = radians(angle);
float cos_angle = cos(angle_radian);
float sin_angle = sin(angle_radian);
mat2 rotationMatrix = mat2(cos_angle, -sin_angle, sin_angle, cos_angle);
return rotationMatrix * vertex;
}
void main(void) {
geometry.worldPosition = instancePositions;
geometry.uv = positions;
geometry.pickingColor = instancePickingColors;
uv = positions;
vLineWidth = instanceLineWidths;
float sizePixels = clamp(
project_size_to_pixel(instanceSizes * textBackground.sizeScale, textBackground.sizeUnits),
textBackground.sizeMinPixels, textBackground.sizeMaxPixels
);
dimensions = instanceRects.zw * sizePixels + textBackground.padding.xy + textBackground.padding.zw;
vec2 pixelOffset = (positions * instanceRects.zw + instanceRects.xy) * sizePixels + mix(-textBackground.padding.xy, textBackground.padding.zw, positions);
pixelOffset = rotate_by_angle(pixelOffset, instanceAngles);
pixelOffset += instancePixelOffsets;
pixelOffset.y *= -1.0;
if (textBackground.billboard)  {
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, vec3(0.0), geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
vec3 offset = vec3(pixelOffset, 0.0);
DECKGL_FILTER_SIZE(offset, geometry);
gl_Position.xy += project_pixel_size_to_clipspace(offset.xy);
} else {
vec3 offset_common = vec3(project_pixel_size(pixelOffset), 0.0);
DECKGL_FILTER_SIZE(offset_common, geometry);
gl_Position = project_position_to_clipspace(instancePositions, instancePositions64Low, offset_common, geometry.position);
DECKGL_FILTER_GL_POSITION(gl_Position, geometry);
}
vFillColor = vec4(instanceFillColors.rgb, instanceFillColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vFillColor, geometry);
vLineColor = vec4(instanceLineColors.rgb, instanceLineColors.a * layer.opacity);
DECKGL_FILTER_COLOR(vLineColor, geometry);
}
`,d9=`\
#version 300 es
#define SHADER_NAME text-background-layer-fragment-shader
precision highp float;
in vec4 vFillColor;
in vec4 vLineColor;
in float vLineWidth;
in vec2 uv;
in vec2 dimensions;
out vec4 fragColor;
float round_rect(vec2 p, vec2 size, vec4 radii) {
vec2 pixelPositionCB = (p - 0.5) * size;
vec2 sizeCB = size * 0.5;
float maxBorderRadius = min(size.x, size.y) * 0.5;
vec4 borderRadius = vec4(min(radii, maxBorderRadius));
borderRadius.xy =
(pixelPositionCB.x > 0.0) ? borderRadius.xy : borderRadius.zw;
borderRadius.x = (pixelPositionCB.y > 0.0) ? borderRadius.x : borderRadius.y;
vec2 q = abs(pixelPositionCB) - sizeCB + borderRadius.x;
return -(min(max(q.x, q.y), 0.0) + length(max(q, 0.0)) - borderRadius.x);
}
float rect(vec2 p, vec2 size) {
vec2 pixelPosition = p * size;
return min(min(pixelPosition.x, size.x - pixelPosition.x),
min(pixelPosition.y, size.y - pixelPosition.y));
}
vec4 get_stroked_fragColor(float dist) {
float isBorder = smoothedge(dist, vLineWidth);
return mix(vFillColor, vLineColor, isBorder);
}
void main(void) {
geometry.uv = uv;
if (textBackground.borderRadius != vec4(0.0)) {
float distToEdge = round_rect(uv, dimensions, textBackground.borderRadius);
if (textBackground.stroked) {
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
float shapeAlpha = smoothedge(-distToEdge, 0.0);
fragColor.a *= shapeAlpha;
} else {
if (textBackground.stroked) {
float distToEdge = rect(uv, dimensions);
fragColor = get_stroked_fragColor(distToEdge);
} else {
fragColor = vFillColor;
}
}
DECKGL_FILTER_COLOR(fragColor, geometry);
}
`,d7={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,borderRadius:{type:"object",value:0},padding:{type:"array",value:[0,0,0,0]},getPosition:{type:"accessor",value:e=>e.position},getSize:{type:"accessor",value:1},getAngle:{type:"accessor",value:0},getPixelOffset:{type:"accessor",value:[0,0]},getBoundingRect:{type:"accessor",value:[0,0,0,0]},getFillColor:{type:"accessor",value:[0,0,0,255]},getLineColor:{type:"accessor",value:[0,0,0,255]},getLineWidth:{type:"accessor",value:1}};class fe extends dr{getShaders(){return super.getShaders({vs:d8,fs:d9,modules:[rh,sg,d5]})}initializeState(){this.getAttributeManager().addInstanced({instancePositions:{size:3,type:"float64",fp64:this.use64bitPositions(),transition:!0,accessor:"getPosition"},instanceSizes:{size:1,transition:!0,accessor:"getSize",defaultValue:1},instanceAngles:{size:1,transition:!0,accessor:"getAngle"},instanceRects:{size:4,accessor:"getBoundingRect"},instancePixelOffsets:{size:2,transition:!0,accessor:"getPixelOffset"},instanceFillColors:{size:4,transition:!0,type:"unorm8",accessor:"getFillColor",defaultValue:[0,0,0,255]},instanceLineColors:{size:4,transition:!0,type:"unorm8",accessor:"getLineColor",defaultValue:[0,0,0,255]},instanceLineWidths:{size:1,transition:!0,accessor:"getLineWidth",defaultValue:1}})}updateState(e){super.updateState(e);let{changeFlags:t}=e;t.extensionsChanged&&(this.state.model?.destroy(),this.state.model=this._getModel(),this.getAttributeManager().invalidateAll())}draw({uniforms:e}){let{billboard:t,sizeScale:i,sizeUnits:r,sizeMinPixels:n,sizeMaxPixels:s,getLineWidth:o}=this.props,{padding:a,borderRadius:l}=this.props;a.length<4&&(a=[a[0],a[1],a[0],a[1]]),Array.isArray(l)||(l=[l,l,l,l]);let u=this.state.model,c={billboard:t,stroked:!!o,borderRadius:l,padding:a,sizeUnits:i0[r],sizeScale:i,sizeMinPixels:n,sizeMaxPixels:s};u.shaderInputs.setProps({textBackground:c}),u.draw(this.context.renderPass)}_getModel(){return new hm(this.context.device,{...this.getShaders(),id:this.props.id,bufferLayout:this.getAttributeManager().getBufferLayouts(),geometry:new dh({topology:"triangle-strip",vertexCount:4,attributes:{positions:{size:2,value:new Float32Array([0,0,1,0,0,1,1,1])}}}),isInstanced:!0})}}fe.defaultProps=d7,fe.layerName="TextBackgroundLayer";let ft={start:1,middle:0,end:-1},fi={top:1,center:0,bottom:-1},fr=[0,0,0,255],fn={billboard:!0,sizeScale:1,sizeUnits:"pixels",sizeMinPixels:0,sizeMaxPixels:Number.MAX_SAFE_INTEGER,background:!1,getBackgroundColor:{type:"accessor",value:[255,255,255,255]},getBorderColor:{type:"accessor",value:fr},getBorderWidth:{type:"accessor",value:0},backgroundBorderRadius:{type:"object",value:0},backgroundPadding:{type:"array",value:[0,0,0,0]},characterSet:{type:"object",value:d1.characterSet},fontFamily:d1.fontFamily,fontWeight:d1.fontWeight,lineHeight:1,outlineWidth:{type:"number",value:0,min:0},outlineColor:{type:"color",value:fr},fontSettings:{type:"object",value:{},compare:1},wordBreak:"break-word",maxWidth:{type:"number",value:-1},getText:{type:"accessor",value:e=>e.text},getPosition:{type:"accessor",value:e=>e.position},getColor:{type:"accessor",value:fr},getSize:{type:"accessor",value:32},getAngle:{type:"accessor",value:0},getTextAnchor:{type:"accessor",value:"middle"},getAlignmentBaseline:{type:"accessor",value:"center"},getPixelOffset:{type:"accessor",value:[0,0]},backgroundColor:{deprecatedFor:["background","getBackgroundColor"]}};class fs extends dC{constructor(){super(...arguments),this.getBoundingRect=(e,t)=>{let{size:[i,r]}=this.transformParagraph(e,t),{fontSize:n}=this.state.fontAtlasManager.props;i/=n,r/=n;let{getTextAnchor:s,getAlignmentBaseline:o}=this.props;return[(ft["function"==typeof s?s(e,t):s]-1)*i/2,(fi["function"==typeof o?o(e,t):o]-1)*r/2,i,r]},this.getIconOffsets=(e,t)=>{let{getTextAnchor:i,getAlignmentBaseline:r}=this.props,{x:n,y:s,rowWidth:o,size:[a,l]}=this.transformParagraph(e,t),u=ft["function"==typeof i?i(e,t):i],c=fi["function"==typeof r?r(e,t):r],h=n.length,d=Array(2*h),f=0;for(let e=0;e<h;e++){let t=(1-u)*(a-o[e])/2;d[f++]=(u-1)*a/2+t+n[e],d[f++]=(c-1)*l/2+s[e]}return d}}initializeState(){this.state={styleVersion:0,fontAtlasManager:new d4},this.props.maxWidth>0&&ia.once(1,"v8.9 breaking change: TextLayer maxWidth is now relative to text size")()}updateState(e){let{props:t,oldProps:i,changeFlags:r}=e;(r.dataChanged||r.updateTriggersChanged&&(r.updateTriggersChanged.all||r.updateTriggersChanged.getText))&&this._updateText(),(this._updateFontAtlas()||t.lineHeight!==i.lineHeight||t.wordBreak!==i.wordBreak||t.maxWidth!==i.maxWidth)&&this.setState({styleVersion:this.state.styleVersion+1})}getPickingInfo({info:e}){return e.object=e.index>=0?this.props.data[e.index]:null,e}_updateFontAtlas(){let{fontSettings:e,fontFamily:t,fontWeight:i}=this.props,{fontAtlasManager:r,characterSet:n}=this.state,s={...e,characterSet:n,fontFamily:t,fontWeight:i};if(!r.mapping)return r.setProps(s),!0;for(let e in s)if(s[e]!==r.props[e])return r.setProps(s),!0;return!1}_updateText(){let e,{data:t,characterSet:i}=this.props,r=t.attributes?.getText,{getText:n}=this.props,s=t.startIndices,o="auto"===i&&new Set;if(r&&s){let{texts:i,characterCount:a}=function({value:e,length:t,stride:i,offset:r,startIndices:n,characterSet:s}){let o=e.BYTES_PER_ELEMENT,a=i?i/o:1,l=r?r/o:0,u=n[t]||Math.ceil((e.length-l)/a),c=s&&new Set,h=Array(t),d=e;if(a>1||l>0){d=new e.constructor(u);for(let t=0;t<u;t++)d[t]=e[t*a+l]}for(let e=0;e<t;e++){let t=n[e],i=n[e+1]||u,r=d.subarray(t,i);h[e]=String.fromCodePoint.apply(null,r),c&&r.forEach(c.add,c)}if(c)for(let e of c)s.add(String.fromCodePoint(e));return{texts:h,characterCount:u}}({...ArrayBuffer.isView(r)?{value:r}:r,length:t.length,startIndices:s,characterSet:o});e=a,n=(e,{index:t})=>i[t]}else{let{iterable:i,objectInfo:r}=lQ(t);for(let t of(s=[0],e=0,i)){r.index++;let i=Array.from(n(t,r)||"");o&&i.forEach(o.add,o),e+=i.length,s.push(e)}}this.setState({getText:n,startIndices:s,numInstances:e,characterSet:o||i})}transformParagraph(e,t){let{fontAtlasManager:i}=this.state,r=i.mapping,n=this.state.getText,{wordBreak:s,lineHeight:o,maxWidth:a}=this.props;return function(e,t,i,r,n){let s=Array.from(e),o=s.length,a=Array(o),l=Array(o),u=Array(o),c=("break-word"===i||"break-all"===i)&&isFinite(r)&&r>0,h=[0,0],d=[0,0],f=0,p=0,g=0;for(let e=0;e<=o;e++){let m=s[e];if(("\n"===m||e===o)&&(g=e),g>p){let e=c?function(e,t,i,r,n=0,s){void 0===s&&(s=e.length);let o=[];return"break-all"===t?dQ(e,n,s,i,r,o):!function(e,t,i,r,n,s){let o=t,a=t,l=t,u=0;for(let c=t;c<i;c++)if(" "===e[c]?l=c+1:(" "===e[c+1]||c+1===i)&&(l=c+1),l>a){let t=dJ(e,a,l,n);u+t>r&&(o<a&&(s.push(a),o=a,u=0),t>r&&(t=dQ(e,a,l,r,n,s),o=s[s.length-1])),a=l,u+=t}}(e,n,s,i,r,o),o}(s,i,r,n,p,g):dK;for(let i=0;i<=e.length;i++){let r=0===i?p:e[i-1],o=i<e.length?e[i]:g;!function(e,t,i,r,n,s){let o=0,a=0;for(let s=t;s<i;s++){let t=e[s],i=r[t];i?(a||(a=i.layoutHeight),n[s]=o+i.layoutWidth/2,o+=i.layoutWidth):(ia.warn(`Missing character: ${t} (${t.codePointAt(0)})`)(),n[s]=o,o+=32)}s[0]=o,s[1]=a}(s,r,o,n,a,d);for(let e=r;e<o;e++){let t=s[e],i=n[t]?.layoutOffsetY||0;l[e]=f+d[1]/2+i,u[e]=d[0]}f+=d[1]*t,h[0]=Math.max(h[0],d[0])}p=g}"\n"===m&&(a[p]=0,l[p]=0,u[p]=0,p++)}return h[1]=f,{x:a,y:l,rowWidth:u,size:h}}(n(e,t)||"",o,s,a*i.props.fontSize,r)}renderLayers(){let{startIndices:e,numInstances:t,getText:i,fontAtlasManager:{scale:r,atlas:n,mapping:s},styleVersion:o}=this.state,{data:a,_dataDiff:l,getPosition:u,getColor:c,getSize:h,getAngle:d,getPixelOffset:f,getBackgroundColor:p,getBorderColor:g,getBorderWidth:m,backgroundBorderRadius:y,backgroundPadding:_,background:v,billboard:b,fontSettings:x,outlineWidth:w,outlineColor:k,sizeScale:T,sizeUnits:S,sizeMinPixels:P,sizeMaxPixels:E,transitions:C,updateTriggers:I}=this.props,A=this.getSubLayerClass("characters",dH),M=this.getSubLayerClass("background",fe);return[v&&new M({getFillColor:p,getLineColor:g,getLineWidth:m,borderRadius:y,padding:_,getPosition:u,getSize:h,getAngle:d,getPixelOffset:f,billboard:b,sizeScale:T,sizeUnits:S,sizeMinPixels:P,sizeMaxPixels:E,transitions:C&&{getPosition:C.getPosition,getAngle:C.getAngle,getSize:C.getSize,getFillColor:C.getBackgroundColor,getLineColor:C.getBorderColor,getLineWidth:C.getBorderWidth,getPixelOffset:C.getPixelOffset}},this.getSubLayerProps({id:"background",updateTriggers:{getPosition:I.getPosition,getAngle:I.getAngle,getSize:I.getSize,getFillColor:I.getBackgroundColor,getLineColor:I.getBorderColor,getLineWidth:I.getBorderWidth,getPixelOffset:I.getPixelOffset,getBoundingRect:{getText:I.getText,getTextAnchor:I.getTextAnchor,getAlignmentBaseline:I.getAlignmentBaseline,styleVersion:o}}}),{data:a.attributes&&a.attributes.background?{length:a.length,attributes:a.attributes.background}:a,_dataDiff:l,autoHighlight:!1,getBoundingRect:this.getBoundingRect}),new A({sdf:x.sdf,smoothing:Number.isFinite(x.smoothing)?x.smoothing:d1.smoothing,outlineWidth:w/(x.radius||d1.radius),outlineColor:k,iconAtlas:n,iconMapping:s,getPosition:u,getColor:c,getSize:h,getAngle:d,getPixelOffset:f,billboard:b,sizeScale:T*r,sizeUnits:S,sizeMinPixels:P*r,sizeMaxPixels:E*r,transitions:C&&{getPosition:C.getPosition,getAngle:C.getAngle,getColor:C.getColor,getSize:C.getSize,getPixelOffset:C.getPixelOffset}},this.getSubLayerProps({id:"characters",updateTriggers:{all:I.getText,getPosition:I.getPosition,getAngle:I.getAngle,getColor:I.getColor,getSize:I.getSize,getPixelOffset:I.getPixelOffset,getIconOffsets:{getTextAnchor:I.getTextAnchor,getAlignmentBaseline:I.getAlignmentBaseline,styleVersion:o}}}),{data:a,_dataDiff:l,startIndices:e,numInstances:t,getIconOffsets:this.getIconOffsets,getIcon:i})]}static set fontAtlasCacheLimit(e){ia.assert(Number.isFinite(e)&&e>=3,"Invalid cache limit"),d2=new d0(e)}}fs.defaultProps=fn,fs.layerName="TextLayer",e.s(["TextLayer",0,fs],89708)},28715,e=>{"use strict";var t=e.i(43476),i=e.i(71645);e.i(62805);var r=e.i(53817),n=e.i(86469),s=e.i(98677),o=e.i(45015),a=e.i(90459),l=e.i(89708),u=e.i(72015),c=e.i(32913);let h={version:8,name:"Dark Basemap",sources:{"carto-dark":{type:"raster",tiles:["https://a.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png","https://b.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png","https://c.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png"],tileSize:256,attribution:"Map tiles by Carto"}},layers:[{id:"carto-dark-layer",type:"raster",source:"carto-dark",minzoom:0,maxzoom:22}]},d=e=>{switch(e){case"Flow":return[0,180,255];case"Activating":return[255,184,0];case"Chaos":return[255,42,0];default:return[136,136,136]}},f=({className:e})=>{let f=(0,u.usePrimoStore)(e=>e.theme),p=(0,u.usePrimoStore)(e=>e.mapViewState),g=(0,u.usePrimoStore)(e=>e.setMapViewState),m=(0,u.usePrimoStore)(e=>e.toggles),y=(0,u.usePrimoStore)(e=>e.selectFacility),_=(0,u.usePrimoStore)(e=>e.selectedFacilityId),v=(0,u.usePrimoStore)(u.selectFilteredFacilities),b=(0,u.usePrimoStore)(u.selectFilteredLanes),x=(0,u.usePrimoStore)(e=>e.facilities),[w,k]=(0,i.useState)(null),T=(0,i.useMemo)(()=>{let e=new Map;return x.forEach(t=>e.set(t.id,t)),e},[x]),S=(0,i.useCallback)(e=>{let t=e.viewState;"number"==typeof t.longitude&&"number"==typeof t.latitude&&"number"==typeof t.zoom&&g({longitude:t.longitude,latitude:t.latitude,zoom:t.zoom,pitch:t.pitch||0,bearing:t.bearing||0})},[g]),P=(0,i.useCallback)(e=>{e.object&&"id"in e.object?y(e.object.id):y(null)},[y]),E=(0,i.useCallback)(e=>{e.object&&"id"in e.object?k({facility:e.object,x:e.x,y:e.y}):k(null)},[]),C=(0,i.useMemo)(()=>{let e=[];return m.showLanes&&b.length>0&&e.push(new a.ArcLayer({id:"lanes-layer",data:b,getSourcePosition:e=>{let t=T.get(e.fromFacilityId);return t?[t.lon,t.lat]:[0,0]},getTargetPosition:e=>{let t=T.get(e.toFacilityId);return t?[t.lon,t.lat]:[0,0]},getSourceColor:e=>[...d(e.status),80],getTargetColor:e=>[...d(e.status),180],getWidth:e=>Math.max(1,e.volume/100),widthMinPixels:1,widthMaxPixels:4,pickable:!1,greatCircle:!0})),e.push(new o.ScatterplotLayer({id:"facilities-layer",data:v,getPosition:e=>[e.lon,e.lat],getFillColor:e=>{let t=d(e.status);return e.id===_?[255,255,255,255]:[...t,220]},getLineColor:e=>[...d(e.status),255],getRadius:e=>{var t;return("Plant"===(t=e.facilityType)?16:"DC"===t?14:"Terminal"===t?12:10)*Math.pow(1.2,p.zoom-4)},lineWidthMinPixels:1,lineWidthMaxPixels:2,stroked:!0,filled:!0,pickable:!0,onClick:P,onHover:E,radiusMinPixels:4,radiusMaxPixels:20,updateTriggers:{getFillColor:[_],getRadius:[p.zoom]}})),m.showLabels&&p.zoom>6&&e.push(new l.TextLayer({id:"labels-layer",data:v,getPosition:e=>[e.lon,e.lat],getText:e=>e.name,getSize:Math.max(10,12+(p.zoom-6)*1.5),getColor:[255,255,255,p.zoom>8?220:150],getAngle:0,getTextAnchor:"middle",getAlignmentBaseline:"top",getPixelOffset:[0,12],fontFamily:f.typography.bodyFont,fontWeight:500,outlineWidth:2,outlineColor:[5,5,5,200],pickable:!1})),e},[v,b,T,m,p.zoom,_,f.typography.bodyFont,P,E]);return(0,t.jsxs)("div",{className:e,style:{position:"relative"},children:[(0,t.jsx)(s.DeckGL,{viewState:p,onViewStateChange:S,controller:!0,layers:C,getCursor:()=>w?"pointer":"grab",children:(0,t.jsxs)(r.default,{mapStyle:h,attributionControl:!1,children:[(0,t.jsx)(n.NavigationControl,{position:"bottom-right"}),(0,t.jsx)(n.ScaleControl,{position:"bottom-left"})]})}),w&&(0,t.jsxs)("div",{className:"absolute pointer-events-none z-10 px-3 py-2 rounded-lg shadow-lg",style:{left:w.x+10,top:w.y+10,backgroundColor:`${f.colors.surface}F0`,border:`1px solid ${c.STATUS_COLORS[w.facility.status]}40`,backdropFilter:"blur(8px)"},children:[(0,t.jsx)("div",{className:"font-semibold text-sm",style:{color:f.colors.text},children:w.facility.name}),(0,t.jsxs)("div",{className:"text-xs",style:{color:f.colors.textSecondary},children:[w.facility.city,", ",w.facility.state]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 mt-1",children:[(0,t.jsx)("span",{className:"text-xs px-1.5 py-0.5 rounded",style:{backgroundColor:`${c.STATUS_COLORS[w.facility.status]}20`,color:c.STATUS_COLORS[w.facility.status]},children:w.facility.status}),(0,t.jsx)("span",{className:"text-xs",style:{color:f.colors.textSecondary},children:w.facility.facilityType})]})]}),(0,t.jsxs)("div",{className:"absolute bottom-16 right-4 p-3 rounded-lg",style:{backgroundColor:`${f.colors.surface}E6`,border:`1px solid ${f.colors.primary}20`,backdropFilter:"blur(8px)"},children:[(0,t.jsx)("div",{className:"text-xs font-medium mb-2",style:{color:f.colors.text},children:"Status Legend"}),(0,t.jsx)("div",{className:"space-y-1.5",children:["Flow","Activating","Chaos"].map(e=>(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"w-3 h-3 rounded-full",style:{backgroundColor:c.STATUS_COLORS[e]}}),(0,t.jsx)("span",{className:"text-xs",style:{color:f.colors.textSecondary},children:e})]},e))})]})]})};e.s(["PrimoMap",0,f,"default",0,f])}]);